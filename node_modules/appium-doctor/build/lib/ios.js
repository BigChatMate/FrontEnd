"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.CarthageCheck = exports.AuthorizationDbCheck = exports.DevToolsSecurityCheck = exports.XcodeCmdLineToolsCheck = exports.XcodeCheck = exports.fixes = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _utils = require("./utils");

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _doctor = require("./doctor");

var _logger = _interopRequireDefault(require("./logger"));

var _carthageDetector = _interopRequireDefault(require("./carthage-detector"));

var _prompt = require("./prompt");

var _env = _interopRequireDefault(require("./env"));

let checks = [];
let fixes = {};
exports.fixes = fixes;

class XcodeCheck extends _doctor.DoctorCheck {
  diagnose() {
    return (0, _asyncToGenerator2.default)(function* () {
      let xcodePath;

      try {
        let _ref = yield (0, _teen_process.exec)('xcode-select', ['--print-path']),
            stdout = _ref.stdout;

        xcodePath = (stdout || '').replace("\n", "");
      } catch (err) {
        return (0, _utils.nok)('Xcode is NOT installed!');
      }

      return xcodePath && (yield _appiumSupport.fs.exists(xcodePath)) ? (0, _utils.ok)(`Xcode is installed at: ${xcodePath}`) : (0, _utils.nok)(`Xcode cannot be found at '${xcodePath}'!`);
    })();
  }

  fix() {
    return (0, _asyncToGenerator2.default)(function* () {
      return 'Manually install Xcode.';
    })();
  }

}

exports.XcodeCheck = XcodeCheck;
checks.push(new XcodeCheck());

class XcodeCmdLineToolsCheck extends _doctor.DoctorCheck {
  constructor() {
    super({
      autofix: true
    });
  }

  diagnose() {
    return (0, _asyncToGenerator2.default)(function* () {
      const errMess = 'Xcode Command Line Tools are NOT installed!';
      let pkgName = (yield _appiumSupport.system.macOsxVersion()) === '10.8' ? 'com.apple.pkg.DeveloperToolsCLI' : 'com.apple.pkg.CLTools_Executables';
      let stdout;

      try {
        stdout = (yield (0, _teen_process.exec)('pkgutil', [`--pkg-info=${pkgName}`])).stdout;
      } catch (err) {
        _logger.default.debug(err);

        return (0, _utils.nok)(errMess);
      }

      return stdout.match(/install-time/) ? (0, _utils.ok)('Xcode Command Line Tools are installed.') : (0, _utils.nok)(errMess);
    })();
  }

  fix() {
    return (0, _asyncToGenerator2.default)(function* () {
      _logger.default.info(`The following command need be executed: xcode-select --install`);

      let yesno = yield (0, _prompt.fixIt)();

      if (yesno === 'yes') {
        yield (0, _teen_process.exec)('xcode-select', ['--install']);
      } else {
        _logger.default.info('Skipping you will need to install Xcode manually.');

        throw new _doctor.FixSkippedError();
      }
    })();
  }

}

exports.XcodeCmdLineToolsCheck = XcodeCmdLineToolsCheck;
checks.push(new XcodeCmdLineToolsCheck());
fixes.authorizeIosFix = (0, _asyncToGenerator2.default)(function* () {
  _logger.default.info(`The authorize iOS script need to be run.`);

  let yesno = yield (0, _prompt.fixIt)();

  if (yesno === 'yes') {
    yield (0, _utils.authorizeIos)();
  } else {
    _logger.default.info('Skipping you will need to run the authorize iOS manually.');

    throw new _doctor.FixSkippedError();
  }
});

class DevToolsSecurityCheck extends _doctor.DoctorCheck {
  constructor() {
    super({
      autofix: true
    });
  }

  diagnose() {
    return (0, _asyncToGenerator2.default)(function* () {
      const errMess = 'DevToolsSecurity is NOT enabled!';
      let stdout;

      try {
        stdout = (yield (0, _teen_process.exec)('DevToolsSecurity', [])).stdout;
      } catch (err) {
        _logger.default.debug(err);

        return (0, _utils.nok)(errMess);
      }

      return stdout && stdout.match(/enabled/) ? (0, _utils.ok)('DevToolsSecurity is enabled.') : (0, _utils.nok)(errMess);
    })();
  }

  fix() {
    return (0, _asyncToGenerator2.default)(function* () {
      return yield fixes.authorizeIosFix();
    })();
  }

}

exports.DevToolsSecurityCheck = DevToolsSecurityCheck;
checks.push(new DevToolsSecurityCheck());

class AuthorizationDbCheck extends _doctor.DoctorCheck {
  constructor() {
    super({
      autofix: true
    });
  }

  diagnose() {
    return (0, _asyncToGenerator2.default)(function* () {
      const successMess = 'The Authorization DB is set up properly.';
      const errMess = 'The Authorization DB is NOT set up properly.';
      let stdout;

      try {
        stdout = (yield (0, _teen_process.exec)('security', ['authorizationdb', 'read', 'system.privilege.taskport'])).stdout;
      } catch (err) {
        if ((yield _appiumSupport.system.macOsxVersion()) === '10.8') {
          let data;

          try {
            data = yield _appiumSupport.fs.readFile('/etc/authorization', 'utf8');
          } catch (err) {
            _logger.default.debug(err);

            return (0, _utils.nok)(errMess);
          }

          let rg = /<key>system.privilege.taskport<\/key>\s*\n\s*<dict>\n\s*<key>allow-root<\/key>\n\s*(<true\/>)/;
          return data && data.match(rg) ? (0, _utils.ok)(successMess) : (0, _utils.nok)(errMess);
        } else {
          _logger.default.debug(err);

          return (0, _utils.nok)(errMess);
        }
      }

      return stdout && (stdout.match(/is-developer/) || stdout.match(/allow/)) ? (0, _utils.ok)(successMess) : (0, _utils.nok)(errMess);
    })();
  }

  fix() {
    return (0, _asyncToGenerator2.default)(function* () {
      return yield fixes.authorizeIosFix();
    })();
  }

}

exports.AuthorizationDbCheck = AuthorizationDbCheck;
checks.push(new AuthorizationDbCheck());

class CarthageCheck extends _doctor.DoctorCheck {
  diagnose() {
    return (0, _asyncToGenerator2.default)(function* () {
      let carthagePath = yield _carthageDetector.default.detect();
      return carthagePath ? (0, _utils.ok)(`Carthage was found at: ${carthagePath}`) : (0, _utils.nok)(`Carthage was NOT found!`);
    })();
  }

  fix() {
    return (0, _asyncToGenerator2.default)(function* () {
      return 'Please install Carthage. Visit https://github.com/Carthage' + '/Carthage#installing-carthage for more information.';
    })();
  }

}

exports.CarthageCheck = CarthageCheck;
checks.push(new CarthageCheck());
checks.push(new _env.default('HOME'));
var _default = checks;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pb3MuanMiXSwibmFtZXMiOlsiY2hlY2tzIiwiZml4ZXMiLCJYY29kZUNoZWNrIiwiRG9jdG9yQ2hlY2siLCJkaWFnbm9zZSIsInhjb2RlUGF0aCIsInN0ZG91dCIsInJlcGxhY2UiLCJlcnIiLCJmcyIsImV4aXN0cyIsImZpeCIsInB1c2giLCJYY29kZUNtZExpbmVUb29sc0NoZWNrIiwiY29uc3RydWN0b3IiLCJhdXRvZml4IiwiZXJyTWVzcyIsInBrZ05hbWUiLCJzeXN0ZW0iLCJtYWNPc3hWZXJzaW9uIiwibG9nIiwiZGVidWciLCJtYXRjaCIsImluZm8iLCJ5ZXNubyIsIkZpeFNraXBwZWRFcnJvciIsImF1dGhvcml6ZUlvc0ZpeCIsIkRldlRvb2xzU2VjdXJpdHlDaGVjayIsIkF1dGhvcml6YXRpb25EYkNoZWNrIiwic3VjY2Vzc01lc3MiLCJkYXRhIiwicmVhZEZpbGUiLCJyZyIsIkNhcnRoYWdlQ2hlY2siLCJjYXJ0aGFnZVBhdGgiLCJDYXJ0aGFnZURldGVjdG9yIiwiZGV0ZWN0IiwiRW52VmFyQW5kUGF0aENoZWNrIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLElBQUlBLE1BQU0sR0FBRyxFQUFiO0FBQ0EsSUFBSUMsS0FBSyxHQUFHLEVBQVo7OztBQUdBLE1BQU1DLFVBQU4sU0FBeUJDLG1CQUF6QixDQUFxQztBQUM3QkMsRUFBQUEsUUFBTixHQUFrQjtBQUFBO0FBQ2hCLFVBQUlDLFNBQUo7O0FBQ0EsVUFBSTtBQUFBLHlCQUNtQix3QkFBSyxjQUFMLEVBQXFCLENBQUMsY0FBRCxDQUFyQixDQURuQjtBQUFBLFlBQ0dDLE1BREgsUUFDR0EsTUFESDs7QUFFRkQsUUFBQUEsU0FBUyxHQUFHLENBQUNDLE1BQU0sSUFBSSxFQUFYLEVBQWVDLE9BQWYsQ0FBdUIsSUFBdkIsRUFBNkIsRUFBN0IsQ0FBWjtBQUNELE9BSEQsQ0FHRSxPQUFPQyxH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T0FBSixDQUFsRDtBQUNELFNBVkQsTUFVTztBQUNMSSwwQkFBSUMsS0FBSixDQUFVYixHQUFWOztBQUNBLGlCQUFPLGdCQUFJUSxPQUFKLENBQVA7QUFDRDtBQUNGOztBQUNELGFBQU9WLE1BQU0sS0FBS0EsTUFBTSxDQUFDZ0IsS0FBUCxDQUFhLGNBQWIsS0FBZ0NoQixNQUFNLENBQUNnQixLQUFQLENBQWEsT0FBYixDQUFyQyxDQUFOLEdBQ0wsZUFBR08sV0FBSCxDQURLLEdBQ2EsZ0JBQUliLE9BQUosQ0FEcEI7QUF0QmdCO0FBd0JqQjs7QUFDS0wsRUFBQUEsR0FBTixHQUFhO0FBQUE7QUFDWCxtQkFBYVYsS0FBSyxDQUFDeUIsZUFBTixFQUFiO0FBRFc7QUFFWjs7QUFoQzRDOzs7QUFrQy9DMUIsTUFBTSxDQUFDWSxJQUFQLENBQVksSUFBSWdCLG9CQUFKLEVBQVo7O0FBR0EsTUFBTUssYUFBTixTQUE0QjlCLG1CQUE1QixDQUF3QztBQUNoQ0MsRUFBQUEsUUFBTixHQUFrQjtBQUFBO0FBQ2hCLFVBQUk4QixZQUFZLFNBQVNDLDBCQUFpQkMsTUFBakIsRUFBekI7QUFDQSxhQUFPRixZQUFZLEdBQ2YsZUFBSSwwQkFBeUJBLFlBQWEsRUFBMUMsQ0FEZSxHQUVmLGdCQUFLLHlCQUFMLENBRko7QUFGZ0I7QUFLakI7O0FBRUt2QixFQUFBQSxHQUFOLEdBQWE7QUFBQTtBQUNYLGFBQU8sK0RBQ0EscURBRFA7QUFEVztBQUdaOztBQVhxQzs7O0FBYXhDWCxNQUFNLENBQUNZLElBQVAsQ0FBWSxJQUFJcUIsYUFBSixFQUFaO0FBRUFqQyxNQUFNLENBQUNZLElBQVAsQ0FBWSxJQUFJeUIsWUFBSixDQUF1QixNQUF2QixDQUFaO2VBTWVyQyxNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgb2ssIG5vaywgYXV0aG9yaXplSW9zIH0gZnJvbSAnLi91dGlscyc7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbmltcG9ydCB7IGZzLCBzeXN0ZW0gfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IERvY3RvckNoZWNrLCBGaXhTa2lwcGVkRXJyb3IgfSBmcm9tICcuL2RvY3Rvcic7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBDYXJ0aGFnZURldGVjdG9yIGZyb20gJy4vY2FydGhhZ2UtZGV0ZWN0b3InO1xuaW1wb3J0IHsgZml4SXQgfSBmcm9tICcuL3Byb21wdCc7XG5pbXBvcnQgRW52VmFyQW5kUGF0aENoZWNrIGZyb20gJy4vZW52JztcblxuXG5sZXQgY2hlY2tzID0gW107XG5sZXQgZml4ZXMgPSB7fTtcblxuLy8gQ2hlY2sgZm9yIFhjb2RlLlxuY2xhc3MgWGNvZGVDaGVjayBleHRlbmRzIERvY3RvckNoZWNrIHtcbiAgYXN5bmMgZGlhZ25vc2UgKCkge1xuICAgIGxldCB4Y29kZVBhdGg7XG4gICAgdHJ5IHtcbiAgICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ3hjb2RlLXNlbGVjdCcsIFsnLS1wcmludC1wYXRoJ10pO1xuICAgICAgeGNvZGVQYXRoID0gKHN0ZG91dCB8fCAnJykucmVwbGFjZShcIlxcblwiLCBcIlwiKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiBub2soJ1hjb2RlIGlzIE5PVCBpbnN0YWxsZWQhJyk7XG4gICAgfVxuICAgIHJldHVybiB4Y29kZVBhdGggJiYgYXdhaXQgZnMuZXhpc3RzKHhjb2RlUGF0aCkgPyBvayhgWGNvZGUgaXMgaW5zdGFsbGVkIGF0OiAke3hjb2RlUGF0aH1gKSA6XG4gICAgICBub2soYFhjb2RlIGNhbm5vdCBiZSBmb3VuZCBhdCAnJHt4Y29kZVBhdGh9JyFgKTtcbiAgfVxuXG4gIGFzeW5jIGZpeCAoKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICAgIHJldHVybiAnTWFudWFsbHkgaW5zdGFsbCBYY29kZS4nO1xuICB9XG59XG5jaGVja3MucHVzaChuZXcgWGNvZGVDaGVjaygpKTtcblxuLy8gQ2hlY2sgZm9yIFhjb2RlIENvbW1hbmQgTGluZSBUb29scy5cbmNsYXNzIFhjb2RlQ21kTGluZVRvb2xzQ2hlY2sgZXh0ZW5kcyBEb2N0b3JDaGVjayB7XG4gIGNvbnN0cnVjdG9yICgpIHtcbiAgICBzdXBlcih7YXV0b2ZpeDogdHJ1ZX0pO1xuICB9XG5cbiAgYXN5bmMgZGlhZ25vc2UgKCkge1xuICAgIGNvbnN0IGVyck1lc3MgPSAnWGNvZGUgQ29tbWFuZCBMaW5lIFRvb2xzIGFyZSBOT1QgaW5zdGFsbGVkISc7XG4gICAgbGV0IHBrZ05hbWUgPSBhd2FpdCBzeXN0ZW0ubWFjT3N4VmVyc2lvbigpID09PSAnMTAuOCcgPyAnY29tLmFwcGxlLnBrZy5EZXZlbG9wZXJUb29sc0NMSScgOiAnY29tLmFwcGxlLnBrZy5DTFRvb2xzX0V4ZWN1dGFibGVzJztcbiAgICBsZXQgc3Rkb3V0O1xuICAgIHRyeSB7XG4gICAgICBzdGRvdXQgPSAoYXdhaXQgZXhlYygncGtndXRpbCcsIFtgLS1wa2ctaW5mbz0ke3BrZ05hbWV9YF0pKS5zdGRvdXQ7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZGVidWcoZXJyKTtcbiAgICAgIHJldHVybiBub2soZXJyTWVzcyk7XG4gICAgfVxuICAgIHJldHVybiBzdGRvdXQubWF0Y2goL2luc3RhbGwtdGltZS8pID8gb2soJ1hjb2RlIENvbW1hbmQgTGluZSBUb29scyBhcmUgaW5zdGFsbGVkLicpIDpcbiAgICAgIG5vayhlcnJNZXNzKTtcbiAgfVxuXG4gIGFzeW5jIGZpeCAoKSB7XG4gICAgbG9nLmluZm8oYFRoZSBmb2xsb3dpbmcgY29tbWFuZCBuZWVkIGJlIGV4ZWN1dGVkOiB4Y29kZS1zZWxlY3QgLS1pbnN0YWxsYCk7XG4gICAgbGV0IHllc25vID0gYXdhaXQgZml4SXQoKTtcbiAgICBpZiAoeWVzbm8gPT09ICd5ZXMnKSB7XG4gICAgICBhd2FpdCBleGVjKCd4Y29kZS1zZWxlY3QnLCBbJy0taW5zdGFsbCddKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmluZm8oJ1NraXBwaW5nIHlvdSB3aWxsIG5lZWQgdG8gaW5zdGFsbCBYY29kZSBtYW51YWxseS4nKTtcbiAgICAgIHRocm93IG5ldyBGaXhTa2lwcGVkRXJyb3IoKTtcbiAgICB9XG4gIH1cbn1cblxuY2hlY2tzLnB1c2gobmV3IFhjb2RlQ21kTGluZVRvb2xzQ2hlY2soKSk7XG5cbi8vIEF1dG9tYXRpY2FsbHkgcnVuIGF1dGhvcml6ZSBpT1MgaWYgcmVxdWVzdGVkXG5maXhlcy5hdXRob3JpemVJb3NGaXggPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxvZy5pbmZvKGBUaGUgYXV0aG9yaXplIGlPUyBzY3JpcHQgbmVlZCB0byBiZSBydW4uYCk7XG4gIGxldCB5ZXNubyA9IGF3YWl0IGZpeEl0KCk7XG4gIGlmICh5ZXNubyA9PT0gJ3llcycpIHtcbiAgICBhd2FpdCBhdXRob3JpemVJb3MoKTtcbiAgfSBlbHNlIHtcbiAgICBsb2cuaW5mbygnU2tpcHBpbmcgeW91IHdpbGwgbmVlZCB0byBydW4gdGhlIGF1dGhvcml6ZSBpT1MgbWFudWFsbHkuJyk7XG4gICAgdGhyb3cgbmV3IEZpeFNraXBwZWRFcnJvcigpO1xuICB9XG59O1xuXG4vLyBEZXYgVG9vbHMgU2VjdXJpdHlcbmNsYXNzIERldlRvb2xzU2VjdXJpdHlDaGVjayBleHRlbmRzIERvY3RvckNoZWNrIHtcbiAgY29uc3RydWN0b3IgKCkge1xuICAgIHN1cGVyKHthdXRvZml4OiB0cnVlfSk7XG4gIH1cblxuICBhc3luYyBkaWFnbm9zZSAoKSB7XG4gICAgY29uc3QgZXJyTWVzcyA9ICdEZXZUb29sc1NlY3VyaXR5IGlzIE5PVCBlbmFibGVkISc7XG4gICAgbGV0IHN0ZG91dDtcbiAgICB0cnkge1xuICAgICAgc3Rkb3V0ID0gKGF3YWl0IGV4ZWMoJ0RldlRvb2xzU2VjdXJpdHknLCBbXSkpLnN0ZG91dDtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5kZWJ1ZyhlcnIpO1xuICAgICAgcmV0dXJuIG5vayhlcnJNZXNzKTtcbiAgICB9XG4gICAgcmV0dXJuIHN0ZG91dCAmJiBzdGRvdXQubWF0Y2goL2VuYWJsZWQvKSA/IG9rKCdEZXZUb29sc1NlY3VyaXR5IGlzIGVuYWJsZWQuJylcbiAgICAgIDogbm9rKGVyck1lc3MpO1xuICB9XG4gIGFzeW5jIGZpeCAoKSB7XG4gICAgcmV0dXJuIGF3YWl0IGZpeGVzLmF1dGhvcml6ZUlvc0ZpeCgpO1xuICB9XG59XG5jaGVja3MucHVzaChuZXcgRGV2VG9vbHNTZWN1cml0eUNoZWNrKCkpO1xuXG4vLyBBdXRob3JpemF0aW9uIERCXG5jbGFzcyBBdXRob3JpemF0aW9uRGJDaGVjayBleHRlbmRzIERvY3RvckNoZWNrIHtcbiAgY29uc3RydWN0b3IgKCkge1xuICAgIHN1cGVyKHthdXRvZml4OiB0cnVlfSk7XG4gIH1cblxuICBhc3luYyBkaWFnbm9zZSAoKSB7XG4gICAgY29uc3Qgc3VjY2Vzc01lc3MgPSAnVGhlIEF1dGhvcml6YXRpb24gREIgaXMgc2V0IHVwIHByb3Blcmx5Lic7XG4gICAgY29uc3QgZXJyTWVzcyA9ICdUaGUgQXV0aG9yaXphdGlvbiBEQiBpcyBOT1Qgc2V0IHVwIHByb3Blcmx5Lic7XG4gICAgbGV0IHN0ZG91dDtcbiAgICB0cnkge1xuICAgICAgc3Rkb3V0ID0gKGF3YWl0IGV4ZWMoJ3NlY3VyaXR5JywgWydhdXRob3JpemF0aW9uZGInLCAncmVhZCcsICdzeXN0ZW0ucHJpdmlsZWdlLnRhc2twb3J0J10pKS5zdGRvdXQ7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoYXdhaXQgc3lzdGVtLm1hY09zeFZlcnNpb24oKSA9PT0gJzEwLjgnKSB7XG4gICAgICAgIGxldCBkYXRhO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGRhdGEgPSBhd2FpdCBmcy5yZWFkRmlsZSgnL2V0Yy9hdXRob3JpemF0aW9uJywgJ3V0ZjgnKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbG9nLmRlYnVnKGVycik7XG4gICAgICAgICAgcmV0dXJuIG5vayhlcnJNZXNzKTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgcmcgPSAvPGtleT5zeXN0ZW0ucHJpdmlsZWdlLnRhc2twb3J0PFxcL2tleT5cXHMqXFxuXFxzKjxkaWN0Plxcblxccyo8a2V5PmFsbG93LXJvb3Q8XFwva2V5PlxcblxccyooPHRydWVcXC8+KS87XG4gICAgICAgIHJldHVybiBkYXRhICYmIGRhdGEubWF0Y2gocmcpID8gb2soc3VjY2Vzc01lc3MpIDogbm9rKGVyck1lc3MpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmRlYnVnKGVycik7XG4gICAgICAgIHJldHVybiBub2soZXJyTWVzcyk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBzdGRvdXQgJiYgKHN0ZG91dC5tYXRjaCgvaXMtZGV2ZWxvcGVyLykgfHwgc3Rkb3V0Lm1hdGNoKC9hbGxvdy8pKSA/XG4gICAgICBvayhzdWNjZXNzTWVzcykgOiBub2soZXJyTWVzcyk7XG4gIH1cbiAgYXN5bmMgZml4ICgpIHtcbiAgICByZXR1cm4gYXdhaXQgZml4ZXMuYXV0aG9yaXplSW9zRml4KCk7XG4gIH1cbn1cbmNoZWNrcy5wdXNoKG5ldyBBdXRob3JpemF0aW9uRGJDaGVjaygpKTtcblxuLy8gQ2hlY2sgZm9yIENhcnRoYWdlIChmb3IgV0RBKVxuY2xhc3MgQ2FydGhhZ2VDaGVjayBleHRlbmRzIERvY3RvckNoZWNrIHtcbiAgYXN5bmMgZGlhZ25vc2UgKCkge1xuICAgIGxldCBjYXJ0aGFnZVBhdGggPSBhd2FpdCBDYXJ0aGFnZURldGVjdG9yLmRldGVjdCgpO1xuICAgIHJldHVybiBjYXJ0aGFnZVBhdGhcbiAgICAgID8gb2soYENhcnRoYWdlIHdhcyBmb3VuZCBhdDogJHtjYXJ0aGFnZVBhdGh9YClcbiAgICAgIDogbm9rKGBDYXJ0aGFnZSB3YXMgTk9UIGZvdW5kIWApO1xuICB9XG5cbiAgYXN5bmMgZml4ICgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gICAgcmV0dXJuICdQbGVhc2UgaW5zdGFsbCBDYXJ0aGFnZS4gVmlzaXQgaHR0cHM6Ly9naXRodWIuY29tL0NhcnRoYWdlJyArXG4gICAgICAgICAgICcvQ2FydGhhZ2UjaW5zdGFsbGluZy1jYXJ0aGFnZSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4nO1xuICB9XG59XG5jaGVja3MucHVzaChuZXcgQ2FydGhhZ2VDaGVjaygpKTtcblxuY2hlY2tzLnB1c2gobmV3IEVudlZhckFuZFBhdGhDaGVjaygnSE9NRScpKTtcblxuZXhwb3J0IHtcbiAgZml4ZXMsIFhjb2RlQ2hlY2ssIFhjb2RlQ21kTGluZVRvb2xzQ2hlY2ssIERldlRvb2xzU2VjdXJpdHlDaGVjayxcbiAgQXV0aG9yaXphdGlvbkRiQ2hlY2ssIENhcnRoYWdlQ2hlY2ssXG59O1xuZXhwb3J0IGRlZmF1bHQgY2hlY2tzO1xuIl0sImZpbGUiOiJsaWIvaW9zLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
