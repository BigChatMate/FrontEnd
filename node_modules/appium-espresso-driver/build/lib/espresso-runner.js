"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.REQUIRED_PARAMS = exports.EspressoRunner = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("./logger"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _package = require("../../package.json");

const TEST_APK_PATH = _path.default.resolve(__dirname, '..', '..', 'espresso-server', 'app', 'build', 'outputs', 'apk', 'androidTest', 'debug', 'app-debug-androidTest.apk');

const TEST_MANIFEST_PATH = _path.default.resolve(__dirname, '..', '..', 'espresso-server', 'AndroidManifest-test.xml');

const TEST_APK_PKG = 'io.appium.espressoserver.test';
const REQUIRED_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort', 'appPackage', 'forceEspressoRebuild'];
exports.REQUIRED_PARAMS = REQUIRED_PARAMS;
const ESPRESSO_SERVER_LAUNCH_TIMEOUT = 30000;
const TARGET_PACKAGE_CONTAINER = '/data/local/tmp/espresso.apppackage';

class EspressoRunner {
  constructor(opts = {}) {
    for (var _i = 0; _i < REQUIRED_PARAMS.length; _i++) {
      let req = REQUIRED_PARAMS[_i];

      if (!opts || !_appiumSupport.util.hasValue(opts[req])) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.host,
      port: this.systemPort,
      base: ''
    });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    this.modServerPath = _path.default.resolve(this.tmpDir, `${TEST_APK_PKG}_${_package.version}_${this.appPackage}.apk`);
    this.serverLaunchTimeout = opts.serverLaunchTimeout || ESPRESSO_SERVER_LAUNCH_TIMEOUT;
  }

  shouldUninstallServer() {
    var _this = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (_this.forceEspressoRebuild || !(yield _this.adb.fileExists(TARGET_PACKAGE_CONTAINER))) {
        return true;
      }

      const tmpRoot = yield _appiumSupport.tempDir.openDir();

      try {
        const dstPath = _path.default.resolve(tmpRoot, _path.default.posix.basename(TARGET_PACKAGE_CONTAINER));

        yield _this.adb.pull(TARGET_PACKAGE_CONTAINER, dstPath);
        const previousAppPackage = yield _appiumSupport.fs.readFile(dstPath, 'utf8');

        _logger.default.debug(`The previous target application package was '${previousAppPackage}'. ` + `The current package is '${_this.appPackage}'.`);

        return previousAppPackage !== _this.appPackage;
      } finally {
        yield _appiumSupport.fs.rimraf(tmpRoot);
      }
    })();
  }

  installServer() {
    var _this2 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      yield _this2.adb.installOrUpgrade(_this2.modServerPath, TEST_APK_PKG);
      const tmpRoot = yield _appiumSupport.tempDir.openDir();

      try {
        const srcPath = _path.default.resolve(tmpRoot, _path.default.posix.basename(TARGET_PACKAGE_CONTAINER));

        yield _appiumSupport.fs.writeFile(srcPath, _this2.appPackage, 'utf8');
        yield _this2.adb.push(srcPath, TARGET_PACKAGE_CONTAINER);

        _logger.default.info(`Recorded the target application package '${_this2.appPackage}' to ${TARGET_PACKAGE_CONTAINER}`);
      } finally {
        yield _appiumSupport.fs.rimraf(tmpRoot);
      }

      _logger.default.info(`Installed Espresso Test Server apk '${_this2.modServerPath}' (pkg: '${TEST_APK_PKG}')`);
    })();
  }

  installTestApk() {
    var _this3 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (_this3.forceEspressoRebuild && (yield _appiumSupport.fs.exists(_this3.modServerPath))) {
        _logger.default.debug(`Capability 'forceEspressoRebuild' on. Deleting file '${_this3.modServerPath}'`);

        yield _appiumSupport.fs.unlink(_this3.modServerPath);
      }

      if (!(yield _appiumSupport.fs.exists(_this3.modServerPath))) {
        yield _this3.buildNewModServer();
      }

      yield _this3.checkAndSignCert(_this3.modServerPath);

      if ((yield _this3.adb.isAppInstalled(TEST_APK_PKG)) && (yield _this3.shouldUninstallServer())) {
        _logger.default.info('Uninstalling the obsolete Espresso server package from the device under test');

        yield _this3.adb.uninstallApk(TEST_APK_PKG);
      }

      yield _this3.installServer();
    })();
  }

  buildNewModServer() {
    var _this4 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _logger.default.info(`Repackaging espresso server for: '${_this4.appPackage}'`);

      const packageTmpDir = _path.default.resolve(_this4.tmpDir, _this4.appPackage);

      const newManifestPath = _path.default.resolve(_this4.tmpDir, 'AndroidManifest.xml');

      yield _appiumSupport.fs.rimraf(newManifestPath);

      _logger.default.info(`Creating new manifest: '${newManifestPath}'`);

      yield (0, _appiumSupport.mkdirp)(packageTmpDir);
      yield _appiumSupport.fs.copyFile(TEST_MANIFEST_PATH, newManifestPath);
      yield _this4.adb.compileManifest(newManifestPath, TEST_APK_PKG, _this4.appPackage);
      yield _this4.adb.insertManifest(newManifestPath, TEST_APK_PATH, _this4.modServerPath);

      _logger.default.info(`Repackaged espresso server ready: '${_this4.modServerPath}'`);
    })();
  }

  checkAndSignCert(apk, apkPackage) {
    var _this5 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let signed = yield _this5.adb.checkApkCert(apk, apkPackage);

      if (!signed) {
        yield _this5.adb.sign(apk);
      }

      return !signed;
    })();
  }

  startSession(caps) {
    var _this6 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      const cmd = ['shell', 'am', 'instrument', '-w', '-e', 'debug', process.env.ESPRESSO_JAVA_DEBUG === 'true' ? 'true' : 'false', `${TEST_APK_PKG}/android.support.test.runner.AndroidJUnitRunner`];

      _logger.default.info(`Starting Espresso Server v${_package.version} with cmd: adb ${cmd.join(' ')}`);

      let hasSocketError = false;
      _this6.instProcess = _this6.adb.createSubProcess(cmd);

      _this6.instProcess.on('exit', (code, signal) => {
        _logger.default.info(`Instrumentation process exited with code ${code} from signal ${signal}`);
      });

      _this6.instProcess.on('die', (code, signal) => {
        _logger.default.error(`Instrumentation process died with code ${code} and signal ${signal}`);
      });

      _this6.instProcess.on('stream-line', line => {
        _logger.default.debug(`[Instrumentation]${line.trim()}`);

        if (line.toLowerCase().includes("java.net.socketexception")) {
          hasSocketError = true;
        }
      });

      yield _this6.instProcess.start((stdout, stderr) => {
        const out = stdout.trim() || stderr.trim();

        if (out.includes('io.appium.espressoserver.EspressoServerRunnerTest:')) {
          return true;
        }

        if (out.toLowerCase().includes('exception')) {
          throw new Error(out);
        }
      }, _this6.serverLaunchTimeout);

      _logger.default.info('Waiting for Espresso to be online...');

      try {
        yield (0, _asyncbox.retryInterval)(20, 1000, (0, _asyncToGenerator2.default)(function* () {
          yield _this6.jwproxy.command('/status', 'GET');
        }));
      } catch (e) {
        if (hasSocketError) {
          _logger.default.errorAndThrow(`Timed out waiting for Espresso Server to start due to Socket exception. Espresso Server requires the 'INTERNET' permission to be set in the Android manifest for the app-under-test (<uses-permission android:name="android.permission.INTERNET" />)`);
        } else {
          _logger.default.errorAndThrow(`Timed out waiting for Espresso Server to start. Original error: ${e.message}`);
        }
      }

      yield _this6.jwproxy.command('/session', 'POST', {
        desiredCapabilities: caps
      });
    })();
  }

  deleteSession() {
    var _this7 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _logger.default.debug('Deleting Espresso server session');

      try {
        yield _this7.jwproxy.command('/', 'DELETE');
      } catch (err) {
        _logger.default.warn(`Did not get confirmation Espresso deleteSession worked; ` + `Error was: ${err}`);
      }

      if (_this7.instProcess && _this7.instProcess.isRunning) {
        yield _this7.instProcess.stop();
      }
    })();
  }

}

exports.EspressoRunner = EspressoRunner;
var _default = EspressoRunner;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9lc3ByZXNzby1ydW5uZXIuanMiXSwibmFtZXMiOlsiVEVTVF9BUEtfUEFUSCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiVEVTVF9NQU5JRkVTVF9QQVRIIiwiVEVTVF9BUEtfUEtHIiwiUkVRVUlSRURfUEFSQU1TIiwiRVNQUkVTU09fU0VSVkVSX0xBVU5DSF9USU1FT1VUIiwiVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSIiwiRXNwcmVzc29SdW5uZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJyZXEiLCJ1dGlsIiwiaGFzVmFsdWUiLCJFcnJvciIsImp3cHJveHkiLCJKV1Byb3h5Iiwic2VydmVyIiwiaG9zdCIsInBvcnQiLCJzeXN0ZW1Qb3J0IiwiYmFzZSIsInByb3h5UmVxUmVzIiwiYmluZCIsIm1vZFNlcnZlclBhdGgiLCJ0bXBEaXIiLCJ2ZXJzaW9uIiwiYXBwUGFja2FnZSIsInNlcnZlckxhdW5jaFRpbWVvdXQiLCJzaG91bGRVbmluc3RhbGxTZXJ2ZXIiLCJmb3JjZUVzcHJlc3NvUmVidWlsZCIsImFkYiIsImZpbGVFeGlzdHMiLCJ0bXBSb290IiwidGVtcERpciIsIm9wZW5EaXIiLCJkc3RQYXRoIiwicG9zaXgiLCJiYXNlbmFtZSIsInB1bGwiLCJwcmV2aW91c0FwcFBhY2thZ2UiLCJmcyIsInJlYWRGaWxlIiwibG9nZ2VyIiwiZGVidWciLCJyaW1yYWYiLCJpbnN0YWxsU2VydmVyIiwiaW5zdGFsbE9yVXBncmFkZSIsInNyY1BhdGgiLCJ3cml0ZUZpbGUiLCJwdXNoIiwiaW5mbyIsImluc3RhbGxUZXN0QXBrIiwiZXhpc3RzIiwidW5saW5rIiwiYnVpbGROZXdNb2RTZXJ2ZXIiLCJjaGVja0FuZFNpZ25DZXJ0IiwiaXNBcHBJbnN0YWxsZWQiLCJ1bmluc3RhbGxBcGsiLCJwYWNrYWdlVG1wRGlyIiwibmV3TWFuaWZlc3RQYXRoIiwiY29weUZpbGUiLCJjb21waWxlTWFuaWZlc3QiLCJpbnNlcnRNYW5pZmVzdCIsImFwayIsImFwa1BhY2thZ2UiLCJzaWduZWQiLCJjaGVja0Fwa0NlcnQiLCJzaWduIiwic3RhcnRTZXNzaW9uIiwiY2FwcyIsImNtZCIsInByb2Nlc3MiLCJlbnYiLCJFU1BSRVNTT19KQVZBX0RFQlVHIiwiam9pbiIsImhhc1NvY2tldEVycm9yIiwiaW5zdFByb2Nlc3MiLCJjcmVhdGVTdWJQcm9jZXNzIiwib24iLCJjb2RlIiwic2lnbmFsIiwiZXJyb3IiLCJsaW5lIiwidHJpbSIsInRvTG93ZXJDYXNlIiwiaW5jbHVkZXMiLCJzdGFydCIsInN0ZG91dCIsInN0ZGVyciIsIm91dCIsImNvbW1hbmQiLCJlIiwiZXJyb3JBbmRUaHJvdyIsIm1lc3NhZ2UiLCJkZXNpcmVkQ2FwYWJpbGl0aWVzIiwiZGVsZXRlU2Vzc2lvbiIsImVyciIsIndhcm4iLCJpc1J1bm5pbmciLCJzdG9wIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLGFBQWEsR0FBR0MsY0FBS0MsT0FBTCxDQUFhQyxTQUFiLEVBQXdCLElBQXhCLEVBQThCLElBQTlCLEVBQW9DLGlCQUFwQyxFQUF1RCxLQUF2RCxFQUE4RCxPQUE5RCxFQUF1RSxTQUF2RSxFQUFrRixLQUFsRixFQUF5RixhQUF6RixFQUF3RyxPQUF4RyxFQUFpSCwyQkFBakgsQ0FBdEI7O0FBQ0EsTUFBTUMsa0JBQWtCLEdBQUdILGNBQUtDLE9BQUwsQ0FBYUMsU0FBYixFQUF3QixJQUF4QixFQUE4QixJQUE5QixFQUFvQyxpQkFBcEMsRUFBdUQsMEJBQXZELENBQTNCOztBQUNBLE1BQU1FLFlBQVksR0FBRywrQkFBckI7QUFDQSxNQUFNQyxlQUFlLEdBQUcsQ0FBQyxLQUFELEVBQVEsUUFBUixFQUFrQixNQUFsQixFQUEwQixZQUExQixFQUF3QyxZQUF4QyxFQUFzRCxZQUF0RCxFQUFvRSxzQkFBcEUsQ0FBeEI7O0FBQ0EsTUFBTUMsOEJBQThCLEdBQUcsS0FBdkM7QUFDQSxNQUFNQyx3QkFBd0IsR0FB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TixHQUF1QjtBQUFBOztBQUFBO0FBQ3JCckQsc0JBQU9DLEtBQVAsQ0FBYSxrQ0FBYjs7QUFHQSxVQUFJO0FBQ0YsY0FBTSxNQUFJLENBQUM3QixPQUFMLENBQWE0RSxPQUFiLENBQXFCLEdBQXJCLEVBQTBCLFFBQTFCLENBQU47QUFDRCxPQUZELENBRUUsT0FBT00sR0FBUCxFQUFZO0FBQ1p0RCx3QkFBT3VELElBQVAsQ0FBYSwwREFBRCxHQUNQLGNBQWFELEdBQUksRUFEdEI7QUFFRDs7QUFFRCxVQUFJLE1BQUksQ0FBQ3BCLFdBQUwsSUFBb0IsTUFBSSxDQUFDQSxXQUFMLENBQWlCc0IsU0FBekMsRUFBb0Q7QUFDbEQsY0FBTSxNQUFJLENBQUN0QixXQUFMLENBQWlCdUIsSUFBakIsRUFBTjtBQUNEO0FBYm9CO0FBY3RCOztBQXZLa0I7OztlQTJLTjVGLGMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBKV1Byb3h5IH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZnMsIHV0aWwsIG1rZGlycCwgdGVtcERpciB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IHZlcnNpb24gfSBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGltcG9ydC9uby11bnJlc29sdmVkXG5cblxuY29uc3QgVEVTVF9BUEtfUEFUSCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdlc3ByZXNzby1zZXJ2ZXInLCAnYXBwJywgJ2J1aWxkJywgJ291dHB1dHMnLCAnYXBrJywgJ2FuZHJvaWRUZXN0JywgJ2RlYnVnJywgJ2FwcC1kZWJ1Zy1hbmRyb2lkVGVzdC5hcGsnKTtcbmNvbnN0IFRFU1RfTUFOSUZFU1RfUEFUSCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdlc3ByZXNzby1zZXJ2ZXInLCAnQW5kcm9pZE1hbmlmZXN0LXRlc3QueG1sJyk7XG5jb25zdCBURVNUX0FQS19QS0cgPSAnaW8uYXBwaXVtLmVzcHJlc3Nvc2VydmVyLnRlc3QnO1xuY29uc3QgUkVRVUlSRURfUEFSQU1TID0gWydhZGInLCAndG1wRGlyJywgJ2hvc3QnLCAnc3lzdGVtUG9ydCcsICdkZXZpY2VQb3J0JywgJ2FwcFBhY2thZ2UnLCAnZm9yY2VFc3ByZXNzb1JlYnVpbGQnXTtcbmNvbnN0IEVTUFJFU1NPX1NFUlZFUl9MQVVOQ0hfVElNRU9VVCA9IDMwMDAwO1xuY29uc3QgVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSID0gJy9kYXRhL2xvY2FsL3RtcC9lc3ByZXNzby5hcHBwYWNrYWdlJztcblxuY2xhc3MgRXNwcmVzc29SdW5uZXIge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgZm9yIChsZXQgcmVxIG9mIFJFUVVJUkVEX1BBUkFNUykge1xuICAgICAgaWYgKCFvcHRzIHx8ICF1dGlsLmhhc1ZhbHVlKG9wdHNbcmVxXSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPcHRpb24gJyR7cmVxfScgaXMgcmVxdWlyZWQhYCk7XG4gICAgICB9XG4gICAgICB0aGlzW3JlcV0gPSBvcHRzW3JlcV07XG4gICAgfVxuICAgIHRoaXMuandwcm94eSA9IG5ldyBKV1Byb3h5KHtzZXJ2ZXI6IHRoaXMuaG9zdCwgcG9ydDogdGhpcy5zeXN0ZW1Qb3J0LCBiYXNlOiAnJ30pO1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xuXG4gICAgdGhpcy5tb2RTZXJ2ZXJQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCBgJHtURVNUX0FQS19QS0d9XyR7dmVyc2lvbn1fJHt0aGlzLmFwcFBhY2thZ2V9LmFwa2ApO1xuXG4gICAgdGhpcy5zZXJ2ZXJMYXVuY2hUaW1lb3V0ID0gb3B0cy5zZXJ2ZXJMYXVuY2hUaW1lb3V0IHx8IEVTUFJFU1NPX1NFUlZFUl9MQVVOQ0hfVElNRU9VVDtcbiAgfVxuXG4gIGFzeW5jIHNob3VsZFVuaW5zdGFsbFNlcnZlciAoKSB7XG4gICAgaWYgKHRoaXMuZm9yY2VFc3ByZXNzb1JlYnVpbGQgfHwgIWF3YWl0IHRoaXMuYWRiLmZpbGVFeGlzdHMoVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgY29uc3QgdG1wUm9vdCA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBkc3RQYXRoID0gcGF0aC5yZXNvbHZlKHRtcFJvb3QsIHBhdGgucG9zaXguYmFzZW5hbWUoVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSKSk7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5wdWxsKFRBUkdFVF9QQUNLQUdFX0NPTlRBSU5FUiwgZHN0UGF0aCk7XG4gICAgICBjb25zdCBwcmV2aW91c0FwcFBhY2thZ2UgPSBhd2FpdCBmcy5yZWFkRmlsZShkc3RQYXRoLCAndXRmOCcpO1xuICAgICAgbG9nZ2VyLmRlYnVnKGBUaGUgcHJldmlvdXMgdGFyZ2V0IGFwcGxpY2F0aW9uIHBhY2thZ2Ugd2FzICcke3ByZXZpb3VzQXBwUGFja2FnZX0nLiBgICtcbiAgICAgICAgYFRoZSBjdXJyZW50IHBhY2thZ2UgaXMgJyR7dGhpcy5hcHBQYWNrYWdlfScuYCk7XG4gICAgICByZXR1cm4gcHJldmlvdXNBcHBQYWNrYWdlICE9PSB0aGlzLmFwcFBhY2thZ2U7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGF3YWl0IGZzLnJpbXJhZih0bXBSb290KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBpbnN0YWxsU2VydmVyICgpIHtcbiAgICBhd2FpdCB0aGlzLmFkYi5pbnN0YWxsT3JVcGdyYWRlKHRoaXMubW9kU2VydmVyUGF0aCwgVEVTVF9BUEtfUEtHKTtcblxuICAgIGNvbnN0IHRtcFJvb3QgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc3JjUGF0aCA9IHBhdGgucmVzb2x2ZSh0bXBSb290LCBwYXRoLnBvc2l4LmJhc2VuYW1lKFRBUkdFVF9QQUNLQUdFX0NPTlRBSU5FUikpO1xuICAgICAgYXdhaXQgZnMud3JpdGVGaWxlKHNyY1BhdGgsIHRoaXMuYXBwUGFja2FnZSwgJ3V0ZjgnKTtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnB1c2goc3JjUGF0aCwgVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSKTtcbiAgICAgIGxvZ2dlci5pbmZvKGBSZWNvcmRlZCB0aGUgdGFyZ2V0IGFwcGxpY2F0aW9uIHBhY2thZ2UgJyR7dGhpcy5hcHBQYWNrYWdlfScgdG8gJHtUQVJHRVRfUEFDS0FHRV9DT05UQUlORVJ9YCk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGF3YWl0IGZzLnJpbXJhZih0bXBSb290KTtcbiAgICB9XG4gICAgbG9nZ2VyLmluZm8oYEluc3RhbGxlZCBFc3ByZXNzbyBUZXN0IFNlcnZlciBhcGsgJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofScgKHBrZzogJyR7VEVTVF9BUEtfUEtHfScpYCk7XG4gIH1cblxuICBhc3luYyBpbnN0YWxsVGVzdEFwayAoKSB7XG4gICAgaWYgKHRoaXMuZm9yY2VFc3ByZXNzb1JlYnVpbGQgJiYgYXdhaXQgZnMuZXhpc3RzKHRoaXMubW9kU2VydmVyUGF0aCkpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgQ2FwYWJpbGl0eSAnZm9yY2VFc3ByZXNzb1JlYnVpbGQnIG9uLiBEZWxldGluZyBmaWxlICcke3RoaXMubW9kU2VydmVyUGF0aH0nYCk7XG4gICAgICBhd2FpdCBmcy51bmxpbmsodGhpcy5tb2RTZXJ2ZXJQYXRoKTtcbiAgICB9XG5cbiAgICBpZiAoIShhd2FpdCBmcy5leGlzdHModGhpcy5tb2RTZXJ2ZXJQYXRoKSkpIHtcbiAgICAgIGF3YWl0IHRoaXMuYnVpbGROZXdNb2RTZXJ2ZXIoKTtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy5jaGVja0FuZFNpZ25DZXJ0KHRoaXMubW9kU2VydmVyUGF0aCk7XG4gICAgaWYgKGF3YWl0IHRoaXMuYWRiLmlzQXBwSW5zdGFsbGVkKFRFU1RfQVBLX1BLRykgJiYgYXdhaXQgdGhpcy5zaG91bGRVbmluc3RhbGxTZXJ2ZXIoKSkge1xuICAgICAgbG9nZ2VyLmluZm8oJ1VuaW5zdGFsbGluZyB0aGUgb2Jzb2xldGUgRXNwcmVzc28gc2VydmVyIHBhY2thZ2UgZnJvbSB0aGUgZGV2aWNlIHVuZGVyIHRlc3QnKTtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnVuaW5zdGFsbEFwayhURVNUX0FQS19QS0cpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuaW5zdGFsbFNlcnZlcigpO1xuICB9XG5cbiAgYXN5bmMgYnVpbGROZXdNb2RTZXJ2ZXIgKCkge1xuICAgIGxvZ2dlci5pbmZvKGBSZXBhY2thZ2luZyBlc3ByZXNzbyBzZXJ2ZXIgZm9yOiAnJHt0aGlzLmFwcFBhY2thZ2V9J2ApO1xuICAgIGNvbnN0IHBhY2thZ2VUbXBEaXIgPSBwYXRoLnJlc29sdmUodGhpcy50bXBEaXIsIHRoaXMuYXBwUGFja2FnZSk7XG4gICAgY29uc3QgbmV3TWFuaWZlc3RQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCAnQW5kcm9pZE1hbmlmZXN0LnhtbCcpO1xuICAgIGF3YWl0IGZzLnJpbXJhZihuZXdNYW5pZmVzdFBhdGgpO1xuXG4gICAgbG9nZ2VyLmluZm8oYENyZWF0aW5nIG5ldyBtYW5pZmVzdDogJyR7bmV3TWFuaWZlc3RQYXRofSdgKTtcbiAgICBhd2FpdCBta2RpcnAocGFja2FnZVRtcERpcik7XG4gICAgYXdhaXQgZnMuY29weUZpbGUoVEVTVF9NQU5JRkVTVF9QQVRILCBuZXdNYW5pZmVzdFBhdGgpO1xuICAgIGF3YWl0IHRoaXMuYWRiLmNvbXBpbGVNYW5pZmVzdChuZXdNYW5pZmVzdFBhdGgsIFRFU1RfQVBLX1BLRywgdGhpcy5hcHBQYWNrYWdlKTsgLy8gY3JlYXRlcyBhIGZpbGUgYCR7bmV3TWFuaWZlc3RQYXRofS5hcGtgXG4gICAgYXdhaXQgdGhpcy5hZGIuaW5zZXJ0TWFuaWZlc3QobmV3TWFuaWZlc3RQYXRoLCBURVNUX0FQS19QQVRILCB0aGlzLm1vZFNlcnZlclBhdGgpOyAvLyBjb3BpZXMgZnJvbSBzZWNvbmQgdG8gdGhpcmQgYW5kIGFkZCBtYW5pZmVzdFxuICAgIGxvZ2dlci5pbmZvKGBSZXBhY2thZ2VkIGVzcHJlc3NvIHNlcnZlciByZWFkeTogJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofSdgKTtcbiAgfVxuXG4gIC8vIFRPRE8gZHVwbGljYXRlZCBmcm9tIHVpYXV0b21hdG9yMiwgc2hvdWxkIGJlIGEgbGliIG1ldGhvZFxuICBhc3luYyBjaGVja0FuZFNpZ25DZXJ0IChhcGssIGFwa1BhY2thZ2UpIHtcbiAgICBsZXQgc2lnbmVkID0gYXdhaXQgdGhpcy5hZGIuY2hlY2tBcGtDZXJ0KGFwaywgYXBrUGFja2FnZSk7XG4gICAgaWYgKCFzaWduZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnNpZ24oYXBrKTtcbiAgICB9XG4gICAgcmV0dXJuICFzaWduZWQ7XG4gIH1cblxuICBhc3luYyBzdGFydFNlc3Npb24gKGNhcHMpIHtcbiAgICBjb25zdCBjbWQgPSBbXG4gICAgICAnc2hlbGwnLFxuICAgICAgJ2FtJywgJ2luc3RydW1lbnQnLFxuICAgICAgJy13JyxcbiAgICAgICctZScsICdkZWJ1ZycsIHByb2Nlc3MuZW52LkVTUFJFU1NPX0pBVkFfREVCVUcgPT09ICd0cnVlJyA/ICd0cnVlJyA6ICdmYWxzZScsXG4gICAgICBgJHtURVNUX0FQS19QS0d9L2FuZHJvaWQuc3VwcG9ydC50ZXN0LnJ1bm5lci5BbmRyb2lkSlVuaXRSdW5uZXJgLFxuICAgIF07XG5cbiAgICBsb2dnZXIuaW5mbyhgU3RhcnRpbmcgRXNwcmVzc28gU2VydmVyIHYke3ZlcnNpb259IHdpdGggY21kOiBhZGIgJHtjbWQuam9pbignICcpfWApO1xuXG4gICAgbGV0IGhhc1NvY2tldEVycm9yID0gZmFsc2U7XG5cbiAgICAvLyBzdGFydCB0aGUgaW5zdHJ1bWVudGF0aW9uIHByb2Nlc3NcbiAgICB0aGlzLmluc3RQcm9jZXNzID0gdGhpcy5hZGIuY3JlYXRlU3ViUHJvY2VzcyhjbWQpO1xuICAgIHRoaXMuaW5zdFByb2Nlc3Mub24oJ2V4aXQnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICBsb2dnZXIuaW5mbyhgSW5zdHJ1bWVudGF0aW9uIHByb2Nlc3MgZXhpdGVkIHdpdGggY29kZSAke2NvZGV9IGZyb20gc2lnbmFsICR7c2lnbmFsfWApO1xuICAgIH0pO1xuICAgIHRoaXMuaW5zdFByb2Nlc3Mub24oJ2RpZScsIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgIGxvZ2dlci5lcnJvcihgSW5zdHJ1bWVudGF0aW9uIHByb2Nlc3MgZGllZCB3aXRoIGNvZGUgJHtjb2RlfSBhbmQgc2lnbmFsICR7c2lnbmFsfWApO1xuICAgIH0pO1xuICAgIHRoaXMuaW5zdFByb2Nlc3Mub24oJ3N0cmVhbS1saW5lJywgbGluZSA9PiB7XG4gICAgICBsb2dnZXIuZGVidWcoYFtJbnN0cnVtZW50YXRpb25dJHtsaW5lLnRyaW0oKX1gKTtcblxuICAgICAgLy8gQSAnU29ja2V0RXhjZXB0aW9uJyBpbmRpY2F0ZXMgdGhhdCB3ZSBjb3VsZG4ndCBjb25uZWN0IHRvIHRoZSBFc3ByZXNzbyBTZXJ2ZXIsIGJlY2F1c2UgdGhlIElOVEVSTkVUIHBlcm1pc3Npb24gaXMgbm90IHNldFxuICAgICAgaWYgKGxpbmUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhcImphdmEubmV0LnNvY2tldGV4Y2VwdGlvblwiKSkge1xuICAgICAgICBoYXNTb2NrZXRFcnJvciA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBhd2FpdCB0aGlzLmluc3RQcm9jZXNzLnN0YXJ0KChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgLy8gZm9yIGFueSBjYWxsIHRvIHRoZSBzdGFydCBkZXRlY3Rvciwgb25lIG9mIHN0ZG91dCBvciBzdGRlcnIgd2lsbCBoYXZlXG4gICAgICAvLyBjb250ZW50LCBzbyBtZXJnZSBmb3IgY2hlY2tzIGhlcmVcbiAgICAgIGNvbnN0IG91dCA9IHN0ZG91dC50cmltKCkgfHwgc3RkZXJyLnRyaW0oKTtcblxuICAgICAgLy8gYWRiIGFsd2F5cyBwcmludHMgdGhpcyBvdXQgb24gc3VjY2Vzcy4gSWYgdGhpcyBpcyBmb3VuZCBub3QgdG8gYmUgdGhlXG4gICAgICAvLyBjYXNlLCBhZGQgb3RoZXIgY29uZGl0aW9uc1xuICAgICAgaWYgKG91dC5pbmNsdWRlcygnaW8uYXBwaXVtLmVzcHJlc3Nvc2VydmVyLkVzcHJlc3NvU2VydmVyUnVubmVyVGVzdDonKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGlmIChvdXQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnZXhjZXB0aW9uJykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKG91dCk7XG4gICAgICB9XG4gICAgfSwgdGhpcy5zZXJ2ZXJMYXVuY2hUaW1lb3V0KTtcblxuICAgIGxvZ2dlci5pbmZvKCdXYWl0aW5nIGZvciBFc3ByZXNzbyB0byBiZSBvbmxpbmUuLi4nKTtcblxuICAgIC8vIHdhaXQgMjBzIGZvciBlc3ByZXNzbyB0byBiZSBvbmxpbmVcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcmV0cnlJbnRlcnZhbCgyMCwgMTAwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChoYXNTb2NrZXRFcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgVGltZWQgb3V0IHdhaXRpbmcgZm9yIEVzcHJlc3NvIFNlcnZlciB0byBzdGFydCBkdWUgdG8gU29ja2V0IGV4Y2VwdGlvbi4gRXNwcmVzc28gU2VydmVyIHJlcXVpcmVzIHRoZSAnSU5URVJORVQnIHBlcm1pc3Npb24gdG8gYmUgc2V0IGluIHRoZSBBbmRyb2lkIG1hbmlmZXN0IGZvciB0aGUgYXBwLXVuZGVyLXRlc3QgKDx1c2VzLXBlcm1pc3Npb24gYW5kcm9pZDpuYW1lPVwiYW5kcm9pZC5wZXJtaXNzaW9uLklOVEVSTkVUXCIgLz4pYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgVGltZWQgb3V0IHdhaXRpbmcgZm9yIEVzcHJlc3NvIFNlcnZlciB0byBzdGFydC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywge2Rlc2lyZWRDYXBhYmlsaXRpZXM6IGNhcHN9KTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnRGVsZXRpbmcgRXNwcmVzc28gc2VydmVyIHNlc3Npb24nKTtcbiAgICAvLyByZWx5IG9uIGp3cHJveHkncyBpbnRlbGxpZ2VuY2UgdG8ga25vdyB3aGF0IHdlJ3JlIHRhbGtpbmcgYWJvdXQgYW5kXG4gICAgLy8gZGVsZXRlIHRoZSBjdXJyZW50IHNlc3Npb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy8nLCAnREVMRVRFJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIud2FybihgRGlkIG5vdCBnZXQgY29uZmlybWF0aW9uIEVzcHJlc3NvIGRlbGV0ZVNlc3Npb24gd29ya2VkOyBgICtcbiAgICAgICAgICBgRXJyb3Igd2FzOiAke2Vycn1gKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pbnN0UHJvY2VzcyAmJiB0aGlzLmluc3RQcm9jZXNzLmlzUnVubmluZykge1xuICAgICAgYXdhaXQgdGhpcy5pbnN0UHJvY2Vzcy5zdG9wKCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCB7IEVzcHJlc3NvUnVubmVyLCBSRVFVSVJFRF9QQVJBTVMgfTtcbmV4cG9ydCBkZWZhdWx0IEVzcHJlc3NvUnVubmVyO1xuIl0sImZpbGUiOiJsaWIvZXNwcmVzc28tcnVubmVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
