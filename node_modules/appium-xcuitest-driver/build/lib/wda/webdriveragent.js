"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.BOOTSTRAP_PATH = exports.WDA_BUNDLE_ID = exports.WebDriverAgent = exports.default = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _url2 = _interopRequireDefault(require("url"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _noSessionProxy = require("./no-session-proxy");

var _utils = require("./utils");

var _utils2 = require("../utils");

var _xcodebuild = _interopRequireDefault(require("./xcodebuild"));

var _iproxy = _interopRequireDefault(require("./iproxy"));

var _teen_process = require("teen_process");

const BOOTSTRAP_PATH = _path.default.resolve(__dirname, '..', '..', '..', 'WebDriverAgent');

exports.BOOTSTRAP_PATH = BOOTSTRAP_PATH;
const WDA_BUNDLE_ID = 'com.apple.test.WebDriverAgentRunner-Runner';
exports.WDA_BUNDLE_ID = WDA_BUNDLE_ID;
const WDA_LAUNCH_TIMEOUT = 60 * 1000;
const WDA_AGENT_PORT = 8100;
const WDA_BASE_URL = 'http://localhost';

class WebDriverAgent {
  constructor(xcodeVersion, args = {}) {
    this.xcodeVersion = xcodeVersion;
    this.args = _lodash.default.clone(args);
    this.device = args.device;
    this.platformVersion = args.platformVersion;
    this.host = args.host;
    this.realDevice = !!args.realDevice;
    this.setWDAPaths(args.bootstrapPath, args.agentPath);
    this.wdaLocalPort = args.wdaLocalPort;
    this.prebuildWDA = args.prebuildWDA;
    this.webDriverAgentUrl = args.webDriverAgentUrl;
    this.started = false;
    this.wdaConnectionTimeout = args.wdaConnectionTimeout;
    this.useCarthageSsl = _lodash.default.isBoolean(args.useCarthageSsl) && args.useCarthageSsl;
    this.useXctestrunFile = args.useXctestrunFile;
    this.xcodebuild = new _xcodebuild.default(this.xcodeVersion, this.device, {
      platformVersion: this.platformVersion,
      agentPath: this.agentPath,
      bootstrapPath: this.bootstrapPath,
      realDevice: this.realDevice,
      showXcodeLog: !!args.showXcodeLog,
      xcodeConfigFile: args.xcodeConfigFile,
      xcodeOrgId: args.xcodeOrgId,
      xcodeSigningId: args.xcodeSigningId,
      keychainPath: args.keychainPath,
      keychainPassword: args.keychainPassword,
      useSimpleBuildTest: args.useSimpleBuildTest,
      usePrebuiltWDA: args.usePrebuiltWDA,
      updatedWDABundleId: args.updatedWDABundleId,
      launchTimeout: args.wdaLaunchTimeout || WDA_LAUNCH_TIMEOUT,
      wdaRemotePort: this.realDevice ? WDA_AGENT_PORT : this.wdaLocalPort || WDA_AGENT_PORT,
      useXctestrunFile: this.useXctestrunFile,
      derivedDataPath: args.derivedDataPath,
      mjpegServerPort: args.mjpegServerPort
    });
  }

  setWDAPaths(bootstrapPath, agentPath) {
    this.bootstrapPath = bootstrapPath || BOOTSTRAP_PATH;

    _logger.default.info(`Using WDA path: '${this.bootstrapPath}'`);

    this.agentPath = agentPath || _path.default.resolve(this.bootstrapPath, 'WebDriverAgent.xcodeproj');

    _logger.default.info(`Using WDA agent: '${this.agentPath}'`);
  }

  cleanupObsoleteProcesses() {
    var _this = this;

    return (0, _asyncToGenerator2.default)(function* () {
      const pids = yield (0, _utils2.getPIDsListeningOnPort)(_this.url.port, cmdLine => (cmdLine.includes('/WebDriverAgentRunner') || cmdLine.includes('/iproxy')) && !cmdLine.toLowerCase().includes(_this.device.udid.toLowerCase()));

      if (!pids.length) {
        _logger.default.debug(`No obsolete cached processes from previous WDA sessions ` + `listening on port ${_this.url.port} have been found`);

        return;
      }

      _logger.default.info(`Detected ${pids.length} obsolete cached process${pids.length === 1 ? '' : 'es'} ` + `from previous WDA sessions. Cleaning up...`);

      try {
        yield (0, _teen_process.exec)('kill', pids);
      } catch (e) {
        _logger.default.warn(`Failed to kill obsolete cached process${pids.length === 1 ? '' : 'es'} '${pids}'. ` + `Original error: ${e.message}`);
      }
    })();
  }

  isRunning() {
    var _this2 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      return !!(yield _this2.getStatus());
    })();
  }

  getStatus() {
    var _this3 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      const noSessionProxy = new _noSessionProxy.NoSessionProxy({
        server: _this3.url.hostname,
        port: _this3.url.port,
        base: '',
        timeout: 3000
      });

      try {
        return yield noSessionProxy.command('/status', 'GET');
      } catch (err) {
        _logger.default.debug(`WDA is not listening at '${_this3.url.href}'`);

        return null;
      }
    })();
  }

  uninstall() {
    var _this4 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _logger.default.debug(`Removing WDA application from device`);

      try {
        yield _this4.device.removeApp(WDA_BUNDLE_ID);
      } catch (e) {
        _logger.default.warn(`WebDriverAgent uninstall failed. Perhaps, it is already uninstalled? Original error: ${JSON.stringify(e)}`);
      }
    })();
  }

  launch(sessionId) {
    var _this5 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (_this5.webDriverAgentUrl) {
        _logger.default.info(`Using provided WebdriverAgent at '${_this5.webDriverAgentUrl}'`);

        _this5.url = _this5.webDriverAgentUrl;

        _this5.setupProxies(sessionId);

        return;
      }

      _logger.default.info('Launching WebDriverAgent on the device');

      _this5.setupProxies(sessionId);

      if (!_this5.useXctestrunFile && !(yield _appiumSupport.fs.exists(_this5.agentPath))) {
        throw new Error(`Trying to use WebDriverAgent project at '${_this5.agentPath}' but the ` + 'file does not exist');
      }

      if (!_this5.useXctestrunFile) {
        const didPerformUpgrade = yield (0, _utils.checkForDependencies)(_this5.bootstrapPath, _this5.useCarthageSsl);

        if (didPerformUpgrade) {
          yield _this5.xcodebuild.cleanProject();
        }
      }

      yield (0, _utils2.resetXCTestProcesses)(_this5.device.udid, !_this5.realDevice, {
        wdaLocalPort: _this5.url.port
      });

      if (_this5.realDevice) {
        _this5.iproxy = new _iproxy.default(_this5.device.udid, _this5.url.port, WDA_AGENT_PORT);
        yield _this5.iproxy.start();
      }

      yield _this5.xcodebuild.init(_this5.noSessionProxy);

      if (_this5.prebuildWDA) {
        yield _this5.xcodebuild.prebuild();
      }

      return yield _this5.xcodebuild.start();
    })();
  }

  setupProxies(sessionId) {
    const proxyOpts = {
      server: this.url.hostname,
      port: this.url.port,
      base: '',
      timeout: this.wdaConnectionTimeout
    };
    this.jwproxy = new _appiumBaseDriver.JWProxy(proxyOpts);
    this.jwproxy.sessionId = sessionId;
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    this.noSessionProxy = new _noSessionProxy.NoSessionProxy(proxyOpts);
    this.noSessionProxyReqRes = this.noSessionProxy.proxyReqRes.bind(this.noSessionProxy);
  }

  quit() {
    var _this6 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _logger.default.info('Shutting down sub-processes');

      if (_this6.iproxy) {
        yield _this6.iproxy.quit();
      }

      yield _this6.xcodebuild.quit();
      yield _this6.xcodebuild.reset();

      if (_this6.jwproxy) {
        _this6.jwproxy.sessionId = null;
      }

      _this6.started = false;

      if (!_this6.args.webDriverAgentUrl) {
        _this6.webDriverAgentUrl = null;
      }
    })();
  }

  get url() {
    if (!this._url) {
      let port = this.wdaLocalPort || WDA_AGENT_PORT;
      this._url = _url2.default.parse(`${WDA_BASE_URL}:${port}`);
    }

    return this._url;
  }

  set url(_url) {
    this._url = _url2.default.parse(_url);
  }

  get fullyStarted() {
    return this.started;
  }

  set fullyStarted(started = false) {
    this.started = started;

    if (this.iproxy) {
      this.iproxy.expectIProxyErrors = !started;
    }
  }

  retrieveDerivedDataPath() {
    var _this7 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      return yield _this7.xcodebuild.retrieveDerivedDataPath();
    })();
  }

  setupCaching(updatedWDABundleId) {
    var _this8 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      const status = yield _this8.getStatus();

      if (!status || !status.build) {
        _logger.default.debug('WDA is currently not running. There is nothing to cache');

        return;
      }

      const _status$build = status.build,
            productBundleIdentifier = _status$build.productBundleIdentifier,
            upgradedAt = _status$build.upgradedAt;

      if (_appiumSupport.util.hasValue(productBundleIdentifier) && _appiumSupport.util.hasValue(updatedWDABundleId) && updatedWDABundleId !== productBundleIdentifier) {
        _logger.default.info(`Will uninstall running WDA since it has different bundle id. The actual value is '${productBundleIdentifier}'.`);

        return yield _this8.uninstall();
      }

      if (_appiumSupport.util.hasValue(productBundleIdentifier) && !_appiumSupport.util.hasValue(updatedWDABundleId) && _utils.WDA_RUNNER_BUNDLE_ID !== productBundleIdentifier) {
        _logger.default.info(`Will uninstall running WDA since its bundle id is not equal to the default value ${_utils.WDA_RUNNER_BUNDLE_ID}`);

        return yield _this8.uninstall();
      }

      const actualUpgradeTimestamp = yield (0, _utils.getWDAUpgradeTimestamp)(_this8.bootstrapPath);

      _logger.default.debug(`Upgrade timestamp of the currently bundled WDA: ${actualUpgradeTimestamp}`);

      _logger.default.debug(`Upgrade timestamp of the WDA on the device: ${upgradedAt}`);

      if (actualUpgradeTimestamp && upgradedAt && _lodash.default.toLower(`${actualUpgradeTimestamp}`) !== _lodash.default.toLower(`${upgradedAt}`)) {
        _logger.default.info('Will uninstall running WDA since it has different version in comparison to the one ' + `which is bundled with appium-xcuitest-driver module (${actualUpgradeTimestamp} != ${upgradedAt})`);

        return yield _this8.uninstall();
      }

      const message = _appiumSupport.util.hasValue(productBundleIdentifier) ? `Will reuse previously cached WDA instance at '${_this8.url.href}' with '${productBundleIdentifier}'` : `Will reuse previously cached WDA instance at '${_this8.url.href}'`;

      _logger.default.info(`${message}. Set the wdaLocalPort capability to a value different from ${_this8.url.port} if this is an undesired behavior.`);

      _this8.webDriverAgentUrl = _this8.url.href;
    })();
  }

  quitAndUninstall() {
    var _this9 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      yield _this9.quit();
      yield _this9.uninstall();
    })();
  }

}

exports.WebDriverAgent = WebDriverAgent;
var _default = WebDriverAgent;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZGEvd2ViZHJpdmVyYWdlbnQuanMiXSwibmFtZXMiOlsiQk9PVFNUUkFQX1BBVEgiLCJwYXRoIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsIldEQV9CVU5ETEVfSUQiLCJXREFfTEFVTkNIX1RJTUVPVVQiLCJXREFfQUdFTlRfUE9SVCIsIldEQV9CQVNFX1VSTCIsIldlYkRyaXZlckFnZW50IiwiY29uc3RydWN0b3IiLCJ4Y29kZVZlcnNpb24iLCJhcmdzIiwiXyIsImNsb25lIiwiZGV2aWNlIiwicGxhdGZvcm1WZXJzaW9uIiwiaG9zdCIsInJlYWxEZXZpY2UiLCJzZXRXREFQYXRocyIsImJvb3RzdHJhcFBhdGgiLCJhZ2VudFBhdGgiLCJ3ZGFMb2NhbFBvcnQiLCJwcmVidWlsZFdEQSIsIndlYkRyaXZlckFnZW50VXJsIiwic3RhcnRlZCIsIndkYUNvbm5lY3Rpb25UaW1lb3V0IiwidXNlQ2FydGhhZ2VTc2wiLCJpc0Jvb2xlYW4iLCJ1c2VYY3Rlc3RydW5GaWxlIiwieGNvZGVidWlsZCIsIlhjb2RlQnVpbGQiLCJzaG93WGNvZGVMb2ciLCJ4Y29kZUNvbmZpZ0ZpbGUiLCJ4Y29kZU9yZ0lkIiwieGNvZGVTaWduaW5nSWQiLCJrZXljaGFpblBhdGgiLCJrZXljaGFpblBhc3N3b3JkIiwidXNlU2ltcGxlQnVpbGRUZXN0IiwidXNlUHJlYnVpbHRXREEiLCJ1cGRhdGVkV0RBQnVuZGxlSWQiLCJsYXVuY2hUaW1lb3V0Iiwid2RhTGF1bmNoVGltZW91dCIsIndkYVJlbW90ZVBvcnQiLCJkZXJpdmVkRGF0YVBhdGgiLCJtanBlZ1NlcnZlclBvcnQiLCJsb2ciLCJpbmZvIiwiY2xlYW51cE9ic29sZXRlUHJvY2Vzc2VzIiwicGlkcyIsInVybCIsInBvcnQiLCJjbWRMaW5lIiwiaW5jbHVkZXMiLCJ0b0xvd2VyQ2FzZSIsInVkaWQiLCJsZW5ndGgiLCJkZWJ1ZyIsImUiLCJ3YXJuIiwibWVzc2FnZSIsImlzUnVubmluZyIsImdldFN0YXR1cyIsIm5vU2Vzc2lvblByb3h5IiwiTm9TZXNzaW9uUHJveHkiLCJzZXJ2ZXIiLCJob3N0bmFtZSIsImJhc2UiLCJ0aW1lb3V0IiwiY29tbWFuZCIsImVyciIsImhyZWYiLCJ1bmluc3RhbGwiLCJyZW1vdmVBcHAiLCJKU09OIiwic3RyaW5naWZ5IiwibGF1bmNoIiwic2Vzc2lvbklkIiwic2V0dXBQcm94aWVzIiwiZnMiLCJleGlzdHMiLCJFcnJvciIsImRpZFBlcmZvcm1VcGdyYWRlIiwiY2xlYW5Qcm9qZWN0IiwiaXByb3h5IiwiaVByb3h5Iiwic3RhcnQiLCJpbml0IiwicHJlYnVpbGQiLCJwcm94eU9wdHMiLCJqd3Byb3h5IiwiSldQcm94eSIsInByb3h5UmVxUmVzIiwiYmluZCIsIm5vU2Vzc2lvblByb3h5UmVxUmVzIiwicXVpdCIsInJlc2V0IiwiX3VybCIsInBhcnNlIiwiZnVsbHlTdGFydGVkIiwiZXhwZWN0SVByb3h5RXJyb3JzIiwicmV0cmlldmVEZXJpdmVkRGF0YVBhdGgiLCJzZXR1cENhY2hpbmciLCJzdGF0dXMiLCJidWlsZCIsInByb2R1Y3RCdW5kbGVJZGVudGlmaWVyIiwidXBncmFkZWRBdCIsInV0aWwiLCJoYXNWYWx1ZSIsIldEQV9SVU5ORVJfQlVORExFX0lEIiwiYWN0dWFsVXBncmFkZVRpbWVzdGFtcCIsInRvTG93ZXIiLCJxdWl0QW5kVW5pbnN0YWxsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLGNBQWMsR0FBR0MsY0FBS0MsT0FBTCxDQUFhQyxTQUFiLEVBQXdCLElBQXhCLEVBQThCLElBQTlCLEVBQW9DLElBQXBDLEVBQTBDLGdCQUExQyxDQUF2Qjs7O0FBQ0EsTUFBTUMsYUFBYSxHQUFHLDRDQUF0Qjs7QUFDQSxNQUFNQyxrQkFBa0IsR0FBRyxLQUFLLElBQWhDO0FBQ0EsTUFBTUMsY0FBYyxHQUFHLElBQXZCO0FBQ0EsTUFBTUMs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LEVBQXBFOztBQUNBLFVBQUlJLHNCQUFzQixJQUFJSixVQUExQixJQUF3QzdGLGdCQUFFa0csT0FBRixDQUFXLEdBQUVELHNCQUF1QixFQUFwQyxNQUEyQ2pHLGdCQUFFa0csT0FBRixDQUFXLEdBQUVMLFVBQVcsRUFBeEIsQ0FBdkYsRUFBbUg7QUFDakg1RCx3QkFBSUMsSUFBSixDQUFTLHdGQUNOLHdEQUF1RCtELHNCQUF1QixPQUFNSixVQUFXLEdBRGxHOztBQUVBLHFCQUFhLE1BQUksQ0FBQ2xDLFNBQUwsRUFBYjtBQUNEOztBQUVELFlBQU1aLE9BQU8sR0FBRytDLG9CQUFLQyxRQUFMLENBQWNILHVCQUFkLElBQ1gsaURBQWdELE1BQUksQ0FBQ3ZELEdBQUwsQ0FBU3FCLElBQUssV0FBVWtDLHVCQUF3QixHQURyRixHQUVYLGlEQUFnRCxNQUFJLENBQUN2RCxHQUFMLENBQVNxQixJQUFLLEdBRm5FOztBQUdBekIsc0JBQUlDLElBQUosQ0FBVSxHQUFFYSxPQUFRLCtEQUE4RCxNQUFJLENBQUNWLEdBQUwsQ0FBU0MsSUFBSyxvQ0FBaEc7O0FBQ0EsTUFBQSxNQUFJLENBQUMzQixpQkFBTCxHQUF5QixNQUFJLENBQUMwQixHQUFMLENBQVNxQixJQUFsQztBQWpDc0M7QUFrQ3ZDOztBQUVLeUMsRUFBQUEsZ0JBQU4sR0FBMEI7QUFBQTs7QUFBQTtBQUN4QixZQUFNLE1BQUksQ0FBQ2pCLElBQUwsRUFBTjtBQUNBLFlBQU0sTUFBSSxDQUFDdkIsU0FBTCxFQUFOO0FBRndCO0FBR3pCOztBQXJTa0I7OztlQXdTTi9ELGMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgdXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgeyBKV1Byb3h5IH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IGZzLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgTm9TZXNzaW9uUHJveHkgfSBmcm9tIFwiLi9uby1zZXNzaW9uLXByb3h5XCI7XG5pbXBvcnQgeyBjaGVja0ZvckRlcGVuZGVuY2llcywgV0RBX1JVTk5FUl9CVU5ETEVfSUQsIGdldFdEQVVwZ3JhZGVUaW1lc3RhbXAgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IHJlc2V0WENUZXN0UHJvY2Vzc2VzLCBnZXRQSURzTGlzdGVuaW5nT25Qb3J0IH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IFhjb2RlQnVpbGQgZnJvbSAnLi94Y29kZWJ1aWxkJztcbmltcG9ydCBpUHJveHkgZnJvbSAnLi9pcHJveHknO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5cblxuY29uc3QgQk9PVFNUUkFQX1BBVEggPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnLi4nLCAnV2ViRHJpdmVyQWdlbnQnKTtcbmNvbnN0IFdEQV9CVU5ETEVfSUQgPSAnY29tLmFwcGxlLnRlc3QuV2ViRHJpdmVyQWdlbnRSdW5uZXItUnVubmVyJztcbmNvbnN0IFdEQV9MQVVOQ0hfVElNRU9VVCA9IDYwICogMTAwMDtcbmNvbnN0IFdEQV9BR0VOVF9QT1JUID0gODEwMDtcbmNvbnN0IFdEQV9CQVNFX1VSTCA9ICdodHRwOi8vbG9jYWxob3N0JztcblxuXG5jbGFzcyBXZWJEcml2ZXJBZ2VudCB7XG4gIGNvbnN0cnVjdG9yICh4Y29kZVZlcnNpb24sIGFyZ3MgPSB7fSkge1xuICAgIHRoaXMueGNvZGVWZXJzaW9uID0geGNvZGVWZXJzaW9uO1xuXG4gICAgdGhpcy5hcmdzID0gXy5jbG9uZShhcmdzKTtcblxuICAgIHRoaXMuZGV2aWNlID0gYXJncy5kZXZpY2U7XG4gICAgdGhpcy5wbGF0Zm9ybVZlcnNpb24gPSBhcmdzLnBsYXRmb3JtVmVyc2lvbjtcbiAgICB0aGlzLmhvc3QgPSBhcmdzLmhvc3Q7XG4gICAgdGhpcy5yZWFsRGV2aWNlID0gISFhcmdzLnJlYWxEZXZpY2U7XG5cbiAgICB0aGlzLnNldFdEQVBhdGhzKGFyZ3MuYm9vdHN0cmFwUGF0aCwgYXJncy5hZ2VudFBhdGgpO1xuXG4gICAgdGhpcy53ZGFMb2NhbFBvcnQgPSBhcmdzLndkYUxvY2FsUG9ydDtcblxuICAgIHRoaXMucHJlYnVpbGRXREEgPSBhcmdzLnByZWJ1aWxkV0RBO1xuXG4gICAgdGhpcy53ZWJEcml2ZXJBZ2VudFVybCA9IGFyZ3Mud2ViRHJpdmVyQWdlbnRVcmw7XG5cbiAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTtcblxuICAgIHRoaXMud2RhQ29ubmVjdGlvblRpbWVvdXQgPSBhcmdzLndkYUNvbm5lY3Rpb25UaW1lb3V0O1xuXG4gICAgdGhpcy51c2VDYXJ0aGFnZVNzbCA9IF8uaXNCb29sZWFuKGFyZ3MudXNlQ2FydGhhZ2VTc2wpICYmIGFyZ3MudXNlQ2FydGhhZ2VTc2w7XG5cbiAgICB0aGlzLnVzZVhjdGVzdHJ1bkZpbGUgPSBhcmdzLnVzZVhjdGVzdHJ1bkZpbGU7XG5cbiAgICB0aGlzLnhjb2RlYnVpbGQgPSBuZXcgWGNvZGVCdWlsZCh0aGlzLnhjb2RlVmVyc2lvbiwgdGhpcy5kZXZpY2UsIHtcbiAgICAgIHBsYXRmb3JtVmVyc2lvbjogdGhpcy5wbGF0Zm9ybVZlcnNpb24sXG4gICAgICBhZ2VudFBhdGg6IHRoaXMuYWdlbnRQYXRoLFxuICAgICAgYm9vdHN0cmFwUGF0aDogdGhpcy5ib290c3RyYXBQYXRoLFxuICAgICAgcmVhbERldmljZTogdGhpcy5yZWFsRGV2aWNlLFxuICAgICAgc2hvd1hjb2RlTG9nOiAhIWFyZ3Muc2hvd1hjb2RlTG9nLFxuICAgICAgeGNvZGVDb25maWdGaWxlOiBhcmdzLnhjb2RlQ29uZmlnRmlsZSxcbiAgICAgIHhjb2RlT3JnSWQ6IGFyZ3MueGNvZGVPcmdJZCxcbiAgICAgIHhjb2RlU2lnbmluZ0lkOiBhcmdzLnhjb2RlU2lnbmluZ0lkLFxuICAgICAga2V5Y2hhaW5QYXRoOiBhcmdzLmtleWNoYWluUGF0aCxcbiAgICAgIGtleWNoYWluUGFzc3dvcmQ6IGFyZ3Mua2V5Y2hhaW5QYXNzd29yZCxcbiAgICAgIHVzZVNpbXBsZUJ1aWxkVGVzdDogYXJncy51c2VTaW1wbGVCdWlsZFRlc3QsXG4gICAgICB1c2VQcmVidWlsdFdEQTogYXJncy51c2VQcmVidWlsdFdEQSxcbiAgICAgIHVwZGF0ZWRXREFCdW5kbGVJZDogYXJncy51cGRhdGVkV0RBQnVuZGxlSWQsXG4gICAgICBsYXVuY2hUaW1lb3V0OiBhcmdzLndkYUxhdW5jaFRpbWVvdXQgfHwgV0RBX0xBVU5DSF9USU1FT1VULFxuICAgICAgd2RhUmVtb3RlUG9ydDogdGhpcy5yZWFsRGV2aWNlID8gV0RBX0FHRU5UX1BPUlQgOiAodGhpcy53ZGFMb2NhbFBvcnQgfHwgV0RBX0FHRU5UX1BPUlQpLFxuICAgICAgdXNlWGN0ZXN0cnVuRmlsZTogdGhpcy51c2VYY3Rlc3RydW5GaWxlLFxuICAgICAgZGVyaXZlZERhdGFQYXRoOiBhcmdzLmRlcml2ZWREYXRhUGF0aCxcbiAgICAgIG1qcGVnU2VydmVyUG9ydDogYXJncy5tanBlZ1NlcnZlclBvcnQsXG4gICAgfSk7XG4gIH1cblxuICBzZXRXREFQYXRocyAoYm9vdHN0cmFwUGF0aCwgYWdlbnRQYXRoKSB7XG4gICAgLy8gYWxsb3cgdGhlIHVzZXIgdG8gc3BlY2lmeSBhIHBsYWNlIGZvciBXREEuIFRoaXMgaXMgdW5kb2N1bWVudGVkIGFuZFxuICAgIC8vIG9ubHkgaGVyZSBmb3IgdGhlIHB1cnBvc2VzIG9mIHRlc3RpbmcgZGV2ZWxvcG1lbnQgb2YgV0RBXG4gICAgdGhpcy5ib290c3RyYXBQYXRoID0gYm9vdHN0cmFwUGF0aCB8fCBCT09UU1RSQVBfUEFUSDtcbiAgICBsb2cuaW5mbyhgVXNpbmcgV0RBIHBhdGg6ICcke3RoaXMuYm9vdHN0cmFwUGF0aH0nYCk7XG5cbiAgICAvLyBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSB3ZSBuZWVkIHRvIGJlIGFibGUgdG8gc3BlY2lmeSBhZ2VudFBhdGggdG9vXG4gICAgdGhpcy5hZ2VudFBhdGggPSBhZ2VudFBhdGggfHwgcGF0aC5yZXNvbHZlKHRoaXMuYm9vdHN0cmFwUGF0aCwgJ1dlYkRyaXZlckFnZW50Lnhjb2RlcHJvaicpO1xuICAgIGxvZy5pbmZvKGBVc2luZyBXREEgYWdlbnQ6ICcke3RoaXMuYWdlbnRQYXRofSdgKTtcbiAgfVxuXG4gIGFzeW5jIGNsZWFudXBPYnNvbGV0ZVByb2Nlc3NlcyAoKSB7XG4gICAgY29uc3QgcGlkcyA9IGF3YWl0IGdldFBJRHNMaXN0ZW5pbmdPblBvcnQodGhpcy51cmwucG9ydCxcbiAgICAgIChjbWRMaW5lKSA9PiAoY21kTGluZS5pbmNsdWRlcygnL1dlYkRyaXZlckFnZW50UnVubmVyJykgfHwgY21kTGluZS5pbmNsdWRlcygnL2lwcm94eScpKSAmJlxuICAgICAgICAhY21kTGluZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHRoaXMuZGV2aWNlLnVkaWQudG9Mb3dlckNhc2UoKSkpO1xuICAgIGlmICghcGlkcy5sZW5ndGgpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgTm8gb2Jzb2xldGUgY2FjaGVkIHByb2Nlc3NlcyBmcm9tIHByZXZpb3VzIFdEQSBzZXNzaW9ucyBgICtcbiAgICAgICAgICAgICAgICBgbGlzdGVuaW5nIG9uIHBvcnQgJHt0aGlzLnVybC5wb3J0fSBoYXZlIGJlZW4gZm91bmRgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsb2cuaW5mbyhgRGV0ZWN0ZWQgJHtwaWRzLmxlbmd0aH0gb2Jzb2xldGUgY2FjaGVkIHByb2Nlc3Mke3BpZHMubGVuZ3RoID09PSAxID8gJycgOiAnZXMnfSBgICtcbiAgICAgICAgICAgICBgZnJvbSBwcmV2aW91cyBXREEgc2Vzc2lvbnMuIENsZWFuaW5nIHVwLi4uYCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4ZWMoJ2tpbGwnLCBwaWRzKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cud2FybihgRmFpbGVkIHRvIGtpbGwgb2Jzb2xldGUgY2FjaGVkIHByb2Nlc3Mke3BpZHMubGVuZ3RoID09PSAxID8gJycgOiAnZXMnfSAnJHtwaWRzfScuIGAgK1xuICAgICAgICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIGJvb2xlYW4gaWYgV0RBIGlzIHJ1bm5pbmcgb3Igbm90XG4gICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgV0RBIGlzIHJ1bm5pbmdcbiAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBpbnZhbGlkIHJlc3BvbnNlIGNvZGUgb3IgYm9keVxuICAgKi9cbiAgYXN5bmMgaXNSdW5uaW5nICgpIHtcbiAgICByZXR1cm4gISEoYXdhaXQgdGhpcy5nZXRTdGF0dXMoKSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIGN1cnJlbnQgcnVubmluZyBXREEncyBzdGF0dXMgbGlrZSBiZWxvd1xuICAgKiB7XG4gICAqICAgXCJzdGF0ZVwiOiBcInN1Y2Nlc3NcIixcbiAgICogICBcIm9zXCI6IHtcbiAgICogICAgIFwibmFtZVwiOiBcImlPU1wiLFxuICAgKiAgICAgXCJ2ZXJzaW9uXCI6IFwiMTEuNFwiLFxuICAgKiAgICAgXCJzZGtWZXJzaW9uXCI6IFwiMTEuM1wiXG4gICAqICAgfSxcbiAgICogICBcImlvc1wiOiB7XG4gICAqICAgICBcInNpbXVsYXRvclZlcnNpb25cIjogXCIxMS40XCIsXG4gICAqICAgICBcImlwXCI6IFwiMTcyLjI1NC45OS4zNFwiXG4gICAqICAgfSxcbiAgICogICBcImJ1aWxkXCI6IHtcbiAgICogICAgIFwidGltZVwiOiBcIkp1biAyNCAyMDE4IDE3OjA4OjIxXCIsXG4gICAqICAgICBcInByb2R1Y3RCdW5kbGVJZGVudGlmaWVyXCI6IFwiY29tLmZhY2Vib29rLldlYkRyaXZlckFnZW50UnVubmVyXCJcbiAgICogICB9XG4gICAqIH1cbiAgICpcbiAgICogQHJldHVybiB7P29iamVjdH0gU3RhdGUgT2JqZWN0XG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgaW52YWxpZCByZXNwb25zZSBjb2RlIG9yIGJvZHlcbiAgICovXG4gIGFzeW5jIGdldFN0YXR1cyAoKSB7XG4gICAgY29uc3Qgbm9TZXNzaW9uUHJveHkgPSBuZXcgTm9TZXNzaW9uUHJveHkoe1xuICAgICAgc2VydmVyOiB0aGlzLnVybC5ob3N0bmFtZSxcbiAgICAgIHBvcnQ6IHRoaXMudXJsLnBvcnQsXG4gICAgICBiYXNlOiAnJyxcbiAgICAgIHRpbWVvdXQ6IDMwMDAsXG4gICAgfSk7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCBub1Nlc3Npb25Qcm94eS5jb21tYW5kKCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmRlYnVnKGBXREEgaXMgbm90IGxpc3RlbmluZyBhdCAnJHt0aGlzLnVybC5ocmVmfSdgKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHVuaW5zdGFsbCAoKSB7XG4gICAgbG9nLmRlYnVnKGBSZW1vdmluZyBXREEgYXBwbGljYXRpb24gZnJvbSBkZXZpY2VgKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5kZXZpY2UucmVtb3ZlQXBwKFdEQV9CVU5ETEVfSUQpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZy53YXJuKGBXZWJEcml2ZXJBZ2VudCB1bmluc3RhbGwgZmFpbGVkLiBQZXJoYXBzLCBpdCBpcyBhbHJlYWR5IHVuaW5zdGFsbGVkPyBPcmlnaW5hbCBlcnJvcjogJHtKU09OLnN0cmluZ2lmeShlKX1gKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBsYXVuY2ggKHNlc3Npb25JZCkge1xuICAgIGlmICh0aGlzLndlYkRyaXZlckFnZW50VXJsKSB7XG4gICAgICBsb2cuaW5mbyhgVXNpbmcgcHJvdmlkZWQgV2ViZHJpdmVyQWdlbnQgYXQgJyR7dGhpcy53ZWJEcml2ZXJBZ2VudFVybH0nYCk7XG4gICAgICB0aGlzLnVybCA9IHRoaXMud2ViRHJpdmVyQWdlbnRVcmw7XG4gICAgICB0aGlzLnNldHVwUHJveGllcyhzZXNzaW9uSWQpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxvZy5pbmZvKCdMYXVuY2hpbmcgV2ViRHJpdmVyQWdlbnQgb24gdGhlIGRldmljZScpO1xuXG4gICAgdGhpcy5zZXR1cFByb3hpZXMoc2Vzc2lvbklkKTtcblxuICAgIGlmICghdGhpcy51c2VYY3Rlc3RydW5GaWxlICYmICFhd2FpdCBmcy5leGlzdHModGhpcy5hZ2VudFBhdGgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRyeWluZyB0byB1c2UgV2ViRHJpdmVyQWdlbnQgcHJvamVjdCBhdCAnJHt0aGlzLmFnZW50UGF0aH0nIGJ1dCB0aGUgYCArXG4gICAgICAgICAgICAgICAgICAgICAgJ2ZpbGUgZG9lcyBub3QgZXhpc3QnKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMudXNlWGN0ZXN0cnVuRmlsZSkge1xuICAgICAgLy8gbWFrZSBzdXJlIHRoYXQgdGhlIFdEQSBkZXBlbmRlbmNpZXMgaGF2ZSBiZWVuIGJ1aWx0XG4gICAgICBjb25zdCBkaWRQZXJmb3JtVXBncmFkZSA9IGF3YWl0IGNoZWNrRm9yRGVwZW5kZW5jaWVzKHRoaXMuYm9vdHN0cmFwUGF0aCwgdGhpcy51c2VDYXJ0aGFnZVNzbCk7XG4gICAgICBpZiAoZGlkUGVyZm9ybVVwZ3JhZGUpIHtcbiAgICAgICAgLy8gT25seSBwZXJmb3JtIHRoZSBjbGVhbnVwIGFmdGVyIFdEQSB1cGdyYWRlXG4gICAgICAgIGF3YWl0IHRoaXMueGNvZGVidWlsZC5jbGVhblByb2plY3QoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gV2UgbmVlZCB0byBwcm92aWRlIFdEQSBsb2NhbCBwb3J0LCBiZWNhdXNlIGl0IG1pZ2h0IGJlIG9jY3VwaWVkIHdpdGhcbiAgICAvLyBpcHJveHkgaW5zdGFuY2UgaW5pdGlhdGVkIGJ5IHNvbWUgcHJlY2VlZGluZyBydW4gd2l0aCBhIHJlYWwgZGV2aWNlXG4gICAgLy8gKGlwcm94eSBpbnN0YW5jZXMgYXJlIG5vdCBraWxsZWQgb24gc2Vzc2lvbiB0ZXJtaW5hdGlvbiBieSBkZWZhdWx0KVxuICAgIGF3YWl0IHJlc2V0WENUZXN0UHJvY2Vzc2VzKHRoaXMuZGV2aWNlLnVkaWQsICF0aGlzLnJlYWxEZXZpY2UsIHt3ZGFMb2NhbFBvcnQ6IHRoaXMudXJsLnBvcnR9KTtcblxuICAgIGlmICh0aGlzLnJlYWxEZXZpY2UpIHtcbiAgICAgIHRoaXMuaXByb3h5ID0gbmV3IGlQcm94eSh0aGlzLmRldmljZS51ZGlkLCB0aGlzLnVybC5wb3J0LCBXREFfQUdFTlRfUE9SVCk7XG4gICAgICBhd2FpdCB0aGlzLmlwcm94eS5zdGFydCgpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMueGNvZGVidWlsZC5pbml0KHRoaXMubm9TZXNzaW9uUHJveHkpO1xuXG4gICAgLy8gU3RhcnQgdGhlIHhjb2RlYnVpbGQgcHJvY2Vzc1xuICAgIGlmICh0aGlzLnByZWJ1aWxkV0RBKSB7XG4gICAgICBhd2FpdCB0aGlzLnhjb2RlYnVpbGQucHJlYnVpbGQoKTtcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMueGNvZGVidWlsZC5zdGFydCgpO1xuICB9XG5cbiAgc2V0dXBQcm94aWVzIChzZXNzaW9uSWQpIHtcbiAgICBjb25zdCBwcm94eU9wdHMgPSB7XG4gICAgICBzZXJ2ZXI6IHRoaXMudXJsLmhvc3RuYW1lLFxuICAgICAgcG9ydDogdGhpcy51cmwucG9ydCxcbiAgICAgIGJhc2U6ICcnLFxuICAgICAgdGltZW91dDogdGhpcy53ZGFDb25uZWN0aW9uVGltZW91dCxcbiAgICB9O1xuXG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEpXUHJveHkocHJveHlPcHRzKTtcbiAgICB0aGlzLmp3cHJveHkuc2Vzc2lvbklkID0gc2Vzc2lvbklkO1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xuXG4gICAgdGhpcy5ub1Nlc3Npb25Qcm94eSA9IG5ldyBOb1Nlc3Npb25Qcm94eShwcm94eU9wdHMpO1xuICAgIHRoaXMubm9TZXNzaW9uUHJveHlSZXFSZXMgPSB0aGlzLm5vU2Vzc2lvblByb3h5LnByb3h5UmVxUmVzLmJpbmQodGhpcy5ub1Nlc3Npb25Qcm94eSk7XG4gIH1cblxuICBhc3luYyBxdWl0ICgpIHtcbiAgICBsb2cuaW5mbygnU2h1dHRpbmcgZG93biBzdWItcHJvY2Vzc2VzJyk7XG5cbiAgICBpZiAodGhpcy5pcHJveHkpIHtcbiAgICAgIGF3YWl0IHRoaXMuaXByb3h5LnF1aXQoKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnhjb2RlYnVpbGQucXVpdCgpO1xuICAgIGF3YWl0IHRoaXMueGNvZGVidWlsZC5yZXNldCgpO1xuXG4gICAgaWYgKHRoaXMuandwcm94eSkge1xuICAgICAgdGhpcy5qd3Byb3h5LnNlc3Npb25JZCA9IG51bGw7XG4gICAgfVxuXG4gICAgdGhpcy5zdGFydGVkID0gZmFsc2U7XG5cbiAgICBpZiAoIXRoaXMuYXJncy53ZWJEcml2ZXJBZ2VudFVybCkge1xuICAgICAgLy8gaWYgd2UgcG9wdWxhdGVkIHRoZSB1cmwgb3Vyc2VsdmVzIChkdXJpbmcgYHNldHVwQ2FjaGluZ2AgY2FsbCwgZm9yIGluc3RhbmNlKVxuICAgICAgLy8gdGhlbiBjbGVhbiB0aGF0IHVwLiBJZiB0aGUgdXJsIHdhcyBzdXBwbGllZCwgd2Ugd2FudCB0byBrZWVwIGl0XG4gICAgICB0aGlzLndlYkRyaXZlckFnZW50VXJsID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBnZXQgdXJsICgpIHtcbiAgICBpZiAoIXRoaXMuX3VybCkge1xuICAgICAgbGV0IHBvcnQgPSB0aGlzLndkYUxvY2FsUG9ydCB8fCBXREFfQUdFTlRfUE9SVDtcbiAgICAgIHRoaXMuX3VybCA9IHVybC5wYXJzZShgJHtXREFfQkFTRV9VUkx9OiR7cG9ydH1gKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX3VybDtcbiAgfVxuXG4gIHNldCB1cmwgKF91cmwpIHtcbiAgICB0aGlzLl91cmwgPSB1cmwucGFyc2UoX3VybCk7XG4gIH1cblxuICBnZXQgZnVsbHlTdGFydGVkICgpIHtcbiAgICByZXR1cm4gdGhpcy5zdGFydGVkO1xuICB9XG5cbiAgc2V0IGZ1bGx5U3RhcnRlZCAoc3RhcnRlZCA9IGZhbHNlKSB7XG4gICAgLy8gYmVmb3JlIFdEQSBpcyBzdGFydGVkIHdlIGV4cGVjdCBlcnJvcnMgZnJvbSBpcHJveHksIHNpbmNlIGl0IGlzIG5vdFxuICAgIC8vIGNvbW11bmljYXRpbmcgd2l0aCBhbnl0aGluZyB5ZXRcbiAgICB0aGlzLnN0YXJ0ZWQgPSBzdGFydGVkO1xuICAgIGlmICh0aGlzLmlwcm94eSkge1xuICAgICAgdGhpcy5pcHJveHkuZXhwZWN0SVByb3h5RXJyb3JzID0gIXN0YXJ0ZWQ7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmV0cmlldmVEZXJpdmVkRGF0YVBhdGggKCkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnhjb2RlYnVpbGQucmV0cmlldmVEZXJpdmVkRGF0YVBhdGgoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXVzZSBydW5uaW5nIFdEQSBpZiBpdCBoYXMgdGhlIHNhbWUgYnVuZGxlIGlkIHdpdGggdXBkYXRlZFdEQUJ1bmRsZUlkLlxuICAgKiBPciByZXVzZSBpdCBpZiBpdCBoYXMgdGhlIGRlZmF1bHQgaWQgd2l0aG91dCB1cGRhdGVkV0RBQnVuZGxlSWQuXG4gICAqIFVuaW5zdGFsbCBpdCBpZiB0aGUgbWV0aG9kIGZhY2VzIGFuIGV4Y2VwdGlvbiBmb3IgdGhlIGFib3ZlIHNpdHVhdGlvbi5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVwZGF0ZWRXREFCdW5kbGVJZCBCdW5kbGVJZCB5b3UnZCBsaWtlIHRvIHVzZVxuICAgKi9cbiAgYXN5bmMgc2V0dXBDYWNoaW5nICh1cGRhdGVkV0RBQnVuZGxlSWQpIHtcbiAgICBjb25zdCBzdGF0dXMgPSBhd2FpdCB0aGlzLmdldFN0YXR1cygpO1xuICAgIGlmICghc3RhdHVzIHx8ICFzdGF0dXMuYnVpbGQpIHtcbiAgICAgIGxvZy5kZWJ1ZygnV0RBIGlzIGN1cnJlbnRseSBub3QgcnVubmluZy4gVGhlcmUgaXMgbm90aGluZyB0byBjYWNoZScpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHtcbiAgICAgIHByb2R1Y3RCdW5kbGVJZGVudGlmaWVyLFxuICAgICAgdXBncmFkZWRBdCxcbiAgICB9ID0gc3RhdHVzLmJ1aWxkO1xuICAgIGlmICh1dGlsLmhhc1ZhbHVlKHByb2R1Y3RCdW5kbGVJZGVudGlmaWVyKSAmJiB1dGlsLmhhc1ZhbHVlKHVwZGF0ZWRXREFCdW5kbGVJZCkgJiYgdXBkYXRlZFdEQUJ1bmRsZUlkICE9PSBwcm9kdWN0QnVuZGxlSWRlbnRpZmllcikge1xuICAgICAgbG9nLmluZm8oYFdpbGwgdW5pbnN0YWxsIHJ1bm5pbmcgV0RBIHNpbmNlIGl0IGhhcyBkaWZmZXJlbnQgYnVuZGxlIGlkLiBUaGUgYWN0dWFsIHZhbHVlIGlzICcke3Byb2R1Y3RCdW5kbGVJZGVudGlmaWVyfScuYCk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy51bmluc3RhbGwoKTtcbiAgICB9XG4gICAgaWYgKHV0aWwuaGFzVmFsdWUocHJvZHVjdEJ1bmRsZUlkZW50aWZpZXIpICYmICF1dGlsLmhhc1ZhbHVlKHVwZGF0ZWRXREFCdW5kbGVJZCkgJiYgV0RBX1JVTk5FUl9CVU5ETEVfSUQgIT09IHByb2R1Y3RCdW5kbGVJZGVudGlmaWVyKSB7XG4gICAgICBsb2cuaW5mbyhgV2lsbCB1bmluc3RhbGwgcnVubmluZyBXREEgc2luY2UgaXRzIGJ1bmRsZSBpZCBpcyBub3QgZXF1YWwgdG8gdGhlIGRlZmF1bHQgdmFsdWUgJHtXREFfUlVOTkVSX0JVTkRMRV9JRH1gKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnVuaW5zdGFsbCgpO1xuICAgIH1cblxuICAgIGNvbnN0IGFjdHVhbFVwZ3JhZGVUaW1lc3RhbXAgPSBhd2FpdCBnZXRXREFVcGdyYWRlVGltZXN0YW1wKHRoaXMuYm9vdHN0cmFwUGF0aCk7XG4gICAgbG9nLmRlYnVnKGBVcGdyYWRlIHRpbWVzdGFtcCBvZiB0aGUgY3VycmVudGx5IGJ1bmRsZWQgV0RBOiAke2FjdHVhbFVwZ3JhZGVUaW1lc3RhbXB9YCk7XG4gICAgbG9nLmRlYnVnKGBVcGdyYWRlIHRpbWVzdGFtcCBvZiB0aGUgV0RBIG9uIHRoZSBkZXZpY2U6ICR7dXBncmFkZWRBdH1gKTtcbiAgICBpZiAoYWN0dWFsVXBncmFkZVRpbWVzdGFtcCAmJiB1cGdyYWRlZEF0ICYmIF8udG9Mb3dlcihgJHthY3R1YWxVcGdyYWRlVGltZXN0YW1wfWApICE9PSBfLnRvTG93ZXIoYCR7dXBncmFkZWRBdH1gKSkge1xuICAgICAgbG9nLmluZm8oJ1dpbGwgdW5pbnN0YWxsIHJ1bm5pbmcgV0RBIHNpbmNlIGl0IGhhcyBkaWZmZXJlbnQgdmVyc2lvbiBpbiBjb21wYXJpc29uIHRvIHRoZSBvbmUgJyArXG4gICAgICAgIGB3aGljaCBpcyBidW5kbGVkIHdpdGggYXBwaXVtLXhjdWl0ZXN0LWRyaXZlciBtb2R1bGUgKCR7YWN0dWFsVXBncmFkZVRpbWVzdGFtcH0gIT0gJHt1cGdyYWRlZEF0fSlgKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnVuaW5zdGFsbCgpO1xuICAgIH1cblxuICAgIGNvbnN0IG1lc3NhZ2UgPSB1dGlsLmhhc1ZhbHVlKHByb2R1Y3RCdW5kbGVJZGVudGlmaWVyKVxuICAgICAgPyBgV2lsbCByZXVzZSBwcmV2aW91c2x5IGNhY2hlZCBXREEgaW5zdGFuY2UgYXQgJyR7dGhpcy51cmwuaHJlZn0nIHdpdGggJyR7cHJvZHVjdEJ1bmRsZUlkZW50aWZpZXJ9J2BcbiAgICAgIDogYFdpbGwgcmV1c2UgcHJldmlvdXNseSBjYWNoZWQgV0RBIGluc3RhbmNlIGF0ICcke3RoaXMudXJsLmhyZWZ9J2A7XG4gICAgbG9nLmluZm8oYCR7bWVzc2FnZX0uIFNldCB0aGUgd2RhTG9jYWxQb3J0IGNhcGFiaWxpdHkgdG8gYSB2YWx1ZSBkaWZmZXJlbnQgZnJvbSAke3RoaXMudXJsLnBvcnR9IGlmIHRoaXMgaXMgYW4gdW5kZXNpcmVkIGJlaGF2aW9yLmApO1xuICAgIHRoaXMud2ViRHJpdmVyQWdlbnRVcmwgPSB0aGlzLnVybC5ocmVmO1xuICB9XG5cbiAgYXN5bmMgcXVpdEFuZFVuaW5zdGFsbCAoKSB7XG4gICAgYXdhaXQgdGhpcy5xdWl0KCk7XG4gICAgYXdhaXQgdGhpcy51bmluc3RhbGwoKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBXZWJEcml2ZXJBZ2VudDtcbmV4cG9ydCB7IFdlYkRyaXZlckFnZW50LCBXREFfQlVORExFX0lELCBCT09UU1RSQVBfUEFUSCB9O1xuIl0sImZpbGUiOiJsaWIvd2RhL3dlYmRyaXZlcmFnZW50LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
