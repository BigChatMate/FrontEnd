"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.XcodeBuild = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _asyncbox = require("asyncbox");

var _teen_process = require("teen_process");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _utils = require("./utils");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

const DEFAULT_SIGNING_ID = "iPhone Developer";
const BUILD_TEST_DELAY = 1000;
const RUNNER_SCHEME = 'WebDriverAgentRunner';
const LIB_SCHEME = 'WebDriverAgentLib';

const xcodeLog = _appiumSupport.logger.getLogger('Xcode');

class XcodeBuild {
  constructor(xcodeVersion, device, args = {}) {
    this.xcodeVersion = xcodeVersion;
    this.device = device;
    this.realDevice = args.realDevice;
    this.agentPath = args.agentPath;
    this.bootstrapPath = args.bootstrapPath;
    this.platformVersion = args.platformVersion;
    this.showXcodeLog = !!args.showXcodeLog;
    this.xcodeConfigFile = args.xcodeConfigFile;
    this.xcodeOrgId = args.xcodeOrgId;
    this.xcodeSigningId = args.xcodeSigningId || DEFAULT_SIGNING_ID;
    this.keychainPath = args.keychainPath;
    this.keychainPassword = args.keychainPassword;
    this.prebuildWDA = args.prebuildWDA;
    this.usePrebuiltWDA = args.usePrebuiltWDA;
    this.useSimpleBuildTest = args.useSimpleBuildTest;
    this.useXctestrunFile = args.useXctestrunFile;
    this.launchTimeout = args.launchTimeout;
    this.wdaRemotePort = args.wdaRemotePort;
    this.updatedWDABundleId = args.updatedWDABundleId;
    this.derivedDataPath = args.derivedDataPath;
    this.mjpegServerPort = args.mjpegServerPort;
  }

  init(noSessionProxy) {
    var _this = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _this.noSessionProxy = noSessionProxy;

      if (_this.useXctestrunFile) {
        if (_this.xcodeVersion.major <= 7) {
          _logger.default.errorAndThrow('useXctestrunFile can only be used with xcode version 8 onwards');
        }

        _this.xctestrunFilePath = yield (0, _utils.setXctestrunFile)(_this.realDevice, _this.device.udid, _this.platformVersion, _this.bootstrapPath, _this.wdaRemotePort);
        return;
      }

      if (_this.xcodeVersion.major === 7 || _this.xcodeVersion.major === 8 && _this.xcodeVersion.minor === 0) {
        _logger.default.debug(`Using Xcode ${_this.xcodeVersion.versionString}, so fixing WDA codebase`);

        yield (0, _utils.fixForXcode7)(_this.bootstrapPath, true);
      }

      if (_this.xcodeVersion.major === 9) {
        _logger.default.debug(`Using Xcode ${_this.xcodeVersion.versionString}, so fixing WDA codebase`);

        yield (0, _utils.fixForXcode9)(_this.bootstrapPath, true);
      }

      if (_this.realDevice) {
        yield (0, _utils.resetProjectFile)(_this.agentPath);

        if (_this.updatedWDABundleId) {
          yield (0, _utils.updateProjectFile)(_this.agentPath, _this.updatedWDABundleId);
        }
      }
    })();
  }

  retrieveDerivedDataPath() {
    var _this2 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (_this2.derivedDataPath) {
        return _this2.derivedDataPath;
      }

      let stdout;

      try {
        var _ref = yield (0, _teen_process.exec)('xcodebuild', ['-project', _this2.agentPath, '-showBuildSettings']);

        stdout = _ref.stdout;
      } catch (err) {
        _logger.default.warn(`Cannot retrieve WDA build settings. Original error: ${err.message}`);

        return;
      }

      const pattern = /^\s*BUILD_DIR\s+=\s+(\/.*)/m;
      const match = pattern.exec(stdout);

      if (!match) {
        _logger.default.warn(`Cannot parse WDA build dir from ${_lodash.default.truncate(stdout, {
          length: 300
        })}`);

        return;
      }

      _logger.default.debug(`Parsed BUILD_DIR configuration value: '${match[1]}'`);

      _this2.derivedDataPath = _path.default.dirname(_path.default.dirname(_path.default.normalize(match[1])));

      _logger.default.debug(`Got derived data root: '${_this2.derivedDataPath}'`);

      return _this2.derivedDataPath;
    })();
  }

  reset() {
    var _this3 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (_this3.realDevice && _this3.updatedWDABundleId) {
        yield (0, _utils.resetProjectFile)(_this3.agentPath);
      }
    })();
  }

  prebuild() {
    var _this4 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (_this4.xcodeVersion.major === 7) {
        _logger.default.debug(`Capability 'prebuildWDA' set, but on xcode version ${_this4.xcodeVersion.versionString} so skipping`);

        return;
      }

      _logger.default.debug('Pre-building WDA before launching test');

      _this4.usePrebuiltWDA = true;
      _this4.xcodebuild = yield _this4.createSubProcess(true);
      yield _this4.start(true);
      _this4.xcodebuild = null;
      yield _bluebird.default.delay(BUILD_TEST_DELAY);
    })();
  }

  cleanProject() {
    var _this5 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      var _arr = [LIB_SCHEME, RUNNER_SCHEME];

      for (var _i = 0; _i < _arr.length; _i++) {
        const scheme = _arr[_i];

        _logger.default.debug(`Cleaning the project scheme '${scheme}' to make sure there are no leftovers from previous installs`);

        yield (0, _teen_process.exec)('xcodebuild', ['clean', '-project', _this5.agentPath, '-scheme', scheme]);
      }
    })();
  }

  getCommand(buildOnly = false) {
    let cmd = 'xcodebuild';
    let args;

    if (this.xcodeVersion.major < 8) {
      args = ['build', 'test'];
    } else {
      let _ref2 = this.useSimpleBuildTest ? ['build', 'test'] : ['build-for-testing', 'test-without-building'],
          _ref3 = (0, _slicedToArray2.default)(_ref2, 2),
          buildCmd = _ref3[0],
          testCmd = _ref3[1];

      if (buildOnly) {
        args = [buildCmd];
      } else if (this.usePrebuiltWDA || this.useXctestrunFile) {
        args = [testCmd];
      } else {
        args = [buildCmd, testCmd];
      }
    }

    if (this.useXctestrunFile) {
      args.push('-xctestrun', this.xctestrunFilePath);
    } else {
      args.push('-project', this.agentPath, '-scheme', RUNNER_SCHEME);

      if (this.derivedDataPath) {
        args.push('-derivedDataPath', this.derivedDataPath);
      }
    }

    args.push('-destination', `id=${this.device.udid}`);
    const versionMatch = new RegExp(/^(\d+)\.(\d+)/).exec(this.platformVersion);

    if (versionMatch) {
      args.push(`IPHONEOS_DEPLOYMENT_TARGET=${versionMatch[1]}.${versionMatch[2]}`);
    } else {
      _logger.default.warn(`Cannot parse major and minor version numbers from platformVersion "${this.platformVersion}". ` + 'Will build for the default platform instead');
    }

    if (this.realDevice && this.xcodeConfigFile) {
      _logger.default.debug(`Using Xcode configuration file: '${this.xcodeConfigFile}'`);

      args.push('-xcconfig', this.xcodeConfigFile);
    }

    return {
      cmd,
      args
    };
  }

  createSubProcess(buildOnly = false) {
    var _this6 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (!_this6.useXctestrunFile) {
        if (_this6.realDevice) {
          if (_this6.keychainPath && _this6.keychainPassword) {
            yield (0, _utils.setRealDeviceSecurity)(_this6.keychainPath, _this6.keychainPassword);
          }

          if (_this6.xcodeOrgId && _this6.xcodeSigningId && !_this6.xcodeConfigFile) {
            _this6.xcodeConfigFile = yield (0, _utils.generateXcodeConfigFile)(_this6.xcodeOrgId, _this6.xcodeSigningId);
          }
        }
      }

      const _this6$getCommand = _this6.getCommand(buildOnly),
            cmd = _this6$getCommand.cmd,
            args = _this6$getCommand.args;

      _logger.default.debug(`Beginning ${buildOnly ? 'build' : 'test'} with command '${cmd} ${args.join(' ')}' ` + `in directory '${_this6.bootstrapPath}'`);

      const env = Object.assign({}, process.env, {
        USE_PORT: _this6.wdaRemotePort,
        WDA_PRODUCT_BUNDLE_IDENTIFIER: _this6.updatedWDABundleId || _utils.WDA_RUNNER_BUNDLE_ID
      });

      if (_this6.mjpegServerPort) {
        env.MJPEG_SERVER_PORT = _this6.mjpegServerPort;
      }

      const upgradeTimestamp = yield (0, _utils.getWDAUpgradeTimestamp)(_this6.bootstrapPath);

      if (upgradeTimestamp) {
        env.UPGRADE_TIMESTAMP = upgradeTimestamp;
      }

      const xcodebuild = new _teen_process.SubProcess(cmd, args, {
        cwd: _this6.bootstrapPath,
        env,
        detached: true,
        stdio: ['ignore', 'pipe', 'pipe']
      });
      let logXcodeOutput = _this6.showXcodeLog;

      _logger.default.debug(`Output from xcodebuild ${logXcodeOutput ? 'will' : 'will not'} be logged. To change this, use 'showXcodeLog' desired capability`);

      xcodebuild.on('output', (stdout, stderr) => {
        let out = stdout || stderr;

        if (out.indexOf('Writing diagnostic log for test session to') !== -1) {
          xcodebuild.logLocation = _lodash.default.first(_lodash.default.remove(out.trim().split('\n'), v => v.indexOf(_path.default.sep) === 0));

          _logger.default.debug(`Log file for xcodebuild test: ${xcodebuild.logLocation}`);
        }

        if (out.indexOf('Error Domain=') !== -1 && out.indexOf('Error writing attachment data to file') === -1 && out.indexOf('Failed to remove screenshot at path') === -1) {
          logXcodeOutput = true;
          xcodebuild._wda_error_occurred = true;
        }

        if (logXcodeOutput) {
          if (out.indexOf('Error writing attachment data to file') === -1) {
            var _iteratorNormalCompletion = true;
            var _didIteratorError = false;
            var _iteratorError = undefined;

            try {
              for (var _iterator = out.split('\n')[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                let line = _step.value;
                xcodeLog.info(line);
              }
            } catch (err) {
              _didIteratorError = true;
              _iteratorError = err;
            } finally {
              try {
                if (!_iteratorNormalCompletion && _iterator.return != null) {
                  _iterator.return();
                }
              } finally {
                if (_didIteratorError) {
                  throw _iteratorError;
                }
              }
            }
          }
        }
      });
      return xcodebuild;
    })();
  }

  start(buildOnly = false) {
    var _this7 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _this7.xcodebuild = yield _this7.createSubProcess(buildOnly);
      return yield new _bluebird.default((resolve, reject) => {
        _this7.xcodebuild.on('exit', function () {
          var _ref4 = (0, _asyncToGenerator2.default)(function* (code, signal) {
            _logger.default.info(`xcodebuild exited with code '${code}' and signal '${signal}'`);

            if (_this7.showXcodeLog && _this7.xcodebuild.logLocation) {
              xcodeLog.info(`Contents of xcodebuild log file '${_this7.xcodebuild.logLocation}':`);

              try {
                let data = yield _appiumSupport.fs.readFile(_this7.xcodebuild.logLocation, 'utf8');
                var _iteratorNormalCompletion2 = true;
                var _didIteratorError2 = false;
                var _iteratorError2 = undefined;

                try {
                  for (var _iterator2 = data.split('\n')[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
                    let line = _step2.value;
                    xcodeLog.info(line);
                  }
                } catch (err) {
                  _didIteratorError2 = true;
                  _iteratorError2 = err;
                } finally {
                  try {
                    if (!_iteratorNormalCompletion2 && _iterator2.return != null) {
                      _iterator2.return();
                    }
                  } finally {
                    if (_didIteratorError2) {
                      throw _iteratorError2;
                    }
                  }
                }
              } catch (err) {
                _logger.default.debug(`Unable to access xcodebuild log file: '${err.message}'`);
              }
            }

            _this7.xcodebuild.processExited = true;

            if (_this7.xcodebuild._wda_error_occurred || !signal && code !== 0) {
              return reject(new Error(`xcodebuild failed with code ${code}`));
            }

            if (buildOnly) {
              return resolve();
            }
          });

          return function (_x, _x2) {
            return _ref4.apply(this, arguments);
          };
        }());

        return (0, _asyncToGenerator2.default)(function* () {
          try {
            let startTime = process.hrtime();
            yield _this7.xcodebuild.start(true);

            if (!buildOnly) {
              let status = yield _this7.waitForStart(startTime);
              resolve(status);
            }
          } catch (err) {
            let msg = `Unable to start WebDriverAgent: ${err}`;

            _logger.default.error(msg);

            reject(new Error(msg));
          }
        })();
      });
    })();
  }

  waitForStart(startTime) {
    var _this8 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _logger.default.debug(`Waiting up to ${_this8.launchTimeout}ms for WebDriverAgent to start`);

      let currentStatus = null;

      try {
        let retries = parseInt(_this8.launchTimeout / 500, 10);
        yield (0, _asyncbox.retryInterval)(retries, 1000, (0, _asyncToGenerator2.default)(function* () {
          if (_this8.xcodebuild.processExited) {
            return;
          }

          const proxyTimeout = _this8.noSessionProxy.timeout;
          _this8.noSessionProxy.timeout = 1000;

          try {
            currentStatus = yield _this8.noSessionProxy.command('/status', 'GET');

            if (currentStatus && currentStatus.ios && currentStatus.ios.ip) {
              _this8.agentUrl = currentStatus.ios.ip;
            }

            _logger.default.debug(`WebDriverAgent information:`);

            _logger.default.debug(JSON.stringify(currentStatus, null, 2));
          } catch (err) {
            throw new Error(`Unable to connect to running WebDriverAgent: ${err.message}`);
          } finally {
            _this8.noSessionProxy.timeout = proxyTimeout;
          }
        }));

        if (_this8.xcodebuild.processExited) {
          return currentStatus;
        }

        let endTime = process.hrtime(startTime);
        let startupTime = parseInt((endTime[0] * 1e9 + endTime[1]) / 1e6, 10);

        _logger.default.debug(`WebDriverAgent successfully started after ${startupTime}ms`);
      } catch (err) {
        _logger.default.debug(err.message);

        _logger.default.warn(`Getting status of WebDriverAgent on device timed out. Continuing`);
      }

      return currentStatus;
    })();
  }

  quit() {
    var _this9 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      yield (0, _utils.killProcess)('xcodebuild', _this9.xcodebuild);
    })();
  }

}

exports.XcodeBuild = XcodeBuild;
var _default = XcodeBuild;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZGEveGNvZGVidWlsZC5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1NJR05JTkdfSUQiLCJCVUlMRF9URVNUX0RFTEFZIiwiUlVOTkVSX1NDSEVNRSIsIkxJQl9TQ0hFTUUiLCJ4Y29kZUxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsIlhjb2RlQnVpbGQiLCJjb25zdHJ1Y3RvciIsInhjb2RlVmVyc2lvbiIsImRldmljZSIsImFyZ3MiLCJyZWFsRGV2aWNlIiwiYWdlbnRQYXRoIiwiYm9vdHN0cmFwUGF0aCIsInBsYXRmb3JtVmVyc2lvbiIsInNob3dYY29kZUxvZyIsInhjb2RlQ29uZmlnRmlsZSIsInhjb2RlT3JnSWQiLCJ4Y29kZVNpZ25pbmdJZCIsImtleWNoYWluUGF0aCIsImtleWNoYWluUGFzc3dvcmQiLCJwcmVidWlsZFdEQSIsInVzZVByZWJ1aWx0V0RBIiwidXNlU2ltcGxlQnVpbGRUZXN0IiwidXNlWGN0ZXN0cnVuRmlsZSIsImxhdW5jaFRpbWVvdXQiLCJ3ZGFSZW1vdGVQb3J0IiwidXBkYXRlZFdEQUJ1bmRsZUlkIiwiZGVyaXZlZERhdGFQYXRoIiwibWpwZWdTZXJ2ZXJQb3J0IiwiaW5pdCIsIm5vU2Vzc2lvblByb3h5IiwibWFqb3IiLCJsb2ciLCJlcnJvckFuZFRocm93IiwieGN0ZXN0cnVuRmlsZVBhdGgiLCJ1ZGlkIiwibWlub3IiLCJkZWJ1ZyIsInZlcnNpb25TdHJpbmciLCJyZXRyaWV2ZURlcml2ZWREYXRhUGF0aCIsInN0ZG91dCIsImVyciIsIndhcm4iLCJtZXNzYWdlIiwicGF0dGVybiIsIm1hdGNoIiwiZXhlYyIsIl8iLCJ0cnVuY2F0ZSIsImxlbmd0aCIsInBhdGgiLCJkaXJuYW1lIiwibm9ybWFsaXplIiwicmVzZXQiLCJwcmVidWlsZCIsInhjb2RlYnVpbGQiLCJjcmVhdGVTdWJQcm9jZXNzIiwic3RhcnQiLCJCIiwiZGVsYXkiLCJjbGVhblByb2plY3QiLCJzY2hlbWUiLCJnZXRDb21tYW5kIiwiYnVpbGRPbmx5IiwiY21kIiwiYnVpbGRDbWQiLCJ0ZXN0Q21kIiwicHVzaCIsInZlcnNpb25NYXRjaCIsIlJlZ0V4cCIsImpvaW4iLCJlbnYiLCJPYmplY3QiLCJhc3NpZ24iLCJwcm9jZXNzIiwiVVNFX1BPUlQiLCJXREFfUFJPRFVDVF9CVU5ETEVfSURFTlRJRklFUiIsIldEQV9SVU5ORVJfQlVORExFX0lEIiwiTUpQRUdfU0VSVkVSX1BPUlQiLCJ1cGdyYWRlVGltZXN0YW1wIiwiVVBHUkFERV9USU1FU1RBTVAiLCJTdWJQcm9jZXNzIiwiY3dkIiwiZGV0YWNoZWQiLCJzdGRpbyIsImxvZ1hjb2RlT3V0cHV0Iiwib24iLCJzdGRlcnIiLCJvdXQiLCJpbmRleE9mIiwibG9nTG9jYXRpb24iLCJmaXJzdCIsInJlbW92ZSIsInRyaW0iLCJzcGxpdCIsInYiLCJzZXAiLCJfd2RhX2Vycm9yX29jY3VycmVkIiwibGluZSIsImluZm8iLCJyZXNvbHZlIiwicmVqZWN0IiwiY29kZSIsInNpZ25hbCIsImRhdGEiLCJmcyIsInJlYWRGaWxlIiwicHJvY2Vzc0V4aXRlZCIsIkVycm9yIiwic3RhcnRUaW1lIiwiaHJ0aW1lIiwic3RhdHVzIiwid2FpdEZvclN0YXJ0IiwibXNnIiwiZXJyb3IiLCJjdXJyZW50U3RhdHVzIiwicmV0cmllcyIsInBhcnNlSW50IiwicHJveHlUaW1lb3V0IiwidGltZW91dCIsImNvbW1hbmQiLCJpb3MiLCJpcCIsImFnZW50VXJsIiwiSlNPTiIsInN0cmluZ2lmeSIsImVuZFRpbWUiLCJzdGFydHVwVGltZSIsInF1aXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFHQSxNQUFNQSxrQkFBa0IsR0FBRyxrQkFBM0I7QUFDQSxNQUFNQyxnQkFBZ0IsR0FBRyxJQUF6QjtBQUNBLE1BQU1DLGFBQWEsR0FBRyxzQkFBdEI7QUFDQSxNQUFNQyxVQUFVLEdBQUcsbUJBQW5COztBQUVBLE1BQU1DLFFBQVEsR0FBR0Ms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QUFOLEdBQWM7QUFBQTs7QUFBQTtBQUNaLFlBQU0sd0JBQVksWUFBWixFQUEwQixNQUFJLENBQUN6RSxVQUEvQixDQUFOO0FBRFk7QUFFYjs7QUEzVmM7OztlQStWRmxELFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgU3ViUHJvY2VzcywgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBmcywgbG9nZ2VyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgZml4Rm9yWGNvZGU3LCBmaXhGb3JYY29kZTksIHNldFJlYWxEZXZpY2VTZWN1cml0eSwgZ2VuZXJhdGVYY29kZUNvbmZpZ0ZpbGUsXG4gICAgICAgICBzZXRYY3Rlc3RydW5GaWxlLCB1cGRhdGVQcm9qZWN0RmlsZSwgcmVzZXRQcm9qZWN0RmlsZSwga2lsbFByb2Nlc3MsXG4gICAgICAgICBXREFfUlVOTkVSX0JVTkRMRV9JRCwgZ2V0V0RBVXBncmFkZVRpbWVzdGFtcCB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5cbmNvbnN0IERFRkFVTFRfU0lHTklOR19JRCA9IFwiaVBob25lIERldmVsb3BlclwiO1xuY29uc3QgQlVJTERfVEVTVF9ERUxBWSA9IDEwMDA7XG5jb25zdCBSVU5ORVJfU0NIRU1FID0gJ1dlYkRyaXZlckFnZW50UnVubmVyJztcbmNvbnN0IExJQl9TQ0hFTUUgPSAnV2ViRHJpdmVyQWdlbnRMaWInO1xuXG5jb25zdCB4Y29kZUxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ1hjb2RlJyk7XG5cblxuY2xhc3MgWGNvZGVCdWlsZCB7XG4gIGNvbnN0cnVjdG9yICh4Y29kZVZlcnNpb24sIGRldmljZSwgYXJncyA9IHt9KSB7XG4gICAgdGhpcy54Y29kZVZlcnNpb24gPSB4Y29kZVZlcnNpb247XG5cbiAgICB0aGlzLmRldmljZSA9IGRldmljZTtcblxuICAgIHRoaXMucmVhbERldmljZSA9IGFyZ3MucmVhbERldmljZTtcblxuICAgIHRoaXMuYWdlbnRQYXRoID0gYXJncy5hZ2VudFBhdGg7XG4gICAgdGhpcy5ib290c3RyYXBQYXRoID0gYXJncy5ib290c3RyYXBQYXRoO1xuXG4gICAgdGhpcy5wbGF0Zm9ybVZlcnNpb24gPSBhcmdzLnBsYXRmb3JtVmVyc2lvbjtcblxuICAgIHRoaXMuc2hvd1hjb2RlTG9nID0gISFhcmdzLnNob3dYY29kZUxvZztcblxuICAgIHRoaXMueGNvZGVDb25maWdGaWxlID0gYXJncy54Y29kZUNvbmZpZ0ZpbGU7XG4gICAgdGhpcy54Y29kZU9yZ0lkID0gYXJncy54Y29kZU9yZ0lkO1xuICAgIHRoaXMueGNvZGVTaWduaW5nSWQgPSBhcmdzLnhjb2RlU2lnbmluZ0lkIHx8IERFRkFVTFRfU0lHTklOR19JRDtcbiAgICB0aGlzLmtleWNoYWluUGF0aCA9IGFyZ3Mua2V5Y2hhaW5QYXRoO1xuICAgIHRoaXMua2V5Y2hhaW5QYXNzd29yZCA9IGFyZ3Mua2V5Y2hhaW5QYXNzd29yZDtcblxuICAgIHRoaXMucHJlYnVpbGRXREEgPSBhcmdzLnByZWJ1aWxkV0RBO1xuICAgIHRoaXMudXNlUHJlYnVpbHRXREEgPSBhcmdzLnVzZVByZWJ1aWx0V0RBO1xuICAgIHRoaXMudXNlU2ltcGxlQnVpbGRUZXN0ID0gYXJncy51c2VTaW1wbGVCdWlsZFRlc3Q7XG5cbiAgICB0aGlzLnVzZVhjdGVzdHJ1bkZpbGUgPSBhcmdzLnVzZVhjdGVzdHJ1bkZpbGU7XG5cbiAgICB0aGlzLmxhdW5jaFRpbWVvdXQgPSBhcmdzLmxhdW5jaFRpbWVvdXQ7XG5cbiAgICB0aGlzLndkYVJlbW90ZVBvcnQgPSBhcmdzLndkYVJlbW90ZVBvcnQ7XG5cbiAgICB0aGlzLnVwZGF0ZWRXREFCdW5kbGVJZCA9IGFyZ3MudXBkYXRlZFdEQUJ1bmRsZUlkO1xuICAgIHRoaXMuZGVyaXZlZERhdGFQYXRoID0gYXJncy5kZXJpdmVkRGF0YVBhdGg7XG5cbiAgICB0aGlzLm1qcGVnU2VydmVyUG9ydCA9IGFyZ3MubWpwZWdTZXJ2ZXJQb3J0O1xuICB9XG5cbiAgYXN5bmMgaW5pdCAobm9TZXNzaW9uUHJveHkpIHtcbiAgICB0aGlzLm5vU2Vzc2lvblByb3h5ID0gbm9TZXNzaW9uUHJveHk7XG5cbiAgICBpZiAodGhpcy51c2VYY3Rlc3RydW5GaWxlKSB7XG4gICAgICBpZiAodGhpcy54Y29kZVZlcnNpb24ubWFqb3IgPD0gNykge1xuICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdygndXNlWGN0ZXN0cnVuRmlsZSBjYW4gb25seSBiZSB1c2VkIHdpdGggeGNvZGUgdmVyc2lvbiA4IG9ud2FyZHMnKTtcbiAgICAgIH1cbiAgICAgIHRoaXMueGN0ZXN0cnVuRmlsZVBhdGggPSBhd2FpdCBzZXRYY3Rlc3RydW5GaWxlKHRoaXMucmVhbERldmljZSwgdGhpcy5kZXZpY2UudWRpZCwgdGhpcy5wbGF0Zm9ybVZlcnNpb24sIHRoaXMuYm9vdHN0cmFwUGF0aCwgdGhpcy53ZGFSZW1vdGVQb3J0KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy54Y29kZVZlcnNpb24ubWFqb3IgPT09IDcgfHwgKHRoaXMueGNvZGVWZXJzaW9uLm1ham9yID09PSA4ICYmIHRoaXMueGNvZGVWZXJzaW9uLm1pbm9yID09PSAwKSkge1xuICAgICAgbG9nLmRlYnVnKGBVc2luZyBYY29kZSAke3RoaXMueGNvZGVWZXJzaW9uLnZlcnNpb25TdHJpbmd9LCBzbyBmaXhpbmcgV0RBIGNvZGViYXNlYCk7XG4gICAgICBhd2FpdCBmaXhGb3JYY29kZTcodGhpcy5ib290c3RyYXBQYXRoLCB0cnVlKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy54Y29kZVZlcnNpb24ubWFqb3IgPT09IDkpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgVXNpbmcgWGNvZGUgJHt0aGlzLnhjb2RlVmVyc2lvbi52ZXJzaW9uU3RyaW5nfSwgc28gZml4aW5nIFdEQSBjb2RlYmFzZWApO1xuICAgICAgYXdhaXQgZml4Rm9yWGNvZGU5KHRoaXMuYm9vdHN0cmFwUGF0aCwgdHJ1ZSk7XG4gICAgfVxuXG4gICAgLy8gaWYgbmVjZXNzYXJ5LCB1cGRhdGUgdGhlIGJ1bmRsZUlkIHRvIHVzZXIncyBzcGVjaWZpY2F0aW9uXG4gICAgaWYgKHRoaXMucmVhbERldmljZSkge1xuICAgICAgLy8gSW4gY2FzZSB0aGUgcHJvamVjdCBzdGlsbCBoYXMgdGhlIHVzZXIgc3BlY2lmaWMgYnVuZGxlIElELCByZXNldCB0aGUgcHJvamVjdCBmaWxlIGZpcnN0LlxuICAgICAgLy8gLSBXZSBkbyB0aGlzIHJlc2V0IGV2ZW4gaWYgdXBkYXRlZFdEQUJ1bmRsZUlkIGlzIG5vdCBzcGVjaWZpZWQsXG4gICAgICAvLyAgIHNpbmNlIHRoZSBwcmV2aW91cyB1cGRhdGVkV0RBQnVuZGxlSWQgdGVzdCBoYXMgZ2VuZXJhdGVkIHRoZSB1c2VyIHNwZWNpZmljIGJ1bmRsZSBJRCBwcm9qZWN0IGZpbGUuXG4gICAgICAvLyAtIFdlIGRvbid0IGNhbGwgcmVzZXRQcm9qZWN0RmlsZSBmb3Igc2ltdWxhdG9yLFxuICAgICAgLy8gICBzaW5jZSBzaW11bGF0b3IgdGVzdCBydW4gd2lsbCB3b3JrIHdpdGggYW55IHVzZXIgc3BlY2lmaWMgYnVuZGxlIElELlxuICAgICAgYXdhaXQgcmVzZXRQcm9qZWN0RmlsZSh0aGlzLmFnZW50UGF0aCk7XG4gICAgICBpZiAodGhpcy51cGRhdGVkV0RBQnVuZGxlSWQpIHtcbiAgICAgICAgYXdhaXQgdXBkYXRlUHJvamVjdEZpbGUodGhpcy5hZ2VudFBhdGgsIHRoaXMudXBkYXRlZFdEQUJ1bmRsZUlkKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyByZXRyaWV2ZURlcml2ZWREYXRhUGF0aCAoKSB7XG4gICAgaWYgKHRoaXMuZGVyaXZlZERhdGFQYXRoKSB7XG4gICAgICByZXR1cm4gdGhpcy5kZXJpdmVkRGF0YVBhdGg7XG4gICAgfVxuXG4gICAgbGV0IHN0ZG91dDtcbiAgICB0cnkge1xuICAgICAgKHtzdGRvdXR9ID0gYXdhaXQgZXhlYygneGNvZGVidWlsZCcsIFsnLXByb2plY3QnLCB0aGlzLmFnZW50UGF0aCwgJy1zaG93QnVpbGRTZXR0aW5ncyddKSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgQ2Fubm90IHJldHJpZXZlIFdEQSBidWlsZCBzZXR0aW5ncy4gT3JpZ2luYWwgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgcGF0dGVybiA9IC9eXFxzKkJVSUxEX0RJUlxccys9XFxzKyhcXC8uKikvbTtcbiAgICBjb25zdCBtYXRjaCA9IHBhdHRlcm4uZXhlYyhzdGRvdXQpO1xuICAgIGlmICghbWF0Y2gpIHtcbiAgICAgIGxvZy53YXJuKGBDYW5ub3QgcGFyc2UgV0RBIGJ1aWxkIGRpciBmcm9tICR7Xy50cnVuY2F0ZShzdGRvdXQsIHtsZW5ndGg6IDMwMH0pfWApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYFBhcnNlZCBCVUlMRF9ESVIgY29uZmlndXJhdGlvbiB2YWx1ZTogJyR7bWF0Y2hbMV19J2ApO1xuICAgIC8vIERlcml2ZWQgZGF0YSByb290IGlzIHR3byBsZXZlbHMgaGlnaGVyIG92ZXIgdGhlIGJ1aWxkIGRpclxuICAgIHRoaXMuZGVyaXZlZERhdGFQYXRoID0gcGF0aC5kaXJuYW1lKHBhdGguZGlybmFtZShwYXRoLm5vcm1hbGl6ZShtYXRjaFsxXSkpKTtcbiAgICBsb2cuZGVidWcoYEdvdCBkZXJpdmVkIGRhdGEgcm9vdDogJyR7dGhpcy5kZXJpdmVkRGF0YVBhdGh9J2ApO1xuICAgIHJldHVybiB0aGlzLmRlcml2ZWREYXRhUGF0aDtcbiAgfVxuXG4gIGFzeW5jIHJlc2V0ICgpIHtcbiAgICAvLyBpZiBuZWNlc3NhcnksIHJlc2V0IHRoZSBidW5kbGVJZCB0byBvcmlnaW5hbCB2YWx1ZVxuICAgIGlmICh0aGlzLnJlYWxEZXZpY2UgJiYgdGhpcy51cGRhdGVkV0RBQnVuZGxlSWQpIHtcbiAgICAgIGF3YWl0IHJlc2V0UHJvamVjdEZpbGUodGhpcy5hZ2VudFBhdGgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHByZWJ1aWxkICgpIHtcbiAgICBpZiAodGhpcy54Y29kZVZlcnNpb24ubWFqb3IgPT09IDcpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgQ2FwYWJpbGl0eSAncHJlYnVpbGRXREEnIHNldCwgYnV0IG9uIHhjb2RlIHZlcnNpb24gJHt0aGlzLnhjb2RlVmVyc2lvbi52ZXJzaW9uU3RyaW5nfSBzbyBza2lwcGluZ2ApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGZpcnN0IGRvIGEgYnVpbGQgcGhhc2VcbiAgICBsb2cuZGVidWcoJ1ByZS1idWlsZGluZyBXREEgYmVmb3JlIGxhdW5jaGluZyB0ZXN0Jyk7XG4gICAgdGhpcy51c2VQcmVidWlsdFdEQSA9IHRydWU7XG4gICAgdGhpcy54Y29kZWJ1aWxkID0gYXdhaXQgdGhpcy5jcmVhdGVTdWJQcm9jZXNzKHRydWUpO1xuICAgIGF3YWl0IHRoaXMuc3RhcnQodHJ1ZSk7XG5cbiAgICB0aGlzLnhjb2RlYnVpbGQgPSBudWxsO1xuXG4gICAgLy8gcGF1c2UgYSBtb21lbnRcbiAgICBhd2FpdCBCLmRlbGF5KEJVSUxEX1RFU1RfREVMQVkpO1xuICB9XG5cbiAgYXN5bmMgY2xlYW5Qcm9qZWN0ICgpIHtcbiAgICBmb3IgKGNvbnN0IHNjaGVtZSBvZiBbTElCX1NDSEVNRSwgUlVOTkVSX1NDSEVNRV0pIHtcbiAgICAgIGxvZy5kZWJ1ZyhgQ2xlYW5pbmcgdGhlIHByb2plY3Qgc2NoZW1lICcke3NjaGVtZX0nIHRvIG1ha2Ugc3VyZSB0aGVyZSBhcmUgbm8gbGVmdG92ZXJzIGZyb20gcHJldmlvdXMgaW5zdGFsbHNgKTtcbiAgICAgIGF3YWl0IGV4ZWMoJ3hjb2RlYnVpbGQnLCBbXG4gICAgICAgICdjbGVhbicsXG4gICAgICAgICctcHJvamVjdCcsIHRoaXMuYWdlbnRQYXRoLFxuICAgICAgICAnLXNjaGVtZScsIHNjaGVtZSxcbiAgICAgIF0pO1xuICAgIH1cbiAgfVxuXG4gIGdldENvbW1hbmQgKGJ1aWxkT25seSA9IGZhbHNlKSB7XG4gICAgbGV0IGNtZCA9ICd4Y29kZWJ1aWxkJztcbiAgICBsZXQgYXJncztcblxuICAgIC8vIGZpZ3VyZSBvdXQgdGhlIHRhcmdldHMgZm9yIHhjb2RlYnVpbGRcbiAgICBpZiAodGhpcy54Y29kZVZlcnNpb24ubWFqb3IgPCA4KSB7XG4gICAgICBhcmdzID0gW1xuICAgICAgICAnYnVpbGQnLFxuICAgICAgICAndGVzdCcsXG4gICAgICBdO1xuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgW2J1aWxkQ21kLCB0ZXN0Q21kXSA9IHRoaXMudXNlU2ltcGxlQnVpbGRUZXN0ID8gWydidWlsZCcsICd0ZXN0J10gOiBbJ2J1aWxkLWZvci10ZXN0aW5nJywgJ3Rlc3Qtd2l0aG91dC1idWlsZGluZyddO1xuICAgICAgaWYgKGJ1aWxkT25seSkge1xuICAgICAgICBhcmdzID0gW2J1aWxkQ21kXTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy51c2VQcmVidWlsdFdEQSB8fCB0aGlzLnVzZVhjdGVzdHJ1bkZpbGUpIHtcbiAgICAgICAgYXJncyA9IFt0ZXN0Q21kXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFyZ3MgPSBbYnVpbGRDbWQsIHRlc3RDbWRdO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLnVzZVhjdGVzdHJ1bkZpbGUpIHtcbiAgICAgIGFyZ3MucHVzaCgnLXhjdGVzdHJ1bicsIHRoaXMueGN0ZXN0cnVuRmlsZVBhdGgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhcmdzLnB1c2goJy1wcm9qZWN0JywgdGhpcy5hZ2VudFBhdGgsICctc2NoZW1lJywgUlVOTkVSX1NDSEVNRSk7XG4gICAgICBpZiAodGhpcy5kZXJpdmVkRGF0YVBhdGgpIHtcbiAgICAgICAgYXJncy5wdXNoKCctZGVyaXZlZERhdGFQYXRoJywgdGhpcy5kZXJpdmVkRGF0YVBhdGgpO1xuICAgICAgfVxuICAgIH1cbiAgICBhcmdzLnB1c2goJy1kZXN0aW5hdGlvbicsIGBpZD0ke3RoaXMuZGV2aWNlLnVkaWR9YCk7XG5cbiAgICBjb25zdCB2ZXJzaW9uTWF0Y2ggPSBuZXcgUmVnRXhwKC9eKFxcZCspXFwuKFxcZCspLykuZXhlYyh0aGlzLnBsYXRmb3JtVmVyc2lvbik7XG4gICAgaWYgKHZlcnNpb25NYXRjaCkge1xuICAgICAgYXJncy5wdXNoKGBJUEhPTkVPU19ERVBMT1lNRU5UX1RBUkdFVD0ke3ZlcnNpb25NYXRjaFsxXX0uJHt2ZXJzaW9uTWF0Y2hbMl19YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy53YXJuKGBDYW5ub3QgcGFyc2UgbWFqb3IgYW5kIG1pbm9yIHZlcnNpb24gbnVtYmVycyBmcm9tIHBsYXRmb3JtVmVyc2lvbiBcIiR7dGhpcy5wbGF0Zm9ybVZlcnNpb259XCIuIGAgK1xuICAgICAgICAgICAgICAgJ1dpbGwgYnVpbGQgZm9yIHRoZSBkZWZhdWx0IHBsYXRmb3JtIGluc3RlYWQnKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5yZWFsRGV2aWNlICYmIHRoaXMueGNvZGVDb25maWdGaWxlKSB7XG4gICAgICBsb2cuZGVidWcoYFVzaW5nIFhjb2RlIGNvbmZpZ3VyYXRpb24gZmlsZTogJyR7dGhpcy54Y29kZUNvbmZpZ0ZpbGV9J2ApO1xuICAgICAgYXJncy5wdXNoKCcteGNjb25maWcnLCB0aGlzLnhjb2RlQ29uZmlnRmlsZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtjbWQsIGFyZ3N9O1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlU3ViUHJvY2VzcyAoYnVpbGRPbmx5ID0gZmFsc2UpIHtcbiAgICBpZiAoIXRoaXMudXNlWGN0ZXN0cnVuRmlsZSkge1xuICAgICAgaWYgKHRoaXMucmVhbERldmljZSkge1xuICAgICAgICBpZiAodGhpcy5rZXljaGFpblBhdGggJiYgdGhpcy5rZXljaGFpblBhc3N3b3JkKSB7XG4gICAgICAgICAgYXdhaXQgc2V0UmVhbERldmljZVNlY3VyaXR5KHRoaXMua2V5Y2hhaW5QYXRoLCB0aGlzLmtleWNoYWluUGFzc3dvcmQpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnhjb2RlT3JnSWQgJiYgdGhpcy54Y29kZVNpZ25pbmdJZCAmJiAhdGhpcy54Y29kZUNvbmZpZ0ZpbGUpIHtcbiAgICAgICAgICB0aGlzLnhjb2RlQ29uZmlnRmlsZSA9IGF3YWl0IGdlbmVyYXRlWGNvZGVDb25maWdGaWxlKHRoaXMueGNvZGVPcmdJZCwgdGhpcy54Y29kZVNpZ25pbmdJZCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCB7Y21kLCBhcmdzfSA9IHRoaXMuZ2V0Q29tbWFuZChidWlsZE9ubHkpO1xuICAgIGxvZy5kZWJ1ZyhgQmVnaW5uaW5nICR7YnVpbGRPbmx5ID8gJ2J1aWxkJyA6ICd0ZXN0J30gd2l0aCBjb21tYW5kICcke2NtZH0gJHthcmdzLmpvaW4oJyAnKX0nIGAgK1xuICAgICAgICAgICAgICBgaW4gZGlyZWN0b3J5ICcke3RoaXMuYm9vdHN0cmFwUGF0aH0nYCk7XG4gICAgY29uc3QgZW52ID0gT2JqZWN0LmFzc2lnbih7fSwgcHJvY2Vzcy5lbnYsIHtcbiAgICAgIFVTRV9QT1JUOiB0aGlzLndkYVJlbW90ZVBvcnQsXG4gICAgICBXREFfUFJPRFVDVF9CVU5ETEVfSURFTlRJRklFUjogdGhpcy51cGRhdGVkV0RBQnVuZGxlSWQgfHwgV0RBX1JVTk5FUl9CVU5ETEVfSUQsXG4gICAgfSk7XG4gICAgaWYgKHRoaXMubWpwZWdTZXJ2ZXJQb3J0KSB7XG4gICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL1dlYkRyaXZlckFnZW50L3B1bGwvMTA1XG4gICAgICBlbnYuTUpQRUdfU0VSVkVSX1BPUlQgPSB0aGlzLm1qcGVnU2VydmVyUG9ydDtcbiAgICB9XG4gICAgY29uc3QgdXBncmFkZVRpbWVzdGFtcCA9IGF3YWl0IGdldFdEQVVwZ3JhZGVUaW1lc3RhbXAodGhpcy5ib290c3RyYXBQYXRoKTtcbiAgICBpZiAodXBncmFkZVRpbWVzdGFtcCkge1xuICAgICAgZW52LlVQR1JBREVfVElNRVNUQU1QID0gdXBncmFkZVRpbWVzdGFtcDtcbiAgICB9XG4gICAgY29uc3QgeGNvZGVidWlsZCA9IG5ldyBTdWJQcm9jZXNzKGNtZCwgYXJncywge1xuICAgICAgY3dkOiB0aGlzLmJvb3RzdHJhcFBhdGgsXG4gICAgICBlbnYsXG4gICAgICBkZXRhY2hlZDogdHJ1ZSxcbiAgICAgIHN0ZGlvOiBbJ2lnbm9yZScsICdwaXBlJywgJ3BpcGUnXSxcbiAgICB9KTtcblxuICAgIGxldCBsb2dYY29kZU91dHB1dCA9IHRoaXMuc2hvd1hjb2RlTG9nO1xuICAgIGxvZy5kZWJ1ZyhgT3V0cHV0IGZyb20geGNvZGVidWlsZCAke2xvZ1hjb2RlT3V0cHV0ID8gJ3dpbGwnIDogJ3dpbGwgbm90J30gYmUgbG9nZ2VkLiBUbyBjaGFuZ2UgdGhpcywgdXNlICdzaG93WGNvZGVMb2cnIGRlc2lyZWQgY2FwYWJpbGl0eWApO1xuICAgIHhjb2RlYnVpbGQub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgbGV0IG91dCA9IHN0ZG91dCB8fCBzdGRlcnI7XG4gICAgICAvLyB3ZSB3YW50IHRvIHB1bGwgb3V0IHRoZSBsb2cgZmlsZSB0aGF0IGlzIGNyZWF0ZWQsIGFuZCBoaWdobGlnaHQgaXRcbiAgICAgIC8vIGZvciBkaWFnbm9zdGljIHB1cnBvc2VzXG4gICAgICBpZiAob3V0LmluZGV4T2YoJ1dyaXRpbmcgZGlhZ25vc3RpYyBsb2cgZm9yIHRlc3Qgc2Vzc2lvbiB0bycpICE9PSAtMSkge1xuICAgICAgICAvLyBwdWxsIG91dCB0aGUgZmlyc3QgbGluZSB0aGF0IGJlZ2lucyB3aXRoIHRoZSBwYXRoIHNlcGFyYXRvclxuICAgICAgICAvLyB3aGljaCAqc2hvdWxkKiBiZSB0aGUgbGluZSBpbmRpY2F0aW5nIHRoZSBsb2cgZmlsZSBnZW5lcmF0ZWRcbiAgICAgICAgeGNvZGVidWlsZC5sb2dMb2NhdGlvbiA9IF8uZmlyc3QoXy5yZW1vdmUob3V0LnRyaW0oKS5zcGxpdCgnXFxuJyksICh2KSA9PiB2LmluZGV4T2YocGF0aC5zZXApID09PSAwKSk7XG4gICAgICAgIGxvZy5kZWJ1ZyhgTG9nIGZpbGUgZm9yIHhjb2RlYnVpbGQgdGVzdDogJHt4Y29kZWJ1aWxkLmxvZ0xvY2F0aW9ufWApO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiB3ZSBoYXZlIGFuIGVycm9yIHdlIHdhbnQgdG8gb3V0cHV0IHRoZSBsb2dzXG4gICAgICAvLyBvdGhlcndpc2UgdGhlIGZhaWx1cmUgaXMgaW5zY3J1dGlibGVcbiAgICAgIC8vIGJ1dCBkbyBub3QgbG9nIHBlcm1pc3Npb24gZXJyb3JzIGZyb20gdHJ5aW5nIHRvIHdyaXRlIHRvIGF0dGFjaG1lbnRzIGZvbGRlclxuICAgICAgaWYgKG91dC5pbmRleE9mKCdFcnJvciBEb21haW49JykgIT09IC0xICYmXG4gICAgICAgICAgb3V0LmluZGV4T2YoJ0Vycm9yIHdyaXRpbmcgYXR0YWNobWVudCBkYXRhIHRvIGZpbGUnKSA9PT0gLTEgJiZcbiAgICAgICAgICBvdXQuaW5kZXhPZignRmFpbGVkIHRvIHJlbW92ZSBzY3JlZW5zaG90IGF0IHBhdGgnKSA9PT0gLTEpIHtcbiAgICAgICAgbG9nWGNvZGVPdXRwdXQgPSB0cnVlO1xuXG4gICAgICAgIC8vIHRlcnJpYmxlIGhhY2sgdG8gaGFuZGxlIGNhc2Ugd2hlcmUgeGNvZGUgcmV0dXJuIDAgYnV0IGlzIGZhaWxpbmdcbiAgICAgICAgeGNvZGVidWlsZC5fd2RhX2Vycm9yX29jY3VycmVkID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKGxvZ1hjb2RlT3V0cHV0KSB7XG4gICAgICAgIC8vIGRvIG5vdCBsb2cgcGVybWlzc2lvbiBlcnJvcnMgZnJvbSB0cnlpbmcgdG8gd3JpdGUgdG8gYXR0YWNobWVudHMgZm9sZGVyXG4gICAgICAgIGlmIChvdXQuaW5kZXhPZignRXJyb3Igd3JpdGluZyBhdHRhY2htZW50IGRhdGEgdG8gZmlsZScpID09PSAtMSkge1xuICAgICAgICAgIGZvciAobGV0IGxpbmUgb2Ygb3V0LnNwbGl0KCdcXG4nKSkge1xuICAgICAgICAgICAgeGNvZGVMb2cuaW5mbyhsaW5lKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiB4Y29kZWJ1aWxkO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKGJ1aWxkT25seSA9IGZhbHNlKSB7XG4gICAgdGhpcy54Y29kZWJ1aWxkID0gYXdhaXQgdGhpcy5jcmVhdGVTdWJQcm9jZXNzKGJ1aWxkT25seSk7XG5cbiAgICAvLyB3cmFwIHRoZSBzdGFydCBwcm9jZWR1cmUgaW4gYSBwcm9taXNlIHNvIHRoYXQgd2UgY2FuIGNhdGNoLCBhbmQgcmVwb3J0LFxuICAgIC8vIGFueSBzdGFydHVwIGVycm9ycyB0aGF0IGFyZSB0aHJvd24gYXMgZXZlbnRzXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMueGNvZGVidWlsZC5vbignZXhpdCcsIGFzeW5jIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgICAgbG9nLmluZm8oYHhjb2RlYnVpbGQgZXhpdGVkIHdpdGggY29kZSAnJHtjb2RlfScgYW5kIHNpZ25hbCAnJHtzaWduYWx9J2ApO1xuICAgICAgICAvLyBwcmludCBvdXQgdGhlIHhjb2RlYnVpbGQgZmlsZSBpZiB1c2VycyBoYXZlIGFza2VkIGZvciBpdFxuICAgICAgICBpZiAodGhpcy5zaG93WGNvZGVMb2cgJiYgdGhpcy54Y29kZWJ1aWxkLmxvZ0xvY2F0aW9uKSB7XG4gICAgICAgICAgeGNvZGVMb2cuaW5mbyhgQ29udGVudHMgb2YgeGNvZGVidWlsZCBsb2cgZmlsZSAnJHt0aGlzLnhjb2RlYnVpbGQubG9nTG9jYXRpb259JzpgKTtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgbGV0IGRhdGEgPSBhd2FpdCBmcy5yZWFkRmlsZSh0aGlzLnhjb2RlYnVpbGQubG9nTG9jYXRpb24sICd1dGY4Jyk7XG4gICAgICAgICAgICBmb3IgKGxldCBsaW5lIG9mIGRhdGEuc3BsaXQoJ1xcbicpKSB7XG4gICAgICAgICAgICAgIHhjb2RlTG9nLmluZm8obGluZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBsb2cuZGVidWcoYFVuYWJsZSB0byBhY2Nlc3MgeGNvZGVidWlsZCBsb2cgZmlsZTogJyR7ZXJyLm1lc3NhZ2V9J2ApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLnhjb2RlYnVpbGQucHJvY2Vzc0V4aXRlZCA9IHRydWU7XG4gICAgICAgIGlmICh0aGlzLnhjb2RlYnVpbGQuX3dkYV9lcnJvcl9vY2N1cnJlZCB8fCAoIXNpZ25hbCAmJiBjb2RlICE9PSAwKSkge1xuICAgICAgICAgIHJldHVybiByZWplY3QobmV3IEVycm9yKGB4Y29kZWJ1aWxkIGZhaWxlZCB3aXRoIGNvZGUgJHtjb2RlfWApKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBpbiB0aGUgY2FzZSBvZiBqdXN0IGJ1aWxkaW5nLCB0aGUgcHJvY2VzcyB3aWxsIGV4aXQgYW5kIHRoYXQgaXMgb3VyIGZpbmlzaFxuICAgICAgICBpZiAoYnVpbGRPbmx5KSB7XG4gICAgICAgICAgcmV0dXJuIHJlc29sdmUoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiAoYXN5bmMgKCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGxldCBzdGFydFRpbWUgPSBwcm9jZXNzLmhydGltZSgpO1xuICAgICAgICAgIGF3YWl0IHRoaXMueGNvZGVidWlsZC5zdGFydCh0cnVlKTtcbiAgICAgICAgICBpZiAoIWJ1aWxkT25seSkge1xuICAgICAgICAgICAgbGV0IHN0YXR1cyA9IGF3YWl0IHRoaXMud2FpdEZvclN0YXJ0KHN0YXJ0VGltZSk7XG4gICAgICAgICAgICByZXNvbHZlKHN0YXR1cyk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBsZXQgbXNnID0gYFVuYWJsZSB0byBzdGFydCBXZWJEcml2ZXJBZ2VudDogJHtlcnJ9YDtcbiAgICAgICAgICBsb2cuZXJyb3IobXNnKTtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKG1zZykpO1xuICAgICAgICB9XG4gICAgICB9KSgpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgd2FpdEZvclN0YXJ0IChzdGFydFRpbWUpIHtcbiAgICAvLyB0cnkgdG8gY29ubmVjdCBvbmNlIGV2ZXJ5IDAuNSBzZWNvbmRzLCB1bnRpbCBgbGF1bmNoVGltZW91dGAgaXMgdXBcbiAgICBsb2cuZGVidWcoYFdhaXRpbmcgdXAgdG8gJHt0aGlzLmxhdW5jaFRpbWVvdXR9bXMgZm9yIFdlYkRyaXZlckFnZW50IHRvIHN0YXJ0YCk7XG4gICAgbGV0IGN1cnJlbnRTdGF0dXMgPSBudWxsO1xuICAgIHRyeSB7XG4gICAgICBsZXQgcmV0cmllcyA9IHBhcnNlSW50KHRoaXMubGF1bmNoVGltZW91dCAvIDUwMCwgMTApO1xuICAgICAgYXdhaXQgcmV0cnlJbnRlcnZhbChyZXRyaWVzLCAxMDAwLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLnhjb2RlYnVpbGQucHJvY2Vzc0V4aXRlZCkge1xuICAgICAgICAgIC8vIHRoZXJlIGhhcyBiZWVuIGFuIGVycm9yIGVsc2V3aGVyZSBhbmQgd2UgbmVlZCB0byBzaG9ydC1jaXJjdWl0XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHByb3h5VGltZW91dCA9IHRoaXMubm9TZXNzaW9uUHJveHkudGltZW91dDtcbiAgICAgICAgdGhpcy5ub1Nlc3Npb25Qcm94eS50aW1lb3V0ID0gMTAwMDtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjdXJyZW50U3RhdHVzID0gYXdhaXQgdGhpcy5ub1Nlc3Npb25Qcm94eS5jb21tYW5kKCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgICAgICAgIGlmIChjdXJyZW50U3RhdHVzICYmIGN1cnJlbnRTdGF0dXMuaW9zICYmIGN1cnJlbnRTdGF0dXMuaW9zLmlwKSB7XG4gICAgICAgICAgICB0aGlzLmFnZW50VXJsID0gY3VycmVudFN0YXR1cy5pb3MuaXA7XG4gICAgICAgICAgfVxuICAgICAgICAgIGxvZy5kZWJ1ZyhgV2ViRHJpdmVyQWdlbnQgaW5mb3JtYXRpb246YCk7XG4gICAgICAgICAgbG9nLmRlYnVnKEpTT04uc3RyaW5naWZ5KGN1cnJlbnRTdGF0dXMsIG51bGwsIDIpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gY29ubmVjdCB0byBydW5uaW5nIFdlYkRyaXZlckFnZW50OiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgIHRoaXMubm9TZXNzaW9uUHJveHkudGltZW91dCA9IHByb3h5VGltZW91dDtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGlmICh0aGlzLnhjb2RlYnVpbGQucHJvY2Vzc0V4aXRlZCkge1xuICAgICAgICAvLyB0aGVyZSBoYXMgYmVlbiBhbiBlcnJvciBlbHNld2hlcmUgYW5kIHdlIG5lZWQgdG8gc2hvcnQtY2lyY3VpdFxuICAgICAgICByZXR1cm4gY3VycmVudFN0YXR1cztcbiAgICAgIH1cblxuICAgICAgbGV0IGVuZFRpbWUgPSBwcm9jZXNzLmhydGltZShzdGFydFRpbWUpO1xuICAgICAgLy8gbXVzdCBnZXQgW3MsIG5zXSBhcnJheSBpbnRvIG1zXG4gICAgICBsZXQgc3RhcnR1cFRpbWUgPSBwYXJzZUludCgoZW5kVGltZVswXSAqIDFlOSArIGVuZFRpbWVbMV0pIC8gMWU2LCAxMCk7XG4gICAgICBsb2cuZGVidWcoYFdlYkRyaXZlckFnZW50IHN1Y2Nlc3NmdWxseSBzdGFydGVkIGFmdGVyICR7c3RhcnR1cFRpbWV9bXNgKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIGlmIHdlIGhhdmUgbm90IGhhZCBhbnkgZXJyb3JzIGZyb20geGNvZGUgaXRzZWxmIChyZXBvcnRlZFxuICAgICAgLy8gZWxzZXdoZXJlKSwgd2UgY2FuIGxldCB0aGlzIGdvIHRocm91Z2ggYW5kIHRyeSB0byBjcmVhdGUgdGhlIHNlc3Npb25cbiAgICAgIGxvZy5kZWJ1ZyhlcnIubWVzc2FnZSk7XG4gICAgICBsb2cud2FybihgR2V0dGluZyBzdGF0dXMgb2YgV2ViRHJpdmVyQWdlbnQgb24gZGV2aWNlIHRpbWVkIG91dC4gQ29udGludWluZ2ApO1xuICAgIH1cbiAgICByZXR1cm4gY3VycmVudFN0YXR1cztcbiAgfVxuXG4gIGFzeW5jIHF1aXQgKCkge1xuICAgIGF3YWl0IGtpbGxQcm9jZXNzKCd4Y29kZWJ1aWxkJywgdGhpcy54Y29kZWJ1aWxkKTtcbiAgfVxufVxuXG5leHBvcnQgeyBYY29kZUJ1aWxkIH07XG5leHBvcnQgZGVmYXVsdCBYY29kZUJ1aWxkO1xuIl0sImZpbGUiOiJsaWIvd2RhL3hjb2RlYnVpbGQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
