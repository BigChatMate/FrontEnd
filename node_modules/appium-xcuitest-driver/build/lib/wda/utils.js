"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.updateProjectFile = updateProjectFile;
exports.resetProjectFile = resetProjectFile;
exports.checkForDependencies = checkForDependencies;
exports.setRealDeviceSecurity = setRealDeviceSecurity;
exports.fixForXcode7 = fixForXcode7;
exports.fixForXcode9 = fixForXcode9;
exports.generateXcodeConfigFile = generateXcodeConfigFile;
exports.setXctestrunFile = setXctestrunFile;
exports.killProcess = killProcess;
exports.randomInt = randomInt;
exports.getWDAUpgradeTimestamp = getWDAUpgradeTimestamp;
exports.WDA_RUNNER_BUNDLE_ID = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _logger = _interopRequireDefault(require("../logger"));

var _lodash = _interopRequireDefault(require("lodash"));

const WDA_RUNNER_BUNDLE_ID = 'com.facebook.WebDriverAgentRunner';
exports.WDA_RUNNER_BUNDLE_ID = WDA_RUNNER_BUNDLE_ID;
const PROJECT_FILE = 'project.pbxproj';
const XCUICOORDINATE_FILE = 'PrivateHeaders/XCTest/XCUICoordinate.h';
const FBMACROS_FILE = 'WebDriverAgentLib/Utilities/FBMacros.h';
const XCUIAPPLICATION_FILE = 'PrivateHeaders/XCTest/XCUIApplication.h';
const FBSESSION_FILE = 'WebDriverAgentLib/Routing/FBSession.m';
const CARTHAGE_ROOT = 'Carthage';

function replaceInFile(_x, _x2, _x3) {
  return _replaceInFile.apply(this, arguments);
}

function _replaceInFile() {
  _replaceInFile = (0, _asyncToGenerator2.default)(function* (file, find, replace) {
    let contents = yield _appiumSupport.fs.readFile(file, 'utf8');
    let newContents = contents.replace(find, replace);

    if (newContents !== contents) {
      yield _appiumSupport.fs.writeFile(file, newContents, 'utf8');
    }
  });
  return _replaceInFile.apply(this, arguments);
}

function updateProjectFile(_x4, _x5) {
  return _updateProjectFile.apply(this, arguments);
}

function _updateProjectFile() {
  _updateProjectFile = (0, _asyncToGenerator2.default)(function* (agentPath, newBundleId) {
    let projectFilePath = `${agentPath}/${PROJECT_FILE}`;

    try {
      yield _appiumSupport.fs.copyFile(projectFilePath, `${projectFilePath}.old`);
      yield replaceInFile(projectFilePath, new RegExp(WDA_RUNNER_BUNDLE_ID.replace('.', '\.'), 'g'), newBundleId);

      _logger.default.debug(`Successfully updated '${projectFilePath}' with bundle id '${newBundleId}'`);
    } catch (err) {
      _logger.default.debug(`Error updating project file: ${err.message}`);

      _logger.default.warn(`Unable to update project file '${projectFilePath}' with ` + `bundle id '${newBundleId}'. WebDriverAgent may not start`);
    }
  });
  return _updateProjectFile.apply(this, arguments);
}

function resetProjectFile(_x6) {
  return _resetProjectFile.apply(this, arguments);
}

function _resetProjectFile() {
  _resetProjectFile = (0, _asyncToGenerator2.default)(function* (agentPath) {
    let projectFilePath = `${agentPath}/${PROJECT_FILE}`;

    try {
      if (!(yield _appiumSupport.fs.exists(`${projectFilePath}.old`))) {
        return;
      }

      yield _appiumSupport.fs.mv(`${projectFilePath}.old`, projectFilePath);

      _logger.default.debug(`Successfully reset '${projectFilePath}' with bundle id '${WDA_RUNNER_BUNDLE_ID}'`);
    } catch (err) {
      _logger.default.debug(`Error resetting project file: ${err.message}`);

      _logger.default.warn(`Unable to reset project file '${projectFilePath}' with ` + `bundle id '${WDA_RUNNER_BUNDLE_ID}'. WebDriverAgent has been ` + `modified and not returned to the original state.`);
    }
  });
  return _resetProjectFile.apply(this, arguments);
}

function checkForDependencies(_x7) {
  return _checkForDependencies.apply(this, arguments);
}

function _checkForDependencies() {
  _checkForDependencies = (0, _asyncToGenerator2.default)(function* (bootstrapPath, useSsl = false) {
    try {
      let carthagePath = yield _appiumSupport.fs.which('carthage');

      _logger.default.debug(`Carthage found: '${carthagePath}'`);
    } catch (err) {
      _logger.default.errorAndThrow('Carthage binary is not found. Install using `brew install carthage` if it is not installed ' + 'and make sure the root folder, where carthage binary is installed, is present in PATH environment variable. ' + `The current PATH value: '${process.env.PATH ? process.env.PATH : "<not defined for the Appium process>"}'`);
    }

    const carthageRoot = _path.default.resolve(bootstrapPath, CARTHAGE_ROOT);

    let areDependenciesUpdated = false;

    if (!(yield _appiumSupport.fs.hasAccess(carthageRoot))) {
      _logger.default.debug('Running WebDriverAgent bootstrap script to install dependencies');

      try {
        let args = useSsl ? ['-d', '-D'] : ['-d'];
        yield (0, _teen_process.exec)('Scripts/bootstrap.sh', args, {
          cwd: bootstrapPath
        });
        areDependenciesUpdated = true;
      } catch (err) {
        var _arr = ['stdout', 'stderr'];

        for (var _i = 0; _i < _arr.length; _i++) {
          let std = _arr[_i];
          var _iteratorNormalCompletion = true;
          var _didIteratorError = false;
          var _iteratorError = undefined;

          try {
            for (var _iterator = (err[std] || '').split('\n')[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
              let line = _step.value;

              if (!line.length) {
                continue;
              }

              _logger.default.error(line);
            }
          } catch (err) {
            _didIteratorError = true;
            _iteratorError = err;
          } finally {
            try {
              if (!_iteratorNormalCompletion && _iterator.return != null) {
                _iterator.return();
              }
            } finally {
              if (_didIteratorError) {
                throw _iteratorError;
              }
            }
          }
        }

        yield _appiumSupport.fs.rimraf(carthageRoot);
        throw err;
      }
    }

    if (!(yield _appiumSupport.fs.hasAccess(`${bootstrapPath}/Resources`))) {
      _logger.default.debug('Creating WebDriverAgent resources directory');

      yield _appiumSupport.fs.mkdir(`${bootstrapPath}/Resources`);
      areDependenciesUpdated = true;
    }

    if (!(yield _appiumSupport.fs.hasAccess(`${bootstrapPath}/Resources/WebDriverAgent.bundle`))) {
      _logger.default.debug('Creating WebDriverAgent resource bundle directory');

      yield _appiumSupport.fs.mkdir(`${bootstrapPath}/Resources/WebDriverAgent.bundle`);
      areDependenciesUpdated = true;
    }

    return areDependenciesUpdated;
  });
  return _checkForDependencies.apply(this, arguments);
}

function setRealDeviceSecurity(_x8, _x9) {
  return _setRealDeviceSecurity.apply(this, arguments);
}

function _setRealDeviceSecurity() {
  _setRealDeviceSecurity = (0, _asyncToGenerator2.default)(function* (keychainPath, keychainPassword) {
    _logger.default.debug('Setting security for iOS device');

    yield (0, _teen_process.exec)('security', ['-v', 'list-keychains', '-s', keychainPath]);
    yield (0, _teen_process.exec)('security', ['-v', 'unlock-keychain', '-p', keychainPassword, keychainPath]);
    yield (0, _teen_process.exec)('security', ['set-keychain-settings', '-t', '3600', '-l', keychainPath]);
  });
  return _setRealDeviceSecurity.apply(this, arguments);
}

function fixXCUICoordinateFile(_x10) {
  return _fixXCUICoordinateFile.apply(this, arguments);
}

function _fixXCUICoordinateFile() {
  _fixXCUICoordinateFile = (0, _asyncToGenerator2.default)(function* (bootstrapPath, initial = true) {
    const file = _path.default.resolve(bootstrapPath, XCUICOORDINATE_FILE);

    let oldDef = '- (void)pressForDuration:(double)arg1 thenDragToCoordinate:(id)arg2;';
    let newDef = '- (void)pressForDuration:(NSTimeInterval)duration thenDragToCoordinate:(XCUICoordinate *)otherCoordinate;';

    if (!initial) {
      var _ref = [newDef, oldDef];
      oldDef = _ref[0];
      newDef = _ref[1];
    }

    yield replaceInFile(file, oldDef, newDef);
  });
  return _fixXCUICoordinateFile.apply(this, arguments);
}

function fixFBSessionFile(_x11) {
  return _fixFBSessionFile.apply(this, arguments);
}

function _fixFBSessionFile() {
  _fixFBSessionFile = (0, _asyncToGenerator2.default)(function* (bootstrapPath, initial = true) {
    const file = _path.default.resolve(bootstrapPath, FBSESSION_FILE);

    let oldLine = 'return [FBApplication fb_activeApplication] ?: self.testedApplication;';
    let newLine = 'FBApplication *application = [FBApplication fb_activeApplication] ?: self.testedApplication;\n' + '  return application;';

    if (!initial) {
      var _ref2 = [newLine, oldLine];
      oldLine = _ref2[0];
      newLine = _ref2[1];
    }

    yield replaceInFile(file, oldLine, newLine);
  });
  return _fixFBSessionFile.apply(this, arguments);
}

function fixForXcode7(_x12) {
  return _fixForXcode.apply(this, arguments);
}

function _fixForXcode() {
  _fixForXcode = (0, _asyncToGenerator2.default)(function* (bootstrapPath, initial = true, fixXcode9 = true) {
    if (fixXcode9) {
      yield fixForXcode9(bootstrapPath, !initial, false);
    }

    yield fixXCUICoordinateFile(bootstrapPath, initial);
    yield fixFBSessionFile(bootstrapPath, initial);
  });
  return _fixForXcode.apply(this, arguments);
}

function fixFBMacrosFile(_x13) {
  return _fixFBMacrosFile.apply(this, arguments);
}

function _fixFBMacrosFile() {
  _fixFBMacrosFile = (0, _asyncToGenerator2.default)(function* (bootstrapPath, initial = true) {
    const file = _path.default.resolve(bootstrapPath, FBMACROS_FILE);

    let oldDef = '#define FBStringify(class, property) ({if(NO){[class.new property];} @#property;})';
    let newDef = '#define FBStringify(class, property) ({@#property;})';

    if (!initial) {
      var _ref3 = [newDef, oldDef];
      oldDef = _ref3[0];
      newDef = _ref3[1];
    }

    yield replaceInFile(file, oldDef, newDef);
  });
  return _fixFBMacrosFile.apply(this, arguments);
}

function fixXCUIApplicationFile(_x14) {
  return _fixXCUIApplicationFile.apply(this, arguments);
}

function _fixXCUIApplicationFile() {
  _fixXCUIApplicationFile = (0, _asyncToGenerator2.default)(function* (bootstrapPath, initial = true) {
    const file = _path.default.resolve(bootstrapPath, XCUIAPPLICATION_FILE);

    let oldDef = '@property(nonatomic, readonly) NSUInteger state; // @synthesize state=_state;';
    let newDef = '@property XCUIApplicationState state;';

    if (!initial) {
      var _ref4 = [newDef, oldDef];
      oldDef = _ref4[0];
      newDef = _ref4[1];
    }

    yield replaceInFile(file, oldDef, newDef);
  });
  return _fixXCUIApplicationFile.apply(this, arguments);
}

function fixForXcode9(_x15) {
  return _fixForXcode2.apply(this, arguments);
}

function _fixForXcode2() {
  _fixForXcode2 = (0, _asyncToGenerator2.default)(function* (bootstrapPath, initial = true, fixXcode7 = true) {
    if (fixXcode7) {
      yield fixForXcode7(bootstrapPath, !initial, false);
    }

    yield fixFBMacrosFile(bootstrapPath, initial);
    yield fixXCUIApplicationFile(bootstrapPath, initial);
  });
  return _fixForXcode2.apply(this, arguments);
}

function generateXcodeConfigFile(_x16, _x17) {
  return _generateXcodeConfigFile.apply(this, arguments);
}

function _generateXcodeConfigFile() {
  _generateXcodeConfigFile = (0, _asyncToGenerator2.default)(function* (orgId, signingId) {
    _logger.default.debug(`Generating xcode config file for orgId '${orgId}' and signingId ` + `'${signingId}'`);

    let contents = `DEVELOPMENT_TEAM = ${orgId}
CODE_SIGN_IDENTITY = ${signingId}
`;
    let xcconfigPath = yield _appiumSupport.tempDir.path('appium-temp.xcconfig');

    _logger.default.debug(`Writing xcode config file to ${xcconfigPath}`);

    yield _appiumSupport.fs.writeFile(xcconfigPath, contents, "utf8");
    return xcconfigPath;
  });
  return _generateXcodeConfigFile.apply(this, arguments);
}

function setXctestrunFile(_x18, _x19, _x20, _x21, _x22) {
  return _setXctestrunFile.apply(this, arguments);
}

function _setXctestrunFile() {
  _setXctestrunFile = (0, _asyncToGenerator2.default)(function* (isRealDevice, udid, platformVersion, bootstrapPath, wdaRemotePort) {
    let xctestrunDeviceFileName = `${udid}_${platformVersion}.xctestrun`;

    let xctestrunFilePath = _path.default.resolve(bootstrapPath, xctestrunDeviceFileName);

    if (!(yield _appiumSupport.fs.exists(xctestrunFilePath))) {
      let xctestBaseFileName = isRealDevice ? `WebDriverAgentRunner_iphoneos${platformVersion}-arm64.xctestrun` : `WebDriverAgentRunner_iphonesimulator${platformVersion}-x86_64.xctestrun`;

      let originalXctestrunFile = _path.default.resolve(bootstrapPath, xctestBaseFileName);

      if (!(yield _appiumSupport.fs.exists(originalXctestrunFile))) {
        _logger.default.errorAndThrow(`if you are using useXctestrunFile capability then you need to have ${originalXctestrunFile} file`);
      }

      yield _appiumSupport.fs.copyFile(originalXctestrunFile, xctestrunFilePath);
    }

    let xctestRunContent = yield _appiumSupport.plist.parsePlistFile(xctestrunFilePath);
    let updateWDAPort = {
      WebDriverAgentRunner: {
        EnvironmentVariables: {
          USE_PORT: wdaRemotePort
        }
      }
    };

    let newXctestRunContent = _lodash.default.merge(xctestRunContent, updateWDAPort);

    yield _appiumSupport.plist.updatePlistFile(xctestrunFilePath, newXctestRunContent, true);
    return xctestrunFilePath;
  });
  return _setXctestrunFile.apply(this, arguments);
}

function killProcess(_x23, _x24) {
  return _killProcess.apply(this, arguments);
}

function _killProcess() {
  _killProcess = (0, _asyncToGenerator2.default)(function* (name, proc) {
    if (proc && proc.proc) {
      _logger.default.info(`Shutting down ${name} process (pid ${proc.proc.pid})`);

      try {
        yield proc.stop('SIGTERM', 1000);
      } catch (err) {
        if (err.message.indexOf(`Process didn't end after`) === -1) {
          throw err;
        }

        _logger.default.debug(`${name} process did not end in a timely fashion: '${err.message}'. ` + `Sending 'SIGKILL'...`);

        try {
          yield proc.stop('SIGKILL');
        } catch (err) {
          if (err.message.indexOf('not currently running') !== -1) {
            return;
          }

          throw err;
        }
      }
    }
  });
  return _killProcess.apply(this, arguments);
}

function randomInt(low, high) {
  return Math.floor(Math.random() * (high - low) + low);
}

function getWDAUpgradeTimestamp(_x25) {
  return _getWDAUpgradeTimestamp.apply(this, arguments);
}

function _getWDAUpgradeTimestamp() {
  _getWDAUpgradeTimestamp = (0, _asyncToGenerator2.default)(function* (bootstrapPath) {
    const carthageRootPath = _path.default.resolve(bootstrapPath, CARTHAGE_ROOT);

    if (yield _appiumSupport.fs.exists(carthageRootPath)) {
      const _ref5 = yield _appiumSupport.fs.stat(carthageRootPath),
            mtime = _ref5.mtime;

      return mtime.getTime();
    }

    return null;
  });
  return _getWDAUpgradeTimestamp.apply(this, arguments);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZGEvdXRpbHMuanMiXSwibmFtZXMiOlsiV0RBX1JVTk5FUl9CVU5ETEVfSUQiLCJQUk9KRUNUX0ZJTEUiLCJYQ1VJQ09PUkRJTkFURV9GSUxFIiwiRkJNQUNST1NfRklMRSIsIlhDVUlBUFBMSUNBVElPTl9GSUxFIiwiRkJTRVNTSU9OX0ZJTEUiLCJDQVJUSEFHRV9ST09UIiwicmVwbGFjZUluRmlsZSIsImZpbGUiLCJmaW5kIiwicmVwbGFjZSIsImNvbnRlbnRzIiwiZnMiLCJyZWFkRmlsZSIsIm5ld0NvbnRlbnRzIiwid3JpdGVGaWxlIiwidXBkYXRlUHJvamVjdEZpbGUiLCJhZ2VudFBhdGgiLCJuZXdCdW5kbGVJZCIsInByb2plY3RGaWxlUGF0aCIsImNvcHlGaWxlIiwiUmVnRXhwIiwibG9nIiwiZGVidWciLCJlcnIiLCJtZXNzYWdlIiwid2FybiIsInJlc2V0UHJvamVjdEZpbGUiLCJleGlzdHMiLCJtdiIsImNoZWNrRm9yRGVwZW5kZW5jaWVzIiwiYm9vdHN0cmFwUGF0aCIsInVzZVNzbCIsImNhcnRoYWdlUGF0aCIsIndoaWNoIiwiZXJyb3JBbmRUaHJvdyIsInByb2Nlc3MiLCJlbnYiLCJQQVRIIiwiY2FydGhhZ2VSb290IiwicGF0aCIsInJlc29sdmUiLCJhcmVEZXBlbmRlbmNpZXNVcGRhdGVkIiwiaGFzQWNjZXNzIiwiYXJncyIsImN3ZCIsInN0ZCIsInNwbGl0IiwibGluZSIsImxlbmd0aCIsImVycm9yIiwicmltcmFmIiwibWtkaXIiLCJzZXRSZWFsRGV2aWNlU2VjdXJpdHkiLCJrZXljaGFpblBhdGgiLCJrZXljaGFpblBhc3N3b3JkIiwiZml4WENVSUNvb3JkaW5hdGVGaWxlIiwiaW5pdGlhbCIsIm9sZERlZiIsIm5ld0RlZiIsImZpeEZCU2Vzc2lvbkZpbGUiLCJvbGRMaW5lIiwibmV3TGluZSIsImZpeEZvclhjb2RlNyIsImZpeFhjb2RlOSIsImZpeEZvclhjb2RlOSIsImZpeEZCTWFjcm9zRmlsZSIsImZpeFhDVUlBcHBsaWNhdGlvbkZpbGUiLCJmaXhYY29kZTciLCJnZW5lcmF0ZVhjb2RlQ29uZmlnRmlsZSIsIm9yZ0lkIiwic2lnbmluZ0lkIiwieGNjb25maWdQYXRoIiwidGVtcERpciIsInNldFhjdGVzdHJ1bkZpbGUiLCJpc1JlYWxEZXZpY2UiLCJ1ZGlkIiwicGxhdGZvcm1WZXJzaW9uIiwid2RhUmVtb3RlUG9ydCIsInhjdGVzdHJ1bkRldmljZUZpbGVOYW1lIiwieGN0ZXN0cnVuRmlsZVBhdGgiLCJ4Y3Rlc3RCYXNlRmlsZU5hbWUiLCJvcmlnaW5hbFhjdGVzdHJ1bkZpbGUiLCJ4Y3Rlc3RSdW5Db250ZW50IiwicGxpc3QiLCJwYXJzZVBsaXN0RmlsZSIsInVwZGF0ZVdEQVBvcnQiLCJXZWJEcml2ZXJBZ2VudFJ1bm5lciIsIkVudmlyb25tZW50VmFyaWFibGVzIiwiVVNFX1BPUlQiLCJuZXdYY3Rlc3RSdW5Db250ZW50IiwiXyIsIm1lcmdlIiwidXBkYXRlUGxpc3RGaWxlIiwia2lsbFByb2Nlc3MiLCJuYW1lIiwicHJvYyIsImluZm8iLCJwaWQiLCJzdG9wIiwiaW5kZXhPZiIsInJhbmRvbUludCIsImxvdyIsImhpZ2giLCJNYXRoIiwiZmxvb3IiLCJyYW5kb20iLCJnZXRXREFVcGdyYWRlVGltZXN0YW1wIiwiY2FydGhhZ2VSb290UGF0aCIsInN0YXQiLCJtdGltZSIsImdldFRpbWUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxvQkFBb0IsR0FBRyxtQ0FBN0I7O0FBQ0EsTUFBTUMsWUFBWSxHQUFHLGlCQUFyQjtBQUNBLE1BQU1DLG1CQUFtQixHQUFHLHdDQUE1QjtBQUNBLE1BQU1DLGFBQWEsR0FBRyx3Q0FBdEI7QUFDQSxNQUFNQyxvQkFBb0IsR0FBRyx5Q0FBN0I7QUFDQSxNQUFNQyxjQUFjLEdBQUcsdUNBQXZCO0FBQ0EsTUFBTUMsYUFBYSxHQUFHLFVBQXRCOztTQUVlQyxhOzs7OzttREFBZixXQUE4QkMs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RUFBeUQ7QUFFdkQ7QUFDRDs7QUFDRCxnQkFBTTVFLEdBQU47QUFDRDtBQUNGO0FBQ0Y7QUFDRixHOzs7O0FBT0QsU0FBUzZFLFNBQVQsQ0FBb0JDLEdBQXBCLEVBQXlCQyxJQUF6QixFQUErQjtBQUM3QixTQUFPQyxJQUFJLENBQUNDLEtBQUwsQ0FBV0QsSUFBSSxDQUFDRSxNQUFMLE1BQWlCSCxJQUFJLEdBQUdELEdBQXhCLElBQStCQSxHQUExQyxDQUFQO0FBQ0Q7O1NBU2NLLHNCOzs7Ozs0REFBZixXQUF1QzVFLGFBQXZDLEVBQXNEO0FBQ3BELFVBQU02RSxnQkFBZ0IsR0FBR3BFLGNBQUtDLE9BQUwsQ0FBYVYsYUFBYixFQUE0QnpCLGFBQTVCLENBQXpCOztBQUNBLGNBQVVNLGtCQUFHZ0IsTUFBSCxDQUFVZ0YsZ0JBQVYsQ0FBVixFQUF1QztBQUFBLDBCQUNmaEcsa0JBQUdpRyxJQUFILENBQVFELGdCQUFSLENBRGU7QUFBQSxZQUM5QkUsS0FEOEIsU0FDOUJBLEtBRDhCOztBQUVyQyxhQUFPQSxLQUFLLENBQUNDLE9BQU4sRUFBUDtBQUNEOztBQUNELFdBQU8sSUFBUDtBQUNELEciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmcywgdGVtcERpciwgcGxpc3QgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuY29uc3QgV0RBX1JVTk5FUl9CVU5ETEVfSUQgPSAnY29tLmZhY2Vib29rLldlYkRyaXZlckFnZW50UnVubmVyJztcbmNvbnN0IFBST0pFQ1RfRklMRSA9ICdwcm9qZWN0LnBieHByb2onO1xuY29uc3QgWENVSUNPT1JESU5BVEVfRklMRSA9ICdQcml2YXRlSGVhZGVycy9YQ1Rlc3QvWENVSUNvb3JkaW5hdGUuaCc7XG5jb25zdCBGQk1BQ1JPU19GSUxFID0gJ1dlYkRyaXZlckFnZW50TGliL1V0aWxpdGllcy9GQk1hY3Jvcy5oJztcbmNvbnN0IFhDVUlBUFBMSUNBVElPTl9GSUxFID0gJ1ByaXZhdGVIZWFkZXJzL1hDVGVzdC9YQ1VJQXBwbGljYXRpb24uaCc7XG5jb25zdCBGQlNFU1NJT05fRklMRSA9ICdXZWJEcml2ZXJBZ2VudExpYi9Sb3V0aW5nL0ZCU2Vzc2lvbi5tJztcbmNvbnN0IENBUlRIQUdFX1JPT1QgPSAnQ2FydGhhZ2UnO1xuXG5hc3luYyBmdW5jdGlvbiByZXBsYWNlSW5GaWxlIChmaWxlLCBmaW5kLCByZXBsYWNlKSB7XG4gIGxldCBjb250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKGZpbGUsICd1dGY4Jyk7XG5cbiAgbGV0IG5ld0NvbnRlbnRzID0gY29udGVudHMucmVwbGFjZShmaW5kLCByZXBsYWNlKTtcbiAgaWYgKG5ld0NvbnRlbnRzICE9PSBjb250ZW50cykge1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZShmaWxlLCBuZXdDb250ZW50cywgJ3V0ZjgnKTtcbiAgfVxufVxuXG4vKipcbiAqIFVwZGF0ZSBXZWJEcml2ZXJBZ2VudFJ1bm5lciBwcm9qZWN0IGJ1bmRsZSBJRCB3aXRoIG5ld0J1bmRsZUlkLlxuICogVGhpcyBtZXRob2QgYXNzdW1lcyBwcm9qZWN0IGZpbGUgaXMgaW4gdGhlIGNvcnJlY3Qgc3RhdGUuXG4gKiBAcGFyYW0ge3N0cmluZ30gYWdlbnRQYXRoIC0gUGF0aCB0byB0aGUgLnhjb2RlcHJvaiBkaXJlY3RvcnkuXG4gKiBAcGFyYW0ge3N0cmluZ30gbmV3QnVuZGxlSWQgdGhlIG5ldyBidW5kbGUgSUQgdXNlZCB0byB1cGRhdGUuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVByb2plY3RGaWxlIChhZ2VudFBhdGgsIG5ld0J1bmRsZUlkKSB7XG4gIGxldCBwcm9qZWN0RmlsZVBhdGggPSBgJHthZ2VudFBhdGh9LyR7UFJPSkVDVF9GSUxFfWA7XG4gIHRyeSB7XG4gICAgLy8gQXNzdW1pbmcgcHJvamVjdEZpbGVQYXRoIGlzIGluIHRoZSBjb3JyZWN0IHN0YXRlLCBjcmVhdGUgLm9sZCBmcm9tIHByb2plY3RGaWxlUGF0aFxuICAgIGF3YWl0IGZzLmNvcHlGaWxlKHByb2plY3RGaWxlUGF0aCwgYCR7cHJvamVjdEZpbGVQYXRofS5vbGRgKTtcbiAgICBhd2FpdCByZXBsYWNlSW5GaWxlKHByb2plY3RGaWxlUGF0aCwgbmV3IFJlZ0V4cChXREFfUlVOTkVSX0JVTkRMRV9JRC5yZXBsYWNlKCcuJywgJ1xcLicpLCAnZycpLCBuZXdCdW5kbGVJZCk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdXNlbGVzcy1lc2NhcGVcbiAgICBsb2cuZGVidWcoYFN1Y2Nlc3NmdWxseSB1cGRhdGVkICcke3Byb2plY3RGaWxlUGF0aH0nIHdpdGggYnVuZGxlIGlkICcke25ld0J1bmRsZUlkfSdgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmRlYnVnKGBFcnJvciB1cGRhdGluZyBwcm9qZWN0IGZpbGU6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgbG9nLndhcm4oYFVuYWJsZSB0byB1cGRhdGUgcHJvamVjdCBmaWxlICcke3Byb2plY3RGaWxlUGF0aH0nIHdpdGggYCArXG4gICAgICAgICAgICAgYGJ1bmRsZSBpZCAnJHtuZXdCdW5kbGVJZH0nLiBXZWJEcml2ZXJBZ2VudCBtYXkgbm90IHN0YXJ0YCk7XG4gIH1cbn1cblxuLyoqXG4gKiBSZXNldCBXZWJEcml2ZXJBZ2VudFJ1bm5lciBwcm9qZWN0IGJ1bmRsZSBJRCB0byBjb3JyZWN0IHN0YXRlLlxuICogQHBhcmFtIHtzdHJpbmd9IGFnZW50UGF0aCAtIFBhdGggdG8gdGhlIC54Y29kZXByb2ogZGlyZWN0b3J5LlxuICovXG5hc3luYyBmdW5jdGlvbiByZXNldFByb2plY3RGaWxlIChhZ2VudFBhdGgpIHtcbiAgbGV0IHByb2plY3RGaWxlUGF0aCA9IGAke2FnZW50UGF0aH0vJHtQUk9KRUNUX0ZJTEV9YDtcbiAgdHJ5IHtcbiAgICAvLyByZXN0b3JlIHByb2plY3RGaWxlUGF0aCBmcm9tIC5vbGQgZmlsZVxuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKGAke3Byb2plY3RGaWxlUGF0aH0ub2xkYCkpIHtcbiAgICAgIHJldHVybjsgLy8gbm8gbmVlZCB0byByZXNldFxuICAgIH1cbiAgICBhd2FpdCBmcy5tdihgJHtwcm9qZWN0RmlsZVBhdGh9Lm9sZGAsIHByb2plY3RGaWxlUGF0aCk7XG4gICAgbG9nLmRlYnVnKGBTdWNjZXNzZnVsbHkgcmVzZXQgJyR7cHJvamVjdEZpbGVQYXRofScgd2l0aCBidW5kbGUgaWQgJyR7V0RBX1JVTk5FUl9CVU5ETEVfSUR9J2ApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoYEVycm9yIHJlc2V0dGluZyBwcm9qZWN0IGZpbGU6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgbG9nLndhcm4oYFVuYWJsZSB0byByZXNldCBwcm9qZWN0IGZpbGUgJyR7cHJvamVjdEZpbGVQYXRofScgd2l0aCBgICtcbiAgICAgICAgICAgICBgYnVuZGxlIGlkICcke1dEQV9SVU5ORVJfQlVORExFX0lEfScuIFdlYkRyaXZlckFnZW50IGhhcyBiZWVuIGAgK1xuICAgICAgICAgICAgIGBtb2RpZmllZCBhbmQgbm90IHJldHVybmVkIHRvIHRoZSBvcmlnaW5hbCBzdGF0ZS5gKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBjaGVja0ZvckRlcGVuZGVuY2llcyAoYm9vdHN0cmFwUGF0aCwgdXNlU3NsID0gZmFsc2UpIHtcbiAgdHJ5IHtcbiAgICBsZXQgY2FydGhhZ2VQYXRoID0gYXdhaXQgZnMud2hpY2goJ2NhcnRoYWdlJyk7XG4gICAgbG9nLmRlYnVnKGBDYXJ0aGFnZSBmb3VuZDogJyR7Y2FydGhhZ2VQYXRofSdgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coJ0NhcnRoYWdlIGJpbmFyeSBpcyBub3QgZm91bmQuIEluc3RhbGwgdXNpbmcgYGJyZXcgaW5zdGFsbCBjYXJ0aGFnZWAgaWYgaXQgaXMgbm90IGluc3RhbGxlZCAnICtcbiAgICAgICdhbmQgbWFrZSBzdXJlIHRoZSByb290IGZvbGRlciwgd2hlcmUgY2FydGhhZ2UgYmluYXJ5IGlzIGluc3RhbGxlZCwgaXMgcHJlc2VudCBpbiBQQVRIIGVudmlyb25tZW50IHZhcmlhYmxlLiAnICtcbiAgICAgIGBUaGUgY3VycmVudCBQQVRIIHZhbHVlOiAnJHtwcm9jZXNzLmVudi5QQVRIID8gcHJvY2Vzcy5lbnYuUEFUSCA6IFwiPG5vdCBkZWZpbmVkIGZvciB0aGUgQXBwaXVtIHByb2Nlc3M+XCJ9J2ApO1xuICB9XG4gIGNvbnN0IGNhcnRoYWdlUm9vdCA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBDQVJUSEFHRV9ST09UKTtcbiAgbGV0IGFyZURlcGVuZGVuY2llc1VwZGF0ZWQgPSBmYWxzZTtcbiAgaWYgKCFhd2FpdCBmcy5oYXNBY2Nlc3MoY2FydGhhZ2VSb290KSkge1xuICAgIGxvZy5kZWJ1ZygnUnVubmluZyBXZWJEcml2ZXJBZ2VudCBib290c3RyYXAgc2NyaXB0IHRvIGluc3RhbGwgZGVwZW5kZW5jaWVzJyk7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBhcmdzID0gdXNlU3NsID8gWyctZCcsICctRCddIDogWyctZCddO1xuICAgICAgYXdhaXQgZXhlYygnU2NyaXB0cy9ib290c3RyYXAuc2gnLCBhcmdzLCB7Y3dkOiBib290c3RyYXBQYXRofSk7XG4gICAgICBhcmVEZXBlbmRlbmNpZXNVcGRhdGVkID0gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIHByaW50IG91dCB0aGUgc3Rkb3V0IGFuZCBzdGRlcnIgcmVwb3J0c1xuICAgICAgZm9yIChsZXQgc3RkIG9mIFsnc3Rkb3V0JywgJ3N0ZGVyciddKSB7XG4gICAgICAgIGZvciAobGV0IGxpbmUgb2YgKGVycltzdGRdIHx8ICcnKS5zcGxpdCgnXFxuJykpIHtcbiAgICAgICAgICBpZiAoIWxpbmUubGVuZ3RoKSB7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgbG9nLmVycm9yKGxpbmUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvLyByZW1vdmUgdGhlIGNhcnRoYWdlIGRpcmVjdG9yeSwgb3IgZWxzZSBzdWJzZXF1ZW50IHJ1bnMgd2lsbCBzZWUgaXQgYW5kXG4gICAgICAvLyBhc3N1bWUgdGhlIGRlcGVuZGVuY2llcyBhcmUgYWxyZWFkeSBkb3dubG9hZGVkXG4gICAgICBhd2FpdCBmcy5yaW1yYWYoY2FydGhhZ2VSb290KTtcblxuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfVxuICBpZiAoIWF3YWl0IGZzLmhhc0FjY2VzcyhgJHtib290c3RyYXBQYXRofS9SZXNvdXJjZXNgKSkge1xuICAgIGxvZy5kZWJ1ZygnQ3JlYXRpbmcgV2ViRHJpdmVyQWdlbnQgcmVzb3VyY2VzIGRpcmVjdG9yeScpO1xuICAgIGF3YWl0IGZzLm1rZGlyKGAke2Jvb3RzdHJhcFBhdGh9L1Jlc291cmNlc2ApO1xuICAgIGFyZURlcGVuZGVuY2llc1VwZGF0ZWQgPSB0cnVlO1xuICB9XG4gIGlmICghYXdhaXQgZnMuaGFzQWNjZXNzKGAke2Jvb3RzdHJhcFBhdGh9L1Jlc291cmNlcy9XZWJEcml2ZXJBZ2VudC5idW5kbGVgKSkge1xuICAgIGxvZy5kZWJ1ZygnQ3JlYXRpbmcgV2ViRHJpdmVyQWdlbnQgcmVzb3VyY2UgYnVuZGxlIGRpcmVjdG9yeScpO1xuICAgIGF3YWl0IGZzLm1rZGlyKGAke2Jvb3RzdHJhcFBhdGh9L1Jlc291cmNlcy9XZWJEcml2ZXJBZ2VudC5idW5kbGVgKTtcbiAgICBhcmVEZXBlbmRlbmNpZXNVcGRhdGVkID0gdHJ1ZTtcbiAgfVxuICByZXR1cm4gYXJlRGVwZW5kZW5jaWVzVXBkYXRlZDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0UmVhbERldmljZVNlY3VyaXR5IChrZXljaGFpblBhdGgsIGtleWNoYWluUGFzc3dvcmQpIHtcbiAgbG9nLmRlYnVnKCdTZXR0aW5nIHNlY3VyaXR5IGZvciBpT1MgZGV2aWNlJyk7XG4gIGF3YWl0IGV4ZWMoJ3NlY3VyaXR5JywgWyctdicsICdsaXN0LWtleWNoYWlucycsICctcycsIGtleWNoYWluUGF0aF0pO1xuICBhd2FpdCBleGVjKCdzZWN1cml0eScsIFsnLXYnLCAndW5sb2NrLWtleWNoYWluJywgJy1wJywga2V5Y2hhaW5QYXNzd29yZCwga2V5Y2hhaW5QYXRoXSk7XG4gIGF3YWl0IGV4ZWMoJ3NlY3VyaXR5JywgWydzZXQta2V5Y2hhaW4tc2V0dGluZ3MnLCAnLXQnLCAnMzYwMCcsICctbCcsIGtleWNoYWluUGF0aF0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaXhYQ1VJQ29vcmRpbmF0ZUZpbGUgKGJvb3RzdHJhcFBhdGgsIGluaXRpYWwgPSB0cnVlKSB7XG4gIC8vIHRoZSB3YXkgdGhlIHVwZGF0ZWQgWENUZXN0IGhlYWRlcnMgYXJlIGluIHRoZSBXREEgcHJvamVjdCwgYnVpbGRpbmcgaW5cbiAgLy8gWGNvZGUgOC4wIGNhdXNlcyBhIGR1cGxpY2F0ZSBkZWNsYXJhdGlvbiBvZiBtZXRob2RcbiAgLy8gc28gZml4IHRoZSBvZmZlbmRpbmcgbGluZSBpbiB0aGUgbG9jYWwgaGVhZGVyc1xuICBjb25zdCBmaWxlID0gcGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIFhDVUlDT09SRElOQVRFX0ZJTEUpO1xuXG4gIGxldCBvbGREZWYgPSAnLSAodm9pZClwcmVzc0ZvckR1cmF0aW9uOihkb3VibGUpYXJnMSB0aGVuRHJhZ1RvQ29vcmRpbmF0ZTooaWQpYXJnMjsnO1xuICBsZXQgbmV3RGVmID0gJy0gKHZvaWQpcHJlc3NGb3JEdXJhdGlvbjooTlNUaW1lSW50ZXJ2YWwpZHVyYXRpb24gdGhlbkRyYWdUb0Nvb3JkaW5hdGU6KFhDVUlDb29yZGluYXRlICopb3RoZXJDb29yZGluYXRlOyc7XG4gIGlmICghaW5pdGlhbCkge1xuICAgIFtvbGREZWYsIG5ld0RlZl0gPSBbbmV3RGVmLCBvbGREZWZdO1xuICB9XG4gIGF3YWl0IHJlcGxhY2VJbkZpbGUoZmlsZSwgb2xkRGVmLCBuZXdEZWYpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaXhGQlNlc3Npb25GaWxlIChib290c3RyYXBQYXRoLCBpbml0aWFsID0gdHJ1ZSkge1xuICBjb25zdCBmaWxlID0gcGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIEZCU0VTU0lPTl9GSUxFKTtcblxuICBsZXQgb2xkTGluZSA9ICdyZXR1cm4gW0ZCQXBwbGljYXRpb24gZmJfYWN0aXZlQXBwbGljYXRpb25dID86IHNlbGYudGVzdGVkQXBwbGljYXRpb247JztcbiAgbGV0IG5ld0xpbmUgPSAnRkJBcHBsaWNhdGlvbiAqYXBwbGljYXRpb24gPSBbRkJBcHBsaWNhdGlvbiBmYl9hY3RpdmVBcHBsaWNhdGlvbl0gPzogc2VsZi50ZXN0ZWRBcHBsaWNhdGlvbjtcXG4nICtcbiAgICAgICAgICAgICAgICAnICByZXR1cm4gYXBwbGljYXRpb247JztcbiAgaWYgKCFpbml0aWFsKSB7XG4gICAgW29sZExpbmUsIG5ld0xpbmVdID0gW25ld0xpbmUsIG9sZExpbmVdO1xuICB9XG4gIGF3YWl0IHJlcGxhY2VJbkZpbGUoZmlsZSwgb2xkTGluZSwgbmV3TGluZSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpeEZvclhjb2RlNyAoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCA9IHRydWUsIGZpeFhjb2RlOSA9IHRydWUpIHtcbiAgaWYgKGZpeFhjb2RlOSkge1xuICAgIGF3YWl0IGZpeEZvclhjb2RlOShib290c3RyYXBQYXRoLCAhaW5pdGlhbCwgZmFsc2UpO1xuICB9XG4gIGF3YWl0IGZpeFhDVUlDb29yZGluYXRlRmlsZShib290c3RyYXBQYXRoLCBpbml0aWFsKTtcbiAgYXdhaXQgZml4RkJTZXNzaW9uRmlsZShib290c3RyYXBQYXRoLCBpbml0aWFsKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZml4RkJNYWNyb3NGaWxlIChib290c3RyYXBQYXRoLCBpbml0aWFsID0gdHJ1ZSkge1xuICBjb25zdCBmaWxlID0gcGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIEZCTUFDUk9TX0ZJTEUpO1xuXG4gIGxldCBvbGREZWYgPSAnI2RlZmluZSBGQlN0cmluZ2lmeShjbGFzcywgcHJvcGVydHkpICh7aWYoTk8pe1tjbGFzcy5uZXcgcHJvcGVydHldO30gQCNwcm9wZXJ0eTt9KSc7XG4gIGxldCBuZXdEZWYgPSAnI2RlZmluZSBGQlN0cmluZ2lmeShjbGFzcywgcHJvcGVydHkpICh7QCNwcm9wZXJ0eTt9KSc7XG4gIGlmICghaW5pdGlhbCkge1xuICAgIFtvbGREZWYsIG5ld0RlZl0gPSBbbmV3RGVmLCBvbGREZWZdO1xuICB9XG4gIGF3YWl0IHJlcGxhY2VJbkZpbGUoZmlsZSwgb2xkRGVmLCBuZXdEZWYpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaXhYQ1VJQXBwbGljYXRpb25GaWxlIChib290c3RyYXBQYXRoLCBpbml0aWFsID0gdHJ1ZSkge1xuICBjb25zdCBmaWxlID0gcGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIFhDVUlBUFBMSUNBVElPTl9GSUxFKTtcblxuICBsZXQgb2xkRGVmID0gJ0Bwcm9wZXJ0eShub25hdG9taWMsIHJlYWRvbmx5KSBOU1VJbnRlZ2VyIHN0YXRlOyAvLyBAc3ludGhlc2l6ZSBzdGF0ZT1fc3RhdGU7JztcbiAgbGV0IG5ld0RlZiA9ICdAcHJvcGVydHkgWENVSUFwcGxpY2F0aW9uU3RhdGUgc3RhdGU7JztcbiAgaWYgKCFpbml0aWFsKSB7XG4gICAgW29sZERlZiwgbmV3RGVmXSA9IFtuZXdEZWYsIG9sZERlZl07XG4gIH1cbiAgYXdhaXQgcmVwbGFjZUluRmlsZShmaWxlLCBvbGREZWYsIG5ld0RlZik7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpeEZvclhjb2RlOSAoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCA9IHRydWUsIGZpeFhjb2RlNyA9IHRydWUpIHtcbiAgaWYgKGZpeFhjb2RlNykge1xuICAgIGF3YWl0IGZpeEZvclhjb2RlNyhib290c3RyYXBQYXRoLCAhaW5pdGlhbCwgZmFsc2UpO1xuICB9XG4gIGF3YWl0IGZpeEZCTWFjcm9zRmlsZShib290c3RyYXBQYXRoLCBpbml0aWFsKTtcbiAgYXdhaXQgZml4WENVSUFwcGxpY2F0aW9uRmlsZShib290c3RyYXBQYXRoLCBpbml0aWFsKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVYY29kZUNvbmZpZ0ZpbGUgKG9yZ0lkLCBzaWduaW5nSWQpIHtcbiAgbG9nLmRlYnVnKGBHZW5lcmF0aW5nIHhjb2RlIGNvbmZpZyBmaWxlIGZvciBvcmdJZCAnJHtvcmdJZH0nIGFuZCBzaWduaW5nSWQgYCArXG4gICAgICAgICAgICBgJyR7c2lnbmluZ0lkfSdgKTtcbiAgbGV0IGNvbnRlbnRzID0gYERFVkVMT1BNRU5UX1RFQU0gPSAke29yZ0lkfVxuQ09ERV9TSUdOX0lERU5USVRZID0gJHtzaWduaW5nSWR9XG5gO1xuICBsZXQgeGNjb25maWdQYXRoID0gYXdhaXQgdGVtcERpci5wYXRoKCdhcHBpdW0tdGVtcC54Y2NvbmZpZycpO1xuICBsb2cuZGVidWcoYFdyaXRpbmcgeGNvZGUgY29uZmlnIGZpbGUgdG8gJHt4Y2NvbmZpZ1BhdGh9YCk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZSh4Y2NvbmZpZ1BhdGgsIGNvbnRlbnRzLCBcInV0ZjhcIik7XG4gIHJldHVybiB4Y2NvbmZpZ1BhdGg7XG59XG5cbi8qKlxuICogQ3JlYXRlcyB4Y3Rlc3RydW4gZmlsZSBwZXIgZGV2aWNlICYgcGxhdGZvcm0gdmVyc2lvbi5cbiAqIFdlIGV4cGVjdHMgdG8gaGF2ZSBXZWJEcml2ZXJBZ2VudFJ1bm5lcl9pcGhvbmVvcyR7cGxhdGZvcm1WZXJzaW9ufS1hcm02NC54Y3Rlc3RydW4gZm9yIHJlYWwgZGV2aWNlXG4gKiBhbmQgV2ViRHJpdmVyQWdlbnRSdW5uZXJfaXBob25lc2ltdWxhdG9yJHtwbGF0Zm9ybVZlcnNpb259LXg4Nl82NC54Y3Rlc3RydW4gZm9yIHNpbXVsYXRvciBsb2NhdGVkIEBib290c3RyYXBQYXRoXG4gKlxuICogQHBhcmFtIHtib29sZWFufSBpc1JlYWxEZXZpY2UgLSBFcXVhbHMgdG8gdHJ1ZSBpZiB0aGUgY3VycmVudCBkZXZpY2UgaXMgYSByZWFsIGRldmljZVxuICogQHBhcmFtIHtzdHJpbmd9IHVkaWQgLSBUaGUgZGV2aWNlIFVESUQuXG4gKiBAcGFyYW0ge3N0cmluZ30gcGxhdGZvcm1WZXJzaW9uIC0gVGhlIHBsYXRmb3JtIHZlcnNpb24gb2YgT1MuXG4gKiBAcGFyYW0ge3N0cmluZ30gYm9vdHN0cmFwUGF0aCAtIFRoZSBmb2xkZXIgcGF0aCBjb250YWluaW5nIHhjdGVzdHJ1biBmaWxlLlxuICogQHBhcmFtIHtzdHJpbmd9IHdkYVJlbW90ZVBvcnQgLSBUaGUgcmVtb3RlIHBvcnQgV0RBIGlzIGxpc3RlbmluZyBvbi5cbiAqIEByZXR1cm4ge3N0cmluZ30gcmV0dXJucyB4Y3Rlc3RydW5GaWxlUGF0aCBmb3IgZ2l2ZW4gZGV2aWNlXG4gKiBAdGhyb3dzIGlmIFdlYkRyaXZlckFnZW50UnVubmVyX2lwaG9uZW9zJHtwbGF0Zm9ybVZlcnNpb259LWFybTY0LnhjdGVzdHJ1biBmb3IgcmVhbCBkZXZpY2VcbiAqIG9yIFdlYkRyaXZlckFnZW50UnVubmVyX2lwaG9uZXNpbXVsYXRvciR7cGxhdGZvcm1WZXJzaW9ufS14ODZfNjQueGN0ZXN0cnVuIGZvciBzaW11bGF0b3IgaXMgbm90IGZvdW5kIEBib290c3RyYXBQYXRoLFxuICogdGhlbiBpdCB3aWxsIHRocm93IGZpbGUgbm90IGZvdW5kIGV4Y2VwdGlvblxuICovXG5hc3luYyBmdW5jdGlvbiBzZXRYY3Rlc3RydW5GaWxlIChpc1JlYWxEZXZpY2UsIHVkaWQsIHBsYXRmb3JtVmVyc2lvbiwgYm9vdHN0cmFwUGF0aCwgd2RhUmVtb3RlUG9ydCkge1xuICBsZXQgeGN0ZXN0cnVuRGV2aWNlRmlsZU5hbWUgPSBgJHt1ZGlkfV8ke3BsYXRmb3JtVmVyc2lvbn0ueGN0ZXN0cnVuYDtcbiAgbGV0IHhjdGVzdHJ1bkZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIHhjdGVzdHJ1bkRldmljZUZpbGVOYW1lKTtcblxuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyh4Y3Rlc3RydW5GaWxlUGF0aCkpIHtcbiAgICBsZXQgeGN0ZXN0QmFzZUZpbGVOYW1lID0gaXNSZWFsRGV2aWNlID8gYFdlYkRyaXZlckFnZW50UnVubmVyX2lwaG9uZW9zJHtwbGF0Zm9ybVZlcnNpb259LWFybTY0LnhjdGVzdHJ1bmAgOlxuICAgICAgYFdlYkRyaXZlckFnZW50UnVubmVyX2lwaG9uZXNpbXVsYXRvciR7cGxhdGZvcm1WZXJzaW9ufS14ODZfNjQueGN0ZXN0cnVuYDtcbiAgICBsZXQgb3JpZ2luYWxYY3Rlc3RydW5GaWxlID0gcGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIHhjdGVzdEJhc2VGaWxlTmFtZSk7XG4gICAgaWYgKCFhd2FpdCBmcy5leGlzdHMob3JpZ2luYWxYY3Rlc3RydW5GaWxlKSkge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYGlmIHlvdSBhcmUgdXNpbmcgdXNlWGN0ZXN0cnVuRmlsZSBjYXBhYmlsaXR5IHRoZW4geW91IG5lZWQgdG8gaGF2ZSAke29yaWdpbmFsWGN0ZXN0cnVuRmlsZX0gZmlsZWApO1xuICAgIH1cbiAgICAvLyBJZiB0aGlzIGlzIGZpcnN0IHRpbWUgcnVuIGZvciBnaXZlbiBkZXZpY2UsIHRoZW4gZmlyc3QgZ2VuZXJhdGUgeGN0ZXN0cnVuIGZpbGUgZm9yIGRldmljZS5cbiAgICAvLyBXZSBuZWVkIHRvIGhhdmUgYSB4Y3Rlc3RydW4gZmlsZSBwZXIgZGV2aWNlIGJlY2F1c2Ugd2UgY2FudCBub3QgaGF2ZSBzYW1lIHdkYSBwb3J0IGZvciBhbGwgZGV2aWNlcy5cbiAgICBhd2FpdCBmcy5jb3B5RmlsZShvcmlnaW5hbFhjdGVzdHJ1bkZpbGUsIHhjdGVzdHJ1bkZpbGVQYXRoKTtcbiAgfVxuXG4gIGxldCB4Y3Rlc3RSdW5Db250ZW50ID0gYXdhaXQgcGxpc3QucGFyc2VQbGlzdEZpbGUoeGN0ZXN0cnVuRmlsZVBhdGgpO1xuXG4gIGxldCB1cGRhdGVXREFQb3J0ID0ge1xuICAgIFdlYkRyaXZlckFnZW50UnVubmVyOiB7XG4gICAgICBFbnZpcm9ubWVudFZhcmlhYmxlczoge1xuICAgICAgICBVU0VfUE9SVDogd2RhUmVtb3RlUG9ydFxuICAgICAgfVxuICAgIH1cbiAgfTtcblxuICBsZXQgbmV3WGN0ZXN0UnVuQ29udGVudCA9IF8ubWVyZ2UoeGN0ZXN0UnVuQ29udGVudCwgdXBkYXRlV0RBUG9ydCk7XG4gIGF3YWl0IHBsaXN0LnVwZGF0ZVBsaXN0RmlsZSh4Y3Rlc3RydW5GaWxlUGF0aCwgbmV3WGN0ZXN0UnVuQ29udGVudCwgdHJ1ZSk7XG5cbiAgcmV0dXJuIHhjdGVzdHJ1bkZpbGVQYXRoO1xufVxuXG5hc3luYyBmdW5jdGlvbiBraWxsUHJvY2VzcyAobmFtZSwgcHJvYykge1xuICBpZiAocHJvYyAmJiBwcm9jLnByb2MpIHtcbiAgICBsb2cuaW5mbyhgU2h1dHRpbmcgZG93biAke25hbWV9IHByb2Nlc3MgKHBpZCAke3Byb2MucHJvYy5waWR9KWApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBwcm9jLnN0b3AoJ1NJR1RFUk0nLCAxMDAwKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmIChlcnIubWVzc2FnZS5pbmRleE9mKGBQcm9jZXNzIGRpZG4ndCBlbmQgYWZ0ZXJgKSA9PT0gLTEpIHtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGAke25hbWV9IHByb2Nlc3MgZGlkIG5vdCBlbmQgaW4gYSB0aW1lbHkgZmFzaGlvbjogJyR7ZXJyLm1lc3NhZ2V9Jy4gYCArXG4gICAgICAgICAgICAgICAgYFNlbmRpbmcgJ1NJR0tJTEwnLi4uYCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBwcm9jLnN0b3AoJ1NJR0tJTEwnKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZignbm90IGN1cnJlbnRseSBydW5uaW5nJykgIT09IC0xKSB7XG4gICAgICAgICAgLy8gdGhlIHByb2Nlc3MgZW5kZWQgYnV0IGZvciBzb21lIHJlYXNvbiB3ZSB3ZXJlIG5vdCBpbmZvcm1lZFxuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogR2VuZXJhdGUgYSByYW5kb20gaW50ZWdlci5cbiAqXG4gKiBAcmV0dXJuIHtudW1iZXJ9IEEgcmFuZG9tIGludGVnZXIgbnVtYmVyIGluIHJhbmdlIFtsb3csIGhpZ2h0KS4gYGxvd2BgIGlzIGluY2x1c2l2ZSBhbmQgYGhpZ2hgIGlzIGV4Y2x1c2l2ZS5cbiAqL1xuZnVuY3Rpb24gcmFuZG9tSW50IChsb3csIGhpZ2gpIHtcbiAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChoaWdoIC0gbG93KSArIGxvdyk7XG59XG5cbi8qKlxuICogUmV0cmlldmVzIFdEQSB1cGdyYWRlIHRpbWVzdGFtcFxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBib290c3RyYXBQYXRoIFRoZSBmdWxsIHBhdGggdG8gdGhlIGZvbGRlciB3aGVyZSBXREEgc291cmNlIGlzIGxvY2F0ZWRcbiAqIEByZXR1cm4gez9udW1iZXJ9IFRoZSBVTklYIHRpbWVzdGFtcCBvZiB0aGUgY2FydGhhZ2Ugcm9vdCBmb2xkZXIsIHdoZXJlIGRlcGVuZGVuY2llcyBhcmUgZG93bmxvYWRlZC5cbiAqIFRoaXMgZm9sZGVyIGlzIGNyZWF0ZWQgb25seSBvbmNlIG9uIG1vZHVsZSB1cGdyYWRlL2ZpcnN0IGluc3RhbGwuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGdldFdEQVVwZ3JhZGVUaW1lc3RhbXAgKGJvb3RzdHJhcFBhdGgpIHtcbiAgY29uc3QgY2FydGhhZ2VSb290UGF0aCA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBDQVJUSEFHRV9ST09UKTtcbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyhjYXJ0aGFnZVJvb3RQYXRoKSkge1xuICAgIGNvbnN0IHttdGltZX0gPSBhd2FpdCBmcy5zdGF0KGNhcnRoYWdlUm9vdFBhdGgpO1xuICAgIHJldHVybiBtdGltZS5nZXRUaW1lKCk7XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmV4cG9ydCB7IHVwZGF0ZVByb2plY3RGaWxlLCByZXNldFByb2plY3RGaWxlLCBjaGVja0ZvckRlcGVuZGVuY2llcyxcbiAgc2V0UmVhbERldmljZVNlY3VyaXR5LCBmaXhGb3JYY29kZTcsIGZpeEZvclhjb2RlOSxcbiAgZ2VuZXJhdGVYY29kZUNvbmZpZ0ZpbGUsIHNldFhjdGVzdHJ1bkZpbGUsIGtpbGxQcm9jZXNzLCByYW5kb21JbnQsIFdEQV9SVU5ORVJfQlVORExFX0lELFxuICBnZXRXREFVcGdyYWRlVGltZXN0YW1wIH07XG4iXSwiZmlsZSI6ImxpYi93ZGEvdXRpbHMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
