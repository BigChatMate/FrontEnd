"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _asyncbox = require("asyncbox");

var _lodash = _interopRequireDefault(require("lodash"));

var _nodeSimctl = require("node-simctl");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

let commands = {};

function getScreenshotWithIdevicelib(_x, _x2) {
  return _getScreenshotWithIdevicelib.apply(this, arguments);
}

function _getScreenshotWithIdevicelib() {
  _getScreenshotWithIdevicelib = (0, _asyncToGenerator2.default)(function* (udid, isLandscape) {
    const pathToScreenshotTiff = yield _appiumSupport.tempDir.path({
      prefix: `screenshot-${udid}`,
      suffix: '.tiff'
    });
    yield _appiumSupport.fs.rimraf(pathToScreenshotTiff);
    const pathToResultPng = yield _appiumSupport.tempDir.path({
      prefix: `screenshot-${udid}`,
      suffix: '.png'
    });
    yield _appiumSupport.fs.rimraf(pathToResultPng);

    try {
      try {
        yield (0, _teen_process.exec)('idevicescreenshot', ['-u', udid, pathToScreenshotTiff]);
      } catch (e) {
        throw new Error(`Cannot take a screenshot from the device '${udid}' using ` + `idevicescreenshot. Original error: ${e.message}`);
      }

      let sipsArgs = ['-s', 'format', 'png', pathToScreenshotTiff, '--out', pathToResultPng];

      if (isLandscape) {
        sipsArgs = ['-r', '-90', ...sipsArgs];
      }

      try {
        yield (0, _teen_process.exec)('sips', sipsArgs);
      } catch (e) {
        throw new Error(`Cannot convert a screenshot from TIFF to PNG using sips tool. ` + `Original error: ${e.message}`);
      }

      if (!(yield _appiumSupport.fs.exists(pathToResultPng))) {
        throw new Error(`Cannot convert a screenshot from TIFF to PNG. The conversion ` + `result does not exist at '${pathToResultPng}'`);
      }

      return (yield _appiumSupport.fs.readFile(pathToResultPng)).toString('base64');
    } finally {
      yield _appiumSupport.fs.rimraf(pathToScreenshotTiff);
      yield _appiumSupport.fs.rimraf(pathToResultPng);
    }
  });
  return _getScreenshotWithIdevicelib.apply(this, arguments);
}

function verifyIdeviceScreenshotAvailable() {
  return _verifyIdeviceScreenshotAvailable.apply(this, arguments);
}

function _verifyIdeviceScreenshotAvailable() {
  _verifyIdeviceScreenshotAvailable = (0, _asyncToGenerator2.default)(function* () {
    try {
      yield _appiumSupport.fs.which('idevicescreenshot');
    } catch (err) {
      throw new Error(`No 'idevicescreenshot' program found. To use, install ` + `using 'brew install --HEAD libimobiledevice'`);
    }
  });
  return _verifyIdeviceScreenshotAvailable.apply(this, arguments);
}

commands.getScreenshot = (0, _asyncToGenerator2.default)(function* () {
  var _this = this;

  const getScreenshotFromIDS = function () {
    var _ref2 = (0, _asyncToGenerator2.default)(function* () {
      _logger.default.debug(`Taking screenshot with 'idevicescreenshot'`);

      yield verifyIdeviceScreenshotAvailable();
      const orientation = yield _this.proxyCommand('/orientation', 'GET');
      return yield getScreenshotWithIdevicelib(_this.opts.udid, orientation === 'LANDSCAPE');
    });

    return function getScreenshotFromIDS() {
      return _ref2.apply(this, arguments);
    };
  }();

  const getScreenshotFromWDA = function () {
    var _ref3 = (0, _asyncToGenerator2.default)(function* () {
      _logger.default.debug(`Taking screenshot with WDA`);

      const data = yield _this.proxyCommand('/screenshot', 'GET');

      if (!_lodash.default.isString(data)) {
        throw new Error(`Unable to take screenshot. WDA returned '${JSON.stringify(data)}'`);
      }

      return data;
    });

    return function getScreenshotFromWDA() {
      return _ref3.apply(this, arguments);
    };
  }();

  if (this.opts.realDeviceScreenshotter && this.mjpegStream) {
    _logger.default.warn("You've specified screenshot retrieval via both MJpeg server " + "and a real device screenshot utility. Please use one or the " + "other! Choosing MJPEG server");
  }

  if (this.mjpegStrem) {
    const data = yield this.mjpegStream.lastChunkPNGBase64();

    if (data) {
      return data;
    }

    _logger.default.warn("Tried to get screenshot from active MJPEG stream, but there " + "was no data yet. Falling back to regular screenshot methods.");
  }

  const useIdeviceScreenshot = _lodash.default.lowerCase(this.opts.realDeviceScreenshotter) === 'idevicescreenshot';

  if (useIdeviceScreenshot) {
    return yield getScreenshotFromIDS();
  }

  try {
    return yield getScreenshotFromWDA();
  } catch (err) {
    _logger.default.warn(`Error getting screenshot: ${err.message}`);
  }

  if (this.isSimulator()) {
    if (this.xcodeVersion.versionFloat < 8.1) {
      _logger.default.errorAndThrow(`No command line screenshot ability with Xcode ` + `${this.xcodeVersion.versionFloat}. Please upgrade to ` + `at least Xcode 8.1`);
    }

    _logger.default.info(`Falling back to 'simctl io screenshot' API`);

    return yield (0, _nodeSimctl.getScreenshot)(this.opts.udid);
  }

  try {
    return yield getScreenshotFromIDS();
  } catch (err) {
    _logger.default.warn(`Error getting screenshot through 'idevicescreenshot': ${err.message}`);
  }

  return yield (0, _asyncbox.retryInterval)(2, 1000, getScreenshotFromWDA);
});

commands.getElementScreenshot = function () {
  var _ref4 = (0, _asyncToGenerator2.default)(function* (el) {
    el = _appiumSupport.util.unwrapElement(el);

    if (this.isWebContext()) {
      const atomsElement = this.useAtomsElement(el);
      return yield this.executeAtom('getElementScreenshot', [atomsElement]);
    }

    if (this.xcodeVersion.major < 9) {
      _logger.default.errorAndThrow(`Element screenshots are only available since Xcode 9. ` + `The current Xcode version is ${this.xcodeVersion.major}.${this.xcodeVersion.minor}`);
    }

    const data = yield this.proxyCommand(`/element/${el}/screenshot`, 'GET');

    if (!_lodash.default.isString(data)) {
      _logger.default.errorAndThrow(`Unable to take a screenshot of the element ${el}. WDA returned '${JSON.stringify(data)}'`);
    }

    return data;
  });

  return function (_x3) {
    return _ref4.apply(this, arguments);
  };
}();

commands.getViewportScreenshot = (0, _asyncToGenerator2.default)(function* () {
  let statusBarHeight = yield this.getStatusBarHeight();
  const screenshot = yield this.getScreenshot();

  if (statusBarHeight === 0) {
    return screenshot;
  }

  const scale = yield this.getDevicePixelRatio();
  statusBarHeight = Math.round(statusBarHeight * scale);
  const windowSize = yield this.getWindowSize();
  let rect = {
    left: 0,
    top: statusBarHeight,
    width: windowSize.width * scale,
    height: windowSize.height * scale - statusBarHeight
  };
  let newScreenshot = yield _appiumSupport.imageUtil.cropBase64Image(screenshot, rect);
  return newScreenshot;
});
var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9zY3JlZW5zaG90cy5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsImdldFNjcmVlbnNob3RXaXRoSWRldmljZWxpYiIsInVkaWQiLCJpc0xhbmRzY2FwZSIsInBhdGhUb1NjcmVlbnNob3RUaWZmIiwidGVtcERpciIsInBhdGgiLCJwcmVmaXgiLCJzdWZmaXgiLCJmcyIsInJpbXJhZiIsInBhdGhUb1Jlc3VsdFBuZyIsImUiLCJFcnJvciIsIm1lc3NhZ2UiLCJzaXBzQXJncyIsImV4aXN0cyIsInJlYWRGaWxlIiwidG9TdHJpbmciLCJ2ZXJpZnlJZGV2aWNlU2NyZWVuc2hvdEF2YWlsYWJsZSIsIndoaWNoIiwiZXJyIiwiZ2V0U2NyZWVuc2hvdCIsImdldFNjcmVlbnNob3RGcm9tSURTIiwibG9nIiwiZGVidWciLCJvcmllbnRhdGlvbiIsInByb3h5Q29tbWFuZCIsIm9wdHMiLCJnZXRTY3JlZW5zaG90RnJvbVdEQSIsImRhdGEiLCJfIiwiaXNTdHJpbmciLCJKU09OIiwic3RyaW5naWZ5IiwicmVhbERldmljZVNjcmVlbnNob3R0ZXIiLCJtanBlZ1N0cmVhbSIsIndhcm4iLCJtanBlZ1N0cmVtIiwibGFzdENodW5rUE5HQmFzZTY0IiwidXNlSWRldmljZVNjcmVlbnNob3QiLCJsb3dlckNhc2UiLCJpc1NpbXVsYXRvciIsInhjb2RlVmVyc2lvbiIsInZlcnNpb25GbG9hdCIsImVycm9yQW5kVGhyb3ciLCJpbmZvIiwiZ2V0RWxlbWVudFNjcmVlbnNob3QiLCJlbCIsInV0aWwiLCJ1bndyYXBFbGVtZW50IiwiaXNXZWJDb250ZXh0IiwiYXRvbXNFbGVtZW50IiwidXNlQXRvbXNFbGVtZW50IiwiZXhlY3V0ZUF0b20iLCJtYWpvciIsIm1pbm9yIiwiZ2V0Vmlld3BvcnRTY3JlZW5zaG90Iiwic3RhdHVzQmFySGVpZ2h0IiwiZ2V0U3RhdHVzQmFySGVpZ2h0Iiwic2NyZWVuc2hvdCIsInNjYWxlIiwiZ2V0RGV2aWNlUGl4ZWxSYXRpbyIsIk1hdGgiLCJyb3VuZCIsIndpbmRvd1NpemUiLCJnZXRXaW5kb3dTaXplIiwicmVjdCIsImxlZnQiLCJ0b3AiLCJ3aWR0aCIsImhlaWdodCIsIm5ld1NjcmVlbnNob3QiLCJpbWFnZVV0aWwiLCJjcm9wQmFzZTY0SW1hZ2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsSUFBSUEsUUFBUSxHQUFHLEVBQWY7O1NBRWVDLDJCOzs7OztpRUFBZixXQUE0Q0MsSUFBNUMsRUFBa0RDLFdBQWxELEVBQStEO0FBQzdELFVBQU1DLG9CQUFvQixTQUFTQyx1QkFBUUMsSUFBUixDQUFhO0FBQUNDLE1BQUFBLE1BQU0sRUFBRyxjQUFhTCxJQUFLLEVBQTVCO0FBQStCTSxNQUFBQSxNQUFNLEVBQUU7QUFBdkMsS0FBYixDQUFuQztBQUNBLFVBQU1DLGtCQUFHQyxNQUFILENBQVVOLG9CQUFWLENBQU47QUFDQSxVQUFNTyxlQUFlLFNBQVNOLHVCQUFRQyxJQUFSLENBQWE7QUFBQ0MsTUFBQUEsTUFBTSxFQUFHLGNBQWFMLElBQUssRUFBNUI7QUFBK0JNLE1BQUFBLE1BQU0sRUFBRTtBQUF2QyxLQUFiLENBQTlCO0FBQ0EsVUFBTUMsa0JBQUdDLE1BQUgsQ0FBVUMsZUFBVixDQUFOOztBQUNBLFFBQUk7QUFDRixVQUFJO0FBQ0YsY0FBTSx3QkFBSyxtQkFBTCxFQUEwQixDQUFDLElBQUQsRUFBT1QsSUFBUCxFQUFhRSxvQkFBYixDQUExQixDQUFOO0FBQ0QsT0FGRCxDQUVFLE9BQU9RLENBQVAsRUFBVTtBQUNWLGNBQU0sSUFBSUMsS0FBSixDQUFXLDZDQUE0Q1gsSUFBSyxVQUFsRCxHQUNiLHNDQUFxQ1UsQ0FBQyxDQUFDRSxPQUFRLEVBRDVDLENBQU47QUFFRDs7QUFDRCxVQUFJQyxRQUFRLEdBQUcsQ0FBQyxJQUFELEVBQU8sUUFBUCxFQUFpQixLQUFqQixFQUF3Qlgsb0JBQXhCLEVBQThDLE9BQTlDLEVBQXVETyxlQUF2RCxDQUFmOztBQUNB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QU1BLE1BQUljLGFBQWEsU0FBU0MseUJBQVVDLGVBQVYsQ0FBMEJkLFVBQTFCLEVBQXNDTyxJQUF0QyxDQUExQjtBQUNBLFNBQU9LLGFBQVA7QUFDRCxDQXRCRDtlQXdCZXhFLFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGdldFNjcmVlbnNob3QgfSBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyLCB1dGlsLCBpbWFnZVV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cbmxldCBjb21tYW5kcyA9IHt9O1xuXG5hc3luYyBmdW5jdGlvbiBnZXRTY3JlZW5zaG90V2l0aElkZXZpY2VsaWIgKHVkaWQsIGlzTGFuZHNjYXBlKSB7XG4gIGNvbnN0IHBhdGhUb1NjcmVlbnNob3RUaWZmID0gYXdhaXQgdGVtcERpci5wYXRoKHtwcmVmaXg6IGBzY3JlZW5zaG90LSR7dWRpZH1gLCBzdWZmaXg6ICcudGlmZid9KTtcbiAgYXdhaXQgZnMucmltcmFmKHBhdGhUb1NjcmVlbnNob3RUaWZmKTtcbiAgY29uc3QgcGF0aFRvUmVzdWx0UG5nID0gYXdhaXQgdGVtcERpci5wYXRoKHtwcmVmaXg6IGBzY3JlZW5zaG90LSR7dWRpZH1gLCBzdWZmaXg6ICcucG5nJ30pO1xuICBhd2FpdCBmcy5yaW1yYWYocGF0aFRvUmVzdWx0UG5nKTtcbiAgdHJ5IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZXhlYygnaWRldmljZXNjcmVlbnNob3QnLCBbJy11JywgdWRpZCwgcGF0aFRvU2NyZWVuc2hvdFRpZmZdKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCB0YWtlIGEgc2NyZWVuc2hvdCBmcm9tIHRoZSBkZXZpY2UgJyR7dWRpZH0nIHVzaW5nIGAgK1xuICAgICAgICBgaWRldmljZXNjcmVlbnNob3QuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gICAgbGV0IHNpcHNBcmdzID0gWyctcycsICdmb3JtYXQnLCAncG5nJywgcGF0aFRvU2NyZWVuc2hvdFRpZmYsICctLW91dCcsIHBhdGhUb1Jlc3VsdFBuZ107XG4gICAgaWYgKGlzTGFuZHNjYXBlKSB7XG4gICAgICBzaXBzQXJncyA9IFsnLXInLCAnLTkwJywgLi4uc2lwc0FyZ3NdO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgLy8gVGhlIHNpcHMgdG9vbCBpcyBvbmx5IHByZXNlbnQgb24gTWFjIE9TXG4gICAgICBhd2FpdCBleGVjKCdzaXBzJywgc2lwc0FyZ3MpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGNvbnZlcnQgYSBzY3JlZW5zaG90IGZyb20gVElGRiB0byBQTkcgdXNpbmcgc2lwcyB0b29sLiBgICtcbiAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gICAgaWYgKCFhd2FpdCBmcy5leGlzdHMocGF0aFRvUmVzdWx0UG5nKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgY29udmVydCBhIHNjcmVlbnNob3QgZnJvbSBUSUZGIHRvIFBORy4gVGhlIGNvbnZlcnNpb24gYCArXG4gICAgICAgIGByZXN1bHQgZG9lcyBub3QgZXhpc3QgYXQgJyR7cGF0aFRvUmVzdWx0UG5nfSdgKTtcbiAgICB9XG4gICAgcmV0dXJuIChhd2FpdCBmcy5yZWFkRmlsZShwYXRoVG9SZXN1bHRQbmcpKS50b1N0cmluZygnYmFzZTY0Jyk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgZnMucmltcmFmKHBhdGhUb1NjcmVlbnNob3RUaWZmKTtcbiAgICBhd2FpdCBmcy5yaW1yYWYocGF0aFRvUmVzdWx0UG5nKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB2ZXJpZnlJZGV2aWNlU2NyZWVuc2hvdEF2YWlsYWJsZSAoKSB7XG4gIHRyeSB7XG4gICAgYXdhaXQgZnMud2hpY2goJ2lkZXZpY2VzY3JlZW5zaG90Jyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgTm8gJ2lkZXZpY2VzY3JlZW5zaG90JyBwcm9ncmFtIGZvdW5kLiBUbyB1c2UsIGluc3RhbGwgYCArXG4gICAgICAgICAgICAgICAgICAgIGB1c2luZyAnYnJldyBpbnN0YWxsIC0tSEVBRCBsaWJpbW9iaWxlZGV2aWNlJ2ApO1xuICB9XG59XG5cbmNvbW1hbmRzLmdldFNjcmVlbnNob3QgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IGdldFNjcmVlbnNob3RGcm9tSURTID0gYXN5bmMgKCkgPT4ge1xuICAgIGxvZy5kZWJ1ZyhgVGFraW5nIHNjcmVlbnNob3Qgd2l0aCAnaWRldmljZXNjcmVlbnNob3QnYCk7XG4gICAgYXdhaXQgdmVyaWZ5SWRldmljZVNjcmVlbnNob3RBdmFpbGFibGUoKTtcbiAgICBjb25zdCBvcmllbnRhdGlvbiA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvb3JpZW50YXRpb24nLCAnR0VUJyk7XG4gICAgcmV0dXJuIGF3YWl0IGdldFNjcmVlbnNob3RXaXRoSWRldmljZWxpYih0aGlzLm9wdHMudWRpZCwgb3JpZW50YXRpb24gPT09ICdMQU5EU0NBUEUnKTtcbiAgfTtcblxuICBjb25zdCBnZXRTY3JlZW5zaG90RnJvbVdEQSA9IGFzeW5jICgpID0+IHtcbiAgICBsb2cuZGVidWcoYFRha2luZyBzY3JlZW5zaG90IHdpdGggV0RBYCk7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvc2NyZWVuc2hvdCcsICdHRVQnKTtcbiAgICBpZiAoIV8uaXNTdHJpbmcoZGF0YSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIHRha2Ugc2NyZWVuc2hvdC4gV0RBIHJldHVybmVkICcke0pTT04uc3RyaW5naWZ5KGRhdGEpfSdgKTtcbiAgICB9XG4gICAgcmV0dXJuIGRhdGE7XG4gIH07XG5cbiAgLy8gZW5zdXJlIHRoZSB1c2VyIGRvZXNuJ3QgdHJ5IHRvIHVzZSAyIHNwZWNpYWx0eSBzY3JlZW5zaG90IGNhcHNcbiAgaWYgKHRoaXMub3B0cy5yZWFsRGV2aWNlU2NyZWVuc2hvdHRlciAmJiB0aGlzLm1qcGVnU3RyZWFtKSB7XG4gICAgbG9nLndhcm4oXCJZb3UndmUgc3BlY2lmaWVkIHNjcmVlbnNob3QgcmV0cmlldmFsIHZpYSBib3RoIE1KcGVnIHNlcnZlciBcIiArXG4gICAgICAgICAgICAgXCJhbmQgYSByZWFsIGRldmljZSBzY3JlZW5zaG90IHV0aWxpdHkuIFBsZWFzZSB1c2Ugb25lIG9yIHRoZSBcIiArXG4gICAgICAgICAgICAgXCJvdGhlciEgQ2hvb3NpbmcgTUpQRUcgc2VydmVyXCIpO1xuICB9XG5cbiAgLy8gaWYgd2UndmUgc3BlY2lmaWVkIGFuIG1qcGVnIHNlcnZlciwgdXNlIHRoYXRcbiAgaWYgKHRoaXMubWpwZWdTdHJlbSkge1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLm1qcGVnU3RyZWFtLmxhc3RDaHVua1BOR0Jhc2U2NCgpO1xuICAgIGlmIChkYXRhKSB7XG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG4gICAgbG9nLndhcm4oXCJUcmllZCB0byBnZXQgc2NyZWVuc2hvdCBmcm9tIGFjdGl2ZSBNSlBFRyBzdHJlYW0sIGJ1dCB0aGVyZSBcIiArXG4gICAgICAgICAgICAgXCJ3YXMgbm8gZGF0YSB5ZXQuIEZhbGxpbmcgYmFjayB0byByZWd1bGFyIHNjcmVlbnNob3QgbWV0aG9kcy5cIik7XG4gIH1cblxuICAvLyBvdGhlcndpc2UgdXNlIHRoZSByZWFsIGRldmljZSBzY3JlZW5zaG90dGVyIGFzIHNwZWNpZmllZFxuICBjb25zdCB1c2VJZGV2aWNlU2NyZWVuc2hvdCA9IF8ubG93ZXJDYXNlKHRoaXMub3B0cy5yZWFsRGV2aWNlU2NyZWVuc2hvdHRlcikgPT09ICdpZGV2aWNlc2NyZWVuc2hvdCc7XG4gIGlmICh1c2VJZGV2aWNlU2NyZWVuc2hvdCkge1xuICAgIHJldHVybiBhd2FpdCBnZXRTY3JlZW5zaG90RnJvbUlEUygpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgZ2V0U2NyZWVuc2hvdEZyb21XREEoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYEVycm9yIGdldHRpbmcgc2NyZWVuc2hvdDogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuXG4gIC8vIHNpbXVsYXRvciBhdHRlbXB0XG4gIGlmICh0aGlzLmlzU2ltdWxhdG9yKCkpIHtcbiAgICBpZiAodGhpcy54Y29kZVZlcnNpb24udmVyc2lvbkZsb2F0IDwgOC4xKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgTm8gY29tbWFuZCBsaW5lIHNjcmVlbnNob3QgYWJpbGl0eSB3aXRoIFhjb2RlIGAgK1xuICAgICAgICAgICAgICAgYCR7dGhpcy54Y29kZVZlcnNpb24udmVyc2lvbkZsb2F0fS4gUGxlYXNlIHVwZ3JhZGUgdG8gYCArXG4gICAgICAgICAgICAgICBgYXQgbGVhc3QgWGNvZGUgOC4xYCk7XG4gICAgfVxuICAgIGxvZy5pbmZvKGBGYWxsaW5nIGJhY2sgdG8gJ3NpbWN0bCBpbyBzY3JlZW5zaG90JyBBUElgKTtcbiAgICByZXR1cm4gYXdhaXQgZ2V0U2NyZWVuc2hvdCh0aGlzLm9wdHMudWRpZCk7XG4gIH1cblxuICAvLyBhbGwgc2ltdWxhdG9yIHNjZW5hcmlvcyBhcmUgZmluaXNoZWRcbiAgLy8gcmVhbCBkZXZpY2UsIHNvIHRyeSBpZGV2aWNlc2NyZWVuc2hvdCBpZiBwb3NzaWJsZVxuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCBnZXRTY3JlZW5zaG90RnJvbUlEUygpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgRXJyb3IgZ2V0dGluZyBzY3JlZW5zaG90IHRocm91Z2ggJ2lkZXZpY2VzY3JlZW5zaG90JzogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuXG4gIC8vIFJldHJ5IGZvciByZWFsIGRldmljZXMgb25seS4gRmFpbCBmYXN0IG9uIFNpbXVsYXRvciBpZiBzaW1jdGwgZG9lcyBub3Qgd29yayBhcyBleHBlY3RlZFxuICByZXR1cm4gYXdhaXQgcmV0cnlJbnRlcnZhbCgyLCAxMDAwLCBnZXRTY3JlZW5zaG90RnJvbVdEQSk7XG59O1xuXG5jb21tYW5kcy5nZXRFbGVtZW50U2NyZWVuc2hvdCA9IGFzeW5jIGZ1bmN0aW9uIChlbCkge1xuICBlbCA9IHV0aWwudW53cmFwRWxlbWVudChlbCk7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgY29uc3QgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRFbGVtZW50U2NyZWVuc2hvdCcsIFthdG9tc0VsZW1lbnRdKTtcbiAgfVxuXG4gIGlmICh0aGlzLnhjb2RlVmVyc2lvbi5tYWpvciA8IDkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgRWxlbWVudCBzY3JlZW5zaG90cyBhcmUgb25seSBhdmFpbGFibGUgc2luY2UgWGNvZGUgOS4gYCArXG4gICAgICAgICAgICAgICAgICAgICAgYFRoZSBjdXJyZW50IFhjb2RlIHZlcnNpb24gaXMgJHt0aGlzLnhjb2RlVmVyc2lvbi5tYWpvcn0uJHt0aGlzLnhjb2RlVmVyc2lvbi5taW5vcn1gKTtcbiAgfVxuICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7ZWx9L3NjcmVlbnNob3RgLCAnR0VUJyk7XG4gIGlmICghXy5pc1N0cmluZyhkYXRhKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBVbmFibGUgdG8gdGFrZSBhIHNjcmVlbnNob3Qgb2YgdGhlIGVsZW1lbnQgJHtlbH0uIFdEQSByZXR1cm5lZCAnJHtKU09OLnN0cmluZ2lmeShkYXRhKX0nYCk7XG4gIH1cbiAgcmV0dXJuIGRhdGE7XG59O1xuXG5jb21tYW5kcy5nZXRWaWV3cG9ydFNjcmVlbnNob3QgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxldCBzdGF0dXNCYXJIZWlnaHQgPSBhd2FpdCB0aGlzLmdldFN0YXR1c0JhckhlaWdodCgpO1xuICBjb25zdCBzY3JlZW5zaG90ID0gYXdhaXQgdGhpcy5nZXRTY3JlZW5zaG90KCk7XG5cbiAgLy8gaWYgd2UgZG9uJ3QgaGF2ZSBhIHN0YXR1cyBiYXIsIHRoZXJlJ3Mgbm90aGluZyB0byBjcm9wLCBzbyB3ZSBjYW4gYXZvaWRcbiAgLy8gZXh0cmEgY2FsbHMgYW5kIHJldHVybiBzdHJhaWdodGF3YXlcbiAgaWYgKHN0YXR1c0JhckhlaWdodCA9PT0gMCkge1xuICAgIHJldHVybiBzY3JlZW5zaG90O1xuICB9XG5cbiAgY29uc3Qgc2NhbGUgPSBhd2FpdCB0aGlzLmdldERldmljZVBpeGVsUmF0aW8oKTtcbiAgLy8gc3RhdHVzIGJhciBoZWlnaHQgY29tZXMgaW4gdW5zY2FsZWQsIHNvIHNjYWxlIGl0XG4gIHN0YXR1c0JhckhlaWdodCA9IE1hdGgucm91bmQoc3RhdHVzQmFySGVpZ2h0ICogc2NhbGUpO1xuICBjb25zdCB3aW5kb3dTaXplID0gYXdhaXQgdGhpcy5nZXRXaW5kb3dTaXplKCk7XG4gIGxldCByZWN0ID0ge1xuICAgIGxlZnQ6IDAsXG4gICAgdG9wOiBzdGF0dXNCYXJIZWlnaHQsXG4gICAgd2lkdGg6IHdpbmRvd1NpemUud2lkdGggKiBzY2FsZSxcbiAgICBoZWlnaHQ6ICgod2luZG93U2l6ZS5oZWlnaHQgKiBzY2FsZSkgLSBzdGF0dXNCYXJIZWlnaHQpXG4gIH07XG4gIGxldCBuZXdTY3JlZW5zaG90ID0gYXdhaXQgaW1hZ2VVdGlsLmNyb3BCYXNlNjRJbWFnZShzY3JlZW5zaG90LCByZWN0KTtcbiAgcmV0dXJuIG5ld1NjcmVlbnNob3Q7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3NjcmVlbnNob3RzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
