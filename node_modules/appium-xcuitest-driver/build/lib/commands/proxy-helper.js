"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _appiumBaseDriver = require("appium-base-driver");

var _logger = _interopRequireDefault(require("../logger"));

var _bluebird = _interopRequireDefault(require("bluebird"));

const GET = 'GET';
const POST = 'POST';
const DELETE = 'DELETE';
const SUPPORTED_METHODS = [GET, POST, DELETE];
let helpers = {},
    extensions = {};
exports.helpers = helpers;
const WDA_ROUTES = {
  '/wda/touch/perform': {
    POST: 'performTouch'
  },
  '/wda/touch/multi/perform': {
    POST: 'performMultiAction'
  },
  '/wda/screen': {
    GET: 'getScreenInfo'
  },
  '/wda/alert/buttons': {
    GET: 'getAlertButtons'
  },
  '/wda/apps/launch': {
    POST: 'mobileLaunchApp'
  },
  '/wda/apps/terminate': {
    POST: 'mobileTerminateApp'
  },
  '/wda/apps/activate': {
    POST: 'mobileActivateApp'
  },
  '/wda/apps/state': {
    POST: 'mobileQueryAppState'
  },
  '/wda/keys': {
    POST: 'keys'
  },
  '/wda/touch_id': {
    POST: 'touchId'
  },
  '/wda/keyboard/dismiss': {
    POST: 'hideKeyboard'
  },
  '/wda/lock': {
    POST: 'lock'
  },
  '/wda/unlock': {
    POST: 'unlock'
  },
  '/wda/locked': {
    GET: 'isLocked'
  },
  '/wda/tap/nil': {
    POST: 'clickCoords'
  },
  '/window/size': {
    GET: 'getWindowSize'
  }
};

function wdaRouteToCommandName(endpoint, method) {
  return WDA_ROUTES[endpoint] ? WDA_ROUTES[endpoint][method] : null;
}

helpers.proxyCommand = function () {
  var _ref = (0, _asyncToGenerator2.default)(function* (endpoint, method, body, isSessionCommand = true) {
    if (this.shutdownUnexpectedly) {
      return;
    }

    if (!endpoint) {
      _logger.default.errorAndThrow('Proxying requires an endpoint');
    } else if (SUPPORTED_METHODS.indexOf(method) === -1) {
      _logger.default.errorAndThrow(`Proxying only works for the following requests: ${SUPPORTED_METHODS.join(', ')}`);
    }

    if (!this.wda) {
      throw new Error('Cannot call proxyCommand without WDA driver active');
    }

    const proxy = isSessionCommand ? this.wda.jwproxy : this.wda.noSessionProxy;

    if (!proxy) {
      throw new Error('Cannot call proxyCommand without WDA proxy active');
    }

    let cmdName = wdaRouteToCommandName(endpoint, method) || (0, _appiumBaseDriver.routeToCommandName)(endpoint, method);

    const timeout = this._getCommandTimeout(cmdName);

    if (!cmdName) {
      cmdName = 'Unknown';

      _logger.default.warn(`Proxying to WDA with an unknown route: ${method} ${endpoint}`);
    }

    if (!timeout) {
      return yield proxy.command(endpoint, method, body);
    }

    _logger.default.debug(`Setting custom timeout to ${timeout} ms for '${cmdName}' command`);

    let isCommandExpired = false;
    const res = yield _bluebird.default.resolve(proxy.command(endpoint, method, body)).timeout(timeout).catch(_bluebird.default.Promise.TimeoutError, () => {
      isCommandExpired = true;
    });

    if (isCommandExpired) {
      proxy.cancelActiveRequests();
      const errMsg = `Appium did not get any response from '${cmdName}' command in ${timeout} ms`;
      yield this.startUnexpectedShutdown(new _appiumBaseDriver.errors.TimeoutError(errMsg));

      _logger.default.errorAndThrow(errMsg);
    }

    return res;
  });

  return function (_x, _x2, _x3) {
    return _ref.apply(this, arguments);
  };
}();

Object.assign(extensions, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9wcm94eS1oZWxwZXIuanMiXSwibmFtZXMiOlsiR0VUIiwiUE9TVCIsIkRFTEVURSIsIlNVUFBPUlRFRF9NRVRIT0RTIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJXREFfUk9VVEVTIiwid2RhUm91dGVUb0NvbW1hbmROYW1lIiwiZW5kcG9pbnQiLCJtZXRob2QiLCJwcm94eUNvbW1hbmQiLCJib2R5IiwiaXNTZXNzaW9uQ29tbWFuZCIsInNodXRkb3duVW5leHBlY3RlZGx5IiwibG9nIiwiZXJyb3JBbmRUaHJvdyIsImluZGV4T2YiLCJqb2luIiwid2RhIiwiRXJyb3IiLCJwcm94eSIsImp3cHJveHkiLCJub1Nlc3Npb25Qcm94eSIsImNtZE5hbWUiLCJ0aW1lb3V0IiwiX2dldENvbW1hbmRUaW1lb3V0Iiwid2FybiIsImNvbW1hbmQiLCJkZWJ1ZyIsImlzQ29tbWFuZEV4cGlyZWQiLCJyZXMiLCJCIiwicmVzb2x2ZSIsImNhdGNoIiwiUHJvbWlzZSIsIlRpbWVvdXRFcnJvciIsImNhbmNlbEFjdGl2ZVJlcXVlc3RzIiwiZXJyTXNnIiwic3RhcnRVbmV4cGVjdGVkU2h1dGRvd24iLCJlcnJvcnMiLCJPYmplY3QiLCJhc3NpZ24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsR0FBRyxHQUFHLEtBQVo7QUFDQSxNQUFNQyxJQUFJLEdBQUcsTUFBYjtBQUNBLE1BQU1DLE1BQU0sR0FBRyxRQUFmO0FBQ0EsTUFBTUMsaUJBQWlCLEdBQUcsQ0FBQ0gsR0FBRCxFQUFNQyxJQUFOLEVBQVlDLE1BQVosQ0FBMUI7QUFFQSxJQUFJRSxPQUFPLEdBQUcsRUFBZDtBQUFBLElBQWtCQyxVQUFVLEdBQUcsRUFBL0I7O0FBRUEsTUFBTUMsVUFBVSxHQUFHO0FBQ2pCLHdCQUFzQjtBQUNwQkwsSUFBQUEsSUFBSSxFQUFFO0FBRGMsR0FETDtBQUlqQiw4QkFBNEI7QUFDMUJBLElBQUFBLElBQUksRUFB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LDZCQUE0QkosT0FBUSxZQUFXRCxPQUFRLFdBQWxFOztBQUNBLFFBQUlNLGdCQUFnQixHQUFHLEtBQXZCO0FBQ0EsVUFBTUMsR0FBRyxTQUFTQyxrQkFBRUMsT0FBRixDQUFVWixLQUFLLENBQUNPLE9BQU4sQ0FBY25CLFFBQWQsRUFBd0JDLE1BQXhCLEVBQWdDRSxJQUFoQyxDQUFWLEVBQ0hhLE9BREcsQ0FDS0EsT0FETCxFQUVIUyxLQUZHLENBRUdGLGtCQUFFRyxPQUFGLENBQVVDLFlBRmIsRUFFMkIsTUFBTTtBQUNuQ04sTUFBQUEsZ0JBQWdCLEdBQUcsSUFBbkI7QUFDRCxLQUpHLENBQWxCOztBQUtBLFFBQUlBLGdCQUFKLEVBQXNCO0FBQ3BCVCxNQUFBQSxLQUFLLENBQUNnQixvQkFBTjtBQUNBLFlBQU1DLE1BQU0sR0FBSSx5Q0FBd0NkLE9BQVEsZ0JBQWVDLE9BQVEsS0FBdkY7QUFDQSxZQUFNLEtBQUtjLHVCQUFMLENBQTZCLElBQUlDLHlCQUFPSixZQUFYLENBQXdCRSxNQUF4QixDQUE3QixDQUFOOztBQUNBdkIsc0JBQUlDLGFBQUosQ0FBa0JzQixNQUFsQjtBQUNEOztBQUNELFdBQU9QLEdBQVA7QUFDRCxHQTdDRDs7QUFBQTtBQUFBO0FBQUE7QUFBQTs7QUErQ0FVLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjcEMsVUFBZCxFQUEwQkQsT0FBMUI7ZUFFZUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGVycm9ycywgcm91dGVUb0NvbW1hbmROYW1lIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuXG5jb25zdCBHRVQgPSAnR0VUJztcbmNvbnN0IFBPU1QgPSAnUE9TVCc7XG5jb25zdCBERUxFVEUgPSAnREVMRVRFJztcbmNvbnN0IFNVUFBPUlRFRF9NRVRIT0RTID0gW0dFVCwgUE9TVCwgREVMRVRFXTtcblxubGV0IGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb25zdCBXREFfUk9VVEVTID0ge1xuICAnL3dkYS90b3VjaC9wZXJmb3JtJzoge1xuICAgIFBPU1Q6ICdwZXJmb3JtVG91Y2gnLFxuICB9LFxuICAnL3dkYS90b3VjaC9tdWx0aS9wZXJmb3JtJzoge1xuICAgIFBPU1Q6ICdwZXJmb3JtTXVsdGlBY3Rpb24nLFxuICB9LFxuICAnL3dkYS9zY3JlZW4nOiB7XG4gICAgR0VUOiAnZ2V0U2NyZWVuSW5mbycsXG4gIH0sXG4gICcvd2RhL2FsZXJ0L2J1dHRvbnMnOiB7XG4gICAgR0VUOiAnZ2V0QWxlcnRCdXR0b25zJyxcbiAgfSxcbiAgJy93ZGEvYXBwcy9sYXVuY2gnOiB7XG4gICAgUE9TVDogJ21vYmlsZUxhdW5jaEFwcCcsXG4gIH0sXG4gICcvd2RhL2FwcHMvdGVybWluYXRlJzoge1xuICAgIFBPU1Q6ICdtb2JpbGVUZXJtaW5hdGVBcHAnLFxuICB9LFxuICAnL3dkYS9hcHBzL2FjdGl2YXRlJzoge1xuICAgIFBPU1Q6ICdtb2JpbGVBY3RpdmF0ZUFwcCcsXG4gIH0sXG4gICcvd2RhL2FwcHMvc3RhdGUnOiB7XG4gICAgUE9TVDogJ21vYmlsZVF1ZXJ5QXBwU3RhdGUnLFxuICB9LFxuICAnL3dkYS9rZXlzJzoge1xuICAgIFBPU1Q6ICdrZXlzJyxcbiAgfSxcbiAgJy93ZGEvdG91Y2hfaWQnOiB7XG4gICAgUE9TVDogJ3RvdWNoSWQnLFxuICB9LFxuICAnL3dkYS9rZXlib2FyZC9kaXNtaXNzJzoge1xuICAgIFBPU1Q6ICdoaWRlS2V5Ym9hcmQnLFxuICB9LFxuICAnL3dkYS9sb2NrJzoge1xuICAgIFBPU1Q6ICdsb2NrJyxcbiAgfSxcbiAgJy93ZGEvdW5sb2NrJzoge1xuICAgIFBPU1Q6ICd1bmxvY2snLFxuICB9LFxuICAnL3dkYS9sb2NrZWQnOiB7XG4gICAgR0VUOiAnaXNMb2NrZWQnLFxuICB9LFxuICAnL3dkYS90YXAvbmlsJzoge1xuICAgIFBPU1Q6ICdjbGlja0Nvb3JkcycsXG4gIH0sXG4gICcvd2luZG93L3NpemUnOiB7XG4gICAgR0VUOiAnZ2V0V2luZG93U2l6ZScsXG4gIH0sXG59O1xuXG5mdW5jdGlvbiB3ZGFSb3V0ZVRvQ29tbWFuZE5hbWUgKGVuZHBvaW50LCBtZXRob2QpIHtcbiAgcmV0dXJuIFdEQV9ST1VURVNbZW5kcG9pbnRdID8gV0RBX1JPVVRFU1tlbmRwb2ludF1bbWV0aG9kXSA6IG51bGw7XG59XG5cbmhlbHBlcnMucHJveHlDb21tYW5kID0gYXN5bmMgZnVuY3Rpb24gKGVuZHBvaW50LCBtZXRob2QsIGJvZHksIGlzU2Vzc2lvbkNvbW1hbmQgPSB0cnVlKSB7XG4gIGlmICh0aGlzLnNodXRkb3duVW5leHBlY3RlZGx5KSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKCFlbmRwb2ludCkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdQcm94eWluZyByZXF1aXJlcyBhbiBlbmRwb2ludCcpO1xuICB9IGVsc2UgaWYgKFNVUFBPUlRFRF9NRVRIT0RTLmluZGV4T2YobWV0aG9kKSA9PT0gLTEpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgUHJveHlpbmcgb25seSB3b3JrcyBmb3IgdGhlIGZvbGxvd2luZyByZXF1ZXN0czogJHtTVVBQT1JURURfTUVUSE9EUy5qb2luKCcsICcpfWApO1xuICB9XG5cbiAgaWYgKCF0aGlzLndkYSkge1xuICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGNhbGwgcHJveHlDb21tYW5kIHdpdGhvdXQgV0RBIGRyaXZlciBhY3RpdmUnKTtcbiAgfVxuICBjb25zdCBwcm94eSA9IGlzU2Vzc2lvbkNvbW1hbmQgPyB0aGlzLndkYS5qd3Byb3h5IDogdGhpcy53ZGEubm9TZXNzaW9uUHJveHk7XG4gIGlmICghcHJveHkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBjYWxsIHByb3h5Q29tbWFuZCB3aXRob3V0IFdEQSBwcm94eSBhY3RpdmUnKTtcbiAgfVxuXG4gIGxldCBjbWROYW1lID0gd2RhUm91dGVUb0NvbW1hbmROYW1lKGVuZHBvaW50LCBtZXRob2QpIHx8IHJvdXRlVG9Db21tYW5kTmFtZShlbmRwb2ludCwgbWV0aG9kKTtcbiAgY29uc3QgdGltZW91dCA9IHRoaXMuX2dldENvbW1hbmRUaW1lb3V0KGNtZE5hbWUpO1xuICBpZiAoIWNtZE5hbWUpIHtcbiAgICAvLyB0aGlzIHNob3VsZCBuZXZlciBoYXBwZW4gZXhjZXB0IHdoZW4gYWRkaW5nIG5ldyByb3V0ZXNcbiAgICBjbWROYW1lID0gJ1Vua25vd24nOyAvLyBqdXN0IGZvciBsb2dnaW5nIHB1cnBvc2VzIGJlbG93XG4gICAgbG9nLndhcm4oYFByb3h5aW5nIHRvIFdEQSB3aXRoIGFuIHVua25vd24gcm91dGU6ICR7bWV0aG9kfSAke2VuZHBvaW50fWApO1xuICB9XG5cbiAgaWYgKCF0aW1lb3V0KSB7XG4gICAgcmV0dXJuIGF3YWl0IHByb3h5LmNvbW1hbmQoZW5kcG9pbnQsIG1ldGhvZCwgYm9keSk7XG4gIH1cblxuICBsb2cuZGVidWcoYFNldHRpbmcgY3VzdG9tIHRpbWVvdXQgdG8gJHt0aW1lb3V0fSBtcyBmb3IgJyR7Y21kTmFtZX0nIGNvbW1hbmRgKTtcbiAgbGV0IGlzQ29tbWFuZEV4cGlyZWQgPSBmYWxzZTtcbiAgY29uc3QgcmVzID0gYXdhaXQgQi5yZXNvbHZlKHByb3h5LmNvbW1hbmQoZW5kcG9pbnQsIG1ldGhvZCwgYm9keSkpXG4gICAgICAgICAgICAgICAgLnRpbWVvdXQodGltZW91dClcbiAgICAgICAgICAgICAgICAuY2F0Y2goQi5Qcm9taXNlLlRpbWVvdXRFcnJvciwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgaXNDb21tYW5kRXhwaXJlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfSk7XG4gIGlmIChpc0NvbW1hbmRFeHBpcmVkKSB7XG4gICAgcHJveHkuY2FuY2VsQWN0aXZlUmVxdWVzdHMoKTtcbiAgICBjb25zdCBlcnJNc2cgPSBgQXBwaXVtIGRpZCBub3QgZ2V0IGFueSByZXNwb25zZSBmcm9tICcke2NtZE5hbWV9JyBjb21tYW5kIGluICR7dGltZW91dH0gbXNgO1xuICAgIGF3YWl0IHRoaXMuc3RhcnRVbmV4cGVjdGVkU2h1dGRvd24obmV3IGVycm9ycy5UaW1lb3V0RXJyb3IoZXJyTXNnKSk7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coZXJyTXNnKTtcbiAgfVxuICByZXR1cm4gcmVzO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9wcm94eS1oZWxwZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
