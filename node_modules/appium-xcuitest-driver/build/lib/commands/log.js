"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumIosDriver = require("appium-ios-driver");

var _iosCrashLog = require("../device-log/ios-crash-log");

var _iosLog = require("../device-log/ios-log");

var _logger = _interopRequireDefault(require("../logger"));

var _ws = _interopRequireDefault(require("ws"));

var _safariConsoleLog = _interopRequireDefault(require("../device-log/safari-console-log"));

var _safariNetworkLog = _interopRequireDefault(require("../device-log/safari-network-log"));

let extensions = {};

const WEBSOCKET_ENDPOINT = sessionId => `${_appiumBaseDriver.DEFAULT_WS_PATHNAME_PREFIX}/session/${sessionId}/appium/device/syslog`;

Object.assign(extensions, _appiumIosDriver.iosCommands.logging);
extensions.supportedLogTypes.safariConsole = {
  description: 'Safari Console Logs - data written to the JS console in Safari',
  getter: function () {
    var _getter = (0, _asyncToGenerator2.default)(function* (self) {
      return yield self.extractLogs('safariConsole', self.logs);
    });

    return function getter(_x) {
      return _getter.apply(this, arguments);
    };
  }()
};
extensions.supportedLogTypes.safariNetwork = {
  description: 'Safari Network Logs - information about network operations undertaken by Safari',
  getter: function () {
    var _getter2 = (0, _asyncToGenerator2.default)(function* (self) {
      return yield self.extractLogs('safariNetwork', self.logs);
    });

    return function getter(_x2) {
      return _getter2.apply(this, arguments);
    };
  }()
};
extensions.startLogCapture = (0, _asyncToGenerator2.default)(function* () {
  this.logs = this.logs || {};

  if (!_lodash.default.isUndefined(this.logs.syslog) && this.logs.syslog.isCapturing) {
    _logger.default.warn('Trying to start iOS log capture but it has already started!');

    return true;
  }

  if (_lodash.default.isUndefined(this.logs.syslog)) {
    this.logs.crashlog = new _iosCrashLog.IOSCrashLog({
      sim: this.opts.device,
      udid: this.isRealDevice() ? this.opts.udid : undefined
    });
    this.logs.syslog = new _iosLog.IOSLog({
      sim: this.opts.device,
      udid: this.isRealDevice() ? this.opts.udid : undefined,
      showLogs: this.opts.showIOSLog,
      realDeviceLogger: this.opts.realDeviceLogger,
      xcodeVersion: this.xcodeVersion
    });
    this.logs.safariConsole = new _safariConsoleLog.default(!!this.opts.showSafariConsoleLog);
    this.logs.safariNetwork = new _safariNetworkLog.default(!!this.opts.showSafariNetworkLog);
  }

  try {
    yield this.logs.syslog.startCapture();
  } catch (err) {
    _logger.default.warn(`Continuing without capturing device logs: ${err.message}`);

    return false;
  }

  yield this.logs.crashlog.startCapture();
  yield this.logs.safariConsole.startCapture();
  yield this.logs.safariNetwork.startCapture();
  return true;
});
extensions.mobileStartLogsBroadcast = (0, _asyncToGenerator2.default)(function* () {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (!_lodash.default.isEmpty((yield this.server.getWebSocketHandlers(pathname)))) {
    _logger.default.debug(`The system logs broadcasting web socket server is already listening at ${pathname}`);

    return;
  }

  _logger.default.info(`Assigning system logs broadcasting web socket server to ${pathname}`);

  const wss = new _ws.default.Server({
    noServer: true
  });
  wss.on('connection', (ws, req) => {
    if (req) {
      const remoteIp = _lodash.default.isEmpty(req.headers['x-forwarded-for']) ? req.connection.remoteAddress : req.headers['x-forwarded-for'];

      _logger.default.debug(`Established a new system logs listener web socket connection from ${remoteIp}`);
    } else {
      _logger.default.debug('Established a new system logs listener web socket connection');
    }

    if (_lodash.default.isEmpty(this._syslogWebsocketListener)) {
      this._syslogWebsocketListener = logRecord => {
        if (ws && ws.readyState === _ws.default.OPEN) {
          ws.send(logRecord.message);
        }
      };
    }

    this.logs.syslog.on('output', this._syslogWebsocketListener);
    ws.on('close', (code, reason) => {
      if (!_lodash.default.isEmpty(this._syslogWebsocketListener)) {
        this.logs.syslog.removeListener('output', this._syslogWebsocketListener);
        this._syslogWebsocketListener = null;
      }

      let closeMsg = 'System logs listener web socket is closed.';

      if (!_lodash.default.isEmpty(code)) {
        closeMsg += ` Code: ${code}.`;
      }

      if (!_lodash.default.isEmpty(reason)) {
        closeMsg += ` Reason: ${reason}.`;
      }

      _logger.default.debug(closeMsg);
    });
  });
  yield this.server.addWebSocketHandler(pathname, wss);
});
extensions.mobileStopLogsBroadcast = (0, _asyncToGenerator2.default)(function* () {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (_lodash.default.isEmpty((yield this.server.getWebSocketHandlers(pathname)))) {
    return;
  }

  _logger.default.debug('Stopping the system logs broadcasting web socket server');

  yield this.server.removeWebSocketHandler(pathname);
});
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9sb2cuanMiXSwibmFtZXMiOlsiZXh0ZW5zaW9ucyIsIldFQlNPQ0tFVF9FTkRQT0lOVCIsInNlc3Npb25JZCIsIkRFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYIiwiT2JqZWN0IiwiYXNzaWduIiwiaW9zQ29tbWFuZHMiLCJsb2dnaW5nIiwic3VwcG9ydGVkTG9nVHlwZXMiLCJzYWZhcmlDb25zb2xlIiwiZGVzY3JpcHRpb24iLCJnZXR0ZXIiLCJzZWxmIiwiZXh0cmFjdExvZ3MiLCJsb2dzIiwic2FmYXJpTmV0d29yayIsInN0YXJ0TG9nQ2FwdHVyZSIsIl8iLCJpc1VuZGVmaW5lZCIsInN5c2xvZyIsImlzQ2FwdHVyaW5nIiwibG9nIiwid2FybiIsImNyYXNobG9nIiwiSU9TQ3Jhc2hMb2ciLCJzaW0iLCJvcHRzIiwiZGV2aWNlIiwidWRpZCIsImlzUmVhbERldmljZSIsInVuZGVmaW5lZCIsIklPU0xvZyIsInNob3dMb2dzIiwic2hvd0lPU0xvZyIsInJlYWxEZXZpY2VMb2dnZXIiLCJ4Y29kZVZlcnNpb24iLCJTYWZhcmlDb25zb2xlTG9nIiwic2hvd1NhZmFyaUNvbnNvbGVMb2ciLCJTYWZhcmlOZXR3b3JrTG9nIiwic2hvd1NhZmFyaU5ldHdvcmtMb2ciLCJzdGFydENhcHR1cmUiLCJlcnIiLCJtZXNzYWdlIiwibW9iaWxlU3RhcnRMb2dzQnJvYWRjYXN0IiwicGF0aG5hbWUiLCJpc0VtcHR5Iiwic2VydmVyIiwiZ2V0V2ViU29ja2V0SGFuZGxlcnMiLCJkZWJ1ZyIsImluZm8iLCJ3c3MiLCJXZWJTb2NrZXQiLCJTZXJ2ZXIiLCJub1NlcnZlciIsIm9uIiwid3MiLCJyZXEiLCJyZW1vdGVJcCIsImhlYWRlcnMiLCJjb25uZWN0aW9uIiwicmVtb3RlQWRkcmVzcyIsIl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lciIsImxvZ1JlY29yZCIsInJlYWR5U3RhdGUiLCJPUEVOIiwic2VuZCIsImNvZGUiLCJyZWFzb24iLCJyZW1vdmVMaXN0ZW5lciIsImNsb3NlTXNnIiwiYWRkV2ViU29ja2V0SGFuZGxlciIsIm1vYmlsZVN0b3BMb2dzQnJvYWRjYXN0IiwicmVtb3ZlV2ViU29ja2V0SGFuZGxlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxJQUFJQSxVQUFVLEdBQUcsRUFBakI7O0FBRUEsTUFBTUMsa0JBQWtCLEdBQUlDLFNBQUQsSUFBZ0IsR0FBRUMsNENBQTJCLFlBQVdELFNBQVUsdUJBQTdGOztBQUVBRSxNQUFNLENBQUNDLE1BQVAsQ0FBY0wsVUFBZCxFQUEwQk0sNkJBQVlDLE9BQXRDO0FBRUFQLFVBQVUsQ0FBQ1EsaUJBQVgsQ0FBNkJDLGFBQTdCLEdBQTZDO0FBQzNDQyxFQUFBQSxXQUFXLEVBQUUsZ0VBRDhCO0FBRTNDQyxFQUFBQSxNQUFNO0FBQUEsa0RBQUUsV0FBT0MsSUFBUDtBQUFBLG1CQUFzQkEsSUFBSSxDQUFDQyxXQUFMLENBQWlCLGVBQWpCLEVBQWtDRCxJQUFJLENBQUNFLElBQXZDLENBQXRCO0FBQUEsS0FBRjs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUZxQyxDQUE3QztBQUtBZCxVQUFVLENBQUNRLGlCQUFYLENBQTZCTyxhQUE3QixHQUE2QztBQUMzQ0wsRUFBQUEsV0FBVyxFQUFFLGlGQUQ4QjtBQUUzQ0MsRUFBQUEsTUFBTTtBQUFBLG1EQUFFLFdBQU9DLElBQVA7QUFBQSxtQkFBc0JBLElBQUksQ0FBQ0MsV0FBTCxDQUFpQixlQUFqQixFQUFrQ0QsSUFBSSxDQUFDRSxJQUF2QyxDQUF0QjtBQUFBLEtBQUY7O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFGcUMsQ0FBN0M7QUFLQWQsVUFBVSxDQUFDZ0IsZUFBWCxtQ0FBNkIsYUFBa0I7QUFDN0MsT0FBS0YsSUFBTCxHQUFZLEtBQUtBLElBQUwsSUFBYSxFQUF6Qjs7QUFDQSxNQUFJLENBQUNHLGdCQUFFQyxXQUFGLENBQWMsS0FBS0osSUFBTCxDQUFV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Q0FBVXFCLFFBQVY7QUFDRCxLQWREO0FBZUQsR0FsQ0Q7QUFtQ0EsUUFBTSxLQUFLdkIsTUFBTCxDQUFZd0IsbUJBQVosQ0FBZ0MxQixRQUFoQyxFQUEwQ00sR0FBMUMsQ0FBTjtBQUNELENBaEREO0FBc0RBbEQsVUFBVSxDQUFDdUUsdUJBQVgsbUNBQXFDLGFBQWtCO0FBQ3JELFFBQU0zQixRQUFRLEdBQUczQyxrQkFBa0IsQ0FBQyxLQUFLQyxTQUFOLENBQW5DOztBQUNBLE1BQUllLGdCQUFFNEIsT0FBRixRQUFnQixLQUFLQyxNQUFMLENBQVlDLG9CQUFaLENBQWlDSCxRQUFqQyxDQUFoQixFQUFKLEVBQWlFO0FBQy9EO0FBQ0Q7O0FBRUR2QixrQkFBSTJCLEtBQUosQ0FBVSx5REFBVjs7QUFDQSxRQUFNLEtBQUtGLE1BQUwsQ0FBWTBCLHNCQUFaLENBQW1DNUIsUUFBbkMsQ0FBTjtBQUNELENBUkQ7ZUFXZTVDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgREVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVggfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgaW9zQ29tbWFuZHMgfSBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgeyBJT1NDcmFzaExvZyB9IGZyb20gJy4uL2RldmljZS1sb2cvaW9zLWNyYXNoLWxvZyc7XG5pbXBvcnQgeyBJT1NMb2cgfSBmcm9tICcuLi9kZXZpY2UtbG9nL2lvcy1sb2cnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IFdlYlNvY2tldCBmcm9tICd3cyc7XG5pbXBvcnQgU2FmYXJpQ29uc29sZUxvZyBmcm9tICcuLi9kZXZpY2UtbG9nL3NhZmFyaS1jb25zb2xlLWxvZyc7XG5pbXBvcnQgU2FmYXJpTmV0d29ya0xvZyBmcm9tICcuLi9kZXZpY2UtbG9nL3NhZmFyaS1uZXR3b3JrLWxvZyc7XG5cblxubGV0IGV4dGVuc2lvbnMgPSB7fTtcblxuY29uc3QgV0VCU09DS0VUX0VORFBPSU5UID0gKHNlc3Npb25JZCkgPT4gYCR7REVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVh9L3Nlc3Npb24vJHtzZXNzaW9uSWR9L2FwcGl1bS9kZXZpY2Uvc3lzbG9nYDtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBpb3NDb21tYW5kcy5sb2dnaW5nKTtcblxuZXh0ZW5zaW9ucy5zdXBwb3J0ZWRMb2dUeXBlcy5zYWZhcmlDb25zb2xlID0ge1xuICBkZXNjcmlwdGlvbjogJ1NhZmFyaSBDb25zb2xlIExvZ3MgLSBkYXRhIHdyaXR0ZW4gdG8gdGhlIEpTIGNvbnNvbGUgaW4gU2FmYXJpJyxcbiAgZ2V0dGVyOiBhc3luYyAoc2VsZikgPT4gYXdhaXQgc2VsZi5leHRyYWN0TG9ncygnc2FmYXJpQ29uc29sZScsIHNlbGYubG9ncyksXG59O1xuXG5leHRlbnNpb25zLnN1cHBvcnRlZExvZ1R5cGVzLnNhZmFyaU5ldHdvcmsgPSB7XG4gIGRlc2NyaXB0aW9uOiAnU2FmYXJpIE5ldHdvcmsgTG9ncyAtIGluZm9ybWF0aW9uIGFib3V0IG5ldHdvcmsgb3BlcmF0aW9ucyB1bmRlcnRha2VuIGJ5IFNhZmFyaScsXG4gIGdldHRlcjogYXN5bmMgKHNlbGYpID0+IGF3YWl0IHNlbGYuZXh0cmFjdExvZ3MoJ3NhZmFyaU5ldHdvcmsnLCBzZWxmLmxvZ3MpLFxufTtcblxuZXh0ZW5zaW9ucy5zdGFydExvZ0NhcHR1cmUgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIHRoaXMubG9ncyA9IHRoaXMubG9ncyB8fCB7fTtcbiAgaWYgKCFfLmlzVW5kZWZpbmVkKHRoaXMubG9ncy5zeXNsb2cpICYmIHRoaXMubG9ncy5zeXNsb2cuaXNDYXB0dXJpbmcpIHtcbiAgICBsb2cud2FybignVHJ5aW5nIHRvIHN0YXJ0IGlPUyBsb2cgY2FwdHVyZSBidXQgaXQgaGFzIGFscmVhZHkgc3RhcnRlZCEnKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBpZiAoXy5pc1VuZGVmaW5lZCh0aGlzLmxvZ3Muc3lzbG9nKSkge1xuICAgIHRoaXMubG9ncy5jcmFzaGxvZyA9IG5ldyBJT1NDcmFzaExvZyh7XG4gICAgICBzaW06IHRoaXMub3B0cy5kZXZpY2UsXG4gICAgICB1ZGlkOiB0aGlzLmlzUmVhbERldmljZSgpID8gdGhpcy5vcHRzLnVkaWQgOiB1bmRlZmluZWQsXG4gICAgfSk7XG4gICAgdGhpcy5sb2dzLnN5c2xvZyA9IG5ldyBJT1NMb2coe1xuICAgICAgc2ltOiB0aGlzLm9wdHMuZGV2aWNlLFxuICAgICAgdWRpZDogdGhpcy5pc1JlYWxEZXZpY2UoKSA/IHRoaXMub3B0cy51ZGlkIDogdW5kZWZpbmVkLFxuICAgICAgc2hvd0xvZ3M6IHRoaXMub3B0cy5zaG93SU9TTG9nLFxuICAgICAgcmVhbERldmljZUxvZ2dlcjogdGhpcy5vcHRzLnJlYWxEZXZpY2VMb2dnZXIsXG4gICAgICB4Y29kZVZlcnNpb246IHRoaXMueGNvZGVWZXJzaW9uLFxuICAgIH0pO1xuICAgIHRoaXMubG9ncy5zYWZhcmlDb25zb2xlID0gbmV3IFNhZmFyaUNvbnNvbGVMb2coISF0aGlzLm9wdHMuc2hvd1NhZmFyaUNvbnNvbGVMb2cpO1xuICAgIHRoaXMubG9ncy5zYWZhcmlOZXR3b3JrID0gbmV3IFNhZmFyaU5ldHdvcmtMb2coISF0aGlzLm9wdHMuc2hvd1NhZmFyaU5ldHdvcmtMb2cpO1xuICB9XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5sb2dzLnN5c2xvZy5zdGFydENhcHR1cmUoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYENvbnRpbnVpbmcgd2l0aG91dCBjYXB0dXJpbmcgZGV2aWNlIGxvZ3M6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIGF3YWl0IHRoaXMubG9ncy5jcmFzaGxvZy5zdGFydENhcHR1cmUoKTtcbiAgYXdhaXQgdGhpcy5sb2dzLnNhZmFyaUNvbnNvbGUuc3RhcnRDYXB0dXJlKCk7XG4gIGF3YWl0IHRoaXMubG9ncy5zYWZhcmlOZXR3b3JrLnN0YXJ0Q2FwdHVyZSgpO1xuXG4gIHJldHVybiB0cnVlO1xufTtcblxuLyoqXG4gKiBTdGFydHMgaU9TIHN5c3RlbSBsb2dzIGJyb2FkY2FzdCB3ZWJzb2NrZXQgb24gdGhlIHNhbWUgaG9zdCBhbmQgcG9ydFxuICogd2hlcmUgQXBwaXVtIHNlcnZlciBpcyBydW5uaW5nIGF0IGAvd3Mvc2Vzc2lvbi86c2Vzc2lvbklkOi9hcHBpdW0vc3lzbG9nYCBlbmRwb2ludC4gVGhlIG1ldGhvZFxuICogd2lsbCByZXR1cm4gaW1tZWRpYXRlbHkgaWYgdGhlIHdlYiBzb2NrZXQgaXMgYWxyZWFkeSBsaXN0ZW5pbmcuXG4gKlxuICogRWFjaCBjb25uZWN0ZWQgd2ViY29rZXQgbGlzdGVuZXIgd2lsbCByZWNlaXZlIHN5c2xvZyBsaW5lc1xuICogYXMgc29vbiBhcyB0aGV5IGFyZSB2aXNpYmxlIHRvIEFwcGl1bS5cbiAqL1xuZXh0ZW5zaW9ucy5tb2JpbGVTdGFydExvZ3NCcm9hZGNhc3QgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IHBhdGhuYW1lID0gV0VCU09DS0VUX0VORFBPSU5UKHRoaXMuc2Vzc2lvbklkKTtcbiAgaWYgKCFfLmlzRW1wdHkoYXdhaXQgdGhpcy5zZXJ2ZXIuZ2V0V2ViU29ja2V0SGFuZGxlcnMocGF0aG5hbWUpKSkge1xuICAgIGxvZy5kZWJ1ZyhgVGhlIHN5c3RlbSBsb2dzIGJyb2FkY2FzdGluZyB3ZWIgc29ja2V0IHNlcnZlciBpcyBhbHJlYWR5IGxpc3RlbmluZyBhdCAke3BhdGhuYW1lfWApO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxvZy5pbmZvKGBBc3NpZ25pbmcgc3lzdGVtIGxvZ3MgYnJvYWRjYXN0aW5nIHdlYiBzb2NrZXQgc2VydmVyIHRvICR7cGF0aG5hbWV9YCk7XG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS93ZWJzb2NrZXRzL3dzL2Jsb2IvbWFzdGVyL2RvYy93cy5tZFxuICBjb25zdCB3c3MgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7XG4gICAgbm9TZXJ2ZXI6IHRydWUsXG4gIH0pO1xuICB3c3Mub24oJ2Nvbm5lY3Rpb24nLCAod3MsIHJlcSkgPT4ge1xuICAgIGlmIChyZXEpIHtcbiAgICAgIGNvbnN0IHJlbW90ZUlwID0gXy5pc0VtcHR5KHJlcS5oZWFkZXJzWyd4LWZvcndhcmRlZC1mb3InXSlcbiAgICAgICAgPyByZXEuY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzXG4gICAgICAgIDogcmVxLmhlYWRlcnNbJ3gtZm9yd2FyZGVkLWZvciddO1xuICAgICAgbG9nLmRlYnVnKGBFc3RhYmxpc2hlZCBhIG5ldyBzeXN0ZW0gbG9ncyBsaXN0ZW5lciB3ZWIgc29ja2V0IGNvbm5lY3Rpb24gZnJvbSAke3JlbW90ZUlwfWApO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZGVidWcoJ0VzdGFibGlzaGVkIGEgbmV3IHN5c3RlbSBsb2dzIGxpc3RlbmVyIHdlYiBzb2NrZXQgY29ubmVjdGlvbicpO1xuICAgIH1cblxuICAgIGlmIChfLmlzRW1wdHkodGhpcy5fc3lzbG9nV2Vic29ja2V0TGlzdGVuZXIpKSB7XG4gICAgICB0aGlzLl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lciA9IChsb2dSZWNvcmQpID0+IHtcbiAgICAgICAgaWYgKHdzICYmIHdzLnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOKSB7XG4gICAgICAgICAgd3Muc2VuZChsb2dSZWNvcmQubWVzc2FnZSk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuICAgIHRoaXMubG9ncy5zeXNsb2cub24oJ291dHB1dCcsIHRoaXMuX3N5c2xvZ1dlYnNvY2tldExpc3RlbmVyKTtcblxuICAgIHdzLm9uKCdjbG9zZScsIChjb2RlLCByZWFzb24pID0+IHtcbiAgICAgIGlmICghXy5pc0VtcHR5KHRoaXMuX3N5c2xvZ1dlYnNvY2tldExpc3RlbmVyKSkge1xuICAgICAgICB0aGlzLmxvZ3Muc3lzbG9nLnJlbW92ZUxpc3RlbmVyKCdvdXRwdXQnLCB0aGlzLl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lcik7XG4gICAgICAgIHRoaXMuX3N5c2xvZ1dlYnNvY2tldExpc3RlbmVyID0gbnVsbDtcbiAgICAgIH1cblxuICAgICAgbGV0IGNsb3NlTXNnID0gJ1N5c3RlbSBsb2dzIGxpc3RlbmVyIHdlYiBzb2NrZXQgaXMgY2xvc2VkLic7XG4gICAgICBpZiAoIV8uaXNFbXB0eShjb2RlKSkge1xuICAgICAgICBjbG9zZU1zZyArPSBgIENvZGU6ICR7Y29kZX0uYDtcbiAgICAgIH1cbiAgICAgIGlmICghXy5pc0VtcHR5KHJlYXNvbikpIHtcbiAgICAgICAgY2xvc2VNc2cgKz0gYCBSZWFzb246ICR7cmVhc29ufS5gO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGNsb3NlTXNnKTtcbiAgICB9KTtcbiAgfSk7XG4gIGF3YWl0IHRoaXMuc2VydmVyLmFkZFdlYlNvY2tldEhhbmRsZXIocGF0aG5hbWUsIHdzcyk7XG59O1xuXG4vKipcbiAqIFN0b3BzIHRoZSBwcmV2aW91c2x5IHN0YXJ0ZWQgc3lzbG9nIGJyb2FkY2FzdGluZyB3ZXNvY2tldCBzZXJ2ZXIuXG4gKiBUaGlzIG1ldGhvZCB3aWxsIHJldHVybiBpbW1lZGlhdGVseSBpZiBubyBzZXJ2ZXIgaXMgcnVubmluZy5cbiAqL1xuZXh0ZW5zaW9ucy5tb2JpbGVTdG9wTG9nc0Jyb2FkY2FzdCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgY29uc3QgcGF0aG5hbWUgPSBXRUJTT0NLRVRfRU5EUE9JTlQodGhpcy5zZXNzaW9uSWQpO1xuICBpZiAoXy5pc0VtcHR5KGF3YWl0IHRoaXMuc2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzKHBhdGhuYW1lKSkpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBsb2cuZGVidWcoJ1N0b3BwaW5nIHRoZSBzeXN0ZW0gbG9ncyBicm9hZGNhc3Rpbmcgd2ViIHNvY2tldCBzZXJ2ZXInKTtcbiAgYXdhaXQgdGhpcy5zZXJ2ZXIucmVtb3ZlV2ViU29ja2V0SGFuZGxlcihwYXRobmFtZSk7XG59O1xuXG5cbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9sb2cuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
