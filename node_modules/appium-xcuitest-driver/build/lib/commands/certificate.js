"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _appiumIosDriver = require("appium-ios-driver");

var _appiumBaseDriver = require("appium-base-driver");

var _nodeSimctl = require("node-simctl");

var _asyncbox = require("asyncbox");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _logger = _interopRequireDefault(require("../logger"));

var _os = _interopRequireDefault(require("os"));

var _path = _interopRequireDefault(require("path"));

var _uuidJs = _interopRequireDefault(require("uuid-js"));

var _teen_process = require("teen_process");

let extensions = {},
    commands = {};
exports.commands = commands;
const CONFIG_EXTENSION = 'mobileconfig';

function extractCommonName(_x) {
  return _extractCommonName.apply(this, arguments);
}

function _extractCommonName() {
  _extractCommonName = (0, _asyncToGenerator2.default)(function* (certBuffer) {
    const tempCert = yield _appiumSupport.tempDir.open({
      prefix: 'cert',
      suffix: '.cer'
    });

    try {
      yield _appiumSupport.fs.writeFile(tempCert.path, certBuffer);

      const _ref2 = yield (0, _teen_process.exec)('openssl', ['x509', '-noout', '-subject', '-in', tempCert.path]),
            stdout = _ref2.stdout;

      const cnMatch = /\/CN=([^\/]+)/.exec(stdout);

      if (cnMatch) {
        return cnMatch[1].trim();
      }

      throw new Error(`There is no common name value in '${stdout}' output`);
    } catch (err) {
      throw new Error(`Cannot parse common name value from the certificate. Is it valid and base64-encoded? ` + `Original error: ${err.message}`);
    } finally {
      yield _appiumSupport.fs.rimraf(tempCert.path);
    }
  });
  return _extractCommonName.apply(this, arguments);
}

function toMobileConfig(certBuffer, commonName) {
  const getUUID = () => _uuidJs.default.create().hex.toUpperCase();

  const contentUuid = getUUID();
  return {
    PayloadContent: [{
      PayloadCertificateFileName: `${commonName}.cer`,
      PayloadContent: certBuffer,
      PayloadDescription: 'Adds a CA root certificate',
      PayloadDisplayName: commonName,
      PayloadIdentifier: `com.apple.security.root.${contentUuid}`,
      PayloadType: 'com.apple.security.root',
      PayloadUUID: contentUuid,
      PayloadVersion: 1
    }],
    PayloadDisplayName: commonName,
    PayloadIdentifier: `${_os.default.hostname().split('.')[0]}.${getUUID()}`,
    PayloadRemovalDisallowed: false,
    PayloadType: 'Configuration',
    PayloadUUID: getUUID(),
    PayloadVersion: 1
  };
}

function clickElement(_x2, _x3) {
  return _clickElement.apply(this, arguments);
}

function _clickElement() {
  _clickElement = (0, _asyncToGenerator2.default)(function* (driver, locator, options = {}) {
    let element = null;
    const _options$timeout = options.timeout,
          timeout = _options$timeout === void 0 ? 5000 : _options$timeout,
          _options$skipIfInvisi = options.skipIfInvisible,
          skipIfInvisible = _options$skipIfInvisi === void 0 ? false : _options$skipIfInvisi;
    const lookupDelay = 500;

    try {
      element = yield (0, _asyncbox.retryInterval)(timeout < lookupDelay ? 1 : timeout / lookupDelay, lookupDelay, () => driver.findNativeElementOrElements(locator.type, locator.value, false));
    } catch (err) {
      if (skipIfInvisible) {
        return false;
      }

      throw new Error(`Cannot find ${JSON.stringify(locator)} within ${timeout}ms timeout`);
    }

    yield driver.nativeClick(element);
    return true;
  });
  return _clickElement.apply(this, arguments);
}

function installCertificateInPreferences(_x4) {
  return _installCertificateInPreferences.apply(this, arguments);
}

function _installCertificateInPreferences() {
  _installCertificateInPreferences = (0, _asyncToGenerator2.default)(function* (driver) {
    yield clickElement(driver, {
      type: 'accessibility id',
      value: 'Allow'
    }, {
      timeout: 15000
    });
    yield _bluebird.default.delay(2000);

    if (!(yield clickElement(driver, {
      type: 'accessibility id',
      value: 'Install'
    }, {
      skipIfInvisible: true
    }))) {
      return false;
    }

    yield _bluebird.default.delay(1500);
    yield clickElement(driver, {
      type: 'accessibility id',
      value: 'Install'
    });
    yield clickElement(driver, {
      type: '-ios class chain',
      value: '**/XCUIElementTypeSheet/**/XCUIElementTypeButton[`label == \'Install\'`]'
    });
    yield clickElement(driver, {
      type: 'accessibility id',
      value: 'Done'
    });
    return true;
  });
  return _installCertificateInPreferences.apply(this, arguments);
}

function trustCertificateInPreferences(_x5, _x6) {
  return _trustCertificateInPreferences.apply(this, arguments);
}

function _trustCertificateInPreferences() {
  _trustCertificateInPreferences = (0, _asyncToGenerator2.default)(function* (driver, name) {
    yield clickElement(driver, {
      type: 'accessibility id',
      value: 'Return to Settings'
    });
    yield clickElement(driver, {
      type: 'accessibility id',
      value: 'General'
    });
    yield clickElement(driver, {
      type: 'accessibility id',
      value: 'About'
    });
    const switchLocator = {
      type: '-ios class chain',
      value: `**/XCUIElementTypeCell[\`label == '${name}'\`]/**/XCUIElementTypeSwitch`
    };
    yield (0, _asyncbox.retry)(5, (0, _asyncToGenerator2.default)(function* () {
      yield driver.mobileSwipe({
        element: yield driver.findNativeElementOrElements('class name', 'XCUIElementTypeTable', false),
        direction: 'up'
      });
      yield clickElement(driver, {
        type: 'accessibility id',
        value: 'Certificate Trust Settings'
      }, {
        timeout: 500
      });
      yield driver.findNativeElementOrElements(switchLocator.type, switchLocator.value, false);
    }));

    if (yield clickElement(driver, {
      type: switchLocator.type,
      value: `${switchLocator.value}[\`value == '0'\`]`
    }, {
      timeout: 1000,
      skipIfInvisible: true
    })) {
      yield driver.postAcceptAlert();
    }
  });
  return _trustCertificateInPreferences.apply(this, arguments);
}

commands.mobileInstallCertificate = function () {
  var _ref = (0, _asyncToGenerator2.default)(function* (opts = {}) {
    const content = opts.content,
          commonName = opts.commonName;

    if (_lodash.default.isEmpty(content)) {
      throw new Error('Certificate content should not be empty');
    }

    if (!(yield _appiumSupport.fs.exists(_appiumBaseDriver.STATIC_DIR))) {
      throw new Error(`The static content root '${_appiumBaseDriver.STATIC_DIR}' ` + `does not exist or is not accessible`);
    }

    const configName = `${(Math.random() * 0x100000000 + 1).toString(36)}.${CONFIG_EXTENSION}`;

    const configPath = _path.default.resolve(_appiumBaseDriver.STATIC_DIR, configName);

    const certBuffer = Buffer.from(content, 'base64');
    const cn = commonName || (yield extractCommonName(certBuffer));
    const mobileConfig = toMobileConfig(certBuffer, cn);

    try {
      yield _appiumSupport.plist.updatePlistFile(configPath, mobileConfig, false, false);
    } catch (err) {
      throw new Error(`Cannot store the generated config as '${configPath}'. ` + `Original error: ${err.message}`);
    }

    try {
      const _this$server$address = this.server.address(),
            address = _this$server$address.address,
            port = _this$server$address.port;

      const certUrl = `http://${address ? address : _os.default.hostname()}:${port ? port : 4723}/${configName}`;

      try {
        if (this.isRealDevice()) {
          try {
            yield this.proxyCommand('/url', 'POST', {
              url: certUrl
            });
          } catch (err) {
            if (this.isWebContext()) {
              yield _appiumIosDriver.iosCommands.general.setUrl.call(this, certUrl);
            } else {
              throw err;
            }
          }
        } else {
          yield (0, _nodeSimctl.openUrl)(this.opts.udid || this.sim.udid, certUrl);
        }

        if (yield installCertificateInPreferences(this)) {
          yield trustCertificateInPreferences(this, cn);
        } else {
          _logger.default.info(`It looks like the '${cn}' certificate has been already added to the CA root`);
        }
      } finally {
        try {
          yield this.activateApp(this.opts.bundleId);
        } catch (e) {
          _logger.default.warn(`Cannot restore the application '${this.opts.bundleId}'. Original error: ${e.message}`);
        }
      }

      return (yield _appiumSupport.fs.readFile(configPath)).toString('base64');
    } finally {
      yield _appiumSupport.fs.rimraf(configPath);
    }
  });

  return function () {
    return _ref.apply(this, arguments);
  };
}();

Object.assign(extensions, commands);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9jZXJ0aWZpY2F0ZS5qcyJdLCJuYW1lcyI6WyJleHRlbnNpb25zIiwiY29tbWFuZHMiLCJDT05GSUdfRVhURU5TSU9OIiwiZXh0cmFjdENvbW1vbk5hbWUiLCJjZXJ0QnVmZmVyIiwidGVtcENlcnQiLCJ0ZW1wRGlyIiwib3BlbiIsInByZWZpeCIsInN1ZmZpeCIsImZzIiwid3JpdGVGaWxlIiwicGF0aCIsInN0ZG91dCIsImNuTWF0Y2giLCJleGVjIiwidHJpbSIsIkVycm9yIiwiZXJyIiwibWVzc2FnZSIsInJpbXJhZiIsInRvTW9iaWxlQ29uZmlnIiwiY29tbW9uTmFtZSIsImdldFVVSUQiLCJVVUlEIiwiY3JlYXRlIiwiaGV4IiwidG9VcHBlckNhc2UiLCJjb250ZW50VXVpZCIsIlBheWxvYWRDb250ZW50IiwiUGF5bG9hZENlcnRpZmljYXRlRmlsZU5hbWUiLCJQYXlsb2FkRGVzY3JpcHRpb24iLCJQYXlsb2FkRGlzcGxheU5hbWUiLCJQYXlsb2FkSWRlbnRpZmllciIsIlBheWxvYWRUeXBlIiwiUGF5bG9hZFVVSUQiLCJQYXlsb2FkVmVyc2lvbiIsIm9zIiwiaG9zdG5hbWUiLCJzcGxpdCIsIlBheWxvYWRSZW1vdmFsRGlzYWxsb3dlZCIsImNsaWNrRWxlbWVudCIsImRyaXZlciIsImxvY2F0b3IiLCJvcHRpb25zIiwiZWxlbWVudCIsInRpbWVvdXQiLCJza2lwSWZJbnZpc2libGUiLCJsb29rdXBEZWxheSIsImZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyIsInR5cGUiLCJ2YWx1ZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJuYXRpdmVDbGljayIsImluc3RhbGxDZXJ0aWZpY2F0ZUluUHJlZmVyZW5jZXMiLCJCIiwiZGVsYXkiLCJ0cnVzdENlcnRpZmljYXRlSW5QcmVmZXJlbmNlcyIsIm5hbWUiLCJzd2l0Y2hMb2NhdG9yIiwibW9iaWxlU3dpcGUiLCJkaXJlY3Rpb24iLCJwb3N0QWNjZXB0QWxlcnQiLCJtb2JpbGVJbnN0YWxsQ2VydGlmaWNhdGUiLCJvcHRzIiwiY29udGVudCIsIl8iLCJpc0VtcHR5IiwiZXhpc3RzIiwiU1RBVElDX0RJUiIsImNvbmZpZ05hbWUiLCJNYXRoIiwicmFuZG9tIiwidG9TdHJpbmciLCJjb25maWdQYXRoIiwicmVzb2x2ZSIsIkJ1ZmZlciIsImZyb20iLCJjbiIsIm1vYmlsZUNvbmZpZyIsInBsaXN0IiwidXBkYXRlUGxpc3RGaWxlIiwic2VydmVyIiwiYWRkcmVzcyIsInBvcnQiLCJjZXJ0VXJsIiwiaXNSZWFsRGV2aWNlIiwicHJveHlDb21tYW5kIiwidXJsIiwiaXNXZWJDb250ZXh0IiwiaW9zQ29tbWFuZHMiLCJnZW5lcmFsIiwic2V0VXJsIiwiY2FsbCIsInVkaWQiLCJzaW0iLCJsb2ciLCJpbmZvIiwiYWN0aXZhdGVBcHAiLCJidW5kbGVJZCIsImUiLCJ3YXJuIiwicmVhZEZpbGUiLCJPYmplY3QiLCJhc3NpZ24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsSUFBSUEsVUFBVSxHQUFHLEVBQWpCO0FBQUEsSUFBcUJDLFFBQVEsR0FBRyxFQUFoQzs7QUFFQSxNQUFNQyxnQkFBZ0IsR0FBRyxjQUF6Qjs7U0FHZUMsaUI7Ozs7O3VEQUFmLFdBQWtDQyxVQUFsQyxFQUE4QztBQUM1QyxVQUFNQyxRQUFRLFNBQVNDLHVCQUFRQyxJQUFSLENBQWE7QUFDbENDLE1BQUFBLE1BQU0sRUFBRSxNQUQwQjtBQUVsQ0MsTUFBQUEsTUFBTSxFQUFFO0FBRjBCLEtBQWIsQ0FBdkI7O0FBSUEsUUFBSTtBQUNGLFlBQU1DLGtCQUFHQyxTQUFILENBQWFOLFFBQVEsQ0FBQ08sSUFBdEIsRUFBNEJSLFVBQTVCLENBQU47O0FBREUsMEJBRXFCLHdCQUFLLFNBQUwsRUFBZ0IsQ0FBQyxNQUFELEVBQVMsUUFBVCxFQUFtQixVQUFuQixFQUErQixLQUEvQixFQUFzQ0MsUUFB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TjtBQUNEOztBQUVELGtCQUFVL0IsK0JBQStCLENBQUMsSUFBRCxDQUF6QyxFQUFpRDtBQUMvQyxnQkFBTUcsNkJBQTZCLENBQUMsSUFBRCxFQUFPcUIsRUFBUCxDQUFuQztBQUNELFNBRkQsTUFFTztBQUNMa0IsMEJBQUlDLElBQUosQ0FBVSxzQkFBcUJuQixFQUFHLHFEQUFsQztBQUNEO0FBQ0YsT0FyQkQsU0FxQlU7QUFDUixZQUFJO0FBQ0YsZ0JBQU0sS0FBS29CLFdBQUwsQ0FBaUIsS0FBS2xDLElBQUwsQ0FBVW1DLFFBQTNCLENBQU47QUFDRCxTQUZELENBRUUsT0FBT0MsQ0FBUCxFQUFVO0FBQ1ZKLDBCQUFJSyxJQUFKLENBQVUsbUNBQWtDLEtBQUtyQyxJQUFMLENBQVVtQyxRQUFTLHNCQUFxQkMsQ0FBQyxDQUFDbEYsT0FBUSxFQUE5RjtBQUNEO0FBQ0Y7O0FBRUQsYUFBTyxPQUFPVCxrQkFBRzZGLFFBQUgsQ0FBWTVCLFVBQVosQ0FBUCxFQUFnQ0QsUUFBaEMsQ0FBeUMsUUFBekMsQ0FBUDtBQUNELEtBakNELFNBaUNVO0FBQ1IsWUFBTWhFLGtCQUFHVSxNQUFILENBQVV1RCxVQUFWLENBQU47QUFDRDtBQUNGLEdBekREOztBQUFBO0FBQUE7QUFBQTtBQUFBOztBQTJEQTZCLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjekcsVUFBZCxFQUEwQkMsUUFBMUI7ZUFFZUQsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBmcywgcGxpc3QsIHRlbXBEaXIgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBpb3NDb21tYW5kcyB9IGZyb20gJ2FwcGl1bS1pb3MtZHJpdmVyJztcbmltcG9ydCB7IFNUQVRJQ19ESVIgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgb3BlblVybCB9IGZyb20gJ25vZGUtc2ltY3RsJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwsIHJldHJ5IH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IFVVSUQgZnJvbSAndXVpZC1qcyc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcblxubGV0IGV4dGVuc2lvbnMgPSB7fSwgY29tbWFuZHMgPSB7fTtcblxuY29uc3QgQ09ORklHX0VYVEVOU0lPTiA9ICdtb2JpbGVjb25maWcnO1xuXG5cbmFzeW5jIGZ1bmN0aW9uIGV4dHJhY3RDb21tb25OYW1lIChjZXJ0QnVmZmVyKSB7XG4gIGNvbnN0IHRlbXBDZXJ0ID0gYXdhaXQgdGVtcERpci5vcGVuKHtcbiAgICBwcmVmaXg6ICdjZXJ0JyxcbiAgICBzdWZmaXg6ICcuY2VyJ1xuICB9KTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUodGVtcENlcnQucGF0aCwgY2VydEJ1ZmZlcik7XG4gICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKCdvcGVuc3NsJywgWyd4NTA5JywgJy1ub291dCcsICctc3ViamVjdCcsICctaW4nLCB0ZW1wQ2VydC5wYXRoXSk7XG4gICAgY29uc3QgY25NYXRjaCA9IC9cXC9DTj0oW15cXC9dKykvLmV4ZWMoc3Rkb3V0KTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11c2VsZXNzLWVzY2FwZVxuICAgIGlmIChjbk1hdGNoKSB7XG4gICAgICByZXR1cm4gY25NYXRjaFsxXS50cmltKCk7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihgVGhlcmUgaXMgbm8gY29tbW9uIG5hbWUgdmFsdWUgaW4gJyR7c3Rkb3V0fScgb3V0cHV0YCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHBhcnNlIGNvbW1vbiBuYW1lIHZhbHVlIGZyb20gdGhlIGNlcnRpZmljYXRlLiBJcyBpdCB2YWxpZCBhbmQgYmFzZTY0LWVuY29kZWQ/IGAgK1xuICAgICAgICAgICAgICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgZnMucmltcmFmKHRlbXBDZXJ0LnBhdGgpO1xuICB9XG59XG5cbi8qKlxuICogR2VuZXJhdGVzIEFwcGxlJ3Mgb3Zlci10aGUtYWlyIGNvbmZpZ3VyYXRpb24gcHJvZmlsZVxuICogZm9yIGNlcnRpZmljYXRlIGRlcGxveW1lbnQgYmFzZWQgb24gdGhlIGdpdmVuIFBFTSBjZXJ0aWZpY2F0ZSBjb250ZW50LlxuICogUmVhZCBodHRwczovL2RldmVsb3Blci5hcHBsZS5jb20vbGlicmFyeS9jb250ZW50L2RvY3VtZW50YXRpb24vTmV0d29ya2luZ0ludGVybmV0L0NvbmNlcHR1YWwvaVBob25lT1RBQ29uZmlndXJhdGlvbi9JbnRyb2R1Y3Rpb24vSW50cm9kdWN0aW9uLmh0bWxcbiAqIGZvciBtb3JlIGRldGFpbHMgb24gc3VjaCBwcm9maWxlcy5cbiAqXG4gKiBAcGFyYW0ge0J1ZmZlcn0gY2VydEJ1ZmZlciAtIFRoZSBhY3R1YWwgY29udGVudCBvZiBQRU0gY2VydGlmaWNhdGUgZW5jb2RlZCBpbnRvIE5vZGVKUyBidWZmZXJcbiAqIEBwYXJhbSB7c3RyaW5nfSBjb21tb25OYW1lIC0gQ2VydGlmaWNhdGUncyBjb21tb24gbmFtZVxuICogQHJldHVybnMge09iamVjdH0gVGhlIGVuY29kZWQgc3RydWN0dXJlIG9mIHRoZSBnaXZlbiBjZXJ0aWZpY2F0ZSwgd2hpY2ggaXMgcmVhZHkgdG8gYmUgcGFzc2VkXG4gKiBhcyBhbiBhcmd1bWVudCB0byBwbGlzdCBidWlsZGVyXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIGdpdmVuIGNlcnRpZmljYXRlIGNhbm5vdCBiZSBwYXJzZWRcbiAqL1xuZnVuY3Rpb24gdG9Nb2JpbGVDb25maWcgKGNlcnRCdWZmZXIsIGNvbW1vbk5hbWUpIHtcbiAgY29uc3QgZ2V0VVVJRCA9ICgpID0+IFVVSUQuY3JlYXRlKCkuaGV4LnRvVXBwZXJDYXNlKCk7XG4gIGNvbnN0IGNvbnRlbnRVdWlkID0gZ2V0VVVJRCgpO1xuICByZXR1cm4ge1xuICAgIFBheWxvYWRDb250ZW50OiBbe1xuICAgICAgUGF5bG9hZENlcnRpZmljYXRlRmlsZU5hbWU6IGAke2NvbW1vbk5hbWV9LmNlcmAsXG4gICAgICBQYXlsb2FkQ29udGVudDogY2VydEJ1ZmZlcixcbiAgICAgIFBheWxvYWREZXNjcmlwdGlvbjogJ0FkZHMgYSBDQSByb290IGNlcnRpZmljYXRlJyxcbiAgICAgIFBheWxvYWREaXNwbGF5TmFtZTogY29tbW9uTmFtZSxcbiAgICAgIFBheWxvYWRJZGVudGlmaWVyOiBgY29tLmFwcGxlLnNlY3VyaXR5LnJvb3QuJHtjb250ZW50VXVpZH1gLFxuICAgICAgUGF5bG9hZFR5cGU6ICdjb20uYXBwbGUuc2VjdXJpdHkucm9vdCcsXG4gICAgICBQYXlsb2FkVVVJRDogY29udGVudFV1aWQsXG4gICAgICBQYXlsb2FkVmVyc2lvbjogMVxuICAgIH1dLFxuICAgIFBheWxvYWREaXNwbGF5TmFtZTogY29tbW9uTmFtZSxcbiAgICBQYXlsb2FkSWRlbnRpZmllcjogYCR7b3MuaG9zdG5hbWUoKS5zcGxpdCgnLicpWzBdfS4ke2dldFVVSUQoKX1gLFxuICAgIFBheWxvYWRSZW1vdmFsRGlzYWxsb3dlZDogZmFsc2UsXG4gICAgUGF5bG9hZFR5cGU6ICdDb25maWd1cmF0aW9uJyxcbiAgICBQYXlsb2FkVVVJRDogZ2V0VVVJRCgpLFxuICAgIFBheWxvYWRWZXJzaW9uOiAxXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNsaWNrRWxlbWVudCAoZHJpdmVyLCBsb2NhdG9yLCBvcHRpb25zID0ge30pIHtcbiAgbGV0IGVsZW1lbnQgPSBudWxsO1xuICBjb25zdCB7XG4gICAgdGltZW91dCA9IDUwMDAsXG4gICAgc2tpcElmSW52aXNpYmxlID0gZmFsc2VcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGxvb2t1cERlbGF5ID0gNTAwO1xuICB0cnkge1xuICAgIGVsZW1lbnQgPSBhd2FpdCByZXRyeUludGVydmFsKHRpbWVvdXQgPCBsb29rdXBEZWxheSA/IDEgOiB0aW1lb3V0IC8gbG9va3VwRGVsYXksIGxvb2t1cERlbGF5LFxuICAgICAgKCkgPT4gZHJpdmVyLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyhsb2NhdG9yLnR5cGUsIGxvY2F0b3IudmFsdWUsIGZhbHNlKVxuICAgICk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChza2lwSWZJbnZpc2libGUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZmluZCAke0pTT04uc3RyaW5naWZ5KGxvY2F0b3IpfSB3aXRoaW4gJHt0aW1lb3V0fW1zIHRpbWVvdXRgKTtcbiAgfVxuICBhd2FpdCBkcml2ZXIubmF0aXZlQ2xpY2soZWxlbWVudCk7XG4gIHJldHVybiB0cnVlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBpbnN0YWxsQ2VydGlmaWNhdGVJblByZWZlcmVuY2VzIChkcml2ZXIpIHtcbiAgLy8gQWNjZXB0IFNhZmFyaSBhbGVydFxuICBhd2FpdCBjbGlja0VsZW1lbnQoZHJpdmVyLCB7XG4gICAgdHlwZTogJ2FjY2Vzc2liaWxpdHkgaWQnLFxuICAgIHZhbHVlOiAnQWxsb3cnLFxuICB9LCB7XG4gICAgLy8gY2VydGlmaWNhdGUgbG9hZCBtaWdodCB0YWtlIHNvbWUgdGltZSBvbiBzbG93IG1hY2hpbmVzXG4gICAgdGltZW91dDogMTUwMDAsXG4gIH0pO1xuICAvLyBXYWl0IHVudGlsIFByZWZlcmVuY2VzIGFyZSBvcGVuZWRcbiAgYXdhaXQgQi5kZWxheSgyMDAwKTtcblxuICAvLyBHbyB0aHJvdWdoIFByZWZlcmVuY2VzIHdpemFyZFxuICBpZiAoIWF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICB0eXBlOiAnYWNjZXNzaWJpbGl0eSBpZCcsXG4gICAgdmFsdWU6ICdJbnN0YWxsJ1xuICB9LCB7XG4gICAgc2tpcElmSW52aXNpYmxlOiB0cnVlLFxuICB9KSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICAvLyBXZSBuZWVkIHRvIGNsaWNrIEluc3RhbGwgYnV0dG9uIG9uIHR3byBkaWZmZXJlbnQgdGFic1xuICAvLyBUaGUgc2Vjb25kIG9uZSBjb25maXJtcyB0aGUgcHJldmlvdXNcbiAgYXdhaXQgQi5kZWxheSgxNTAwKTtcbiAgYXdhaXQgY2xpY2tFbGVtZW50KGRyaXZlciwge1xuICAgIHR5cGU6ICdhY2Nlc3NpYmlsaXR5IGlkJyxcbiAgICB2YWx1ZTogJ0luc3RhbGwnXG4gIH0pO1xuICAvLyBBY2NlcHQgc2hlZXQgYWxlcnRcbiAgYXdhaXQgY2xpY2tFbGVtZW50KGRyaXZlciwge1xuICAgIHR5cGU6ICctaW9zIGNsYXNzIGNoYWluJyxcbiAgICB2YWx1ZTogJyoqL1hDVUlFbGVtZW50VHlwZVNoZWV0LyoqL1hDVUlFbGVtZW50VHlwZUJ1dHRvbltgbGFiZWwgPT0gXFwnSW5zdGFsbFxcJ2BdJ1xuICB9KTtcbiAgLy8gRmluaXNoIGFkZGluZyBjZXJ0aWZpY2F0ZVxuICBhd2FpdCBjbGlja0VsZW1lbnQoZHJpdmVyLCB7XG4gICAgdHlwZTogJ2FjY2Vzc2liaWxpdHkgaWQnLFxuICAgIHZhbHVlOiAnRG9uZSdcbiAgfSk7XG4gIHJldHVybiB0cnVlO1xufVxuXG5hc3luYyBmdW5jdGlvbiB0cnVzdENlcnRpZmljYXRlSW5QcmVmZXJlbmNlcyAoZHJpdmVyLCBuYW1lKSB7XG4gIGF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICB0eXBlOiAnYWNjZXNzaWJpbGl0eSBpZCcsXG4gICAgdmFsdWU6ICdSZXR1cm4gdG8gU2V0dGluZ3MnXG4gIH0pO1xuICBhd2FpdCBjbGlja0VsZW1lbnQoZHJpdmVyLCB7XG4gICAgdHlwZTogJ2FjY2Vzc2liaWxpdHkgaWQnLFxuICAgIHZhbHVlOiAnR2VuZXJhbCdcbiAgfSk7XG4gIGF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICB0eXBlOiAnYWNjZXNzaWJpbGl0eSBpZCcsXG4gICAgdmFsdWU6ICdBYm91dCdcbiAgfSk7XG4gIGNvbnN0IHN3aXRjaExvY2F0b3IgPSB7XG4gICAgdHlwZTogJy1pb3MgY2xhc3MgY2hhaW4nLFxuICAgIHZhbHVlOiBgKiovWENVSUVsZW1lbnRUeXBlQ2VsbFtcXGBsYWJlbCA9PSAnJHtuYW1lfSdcXGBdLyoqL1hDVUlFbGVtZW50VHlwZVN3aXRjaGAsXG4gIH07XG4gIGF3YWl0IHJldHJ5KDUsIGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBkcml2ZXIubW9iaWxlU3dpcGUoe1xuICAgICAgZWxlbWVudDogYXdhaXQgZHJpdmVyLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnY2xhc3MgbmFtZScsICdYQ1VJRWxlbWVudFR5cGVUYWJsZScsIGZhbHNlKSxcbiAgICAgIGRpcmVjdGlvbjogJ3VwJ1xuICAgIH0pO1xuICAgIGF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICAgIHR5cGU6ICdhY2Nlc3NpYmlsaXR5IGlkJyxcbiAgICAgIHZhbHVlOiAnQ2VydGlmaWNhdGUgVHJ1c3QgU2V0dGluZ3MnXG4gICAgfSwge1xuICAgICAgdGltZW91dDogNTAwLFxuICAgIH0pO1xuXG4gICAgYXdhaXQgZHJpdmVyLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyhzd2l0Y2hMb2NhdG9yLnR5cGUsIHN3aXRjaExvY2F0b3IudmFsdWUsIGZhbHNlKTtcbiAgfSk7XG4gIC8vIE9ubHkgY2xpY2sgdGhlIHN3aXRjaCBpZiBpdCBpcyBzZXQgdG8gT2ZmXG4gIGlmIChhd2FpdCBjbGlja0VsZW1lbnQoZHJpdmVyLCB7XG4gICAgdHlwZTogc3dpdGNoTG9jYXRvci50eXBlLFxuICAgIHZhbHVlOiBgJHtzd2l0Y2hMb2NhdG9yLnZhbHVlfVtcXGB2YWx1ZSA9PSAnMCdcXGBdYFxuICB9LCB7XG4gICAgdGltZW91dDogMTAwMCxcbiAgICBza2lwSWZJbnZpc2libGU6IHRydWUsXG4gIH0pKSB7XG4gICAgYXdhaXQgZHJpdmVyLnBvc3RBY2NlcHRBbGVydCgpO1xuICB9XG59XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gQ2VydGlmaWNhdGVJbnN0YWxsYXRpb25PcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHshc3RyaW5nfSBjb250ZW50IC0gQmFzZTY0LWVuY29kZWQgY29udGVudCBvZiB0aGUgcHVibGljIGNlcnRpZmljYXRlXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IGNvbW1vbk5hbWUgLSBDb21tb24gbmFtZSBvZiB0aGUgY2VydGlmaWNhdGUuIElmIHRoaXMgaXMgbm90IHNldFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlbiB0aGUgc2NyaXB0IHdpbGwgdHJ5IHRvIHBhcnNlIGl0IGZyb20gdGhlIGdpdmVuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZXJ0aWZpY2F0ZSBjb250ZW50LlxuICovXG5cbi8qKlxuICogSW5zdGFsbHMgYSBjdXN0b20gY2VydGlmaWNhdGUgb250byB0aGUgZGV2aWNlLlxuICogU2luY2UgQXBwbGUgcHJvdmlkZXMgbm8gb2ZmaWNpYWwgd2F5IHRvIGRvIGl0IHZpYSBjb21tYW5kIGxpbmUsXG4gKiB0aGlzIG1ldGhvZCB0cmllcyB0byB3cmFwIHRoZSBjZXJ0aWZpY2F0ZSBpbnRvIC5tb2JpbGVjb25maWcgZm9ybWF0XG4gKiBhbmQgdGhlbiBkZXBsb3lzIHRoZSB3cmFwcGVkIGZpbGUgdG8gdGhlIGludGVybmFsIEhUVFAgc2VydmVyLFxuICogc28gb25lIGNhbiBvcGVuIGl0IHdpdGggbW9iaWxlIFNhZmFyaS5cbiAqIFRoZW4gdGhlIGFsZ29yaXRobSBnb2VzIHRocm91Z2ggdGhlIHByb2ZpbGUgaW5zdGFsbGF0aW9uIHByb2NlZHVyZSBieVxuICogY2xpY2tpbmcgdGhlIG5lY2Vzc2FyeSBidXR0b25zIHVzaW5nIFdlYkRyaXZlckFnZW50LlxuICpcbiAqIEBwYXJhbSB7Q2VydGlmaWNhdGVJbnN0YWxsYXRpb25PcHRpb25zfSBvcHRzXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgY29udGVudCBvZiB0aGUgZ2VuZXJhdGVkIC5tb2JpbGVjb25maWcgZmlsZSBhc1xuICogYmFzZTY0LWVuY29kZWQgc3RyaW5nLiBUaGlzIGNvbmZpZyBtaWdodCBiZSB1c2VmdWwgZm9yIGRlYnVnZ2luZyBwdXJwb3Nlcy5cbiAqL1xuY29tbWFuZHMubW9iaWxlSW5zdGFsbENlcnRpZmljYXRlID0gYXN5bmMgZnVuY3Rpb24gKG9wdHMgPSB7fSkge1xuICBjb25zdCB7Y29udGVudCwgY29tbW9uTmFtZX0gPSBvcHRzO1xuICBpZiAoXy5pc0VtcHR5KGNvbnRlbnQpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDZXJ0aWZpY2F0ZSBjb250ZW50IHNob3VsZCBub3QgYmUgZW1wdHknKTtcbiAgfVxuXG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKFNUQVRJQ19ESVIpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgc3RhdGljIGNvbnRlbnQgcm9vdCAnJHtTVEFUSUNfRElSfScgYCArXG4gICAgICAgICAgICAgICAgICAgIGBkb2VzIG5vdCBleGlzdCBvciBpcyBub3QgYWNjZXNzaWJsZWApO1xuICB9XG4gIGNvbnN0IGNvbmZpZ05hbWUgPSBgJHsoTWF0aC5yYW5kb20oKSAqIDB4MTAwMDAwMDAwICsgMSkudG9TdHJpbmcoMzYpfS4ke0NPTkZJR19FWFRFTlNJT059YDtcbiAgY29uc3QgY29uZmlnUGF0aCA9IHBhdGgucmVzb2x2ZShTVEFUSUNfRElSLCBjb25maWdOYW1lKTtcbiAgY29uc3QgY2VydEJ1ZmZlciA9IEJ1ZmZlci5mcm9tKGNvbnRlbnQsICdiYXNlNjQnKTtcbiAgY29uc3QgY24gPSBjb21tb25OYW1lIHx8IGF3YWl0IGV4dHJhY3RDb21tb25OYW1lKGNlcnRCdWZmZXIpO1xuICBjb25zdCBtb2JpbGVDb25maWcgPSB0b01vYmlsZUNvbmZpZyhjZXJ0QnVmZmVyLCBjbik7XG4gIHRyeSB7XG4gICAgYXdhaXQgcGxpc3QudXBkYXRlUGxpc3RGaWxlKGNvbmZpZ1BhdGgsIG1vYmlsZUNvbmZpZywgZmFsc2UsIGZhbHNlKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3Qgc3RvcmUgdGhlIGdlbmVyYXRlZCBjb25maWcgYXMgJyR7Y29uZmlnUGF0aH0nLiBgICtcbiAgICAgICAgICAgICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG4gIHRyeSB7XG4gICAgY29uc3Qge2FkZHJlc3MsIHBvcnR9ID0gdGhpcy5zZXJ2ZXIuYWRkcmVzcygpO1xuICAgIGNvbnN0IGNlcnRVcmwgPSBgaHR0cDovLyR7YWRkcmVzcyA/IGFkZHJlc3MgOiBvcy5ob3N0bmFtZSgpfToke3BvcnQgPyBwb3J0IDogNDcyM30vJHtjb25maWdOYW1lfWA7XG4gICAgdHJ5IHtcbiAgICAgIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy91cmwnLCAnUE9TVCcsIHt1cmw6IGNlcnRVcmx9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICAgICAgICAgIC8vIFRoZSBjb21tYW5kIGFib3ZlIGRvZXMgbm90IGFsd2F5cyB3b3JrIG9uIHJlYWwgZGV2aWNlc1xuICAgICAgICAgICAgYXdhaXQgaW9zQ29tbWFuZHMuZ2VuZXJhbC5zZXRVcmwuY2FsbCh0aGlzLCBjZXJ0VXJsKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXdhaXQgb3BlblVybCh0aGlzLm9wdHMudWRpZCB8fCB0aGlzLnNpbS51ZGlkLCBjZXJ0VXJsKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGF3YWl0IGluc3RhbGxDZXJ0aWZpY2F0ZUluUHJlZmVyZW5jZXModGhpcykpIHtcbiAgICAgICAgYXdhaXQgdHJ1c3RDZXJ0aWZpY2F0ZUluUHJlZmVyZW5jZXModGhpcywgY24pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmluZm8oYEl0IGxvb2tzIGxpa2UgdGhlICcke2NufScgY2VydGlmaWNhdGUgaGFzIGJlZW4gYWxyZWFkeSBhZGRlZCB0byB0aGUgQ0Egcm9vdGApO1xuICAgICAgfVxuICAgIH0gZmluYWxseSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmFjdGl2YXRlQXBwKHRoaXMub3B0cy5idW5kbGVJZCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy53YXJuKGBDYW5ub3QgcmVzdG9yZSB0aGUgYXBwbGljYXRpb24gJyR7dGhpcy5vcHRzLmJ1bmRsZUlkfScuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gKGF3YWl0IGZzLnJlYWRGaWxlKGNvbmZpZ1BhdGgpKS50b1N0cmluZygnYmFzZTY0Jyk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgZnMucmltcmFmKGNvbmZpZ1BhdGgpO1xuICB9XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzKTtcbmV4cG9ydCB7IGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvY2VydGlmaWNhdGUuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
