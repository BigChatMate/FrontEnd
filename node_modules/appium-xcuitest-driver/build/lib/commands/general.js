"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.extensions = exports.helpers = exports.commands = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumIosDriver = require("appium-ios-driver");

var _logger = _interopRequireDefault(require("../logger"));

let commands = {},
    helpers = {},
    extensions = {};
exports.extensions = extensions;
exports.helpers = helpers;
exports.commands = commands;
commands.active = (0, _asyncToGenerator2.default)(function* () {
  if (this.isWebContext()) {
    return yield this.executeAtom('active_element', []);
  }

  return yield this.proxyCommand(`/element/active`, 'GET');
});

commands.background = function () {
  var _ref2 = (0, _asyncToGenerator2.default)(function* (duration) {
    const homescreenEndpoint = '/wda/homescreen';
    const deactivateAppEndpoint = '/wda/deactivateApp';
    let endpoint;
    let params;

    if (_lodash.default.isUndefined(duration)) {
      _logger.default.warn('commands.background: Application under test will never be restored in the future if no duration is provided. ' + 'See https://github.com/appium/appium/issues/7741');

      endpoint = deactivateAppEndpoint;
      params = {};
    } else if (_lodash.default.isNumber(duration)) {
      _logger.default.warn('commands.background: Passing numbers to \'duration\' argument is deprecated. ' + 'See https://github.com/appium/appium/issues/7741');

      if (duration >= 0) {
        params = {
          duration
        };
        endpoint = deactivateAppEndpoint;
      } else {
        endpoint = homescreenEndpoint;
      }
    } else if (_lodash.default.isPlainObject(duration)) {
      if (_lodash.default.has(duration, 'timeout')) {
        if (duration.timeout === null) {
          endpoint = homescreenEndpoint;
        } else if (_lodash.default.isNumber(duration.timeout)) {
          if (duration.timeout >= 0) {
            params = {
              duration: duration.timeout / 1000.0
            };
            endpoint = deactivateAppEndpoint;
          } else {
            endpoint = homescreenEndpoint;
          }
        }
      }
    }

    if (_lodash.default.isUndefined(endpoint)) {
      _logger.default.errorAndThrow('commands.background: Argument value is expected to be an object or \'undefined\'. ' + `'${duration}' value has been provided instead. ` + 'The \'timeout\' attribute can be \'null\' or any negative number to put the app under test ' + 'into background and never come back or a positive number of milliseconds to wait until the app is restored.');
    }

    return yield this.proxyCommand(endpoint, 'POST', params, endpoint !== homescreenEndpoint);
  });

  return function (_x) {
    return _ref2.apply(this, arguments);
  };
}();

commands.touchId = function () {
  var _ref3 = (0, _asyncToGenerator2.default)(function* (match = true) {
    yield this.mobileSendBiometricMatch({
      match
    });
  });

  return function () {
    return _ref3.apply(this, arguments);
  };
}();

commands.toggleEnrollTouchId = function () {
  var _ref4 = (0, _asyncToGenerator2.default)(function* (isEnabled = true) {
    yield this.mobileEnrollBiometric({
      isEnabled
    });
  });

  return function () {
    return _ref4.apply(this, arguments);
  };
}();

helpers.getWindowSizeWeb = function () {
  var _getWindowSizeWeb = (0, _asyncToGenerator2.default)(function* () {
    return yield this.executeAtom('get_window_size', []);
  });

  return function getWindowSizeWeb() {
    return _getWindowSizeWeb.apply(this, arguments);
  };
}();

helpers.getWindowSizeNative = function () {
  var _getWindowSizeNative = (0, _asyncToGenerator2.default)(function* () {
    return yield this.proxyCommand(`/window/size`, 'GET');
  });

  return function getWindowSizeNative() {
    return _getWindowSizeNative.apply(this, arguments);
  };
}();

commands.getWindowSize = function () {
  var _ref5 = (0, _asyncToGenerator2.default)(function* (windowHandle = 'current') {
    if (windowHandle !== "current") {
      throw new _appiumBaseDriver.errors.NotYetImplementedError('Currently only getting current window size is supported.');
    }

    if (!this.isWebContext()) {
      return yield this.getWindowSizeNative();
    } else {
      return yield this.getWindowSizeWeb();
    }
  });

  return function () {
    return _ref5.apply(this, arguments);
  };
}();

commands.getWindowRect = (0, _asyncToGenerator2.default)(function* () {
  const _ref7 = yield this.getWindowSize(),
        width = _ref7.width,
        height = _ref7.height;

  return {
    width,
    height,
    x: 0,
    y: 0
  };
});

commands.hideKeyboard = function () {
  var _ref8 = (0, _asyncToGenerator2.default)(function* (strategy, ...possibleKeys) {
    if ((this.opts.deviceName || '').indexOf('iPhone') === -1) {
      try {
        yield this.proxyCommand('/wda/keyboard/dismiss', 'POST');
        return;
      } catch (err) {
        _logger.default.debug('Cannot dismiss the keyboard using the native call. Trying to apply a workaround...');
      }
    }

    let keyboard;

    try {
      keyboard = yield this.findNativeElementOrElements('class name', 'XCUIElementTypeKeyboard', false);
    } catch (err) {
      _logger.default.debug('No keyboard found. Unable to hide.');

      return;
    }

    possibleKeys.pop();
    possibleKeys = possibleKeys.filter(element => !!element);

    if (possibleKeys.length) {
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = possibleKeys[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          let key = _step.value;

          let el = _lodash.default.last((yield this.findNativeElementOrElements('accessibility id', key, true, keyboard)));

          if (el) {
            _logger.default.debug(`Attempting to hide keyboard by pressing '${key}' key.`);

            yield this.nativeClick(el);
            return;
          }
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator.return != null) {
            _iterator.return();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }
    } else {
      _logger.default.debug('Finding keyboard and clicking final button to close');

      if ((yield this.getAttribute('visible', keyboard)) === 'false') {
        _logger.default.debug('No visible keyboard found. Returning');

        return;
      }

      let buttons = yield this.findNativeElementOrElements('class name', 'XCUIElementTypeButton', true, keyboard);
      yield this.nativeClick(_lodash.default.last(buttons));
    }
  });

  return function (_x2) {
    return _ref8.apply(this, arguments);
  };
}();

commands.getDeviceTime = _appiumIosDriver.iosCommands.general.getDeviceTime;
commands.getStrings = _appiumIosDriver.iosCommands.general.getStrings;

commands.removeApp = function () {
  var _ref9 = (0, _asyncToGenerator2.default)(function* (bundleId) {
    return yield this.mobileRemoveApp({
      bundleId
    });
  });

  return function (_x3) {
    return _ref9.apply(this, arguments);
  };
}();

commands.launchApp = _appiumIosDriver.iosCommands.general.launchApp;
commands.closeApp = _appiumIosDriver.iosCommands.general.closeApp;

commands.keys = function () {
  var _ref10 = (0, _asyncToGenerator2.default)(function* (keys) {
    if (!this.isWebContext()) {
      throw new _appiumBaseDriver.errors.UnknownError('Command should be proxied to WDA');
    }

    let el = yield this.active();

    if (_lodash.default.isUndefined(el.ELEMENT)) {
      throw new _appiumBaseDriver.errors.NoSuchElementError();
    }

    yield this.setValue(keys, el.ELEMENT);
  });

  return function (_x4) {
    return _ref10.apply(this, arguments);
  };
}();

commands.setUrl = function () {
  var _ref11 = (0, _asyncToGenerator2.default)(function* (url) {
    if (!this.isWebContext() && this.isRealDevice()) {
      return yield this.proxyCommand('/url', 'POST', {
        url
      });
    }

    return yield _appiumIosDriver.iosCommands.general.setUrl.call(this, url);
  });

  return function (_x5) {
    return _ref11.apply(this, arguments);
  };
}();

commands.getViewportRect = _appiumIosDriver.iosCommands.device.getViewportRect;
commands.getScreenInfo = (0, _asyncToGenerator2.default)(function* () {
  return yield this.proxyCommand('/wda/screen', 'GET');
});
commands.getStatusBarHeight = (0, _asyncToGenerator2.default)(function* () {
  const _ref14 = yield this.getScreenInfo(),
        statusBarSize = _ref14.statusBarSize;

  return statusBarSize.height;
});
commands.getDevicePixelRatio = (0, _asyncToGenerator2.default)(function* () {
  const _ref16 = yield this.getScreenInfo(),
        scale = _ref16.scale;

  return scale;
});

commands.mobilePressButton = function () {
  var _ref17 = (0, _asyncToGenerator2.default)(function* (opts = {}) {
    const name = opts.name;

    if (!name) {
      _logger.default.errorAndThrow('Button name is mandatory');
    }

    return yield this.proxyCommand('/wda/pressButton', 'POST', {
      name
    });
  });

  return function () {
    return _ref17.apply(this, arguments);
  };
}();

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJhY3RpdmUiLCJpc1dlYkNvbnRleHQiLCJleGVjdXRlQXRvbSIsInByb3h5Q29tbWFuZCIsImJhY2tncm91bmQiLCJkdXJhdGlvbiIsImhvbWVzY3JlZW5FbmRwb2ludCIsImRlYWN0aXZhdGVBcHBFbmRwb2ludCIsImVuZHBvaW50IiwicGFyYW1zIiwiXyIsImlzVW5kZWZpbmVkIiwibG9nIiwid2FybiIsImlzTnVtYmVyIiwiaXNQbGFpbk9iamVjdCIsImhhcyIsInRpbWVvdXQiLCJlcnJvckFuZFRocm93IiwidG91Y2hJZCIsIm1hdGNoIiwibW9iaWxlU2VuZEJpb21ldHJpY01hdGNoIiwidG9nZ2xlRW5yb2xsVG91Y2hJZCIsImlzRW5hYmxlZCIsIm1vYmlsZUVucm9sbEJpb21ldHJpYyIsImdldFdpbmRvd1NpemVXZWIiLCJnZXRXaW5kb3dTaXplTmF0aXZlIiwiZ2V0V2luZG93U2l6ZSIsIndpbmRvd0hhbmRsZSIsImVycm9ycyIsIk5vdFlldEltcGxlbWVudGVkRXJyb3IiLCJnZXRXaW5kb3dSZWN0Iiwid2lkdGgiLCJoZWlnaHQiLCJ4IiwieSIsImhpZGVLZXlib2FyZCIsInN0cmF0ZWd5IiwicG9zc2libGVLZXlzIiwib3B0cyIsImRldmljZU5hbWUiLCJpbmRleE9mIiwiZXJyIiwiZGVidWciLCJrZXlib2FyZCIsImZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyIsInBvcCIsImZpbHRlciIsImVsZW1lbnQiLCJsZW5ndGgiLCJrZXkiLCJlbCIsImxhc3QiLCJuYXRpdmVDbGljayIsImdldEF0dHJpYnV0ZSIsImJ1dHRvbnMiLCJnZXREZXZpY2VUaW1lIiwiaW9zQ29tbWFuZHMiLCJnZW5lcmFsIiwiZ2V0U3RyaW5ncyIsInJlbW92ZUFwcCIsImJ1bmRsZUlkIiwibW9iaWxlUmVtb3ZlQXBwIiwibGF1bmNoQXBwIiwiY2xvc2VBcHAiLCJrZXlzIiwiVW5rbm93bkVycm9yIiwiRUxFTUVOVCIsIk5vU3VjaEVsZW1lbnRFcnJvciIsInNldFZhbHVlIiwic2V0VXJsIiwidXJsIiwiaXNSZWFsRGV2aWNlIiwiY2FsbCIsImdldFZpZXdwb3J0UmVjdCIsImRldmljZSIsImdldFNjcmVlbkluZm8iLCJnZXRTdGF0dXNCYXJIZWlnaHQiLCJzdGF0dXNCYXJTaXplIiwiZ2V0RGV2aWNlUGl4ZWxSYXRpbyIsInNjYWxlIiwibW9iaWxlUHJlc3NCdXR0b24iLCJuYW1lIiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmO0FBQUEsSUFBbUJDLE9BQU8sR0FBRyxFQUE3QjtBQUFBLElBQWlDQyxVQUFVLEdBQUcsRUFBOUM7Ozs7QUFFQUYsUUFBUSxDQUFDRyxNQUFULG1DQUFrQixhQUFrQjtBQUNsQyxNQUFJLEtBQUtDLFlBQUwsRUFBSixFQUF5QjtBQUN2QixpQkFBYSxLQUFLQyxXQUFMLENBQWlCLGdCQUFqQixFQUFtQyxFQUFuQyxDQUFiO0FBQ0Q7O0FBQ0QsZUFBYSxLQUFLQyxZQUFMLENBQW1CLGlCQUFuQixFQUFxQyxLQUFyQyxDQUFiO0FBQ0QsQ0FMRDs7QUFrQkFOLFFBQVEsQ0FBQ08sVUFBVDtBQUFBLDhDQUFzQixXQUFnQkMsUUFBaEIsRUFBMEI7QUFDOUMsVUFBTUMsa0JBQWtCLEdBQUcsaUJBQTNCO0FBQ0EsVUFBTUMscUJBQXFCLEdBQUcsb0JBQTlCO0FBQ0EsUUFBSUMsUUFBSjtBQUNBLFFBQUlDLE1BQUo7O0FBQ0EsUUFBSUMsZ0JBQUVDLFdBQUYsQ0FBY04sUUFBZCxDQUFKLEVBQTZCO0FBRzNCTyxzQkFBSUMsSUFBSixDQUFTLGtIQUNBLGtEQURUOztBQUVBTCxNQUFBQSxRQUFRLEdBQUdELHFCQUFYO0FBQ0FFLE1BQUFBLE1BQU0sR0FBRyxFQUFUO0FBQ0QsS0FQRCxNQU9PLElBQUlDLGdCQUFF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OztBQUFBO0FBQUE7QUFBQTtBQUFBOztBQU9BMUUsUUFBUSxDQUFDNkUsZUFBVCxHQUEyQmpCLDZCQUFZa0IsTUFBWixDQUFtQkQsZUFBOUM7QUFHQTdFLFFBQVEsQ0FBQytFLGFBQVQsbUNBQXlCLGFBQWtCO0FBQ3pDLGVBQWEsS0FBS3pFLFlBQUwsQ0FBa0IsYUFBbEIsRUFBaUMsS0FBakMsQ0FBYjtBQUNELENBRkQ7QUFJQU4sUUFBUSxDQUFDZ0Ysa0JBQVQsbUNBQThCLGFBQWtCO0FBQUEsdUJBQ2hCLEtBQUtELGFBQUwsRUFEZ0I7QUFBQSxRQUN2Q0UsYUFEdUMsVUFDdkNBLGFBRHVDOztBQUU5QyxTQUFPQSxhQUFhLENBQUM3QyxNQUFyQjtBQUNELENBSEQ7QUFNQXBDLFFBQVEsQ0FBQ2tGLG1CQUFULG1DQUErQixhQUFrQjtBQUFBLHVCQUN6QixLQUFLSCxhQUFMLEVBRHlCO0FBQUEsUUFDeENJLEtBRHdDLFVBQ3hDQSxLQUR3Qzs7QUFFL0MsU0FBT0EsS0FBUDtBQUNELENBSEQ7O0FBS0FuRixRQUFRLENBQUNvRixpQkFBVDtBQUFBLCtDQUE2QixXQUFnQjFDLElBQUksR0FBRyxFQUF2QixFQUEyQjtBQUFBLFVBQy9DMkMsSUFEK0MsR0FDdkMzQyxJQUR1QyxDQUMvQzJDLElBRCtDOztBQUV0RCxRQUFJLENBQUNBLElBQUwsRUFBVztBQUNUdEUsc0JBQUlNLGFBQUosQ0FBa0IsMEJBQWxCO0FBQ0Q7O0FBQ0QsaUJBQWEsS0FBS2YsWUFBTCxDQUFrQixrQkFBbEIsRUFBc0MsTUFBdEMsRUFBOEM7QUFBQytFLE1BQUFBO0FBQUQsS0FBOUMsQ0FBYjtBQUNELEdBTkQ7O0FBQUE7QUFBQTtBQUFBO0FBQUE7O0FBUUFDLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjckYsVUFBZCxFQUEwQkYsUUFBMUIsRUFBb0NDLE9BQXBDO2VBR2VDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IGlvc0NvbW1hbmRzIH0gZnJvbSAnYXBwaXVtLWlvcy1kcml2ZXInO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbW1hbmRzLmFjdGl2ZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnYWN0aXZlX2VsZW1lbnQnLCBbXSk7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC9hY3RpdmVgLCAnR0VUJyk7XG59O1xuXG4vKipcbiAqIENsb3NlIGFwcCAoc2ltdWxhdGUgZGV2aWNlIGhvbWUgYnV0dG9uKS4gSXQgaXMgcG9zc2libGUgdG8gcmVzdG9yZVxuICogdGhlIGFwcCBhZnRlciB0aGUgdGltZW91dCBvciBrZWVwIGl0IG1pbmltaXplZCBiYXNlZCBvbiB0aGUgcGFyYW1ldGVyIHZhbHVlLlxuICpcbiAqIFBvc3NpYmxlIHZhbHVlcyBmb3IgYGR1cmF0aW9uYDpcbiAqIC0gYW55IHBvc2l0aXZlIG51bWJlciBvZiBzZWNvbmRzOiBjb21lIGJhY2sgYWZ0ZXIgWCBzZWNvbmRzLCBzaG93IGRlcHJlY2F0aW9uIHdhcm5pbmdcbiAqIC0gYW55IG5lZ2F0aXZlIG51bWJlciBvZiBzZWNvbmRzOiBuZXZlciBjb21lIGJhY2ssIHNob3cgZGVwcmVjYXRpb24gd2FybmluZ1xuICogLSB1bmRlZmluZWQ6IGNvbWUgYmFjayBhZnRlciB0aGUgZGVmYXVsdCB0aW1lb3V0IChkZWZpbmVkIGJ5IFdEQSksIHNob3cgZGVwcmVjYXRpb24gd2FybmluZy4gQWZ0ZXIgZGVwcmVjYXRpb246IG5ldmVyIGNvbWUgYmFja1xuICogLSB7dGltZW91dDogNTAwMH06IGNvbWUgYmFjayBhZnRlciA1IHNlY29uZHNcbiAqIC0ge3RpbWVvdXQ6IG51bGx9LCB7dGltZW91dDogLTJ9OiBuZXZlciBjb21lIGJhY2tcbiAqL1xuY29tbWFuZHMuYmFja2dyb3VuZCA9IGFzeW5jIGZ1bmN0aW9uIChkdXJhdGlvbikge1xuICBjb25zdCBob21lc2NyZWVuRW5kcG9pbnQgPSAnL3dkYS9ob21lc2NyZWVuJztcbiAgY29uc3QgZGVhY3RpdmF0ZUFwcEVuZHBvaW50ID0gJy93ZGEvZGVhY3RpdmF0ZUFwcCc7XG4gIGxldCBlbmRwb2ludDtcbiAgbGV0IHBhcmFtcztcbiAgaWYgKF8uaXNVbmRlZmluZWQoZHVyYXRpb24pKSB7XG4gICAgLy8gVE9ETzogUmVwbGFjZSB0aGUgYmxvY2sgYWZ0ZXIgZGVwcmVjYXRlZCBzdHVmZiBpcyByZW1vdmVkXG4gICAgLy8gZW5kcG9pbnQgPSBob21lc2NyZWVuRW5kcG9pbnQ7XG4gICAgbG9nLndhcm4oJ2NvbW1hbmRzLmJhY2tncm91bmQ6IEFwcGxpY2F0aW9uIHVuZGVyIHRlc3Qgd2lsbCBuZXZlciBiZSByZXN0b3JlZCBpbiB0aGUgZnV0dXJlIGlmIG5vIGR1cmF0aW9uIGlzIHByb3ZpZGVkLiAnICtcbiAgICAgICAgICAgICAnU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy83NzQxJyk7XG4gICAgZW5kcG9pbnQgPSBkZWFjdGl2YXRlQXBwRW5kcG9pbnQ7XG4gICAgcGFyYW1zID0ge307XG4gIH0gZWxzZSBpZiAoXy5pc051bWJlcihkdXJhdGlvbikpIHtcbiAgICAvLyBUT0RPOiBkZXByZWNhdGUgdGhpcyBjYXNlXG4gICAgbG9nLndhcm4oJ2NvbW1hbmRzLmJhY2tncm91bmQ6IFBhc3NpbmcgbnVtYmVycyB0byBcXCdkdXJhdGlvblxcJyBhcmd1bWVudCBpcyBkZXByZWNhdGVkLiAnICtcbiAgICAgICAgICAgICAnU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy83NzQxJyk7XG4gICAgaWYgKGR1cmF0aW9uID49IDApIHtcbiAgICAgIHBhcmFtcyA9IHtkdXJhdGlvbn07XG4gICAgICBlbmRwb2ludCA9IGRlYWN0aXZhdGVBcHBFbmRwb2ludDtcbiAgICB9IGVsc2Uge1xuICAgICAgZW5kcG9pbnQgPSBob21lc2NyZWVuRW5kcG9pbnQ7XG4gICAgfVxuICB9IGVsc2UgaWYgKF8uaXNQbGFpbk9iamVjdChkdXJhdGlvbikpIHtcbiAgICBpZiAoXy5oYXMoZHVyYXRpb24sICd0aW1lb3V0JykpIHtcbiAgICAgIGlmIChkdXJhdGlvbi50aW1lb3V0ID09PSBudWxsKSB7XG4gICAgICAgIGVuZHBvaW50ID0gaG9tZXNjcmVlbkVuZHBvaW50O1xuICAgICAgfSBlbHNlIGlmIChfLmlzTnVtYmVyKGR1cmF0aW9uLnRpbWVvdXQpKSB7XG4gICAgICAgIGlmIChkdXJhdGlvbi50aW1lb3V0ID49IDApIHtcbiAgICAgICAgICBwYXJhbXMgPSB7ZHVyYXRpb246IGR1cmF0aW9uLnRpbWVvdXQgLyAxMDAwLjB9O1xuICAgICAgICAgIGVuZHBvaW50ID0gZGVhY3RpdmF0ZUFwcEVuZHBvaW50O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGVuZHBvaW50ID0gaG9tZXNjcmVlbkVuZHBvaW50O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG4gIGlmIChfLmlzVW5kZWZpbmVkKGVuZHBvaW50KSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdjb21tYW5kcy5iYWNrZ3JvdW5kOiBBcmd1bWVudCB2YWx1ZSBpcyBleHBlY3RlZCB0byBiZSBhbiBvYmplY3Qgb3IgXFwndW5kZWZpbmVkXFwnLiAnICtcbiAgICAgICAgICAgICAgICAgICAgICBgJyR7ZHVyYXRpb259JyB2YWx1ZSBoYXMgYmVlbiBwcm92aWRlZCBpbnN0ZWFkLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICAnVGhlIFxcJ3RpbWVvdXRcXCcgYXR0cmlidXRlIGNhbiBiZSBcXCdudWxsXFwnIG9yIGFueSBuZWdhdGl2ZSBudW1iZXIgdG8gcHV0IHRoZSBhcHAgdW5kZXIgdGVzdCAnICtcbiAgICAgICAgICAgICAgICAgICAgICAnaW50byBiYWNrZ3JvdW5kIGFuZCBuZXZlciBjb21lIGJhY2sgb3IgYSBwb3NpdGl2ZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdW50aWwgdGhlIGFwcCBpcyByZXN0b3JlZC4nKTtcbiAgfVxuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoZW5kcG9pbnQsICdQT1NUJywgcGFyYW1zLCBlbmRwb2ludCAhPT0gaG9tZXNjcmVlbkVuZHBvaW50KTtcbn07XG5cbmNvbW1hbmRzLnRvdWNoSWQgPSBhc3luYyBmdW5jdGlvbiAobWF0Y2ggPSB0cnVlKSB7XG4gIGF3YWl0IHRoaXMubW9iaWxlU2VuZEJpb21ldHJpY01hdGNoKHttYXRjaH0pO1xufTtcblxuY29tbWFuZHMudG9nZ2xlRW5yb2xsVG91Y2hJZCA9IGFzeW5jIGZ1bmN0aW9uIChpc0VuYWJsZWQgPSB0cnVlKSB7XG4gIGF3YWl0IHRoaXMubW9iaWxlRW5yb2xsQmlvbWV0cmljKHtpc0VuYWJsZWR9KTtcbn07XG5cbi8vIG1lbW9pemVkIGluIGNvbnN0cnVjdG9yXG5oZWxwZXJzLmdldFdpbmRvd1NpemVXZWIgPSBhc3luYyBmdW5jdGlvbiBnZXRXaW5kb3dTaXplV2ViICgpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF93aW5kb3dfc2l6ZScsIFtdKTtcbn07XG5cbi8vIG1lbW9pemVkIGluIGNvbnN0cnVjdG9yXG5oZWxwZXJzLmdldFdpbmRvd1NpemVOYXRpdmUgPSBhc3luYyBmdW5jdGlvbiBnZXRXaW5kb3dTaXplTmF0aXZlICgpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvd2luZG93L3NpemVgLCAnR0VUJyk7XG59O1xuXG5jb21tYW5kcy5nZXRXaW5kb3dTaXplID0gYXN5bmMgZnVuY3Rpb24gKHdpbmRvd0hhbmRsZSA9ICdjdXJyZW50Jykge1xuICBpZiAod2luZG93SGFuZGxlICE9PSBcImN1cnJlbnRcIikge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcignQ3VycmVudGx5IG9ubHkgZ2V0dGluZyBjdXJyZW50IHdpbmRvdyBzaXplIGlzIHN1cHBvcnRlZC4nKTtcbiAgfVxuXG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFdpbmRvd1NpemVOYXRpdmUoKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRXaW5kb3dTaXplV2ViKCk7XG4gIH1cbn07XG5cbi8vIEZvciBXM0NcbmNvbW1hbmRzLmdldFdpbmRvd1JlY3QgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IHt3aWR0aCwgaGVpZ2h0fSA9IGF3YWl0IHRoaXMuZ2V0V2luZG93U2l6ZSgpO1xuICByZXR1cm4ge1xuICAgIHdpZHRoLFxuICAgIGhlaWdodCxcbiAgICB4OiAwLFxuICAgIHk6IDBcbiAgfTtcbn07XG5cbmNvbW1hbmRzLmhpZGVLZXlib2FyZCA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgLi4ucG9zc2libGVLZXlzKSB7XG4gIGlmICgodGhpcy5vcHRzLmRldmljZU5hbWUgfHwgJycpLmluZGV4T2YoJ2lQaG9uZScpID09PSAtMSkge1xuICAgIC8vIFRPRE86IG9uY2UgV0RBIGNhbiBoYW5kbGUgZGlzbWlzc2luZyBrZXlib2FyZCBmb3IgaXBob25lLCB0YWtlIGF3YXkgY29uZGl0aW9uYWxcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEva2V5Ym9hcmQvZGlzbWlzcycsICdQT1NUJyk7XG4gICAgICByZXR1cm47XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZGVidWcoJ0Nhbm5vdCBkaXNtaXNzIHRoZSBrZXlib2FyZCB1c2luZyB0aGUgbmF0aXZlIGNhbGwuIFRyeWluZyB0byBhcHBseSBhIHdvcmthcm91bmQuLi4nKTtcbiAgICB9XG4gIH1cblxuICBsZXQga2V5Ym9hcmQ7XG4gIHRyeSB7XG4gICAga2V5Ym9hcmQgPSBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnY2xhc3MgbmFtZScsICdYQ1VJRWxlbWVudFR5cGVLZXlib2FyZCcsIGZhbHNlKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gbm8ga2V5Ym9hcmQgZm91bmRcbiAgICBsb2cuZGVidWcoJ05vIGtleWJvYXJkIGZvdW5kLiBVbmFibGUgdG8gaGlkZS4nKTtcbiAgICByZXR1cm47XG4gIH1cbiAgcG9zc2libGVLZXlzLnBvcCgpOyAvLyBsYXN0IHBhcmFtZXRlciBpcyB0aGUgc2Vzc2lvbiBpZFxuICBwb3NzaWJsZUtleXMgPSBwb3NzaWJsZUtleXMuZmlsdGVyKChlbGVtZW50KSA9PiAhIWVsZW1lbnQpOyAvLyBnZXQgcmlkIG9mIHVuZGVmaW5lZCBlbGVtZW50c1xuICBpZiAocG9zc2libGVLZXlzLmxlbmd0aCkge1xuICAgIGZvciAobGV0IGtleSBvZiBwb3NzaWJsZUtleXMpIHtcbiAgICAgIGxldCBlbCA9IF8ubGFzdChhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnYWNjZXNzaWJpbGl0eSBpZCcsIGtleSwgdHJ1ZSwga2V5Ym9hcmQpKTtcbiAgICAgIGlmIChlbCkge1xuICAgICAgICBsb2cuZGVidWcoYEF0dGVtcHRpbmcgdG8gaGlkZSBrZXlib2FyZCBieSBwcmVzc2luZyAnJHtrZXl9JyBrZXkuYCk7XG4gICAgICAgIGF3YWl0IHRoaXMubmF0aXZlQ2xpY2soZWwpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIC8vIGZpbmQgdGhlIGtleWJvYXJkLCBhbmQgaGl0IHRoZSBsYXN0IEJ1dHRvblxuICAgIGxvZy5kZWJ1ZygnRmluZGluZyBrZXlib2FyZCBhbmQgY2xpY2tpbmcgZmluYWwgYnV0dG9uIHRvIGNsb3NlJyk7XG4gICAgaWYgKGF3YWl0IHRoaXMuZ2V0QXR0cmlidXRlKCd2aXNpYmxlJywga2V5Ym9hcmQpID09PSAnZmFsc2UnKSB7XG4gICAgICBsb2cuZGVidWcoJ05vIHZpc2libGUga2V5Ym9hcmQgZm91bmQuIFJldHVybmluZycpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgYnV0dG9ucyA9IGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdjbGFzcyBuYW1lJywgJ1hDVUlFbGVtZW50VHlwZUJ1dHRvbicsIHRydWUsIGtleWJvYXJkKTtcbiAgICBhd2FpdCB0aGlzLm5hdGl2ZUNsaWNrKF8ubGFzdChidXR0b25zKSk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldERldmljZVRpbWUgPSBpb3NDb21tYW5kcy5nZW5lcmFsLmdldERldmljZVRpbWU7XG5cbmNvbW1hbmRzLmdldFN0cmluZ3MgPSBpb3NDb21tYW5kcy5nZW5lcmFsLmdldFN0cmluZ3M7XG5cbmNvbW1hbmRzLnJlbW92ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIChidW5kbGVJZCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5tb2JpbGVSZW1vdmVBcHAoe2J1bmRsZUlkfSk7XG59O1xuXG5jb21tYW5kcy5sYXVuY2hBcHAgPSBpb3NDb21tYW5kcy5nZW5lcmFsLmxhdW5jaEFwcDtcblxuY29tbWFuZHMuY2xvc2VBcHAgPSBpb3NDb21tYW5kcy5nZW5lcmFsLmNsb3NlQXBwO1xuXG5jb21tYW5kcy5rZXlzID0gYXN5bmMgZnVuY3Rpb24gKGtleXMpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoJ0NvbW1hbmQgc2hvdWxkIGJlIHByb3hpZWQgdG8gV0RBJyk7XG4gIH1cbiAgbGV0IGVsID0gYXdhaXQgdGhpcy5hY3RpdmUoKTtcbiAgaWYgKF8uaXNVbmRlZmluZWQoZWwuRUxFTUVOVCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICB9XG4gIGF3YWl0IHRoaXMuc2V0VmFsdWUoa2V5cywgZWwuRUxFTUVOVCk7XG59O1xuXG5jb21tYW5kcy5zZXRVcmwgPSBhc3luYyBmdW5jdGlvbiAodXJsKSB7XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSAmJiB0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvdXJsJywgJ1BPU1QnLCB7dXJsfSk7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IGlvc0NvbW1hbmRzLmdlbmVyYWwuc2V0VXJsLmNhbGwodGhpcywgdXJsKTtcbn07XG5cbmNvbW1hbmRzLmdldFZpZXdwb3J0UmVjdCA9IGlvc0NvbW1hbmRzLmRldmljZS5nZXRWaWV3cG9ydFJlY3Q7XG5cbi8vIG1lbW9pemVkIGluIGNvbnN0cnVjdG9yXG5jb21tYW5kcy5nZXRTY3JlZW5JbmZvID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvc2NyZWVuJywgJ0dFVCcpO1xufTtcblxuY29tbWFuZHMuZ2V0U3RhdHVzQmFySGVpZ2h0ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBjb25zdCB7c3RhdHVzQmFyU2l6ZX0gPSBhd2FpdCB0aGlzLmdldFNjcmVlbkluZm8oKTtcbiAgcmV0dXJuIHN0YXR1c0JhclNpemUuaGVpZ2h0O1xufTtcblxuLy8gbWVtb2l6ZWQgaW4gY29uc3RydWN0b3JcbmNvbW1hbmRzLmdldERldmljZVBpeGVsUmF0aW8gPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IHtzY2FsZX0gPSBhd2FpdCB0aGlzLmdldFNjcmVlbkluZm8oKTtcbiAgcmV0dXJuIHNjYWxlO1xufTtcblxuY29tbWFuZHMubW9iaWxlUHJlc3NCdXR0b24gPSBhc3luYyBmdW5jdGlvbiAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtuYW1lfSA9IG9wdHM7XG4gIGlmICghbmFtZSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdCdXR0b24gbmFtZSBpcyBtYW5kYXRvcnknKTtcbiAgfVxuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvcHJlc3NCdXR0b24nLCAnUE9TVCcsIHtuYW1lfSk7XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcblxuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMsIGV4dGVuc2lvbnMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
