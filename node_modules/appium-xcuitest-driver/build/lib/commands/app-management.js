"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

let commands = {};

function extractMandatoryOptions(opts = {}, keys) {
  const result = {};
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = keys[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      const key = _step.value;
      const value = opts[key];

      if (!_lodash.default.isString(value) || _lodash.default.isEmpty(value)) {
        _logger.default.errorAndThrow(`'${key}' is expected to be a valid string. '${value}' is given instead`);
      }

      result[key] = value;
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator.return != null) {
        _iterator.return();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return result;
}

commands.mobileInstallApp = function () {
  var _ref = (0, _asyncToGenerator2.default)(function* (opts = {}) {
    const _extractMandatoryOpti = extractMandatoryOptions(opts, ['app']),
          app = _extractMandatoryOpti.app;

    const dstPath = yield this.helpers.configureApp(app, '.app');

    _logger.default.info(`Installing '${dstPath}' to the ${this.isRealDevice() ? 'real device' : 'Simulator'} ` + `with UDID ${this.opts.device.udid}`);

    if (!(yield _appiumSupport.fs.exists(dstPath))) {
      _logger.default.errorAndThrow(`The application at '${dstPath}' does not exist or is not accessible`);
    }

    try {
      yield this.opts.device.installApp(dstPath);

      _logger.default.info(`Installation of '${dstPath}' succeeded`);
    } finally {
      if (dstPath !== app) {
        yield _appiumSupport.fs.rimraf(dstPath);
      }
    }
  });

  return function () {
    return _ref.apply(this, arguments);
  };
}();

commands.mobileIsAppInstalled = function () {
  var _ref2 = (0, _asyncToGenerator2.default)(function* (opts = {}) {
    const _extractMandatoryOpti2 = extractMandatoryOptions(opts, ['bundleId']),
          bundleId = _extractMandatoryOpti2.bundleId;

    const installed = yield this.opts.device.isAppInstalled(bundleId);

    _logger.default.info(`App '${bundleId}' is${installed ? '' : ' not'} installed`);

    return installed;
  });

  return function () {
    return _ref2.apply(this, arguments);
  };
}();

commands.mobileRemoveApp = function () {
  var _ref3 = (0, _asyncToGenerator2.default)(function* (opts = {}) {
    const _extractMandatoryOpti3 = extractMandatoryOptions(opts, ['bundleId']),
          bundleId = _extractMandatoryOpti3.bundleId;

    _logger.default.info(`Uninstalling the application with bundle identifier '${bundleId}' ` + `from the ${this.isRealDevice() ? 'real device' : 'Simulator'} with UDID ${this.opts.device.udid}`);

    try {
      yield this.opts.device.removeApp(bundleId);

      _logger.default.info(`Removal of '${bundleId}' succeeded`);

      return true;
    } catch (err) {
      _logger.default.warn(`Cannot remove '${bundleId}'. Original error: ${err.message}`);

      return false;
    }
  });

  return function () {
    return _ref3.apply(this, arguments);
  };
}();

commands.mobileLaunchApp = function () {
  var _ref4 = (0, _asyncToGenerator2.default)(function* (opts = {}) {
    const wdaOpts = extractMandatoryOptions(opts, ['bundleId']);

    if (opts.arguments) {
      wdaOpts.arguments = _lodash.default.isArray(opts.arguments) ? opts.arguments : [opts.arguments];
    }

    if (opts.environment) {
      wdaOpts.environment = opts.environment;
    }

    return yield this.proxyCommand('/wda/apps/launch', 'POST', wdaOpts);
  });

  return function () {
    return _ref4.apply(this, arguments);
  };
}();

commands.mobileTerminateApp = function () {
  var _ref5 = (0, _asyncToGenerator2.default)(function* (opts = {}) {
    return yield this.proxyCommand('/wda/apps/terminate', 'POST', extractMandatoryOptions(opts, ['bundleId']));
  });

  return function () {
    return _ref5.apply(this, arguments);
  };
}();

commands.mobileActivateApp = function () {
  var _ref6 = (0, _asyncToGenerator2.default)(function* (opts = {}) {
    return yield this.proxyCommand('/wda/apps/activate', 'POST', extractMandatoryOptions(opts, ['bundleId']));
  });

  return function () {
    return _ref6.apply(this, arguments);
  };
}();

commands.mobileQueryAppState = function () {
  var _ref7 = (0, _asyncToGenerator2.default)(function* (opts = {}) {
    return yield this.proxyCommand('/wda/apps/state', 'POST', extractMandatoryOptions(opts, ['bundleId']));
  });

  return function () {
    return _ref7.apply(this, arguments);
  };
}();

commands.installApp = function () {
  var _ref8 = (0, _asyncToGenerator2.default)(function* (appPath) {
    yield this.mobileInstallApp({
      app: appPath
    });
  });

  return function (_x) {
    return _ref8.apply(this, arguments);
  };
}();

commands.activateApp = function () {
  var _ref9 = (0, _asyncToGenerator2.default)(function* (bundleId, opts = {}) {
    return yield this.mobileLaunchApp(Object.assign({}, opts, {
      bundleId
    }));
  });

  return function (_x2) {
    return _ref9.apply(this, arguments);
  };
}();

commands.isAppInstalled = function () {
  var _ref10 = (0, _asyncToGenerator2.default)(function* (bundleId) {
    return yield this.mobileIsAppInstalled({
      bundleId
    });
  });

  return function (_x3) {
    return _ref10.apply(this, arguments);
  };
}();

commands.terminateApp = function () {
  var _ref11 = (0, _asyncToGenerator2.default)(function* (bundleId) {
    return yield this.mobileTerminateApp({
      bundleId
    });
  });

  return function (_x4) {
    return _ref11.apply(this, arguments);
  };
}();

commands.queryAppState = function () {
  var _ref12 = (0, _asyncToGenerator2.default)(function* (bundleId) {
    return yield this.mobileQueryAppState({
      bundleId
    });
  });

  return function (_x5) {
    return _ref12.apply(this, arguments);
  };
}();

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9hcHAtbWFuYWdlbWVudC5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsImV4dHJhY3RNYW5kYXRvcnlPcHRpb25zIiwib3B0cyIsImtleXMiLCJyZXN1bHQiLCJrZXkiLCJ2YWx1ZSIsIl8iLCJpc1N0cmluZyIsImlzRW1wdHkiLCJsb2ciLCJlcnJvckFuZFRocm93IiwibW9iaWxlSW5zdGFsbEFwcCIsImFwcCIsImRzdFBhdGgiLCJoZWxwZXJzIiwiY29uZmlndXJlQXBwIiwiaW5mbyIsImlzUmVhbERldmljZSIsImRldmljZSIsInVkaWQiLCJmcyIsImV4aXN0cyIsImluc3RhbGxBcHAiLCJyaW1yYWYiLCJtb2JpbGVJc0FwcEluc3RhbGxlZCIsImJ1bmRsZUlkIiwiaW5zdGFsbGVkIiwiaXNBcHBJbnN0YWxsZWQiLCJtb2JpbGVSZW1vdmVBcHAiLCJyZW1vdmVBcHAiLCJlcnIiLCJ3YXJuIiwibWVzc2FnZSIsIm1vYmlsZUxhdW5jaEFwcCIsIndkYU9wdHMiLCJhcmd1bWVudHMiLCJpc0FycmF5IiwiZW52aXJvbm1lbnQiLCJwcm94eUNvbW1hbmQiLCJtb2JpbGVUZXJtaW5hdGVBcHAiLCJtb2JpbGVBY3RpdmF0ZUFwcCIsIm1vYmlsZVF1ZXJ5QXBwU3RhdGUiLCJhcHBQYXRoIiwiYWN0aXZhdGVBcHAiLCJPYmplY3QiLCJhc3NpZ24iLCJ0ZXJtaW5hdGVBcHAiLCJxdWVyeUFwcFN0YXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmOztBQUVBLFNBQVNDLHVCQUFULENBQWtDQyxJQUFJLEdBQUcsRUFBekMsRUFBNkNDLElBQTdDLEVBQW1EO0FBQ2pELFFBQU1DLE1BQU0sR0FBRyxFQUFmO0FBRGlEO0FBQUE7QUFBQTs7QUFBQTtBQUVqRCx5QkFBa0JELElBQWxCLDhIQUF3QjtBQUFBLFlBQWJFLEdBQWE7QUFDdEIsWUFBTUMsS0FBSyxHQUFHSixJQUFJ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QUFBQTs7QUFJQTFCLFFBQVEsQ0FBQytDLFlBQVQ7QUFBQSwrQ0FBd0IsV0FBZ0JyQixRQUFoQixFQUEwQjtBQUNoRCxpQkFBYSxLQUFLYyxrQkFBTCxDQUF3QjtBQUFDZCxNQUFBQTtBQUFELEtBQXhCLENBQWI7QUFDRCxHQUZEOztBQUFBO0FBQUE7QUFBQTtBQUFBOztBQUlBMUIsUUFBUSxDQUFDZ0QsYUFBVDtBQUFBLCtDQUF5QixXQUFnQnRCLFFBQWhCLEVBQTBCO0FBQ2pELGlCQUFhLEtBQUtnQixtQkFBTCxDQUF5QjtBQUFDaEIsTUFBQUE7QUFBRCxLQUF6QixDQUFiO0FBQ0QsR0FGRDs7QUFBQTtBQUFBO0FBQUE7QUFBQTs7ZUFJZTFCLFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5cbmxldCBjb21tYW5kcyA9IHt9O1xuXG5mdW5jdGlvbiBleHRyYWN0TWFuZGF0b3J5T3B0aW9ucyAob3B0cyA9IHt9LCBrZXlzKSB7XG4gIGNvbnN0IHJlc3VsdCA9IHt9O1xuICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XG4gICAgY29uc3QgdmFsdWUgPSBvcHRzW2tleV07XG4gICAgaWYgKCFfLmlzU3RyaW5nKHZhbHVlKSB8fCBfLmlzRW1wdHkodmFsdWUpKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgJyR7a2V5fScgaXMgZXhwZWN0ZWQgdG8gYmUgYSB2YWxpZCBzdHJpbmcuICcke3ZhbHVlfScgaXMgZ2l2ZW4gaW5zdGVhZGApO1xuICAgIH1cbiAgICByZXN1bHRba2V5XSA9IHZhbHVlO1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmNvbW1hbmRzLm1vYmlsZUluc3RhbGxBcHAgPSBhc3luYyBmdW5jdGlvbiAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHthcHB9ID0gZXh0cmFjdE1hbmRhdG9yeU9wdGlvbnMob3B0cywgWydhcHAnXSk7XG4gIGNvbnN0IGRzdFBhdGggPSBhd2FpdCB0aGlzLmhlbHBlcnMuY29uZmlndXJlQXBwKGFwcCwgJy5hcHAnKTtcbiAgbG9nLmluZm8oYEluc3RhbGxpbmcgJyR7ZHN0UGF0aH0nIHRvIHRoZSAke3RoaXMuaXNSZWFsRGV2aWNlKCkgPyAncmVhbCBkZXZpY2UnIDogJ1NpbXVsYXRvcid9IGAgK1xuICAgICAgICAgICBgd2l0aCBVRElEICR7dGhpcy5vcHRzLmRldmljZS51ZGlkfWApO1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhkc3RQYXRoKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgYXBwbGljYXRpb24gYXQgJyR7ZHN0UGF0aH0nIGRvZXMgbm90IGV4aXN0IG9yIGlzIG5vdCBhY2Nlc3NpYmxlYCk7XG4gIH1cbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLmluc3RhbGxBcHAoZHN0UGF0aCk7XG4gICAgbG9nLmluZm8oYEluc3RhbGxhdGlvbiBvZiAnJHtkc3RQYXRofScgc3VjY2VlZGVkYCk7XG4gIH0gZmluYWxseSB7XG4gICAgaWYgKGRzdFBhdGggIT09IGFwcCkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKGRzdFBhdGgpO1xuICAgIH1cbiAgfVxufTtcblxuY29tbWFuZHMubW9iaWxlSXNBcHBJbnN0YWxsZWQgPSBhc3luYyBmdW5jdGlvbiAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtidW5kbGVJZH0gPSBleHRyYWN0TWFuZGF0b3J5T3B0aW9ucyhvcHRzLCBbJ2J1bmRsZUlkJ10pO1xuICBjb25zdCBpbnN0YWxsZWQgPSBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLmlzQXBwSW5zdGFsbGVkKGJ1bmRsZUlkKTtcbiAgbG9nLmluZm8oYEFwcCAnJHtidW5kbGVJZH0nIGlzJHtpbnN0YWxsZWQgPyAnJyA6ICcgbm90J30gaW5zdGFsbGVkYCk7XG4gIHJldHVybiBpbnN0YWxsZWQ7XG59O1xuXG5jb21tYW5kcy5tb2JpbGVSZW1vdmVBcHAgPSBhc3luYyBmdW5jdGlvbiAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtidW5kbGVJZH0gPSBleHRyYWN0TWFuZGF0b3J5T3B0aW9ucyhvcHRzLCBbJ2J1bmRsZUlkJ10pO1xuICBsb2cuaW5mbyhgVW5pbnN0YWxsaW5nIHRoZSBhcHBsaWNhdGlvbiB3aXRoIGJ1bmRsZSBpZGVudGlmaWVyICcke2J1bmRsZUlkfScgYCArXG4gICAgYGZyb20gdGhlICR7dGhpcy5pc1JlYWxEZXZpY2UoKSA/ICdyZWFsIGRldmljZScgOiAnU2ltdWxhdG9yJ30gd2l0aCBVRElEICR7dGhpcy5vcHRzLmRldmljZS51ZGlkfWApO1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMub3B0cy5kZXZpY2UucmVtb3ZlQXBwKGJ1bmRsZUlkKTtcbiAgICBsb2cuaW5mbyhgUmVtb3ZhbCBvZiAnJHtidW5kbGVJZH0nIHN1Y2NlZWRlZGApO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgQ2Fubm90IHJlbW92ZSAnJHtidW5kbGVJZH0nLiBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn07XG5cbmNvbW1hbmRzLm1vYmlsZUxhdW5jaEFwcCA9IGFzeW5jIGZ1bmN0aW9uIChvcHRzID0ge30pIHtcbiAgY29uc3Qgd2RhT3B0cyA9IGV4dHJhY3RNYW5kYXRvcnlPcHRpb25zKG9wdHMsIFsnYnVuZGxlSWQnXSk7XG4gIGlmIChvcHRzLmFyZ3VtZW50cykge1xuICAgIHdkYU9wdHMuYXJndW1lbnRzID0gXy5pc0FycmF5KG9wdHMuYXJndW1lbnRzKSA/IG9wdHMuYXJndW1lbnRzIDogW29wdHMuYXJndW1lbnRzXTtcbiAgfVxuICBpZiAob3B0cy5lbnZpcm9ubWVudCkge1xuICAgIHdkYU9wdHMuZW52aXJvbm1lbnQgPSBvcHRzLmVudmlyb25tZW50O1xuICB9XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3dkYS9hcHBzL2xhdW5jaCcsICdQT1NUJywgd2RhT3B0cyk7XG59O1xuXG5jb21tYW5kcy5tb2JpbGVUZXJtaW5hdGVBcHAgPSBhc3luYyBmdW5jdGlvbiAob3B0cyA9IHt9KSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3dkYS9hcHBzL3Rlcm1pbmF0ZScsICdQT1NUJywgZXh0cmFjdE1hbmRhdG9yeU9wdGlvbnMob3B0cywgWydidW5kbGVJZCddKSk7XG59O1xuXG5jb21tYW5kcy5tb2JpbGVBY3RpdmF0ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIChvcHRzID0ge30pIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvd2RhL2FwcHMvYWN0aXZhdGUnLCAnUE9TVCcsIGV4dHJhY3RNYW5kYXRvcnlPcHRpb25zKG9wdHMsIFsnYnVuZGxlSWQnXSkpO1xufTtcblxuLyoqXG4gKiBSZXR1cm5zIHRoZSBjdXJyZW50IGFwcGxpY2F0aW9uIHN0YXRlXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IG9wdHMgLSBPcHRpb25zIHNldCwgd2hpY2ggbXVzdCBjb250YWluIGBidW5kbGVJZGAgcHJvcGVydHlcbiAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBhY3R1YWwgYXBwbGljYXRpb24gc3RhdGUgY29kZS4gU2VlXG4gKiBodHRwczovL2RldmVsb3Blci5hcHBsZS5jb20vZG9jdW1lbnRhdGlvbi94Y3Rlc3QveGN1aWFwcGxpY2F0aW9uc3RhdGU/bGFuZ3VhZ2U9b2JqY1xuICogdG8gZ2V0IHRoZSBsaXN0IG9mIHBvc3NpYmxlIHZhbHVlcy5cbiAqL1xuY29tbWFuZHMubW9iaWxlUXVlcnlBcHBTdGF0ZSA9IGFzeW5jIGZ1bmN0aW9uIChvcHRzID0ge30pIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvd2RhL2FwcHMvc3RhdGUnLCAnUE9TVCcsIGV4dHJhY3RNYW5kYXRvcnlPcHRpb25zKG9wdHMsIFsnYnVuZGxlSWQnXSkpO1xufTtcblxuY29tbWFuZHMuaW5zdGFsbEFwcCA9IGFzeW5jIGZ1bmN0aW9uIChhcHBQYXRoKSB7XG4gIGF3YWl0IHRoaXMubW9iaWxlSW5zdGFsbEFwcCh7YXBwOiBhcHBQYXRofSk7XG59O1xuXG5jb21tYW5kcy5hY3RpdmF0ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIChidW5kbGVJZCwgb3B0cyA9IHt9KSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLm1vYmlsZUxhdW5jaEFwcChPYmplY3QuYXNzaWduKHt9LCBvcHRzLCB7YnVuZGxlSWR9KSk7XG59O1xuXG5jb21tYW5kcy5pc0FwcEluc3RhbGxlZCA9IGFzeW5jIGZ1bmN0aW9uIChidW5kbGVJZCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5tb2JpbGVJc0FwcEluc3RhbGxlZCh7YnVuZGxlSWR9KTtcbn07XG5cbmNvbW1hbmRzLnRlcm1pbmF0ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIChidW5kbGVJZCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5tb2JpbGVUZXJtaW5hdGVBcHAoe2J1bmRsZUlkfSk7XG59O1xuXG5jb21tYW5kcy5xdWVyeUFwcFN0YXRlID0gYXN5bmMgZnVuY3Rpb24gKGJ1bmRsZUlkKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLm1vYmlsZVF1ZXJ5QXBwU3RhdGUoe2J1bmRsZUlkfSk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL2FwcC1tYW5hZ2VtZW50LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
