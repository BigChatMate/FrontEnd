"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _iproxy = _interopRequireDefault(require("../wda/iproxy"));

let commands = {};
exports.commands = commands;
const MAX_RECORDING_TIME_SEC = 60 * 30;
const DEFAULT_RECORDING_TIME_SEC = 60 * 3;
const DEFAULT_MJPEG_SERVER_PORT = 9100;
const MP4_EXT = '.mp4';
const DEFAULT_FPS = 10;
const FFMPEG_BINARY = 'ffmpeg';

const ffmpegLogger = _appiumSupport.logger.getLogger(FFMPEG_BINARY);

class ScreenRecorder {
  constructor(udid, videoPath, opts = {}) {
    this.videoPath = videoPath;
    this.opts = opts;
    this.udid = udid;
    this.mainProcess = null;
    this.iproxy = null;
    this.timeoutHandler = null;
  }

  start(timeoutMs) {
    var _this = this;

    return (0, _asyncToGenerator2.default)(function* () {
      try {
        yield _appiumSupport.fs.which(FFMPEG_BINARY);
      } catch (err) {
        throw new Error(`'${FFMPEG_BINARY}' binary is not found in PATH. Install it using 'brew install ffmpeg'. ` + `Check https://www.ffmpeg.org/download.html for more details.`);
      }

      const localPort = _this.opts.remotePort;

      if (_this.opts.usePortForwarding) {
        yield _this.startIproxy(localPort);
      }

      const args = ['-f', 'mjpeg', '-r', _this.opts.videoFps, '-i', `http://localhost:${localPort}`, '-vcodec', 'mjpeg', '-y', _this.videoPath];
      _this.mainProcess = new _teen_process.SubProcess(FFMPEG_BINARY, args);

      _this.mainProcess.on('output', (stdout, stderr) => {
        if (stderr && !stderr.includes('frame=')) {
          ffmpegLogger.info(`${stderr}`);
        }
      });

      yield _this.mainProcess.start(5000);

      _logger.default.info(`Starting screen capture on the device '${_this.udid}' with command: '${FFMPEG_BINARY} ${args.join(' ')}'. ` + `Will timeout in ${timeoutMs}ms`);

      _this.timeoutHandler = setTimeout((0, _asyncToGenerator2.default)(function* () {
        if (!(yield _this.interrupt())) {
          _logger.default.warn(`Cannot finish the active screen recording on the device '${_this.udid}' after ${timeoutMs}ms timeout`);
        }
      }), timeoutMs);
    })();
  }

  startIproxy(localPort) {
    var _this2 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _this2.iproxy = new _iproxy.default(_this2.udid, localPort, _this2.opts.remotePort);

      try {
        yield _this2.iproxy.start();
      } catch (err) {
        _logger.default.warn(`Cannot start iproxy. Assuming it is already forwarding the remote port ${_this2.opts.remotePort} to ${localPort} ` + `for the device ${_this2.udid}. Set the custom value to 'mjpegServerPort' capability if this is an undesired behavior. ` + `Original error: ${err.message}`);

        _this2.iproxy = null;
      }
    })();
  }

  stopIproxy() {
    var _this3 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (!_this3.iproxy) {
        return;
      }

      const quitPromise = _this3.iproxy.quit();

      _this3.iproxy = null;

      try {
        yield quitPromise;
      } catch (err) {
        _logger.default.warn(`Cannot stop iproxy. Original error: ${err.message}`);
      }
    })();
  }

  interrupt(force = false) {
    var _this4 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let result = true;

      if (_this4.timeoutHandler) {
        clearTimeout(_this4.timeoutHandler);
        _this4.timeoutHandler = null;
      }

      if (_this4.mainProcess && _this4.mainProcess.isRunning) {
        const interruptPromise = _this4.mainProcess.stop(force ? 'SIGTERM' : 'SIGINT');

        _this4.mainProcess = null;

        try {
          yield interruptPromise;
        } catch (e) {
          _logger.default.warn(`Cannot ${force ? 'terminate' : 'interrupt'} ${FFMPEG_BINARY}. ` + `Original error: ${e.message}`);

          result = false;
        }
      }

      if (_this4.opts.usePortForwarding) {
        yield _this4.stopIproxy();
      }

      return result;
    })();
  }

  finish() {
    var _this5 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      yield _this5.interrupt();
      return _this5.videoPath;
    })();
  }

  cleanup() {
    var _this6 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (yield _appiumSupport.fs.exists(_this6.videoPath)) {
        yield _appiumSupport.fs.rimraf(_this6.videoPath);
      }
    })();
  }

}

commands.startRecordingScreen = function () {
  var _ref2 = (0, _asyncToGenerator2.default)(function* (options = {}) {
    const videoType = options.videoType,
          _options$timeLimit = options.timeLimit,
          timeLimit = _options$timeLimit === void 0 ? DEFAULT_RECORDING_TIME_SEC : _options$timeLimit,
          _options$videoQuality = options.videoQuality,
          videoQuality = _options$videoQuality === void 0 ? 'medium' : _options$videoQuality,
          _options$videoFps = options.videoFps,
          videoFps = _options$videoFps === void 0 ? DEFAULT_FPS : _options$videoFps,
          forceRestart = options.forceRestart;
    let result = '';

    if (!forceRestart) {
      _logger.default.info(`Checking if there is/was a previous screen recording. ` + `Set 'forceRestart' option to 'true' if you'd like to skip this step.`);

      result = yield this.stopRecordingScreen(options);
    }

    const videoPath = yield _appiumSupport.tempDir.path({
      prefix: `appium_${Math.random().toString(16).substring(2, 8)}`,
      suffix: MP4_EXT
    });
    const screenRecorder = new ScreenRecorder(this.opts.device.udid, videoPath, {
      videoType,
      videoQuality,
      videoFps: videoFps || DEFAULT_FPS,
      remotePort: this.opts.mjpegServerPort || DEFAULT_MJPEG_SERVER_PORT,
      usePortForwarding: this.isRealDevice()
    });

    if (!(yield screenRecorder.interrupt(true))) {
      _logger.default.errorAndThrow('Unable to stop screen recording process');
    }

    if (this._recentScreenRecorder) {
      yield this._recentScreenRecorder.cleanup();
      this._recentScreenRecorder = null;
    }

    const timeoutSeconds = parseFloat(timeLimit);

    if (isNaN(timeoutSeconds) || timeoutSeconds > MAX_RECORDING_TIME_SEC || timeoutSeconds <= 0) {
      _logger.default.errorAndThrow(`The timeLimit value must be in range [1, ${MAX_RECORDING_TIME_SEC}] seconds. ` + `The value of '${timeLimit}' has been passed instead.`);
    }

    try {
      yield screenRecorder.start(timeoutSeconds * 1000);
    } catch (e) {
      yield screenRecorder.interrupt(true);
      yield screenRecorder.cleanup();
      throw e;
    }

    this._recentScreenRecorder = screenRecorder;
    return result;
  });

  return function () {
    return _ref2.apply(this, arguments);
  };
}();

commands.stopRecordingScreen = function () {
  var _ref3 = (0, _asyncToGenerator2.default)(function* (options = {}) {
    const remotePath = options.remotePath,
          user = options.user,
          pass = options.pass,
          method = options.method;

    if (!this._recentScreenRecorder) {
      _logger.default.info('Screen recording is not running. There is nothing to stop.');

      return '';
    }

    try {
      const videoPath = yield this._recentScreenRecorder.finish();

      if (!(yield _appiumSupport.fs.exists(videoPath))) {
        _logger.default.errorAndThrow(`The screen recorder utility has failed ` + `to store the actual screen recording at '${videoPath}'`);
      }

      return yield (0, _utils.encodeBase64OrUpload)(videoPath, remotePath, {
        user,
        pass,
        method
      });
    } finally {
      yield this._recentScreenRecorder.interrupt(true);
      yield this._recentScreenRecorder.cleanup();
      this._recentScreenRecorder = null;
    }
  });

  return function () {
    return _ref3.apply(this, arguments);
  };
}();

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9yZWNvcmRzY3JlZW4uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJNQVhfUkVDT1JESU5HX1RJTUVfU0VDIiwiREVGQVVMVF9SRUNPUkRJTkdfVElNRV9TRUMiLCJERUZBVUxUX01KUEVHX1NFUlZFUl9QT1JUIiwiTVA0X0VYVCIsIkRFRkFVTFRfRlBTIiwiRkZNUEVHX0JJTkFSWSIsImZmbXBlZ0xvZ2dlciIsImxvZ2dlciIsImdldExvZ2dlciIsIlNjcmVlblJlY29yZGVyIiwiY29uc3RydWN0b3IiLCJ1ZGlkIiwidmlkZW9QYXRoIiwib3B0cyIsIm1haW5Qcm9jZXNzIiwiaXByb3h5IiwidGltZW91dEhhbmRsZXIiLCJzdGFydCIsInRpbWVvdXRNcyIsImZzIiwid2hpY2giLCJlcnIiLCJFcnJvciIsImxvY2FsUG9ydCIsInJlbW90ZVBvcnQiLCJ1c2VQb3J0Rm9yd2FyZGluZyIsInN0YXJ0SXByb3h5IiwiYXJncyIsInZpZGVvRnBzIiwiU3ViUHJvY2VzcyIsIm9uIiwic3Rkb3V0Iiwic3RkZXJyIiwiaW5jbHVkZXMiLCJpbmZvIiwibG9nIiwiam9pbiIsInNldFRpbWVvdXQiLCJpbnRlcnJ1cHQiLCJ3YXJuIiwiaVByb3h5IiwibWVzc2FnZSIsInN0b3BJcHJveHkiLCJxdWl0UHJvbWlzZSIsInF1aXQiLCJmb3JjZSIsInJlc3VsdCIsImNsZWFyVGltZW91dCIsImlzUnVubmluZyIsImludGVycnVwdFByb21pc2UiLCJzdG9wIiwiZSIsImZpbmlzaCIsImNsZWFudXAiLCJleGlzdHMiLCJyaW1yYWYiLCJzdGFydFJlY29yZGluZ1NjcmVlbiIsIm9wdGlvbnMiLCJ2aWRlb1R5cGUiLCJ0aW1lTGltaXQiLCJ2aWRlb1F1YWxpdHkiLCJmb3JjZVJlc3RhcnQiLCJzdG9wUmVjb3JkaW5nU2NyZWVuIiwidGVtcERpciIsInBhdGgiLCJwcmVmaXgiLCJNYXRoIiwicmFuZG9tIiwidG9TdHJpbmciLCJzdWJzdHJpbmciLCJzdWZmaXgiLCJzY3JlZW5SZWNvcmRlciIsImRldmljZSIsIm1qcGVnU2VydmVyUG9ydCIsImlzUmVhbERldmljZSIsImVycm9yQW5kVGhyb3ciLCJfcmVjZW50U2NyZWVuUmVjb3JkZXIiLCJ0aW1lb3V0U2Vjb25kcyIsInBhcnNlRmxvYXQiLCJpc05hTiIsInJlbW90ZVBhdGgiLCJ1c2VyIiwicGFzcyIsIm1ldGhvZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFJQSxRQUFRLEdBQUcsRUFBZjs7QUFFQSxNQUFNQyxzQkFBc0IsR0FBRyxLQUFLLEVBQXBDO0FBQ0EsTUFBTUMsMEJBQTBCLEdBQUcsS0FBSyxDQUF4QztBQUNBLE1BQU1DLHlCQUF5QixHQUFHLElBQWxDO0FBQ0EsTUFBTUMsT0FBTyxHQUFHLE1BQWhCO0FBQ0EsTUFBTUMsV0FBVyxHQUFHLEVBQXBCO0FBQ0EsTUFBTUMsYUFBYSxHQUFHLFFBQXRCOztBQUNBLE1BQU1DLFlBQVksR0FBR0Msc0JBQU9DLFNBQVAsQ0FBaUJILGFBQWpCLENBQXJCOztBQUVBLE1BQU1JLGNBQU4sQ0FBcUI7QUFDbkJDLEVBQUFBLFdBQVcsQ0FBRUMsSUFBRixFQUFRQyxTQUFSLEVBQW1CQyxJQUFJLEdBQUcsRUFBMUIsRUFBOEI7QUFDdkMsU0FBS0QsU0FBTCxHQUFpQkEsU0FBakI7QUFDQSxTQUFLQyxJQUFMLEdBQVlBLElBQVo7QUFDQSxTQUFLRixJQUFMLEdBQVlBLElBQVo7QUFDQSxTQUFLRyxXQUFMLEdBQW1CLElBQW5CO0FBQ0EsU0FBS0MsTUFBTCxHQUFjLElBQWQ7QUFDQSxTQUFLQyxjQUFMLEdBQXNCLElBQXRCO0FBQ0Q7O0FBRUtDLEVBQUFBLEtBQU4sQ0FBYUMsU0FBYixFQUF3QjtBQUFBOztBQUFBO0FBQ3RCLFVBQUk7QUFDRixjQUFNQyxrQkFBR0MsS0FBSCxDQUFTZixhQUFULENBQU47QUFDRCxPQUZELENBRUUsT0FBT2dCLEdBQVAsRUFBWTtBQUNaLGNBQU0sSUFBSUMsS0FBSixD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aW1wb3J0IHsgZnMsIHRlbXBEaXIsIGxvZ2dlciB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IFN1YlByb2Nlc3MgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZW5jb2RlQmFzZTY0T3JVcGxvYWQgfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgaVByb3h5IGZyb20gJy4uL3dkYS9pcHJveHknO1xuXG5sZXQgY29tbWFuZHMgPSB7fTtcblxuY29uc3QgTUFYX1JFQ09SRElOR19USU1FX1NFQyA9IDYwICogMzA7XG5jb25zdCBERUZBVUxUX1JFQ09SRElOR19USU1FX1NFQyA9IDYwICogMztcbmNvbnN0IERFRkFVTFRfTUpQRUdfU0VSVkVSX1BPUlQgPSA5MTAwO1xuY29uc3QgTVA0X0VYVCA9ICcubXA0JztcbmNvbnN0IERFRkFVTFRfRlBTID0gMTA7XG5jb25zdCBGRk1QRUdfQklOQVJZID0gJ2ZmbXBlZyc7XG5jb25zdCBmZm1wZWdMb2dnZXIgPSBsb2dnZXIuZ2V0TG9nZ2VyKEZGTVBFR19CSU5BUlkpO1xuXG5jbGFzcyBTY3JlZW5SZWNvcmRlciB7XG4gIGNvbnN0cnVjdG9yICh1ZGlkLCB2aWRlb1BhdGgsIG9wdHMgPSB7fSkge1xuICAgIHRoaXMudmlkZW9QYXRoID0gdmlkZW9QYXRoO1xuICAgIHRoaXMub3B0cyA9IG9wdHM7XG4gICAgdGhpcy51ZGlkID0gdWRpZDtcbiAgICB0aGlzLm1haW5Qcm9jZXNzID0gbnVsbDtcbiAgICB0aGlzLmlwcm94eSA9IG51bGw7XG4gICAgdGhpcy50aW1lb3V0SGFuZGxlciA9IG51bGw7XG4gIH1cblxuICBhc3luYyBzdGFydCAodGltZW91dE1zKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGZzLndoaWNoKEZGTVBFR19CSU5BUlkpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAnJHtGRk1QRUdfQklOQVJZfScgYmluYXJ5IGlzIG5vdCBmb3VuZCBpbiBQQVRILiBJbnN0YWxsIGl0IHVzaW5nICdicmV3IGluc3RhbGwgZmZtcGVnJy4gYCArXG4gICAgICAgIGBDaGVjayBodHRwczovL3d3dy5mZm1wZWcub3JnL2Rvd25sb2FkLmh0bWwgZm9yIG1vcmUgZGV0YWlscy5gKTtcbiAgICB9XG5cbiAgICBjb25zdCBsb2NhbFBvcnQgPSB0aGlzLm9wdHMucmVtb3RlUG9ydDtcbiAgICBpZiAodGhpcy5vcHRzLnVzZVBvcnRGb3J3YXJkaW5nKSB7XG4gICAgICBhd2FpdCB0aGlzLnN0YXJ0SXByb3h5KGxvY2FsUG9ydCk7XG4gICAgfVxuXG4gICAgY29uc3QgYXJncyA9IFtcbiAgICAgICctZicsICdtanBlZycsXG4gICAgICAnLXInLCB0aGlzLm9wdHMudmlkZW9GcHMsXG4gICAgICAnLWknLCBgaHR0cDovL2xvY2FsaG9zdDoke2xvY2FsUG9ydH1gLFxuICAgICAgJy12Y29kZWMnLCAnbWpwZWcnLFxuICAgICAgJy15JywgdGhpcy52aWRlb1BhdGgsXG4gICAgXTtcbiAgICB0aGlzLm1haW5Qcm9jZXNzID0gbmV3IFN1YlByb2Nlc3MoRkZNUEVHX0JJTkFSWSwgYXJncyk7XG4gICAgdGhpcy5tYWluUHJvY2Vzcy5vbignb3V0cHV0JywgKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICBpZiAoc3RkZXJyICYmICFzdGRlcnIuaW5jbHVkZXMoJ2ZyYW1lPScpKSB7XG4gICAgICAgIGZmbXBlZ0xvZ2dlci5pbmZvKGAke3N0ZGVycn1gKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICAvLyBHaXZlIGZmbXBlZyBzb21lIHRpbWUgZm9yIGluaXRcbiAgICBhd2FpdCB0aGlzLm1haW5Qcm9jZXNzLnN0YXJ0KDUwMDApO1xuICAgIGxvZy5pbmZvKGBTdGFydGluZyBzY3JlZW4gY2FwdHVyZSBvbiB0aGUgZGV2aWNlICcke3RoaXMudWRpZH0nIHdpdGggY29tbWFuZDogJyR7RkZNUEVHX0JJTkFSWX0gJHthcmdzLmpvaW4oJyAnKX0nLiBgICtcbiAgICAgIGBXaWxsIHRpbWVvdXQgaW4gJHt0aW1lb3V0TXN9bXNgKTtcblxuICAgIHRoaXMudGltZW91dEhhbmRsZXIgPSBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHtcbiAgICAgIGlmICghYXdhaXQgdGhpcy5pbnRlcnJ1cHQoKSkge1xuICAgICAgICBsb2cud2FybihgQ2Fubm90IGZpbmlzaCB0aGUgYWN0aXZlIHNjcmVlbiByZWNvcmRpbmcgb24gdGhlIGRldmljZSAnJHt0aGlzLnVkaWR9JyBhZnRlciAke3RpbWVvdXRNc31tcyB0aW1lb3V0YCk7XG4gICAgICB9XG4gICAgfSwgdGltZW91dE1zKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0SXByb3h5IChsb2NhbFBvcnQpIHtcbiAgICB0aGlzLmlwcm94eSA9IG5ldyBpUHJveHkodGhpcy51ZGlkLCBsb2NhbFBvcnQsIHRoaXMub3B0cy5yZW1vdGVQb3J0KTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5pcHJveHkuc3RhcnQoKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGBDYW5ub3Qgc3RhcnQgaXByb3h5LiBBc3N1bWluZyBpdCBpcyBhbHJlYWR5IGZvcndhcmRpbmcgdGhlIHJlbW90ZSBwb3J0ICR7dGhpcy5vcHRzLnJlbW90ZVBvcnR9IHRvICR7bG9jYWxQb3J0fSBgICtcbiAgICAgICAgYGZvciB0aGUgZGV2aWNlICR7dGhpcy51ZGlkfS4gU2V0IHRoZSBjdXN0b20gdmFsdWUgdG8gJ21qcGVnU2VydmVyUG9ydCcgY2FwYWJpbGl0eSBpZiB0aGlzIGlzIGFuIHVuZGVzaXJlZCBiZWhhdmlvci4gYCArXG4gICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIHRoaXMuaXByb3h5ID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzdG9wSXByb3h5ICgpIHtcbiAgICBpZiAoIXRoaXMuaXByb3h5KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgcXVpdFByb21pc2UgPSB0aGlzLmlwcm94eS5xdWl0KCk7XG4gICAgdGhpcy5pcHJveHkgPSBudWxsO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBxdWl0UHJvbWlzZTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGBDYW5ub3Qgc3RvcCBpcHJveHkuIE9yaWdpbmFsIGVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGludGVycnVwdCAoZm9yY2UgPSBmYWxzZSkge1xuICAgIGxldCByZXN1bHQgPSB0cnVlO1xuXG4gICAgaWYgKHRoaXMudGltZW91dEhhbmRsZXIpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXRIYW5kbGVyKTtcbiAgICAgIHRoaXMudGltZW91dEhhbmRsZXIgPSBudWxsO1xuICAgIH1cblxuICAgIGlmICh0aGlzLm1haW5Qcm9jZXNzICYmIHRoaXMubWFpblByb2Nlc3MuaXNSdW5uaW5nKSB7XG4gICAgICBjb25zdCBpbnRlcnJ1cHRQcm9taXNlID0gdGhpcy5tYWluUHJvY2Vzcy5zdG9wKGZvcmNlID8gJ1NJR1RFUk0nIDogJ1NJR0lOVCcpO1xuICAgICAgdGhpcy5tYWluUHJvY2VzcyA9IG51bGw7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBpbnRlcnJ1cHRQcm9taXNlO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cud2FybihgQ2Fubm90ICR7Zm9yY2UgPyAndGVybWluYXRlJyA6ICdpbnRlcnJ1cHQnfSAke0ZGTVBFR19CSU5BUll9LiBgICtcbiAgICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgICByZXN1bHQgPSBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5vcHRzLnVzZVBvcnRGb3J3YXJkaW5nKSB7XG4gICAgICBhd2FpdCB0aGlzLnN0b3BJcHJveHkoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgYXN5bmMgZmluaXNoICgpIHtcbiAgICBhd2FpdCB0aGlzLmludGVycnVwdCgpO1xuICAgIHJldHVybiB0aGlzLnZpZGVvUGF0aDtcbiAgfVxuXG4gIGFzeW5jIGNsZWFudXAgKCkge1xuICAgIGlmIChhd2FpdCBmcy5leGlzdHModGhpcy52aWRlb1BhdGgpKSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYodGhpcy52aWRlb1BhdGgpO1xuICAgIH1cbiAgfVxufVxuXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU3RhcnRSZWNvcmRpbmdPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHBhdGggdG8gdGhlIHJlbW90ZSBsb2NhdGlvbiwgd2hlcmUgdGhlIHJlc3VsdGluZyB2aWRlbyBzaG91bGQgYmUgdXBsb2FkZWQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZm9sbG93aW5nIHByb3RvY29scyBhcmUgc3VwcG9ydGVkOiBodHRwL2h0dHBzLCBmdHAuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBOdWxsIG9yIGVtcHR5IHN0cmluZyB2YWx1ZSAodGhlIGRlZmF1bHQgc2V0dGluZykgbWVhbnMgdGhlIGNvbnRlbnQgb2YgcmVzdWx0aW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlIHNob3VsZCBiZSBlbmNvZGVkIGFzIEJhc2U2NCBhbmQgcGFzc2VkIGFzIHRoZSBlbmRwb3VudCByZXNwb25zZSB2YWx1ZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFuIGV4Y2VwdGlvbiB3aWxsIGJlIHRocm93biBpZiB0aGUgZ2VuZXJhdGVkIG1lZGlhIGZpbGUgaXMgdG9vIGJpZyB0b1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZml0IGludG8gdGhlIGF2YWlsYWJsZSBwcm9jZXNzIG1lbW9yeS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoaXMgb3B0aW9uIG9ubHkgaGFzIGFuIGVmZmVjdCBpZiB0aGVyZSBpcyBzY3JlZW4gcmVjb3JkaW5nIHByb2Nlc3MgaW4gcHJvZ3JlZXNzXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmQgYGZvcmNlUmVzdGFydGAgcGFyYW1ldGVyIGlzIG5vdCBzZXQgdG8gYHRydWVgLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB1c2VyIC0gVGhlIG5hbWUgb2YgdGhlIHVzZXIgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBwYXNzIC0gVGhlIHBhc3N3b3JkIGZvciB0aGUgcmVtb3RlIGF1dGhlbnRpY2F0aW9uLiBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gbWV0aG9kIC0gVGhlIGh0dHAgbXVsdGlwYXJ0IHVwbG9hZCBtZXRob2QgbmFtZS4gVGhlICdQVVQnIG9uZSBpcyB1c2VkIGJ5IGRlZmF1bHQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB2aWRlb1R5cGUgLSBUaGUgZm9ybWF0IG9mIHRoZSBzY3JlZW4gY2FwdHVyZSB0byBiZSByZWNvcmRlZC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQXZhaWxhYmxlIGZvcm1hdHM6IFwiaDI2NFwiLCBcIm1wNFwiIG9yIFwiZm1wNFwiLiBEZWZhdWx0IGlzIFwibXA0XCIuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHZpZGVvUXVhbGl0eSAtIFRoZSB2aWRlbyBlbmNvZGluZyBxdWFsaXR5IChsb3csIG1lZGl1bSwgaGlnaCwgcGhvdG8gLSBkZWZhdWx0cyB0byBtZWRpdW0pLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB2aWRlb0ZwcyAtIFRoZSBGcmFtZXMgUGVyIFNlY29uZCByYXRlIG9mIHRoZSByZWNvcmRlZCB2aWRlby4gQ2hhbmdlIHRoaXMgdmFsdWUgaWYgdGhlIHJlc3VsdGluZyB2aWRlb1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzIHRvbyBzbG93IG9yIHRvbyBmYXN0LiBEZWZhdWx0cyB0byAxMC5cbiAqIEBwcm9wZXJ0eSB7P2Jvb2xlYW59IGZvcmNlUmVzdGFydCAtIFdoZXRoZXIgdG8gdHJ5IHRvIGNhdGNoIGFuZCB1cGxvYWQvcmV0dXJuIHRoZSBjdXJyZW50bHkgcnVubmluZyBzY3JlZW4gcmVjb3JkaW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoYGZhbHNlYCwgdGhlIGRlZmF1bHQgc2V0dGluZykgb3IgaWdub3JlIHRoZSByZXN1bHQgb2YgaXQgYW5kIHN0YXJ0IGEgbmV3IHJlY29yZGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1tZWRpYXRlbHkuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd8bnVtYmVyfSB0aW1lTGltaXQgLSBUaGUgbWF4aW11bSByZWNvcmRpbmcgdGltZSwgaW4gc2Vjb25kcy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBkZWZhdWx0IHZhbHVlIGlzIDE4MCwgdGhlIG1heGltdW0gdmFsdWUgaXMgNjAwICgxMCBtaW51dGVzKS5cbiAqL1xuXG4vKipcbiAqIFJlY29yZCB0aGUgZGlzcGxheSBvZiBkZXZpY2VzIHJ1bm5pbmcgaU9TIFNpbXVsYXRvciBzaW5jZSBYY29kZSA4LjMgb3IgcmVhbCBkZXZpY2VzIHNpbmNlIGlPUyA4XG4gKiAoaW9zLW1pbmljYXAgdXRpbGl0eSBpcyByZXF1aXJlZDogaHR0cHM6Ly9naXRodWIuY29tL29wZW5zdGYvaW9zLW1pbmljYXApLlxuICogSXQgcmVjb3JkcyBzY3JlZW4gYWN0aXZpdHkgdG8gYSBNUEVHLTQgZmlsZS4gQXVkaW8gaXMgbm90IHJlY29yZGVkIHdpdGggdGhlIHZpZGVvIGZpbGUuXG4gKiBJZiBzY3JlZW4gcmVjb3JkaW5nIGhhcyBiZWVuIGFscmVhZHkgc3RhcnRlZCB0aGVuIHRoZSBjb21tYW5kIHdpbGwgc3RvcCBpdCBmb3JjZWZ1bGx5IGFuZCBzdGFydCBhIG5ldyBvbmUuXG4gKiBUaGUgcHJldmlvdXNseSByZWNvcmRlZCB2aWRlbyBmaWxlIHdpbGwgYmUgZGVsZXRlZC5cbiAqXG4gKiBAcGFyYW0gez9TdGFydFJlY29yZGluZ09wdGlvbnN9IG9wdGlvbnMgLSBUaGUgYXZhaWxhYmxlIG9wdGlvbnMuXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBCYXNlNjQtZW5jb2RlZCBjb250ZW50IG9mIHRoZSByZWNvcmRlZCBtZWRpYSBmaWxlIGlmXG4gKiAgICAgICAgICAgICAgICAgICBhbnkgc2NyZWVuIHJlY29yZGluZyBpcyBjdXJyZW50bHkgcnVubmluZyBvciBhbiBlbXB0eSBzdHJpbmcuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgc2NyZWVuIHJlY29yZGluZyBoYXMgZmFpbGVkIHRvIHN0YXJ0LlxuICovXG5jb21tYW5kcy5zdGFydFJlY29yZGluZ1NjcmVlbiA9IGFzeW5jIGZ1bmN0aW9uIChvcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIHZpZGVvVHlwZSxcbiAgICB0aW1lTGltaXQgPSBERUZBVUxUX1JFQ09SRElOR19USU1FX1NFQyxcbiAgICB2aWRlb1F1YWxpdHkgPSAnbWVkaXVtJyxcbiAgICB2aWRlb0ZwcyA9IERFRkFVTFRfRlBTLFxuICAgIGZvcmNlUmVzdGFydCxcbiAgfSA9IG9wdGlvbnM7XG5cbiAgbGV0IHJlc3VsdCA9ICcnO1xuICBpZiAoIWZvcmNlUmVzdGFydCkge1xuICAgIGxvZy5pbmZvKGBDaGVja2luZyBpZiB0aGVyZSBpcy93YXMgYSBwcmV2aW91cyBzY3JlZW4gcmVjb3JkaW5nLiBgICtcbiAgICAgIGBTZXQgJ2ZvcmNlUmVzdGFydCcgb3B0aW9uIHRvICd0cnVlJyBpZiB5b3UnZCBsaWtlIHRvIHNraXAgdGhpcyBzdGVwLmApO1xuICAgIHJlc3VsdCA9IGF3YWl0IHRoaXMuc3RvcFJlY29yZGluZ1NjcmVlbihvcHRpb25zKTtcbiAgfVxuXG4gIGNvbnN0IHZpZGVvUGF0aCA9IGF3YWl0IHRlbXBEaXIucGF0aCh7XG4gICAgcHJlZml4OiBgYXBwaXVtXyR7TWF0aC5yYW5kb20oKS50b1N0cmluZygxNikuc3Vic3RyaW5nKDIsIDgpfWAsXG4gICAgc3VmZml4OiBNUDRfRVhULFxuICB9KTtcblxuICBjb25zdCBzY3JlZW5SZWNvcmRlciA9IG5ldyBTY3JlZW5SZWNvcmRlcih0aGlzLm9wdHMuZGV2aWNlLnVkaWQsIHZpZGVvUGF0aCwge1xuICAgIC8vIFRPRE86IEFwcGx5IHR5cGUgYW5kIHF1YWxpdHkgb3B0aW9uc1xuICAgIHZpZGVvVHlwZSxcbiAgICB2aWRlb1F1YWxpdHksXG4gICAgdmlkZW9GcHM6IHZpZGVvRnBzIHx8IERFRkFVTFRfRlBTLFxuICAgIHJlbW90ZVBvcnQ6IHRoaXMub3B0cy5tanBlZ1NlcnZlclBvcnQgfHwgREVGQVVMVF9NSlBFR19TRVJWRVJfUE9SVCxcbiAgICB1c2VQb3J0Rm9yd2FyZGluZzogdGhpcy5pc1JlYWxEZXZpY2UoKSxcbiAgfSk7XG4gIGlmICghYXdhaXQgc2NyZWVuUmVjb3JkZXIuaW50ZXJydXB0KHRydWUpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coJ1VuYWJsZSB0byBzdG9wIHNjcmVlbiByZWNvcmRpbmcgcHJvY2VzcycpO1xuICB9XG4gIGlmICh0aGlzLl9yZWNlbnRTY3JlZW5SZWNvcmRlcikge1xuICAgIGF3YWl0IHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyLmNsZWFudXAoKTtcbiAgICB0aGlzLl9yZWNlbnRTY3JlZW5SZWNvcmRlciA9IG51bGw7XG4gIH1cblxuICBjb25zdCB0aW1lb3V0U2Vjb25kcyA9IHBhcnNlRmxvYXQodGltZUxpbWl0KTtcbiAgaWYgKGlzTmFOKHRpbWVvdXRTZWNvbmRzKSB8fCB0aW1lb3V0U2Vjb25kcyA+IE1BWF9SRUNPUkRJTkdfVElNRV9TRUMgfHwgdGltZW91dFNlY29uZHMgPD0gMCkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgdGltZUxpbWl0IHZhbHVlIG11c3QgYmUgaW4gcmFuZ2UgWzEsICR7TUFYX1JFQ09SRElOR19USU1FX1NFQ31dIHNlY29uZHMuIGAgK1xuICAgICAgYFRoZSB2YWx1ZSBvZiAnJHt0aW1lTGltaXR9JyBoYXMgYmVlbiBwYXNzZWQgaW5zdGVhZC5gKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgYXdhaXQgc2NyZWVuUmVjb3JkZXIuc3RhcnQodGltZW91dFNlY29uZHMgKiAxMDAwKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGF3YWl0IHNjcmVlblJlY29yZGVyLmludGVycnVwdCh0cnVlKTtcbiAgICBhd2FpdCBzY3JlZW5SZWNvcmRlci5jbGVhbnVwKCk7XG4gICAgdGhyb3cgZTtcbiAgfVxuICB0aGlzLl9yZWNlbnRTY3JlZW5SZWNvcmRlciA9IHNjcmVlblJlY29yZGVyO1xuXG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFN0b3BSZWNvcmRpbmdPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHBhdGggdG8gdGhlIHJlbW90ZSBsb2NhdGlvbiwgd2hlcmUgdGhlIHJlc3VsdGluZyB2aWRlbyBzaG91bGQgYmUgdXBsb2FkZWQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZm9sbG93aW5nIHByb3RvY29scyBhcmUgc3VwcG9ydGVkOiBodHRwL2h0dHBzLCBmdHAuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBOdWxsIG9yIGVtcHR5IHN0cmluZyB2YWx1ZSAodGhlIGRlZmF1bHQgc2V0dGluZykgbWVhbnMgdGhlIGNvbnRlbnQgb2YgcmVzdWx0aW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlIHNob3VsZCBiZSBlbmNvZGVkIGFzIEJhc2U2NCBhbmQgcGFzc2VkIGFzIHRoZSBlbmRwb3VudCByZXNwb25zZSB2YWx1ZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFuIGV4Y2VwdGlvbiB3aWxsIGJlIHRocm93biBpZiB0aGUgZ2VuZXJhdGVkIG1lZGlhIGZpbGUgaXMgdG9vIGJpZyB0b1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZml0IGludG8gdGhlIGF2YWlsYWJsZSBwcm9jZXNzIG1lbW9yeS5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdXNlciAtIFRoZSBuYW1lIG9mIHRoZSB1c2VyIGZvciB0aGUgcmVtb3RlIGF1dGhlbnRpY2F0aW9uLiBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcGFzcyAtIFRoZSBwYXNzd29yZCBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IG1ldGhvZCAtIFRoZSBodHRwIG11bHRpcGFydCB1cGxvYWQgbWV0aG9kIG5hbWUuIFRoZSAnUFVUJyBvbmUgaXMgdXNlZCBieSBkZWZhdWx0LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqL1xuXG4vKipcbiAqIFN0b3AgcmVjb3JkaW5nIHRoZSBzY3JlZW4uIElmIG5vIHNjcmVlbiByZWNvcmRpbmcgcHJvY2VzcyBpcyBydW5uaW5nIHRoZW5cbiAqIHRoZSBlbmRwb2ludCB3aWxsIHRyeSB0byBnZXQgdGhlIHJlY2VudGx5IHJlY29yZGVkIGZpbGUuXG4gKiBJZiBubyBwcmV2aW91c2x5IHJlY29yZGVkIGZpbGUgaXMgZm91bmQgYW5kIG5vIGFjdGl2ZSBzY3JlZW4gcmVjb3JkaW5nXG4gKiBwcm9jZXNzZXMgYXJlIHJ1bm5pbmcgdGhlbiB0aGUgbWV0aG9kIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nLlxuICpcbiAqIEBwYXJhbSB7P1N0b3BSZWNvcmRpbmdPcHRpb25zfSBvcHRpb25zIC0gVGhlIGF2YWlsYWJsZSBvcHRpb25zLlxuICogQHJldHVybnMge3N0cmluZ30gQmFzZTY0LWVuY29kZWQgY29udGVudCBvZiB0aGUgcmVjb3JkZWQgbWVkaWEgZmlsZSBpZiAncmVtb3RlUGF0aCdcbiAqICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlciBpcyBlbXB0eSBvciBudWxsIG9yIGFuIGVtcHR5IHN0cmluZy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgZ2V0dGluZyB0aGUgbmFtZSBvZiBhIG1lZGlhIGZpbGVcbiAqICAgICAgICAgICAgICAgICBvciB0aGUgZmlsZSBjb250ZW50IGNhbm5vdCBiZSB1cGxvYWRlZCB0byB0aGUgcmVtb3RlIGxvY2F0aW9uLlxuICovXG5jb21tYW5kcy5zdG9wUmVjb3JkaW5nU2NyZWVuID0gYXN5bmMgZnVuY3Rpb24gKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgcmVtb3RlUGF0aCxcbiAgICB1c2VyLFxuICAgIHBhc3MsXG4gICAgbWV0aG9kLFxuICB9ID0gb3B0aW9ucztcblxuICBpZiAoIXRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyKSB7XG4gICAgbG9nLmluZm8oJ1NjcmVlbiByZWNvcmRpbmcgaXMgbm90IHJ1bm5pbmcuIFRoZXJlIGlzIG5vdGhpbmcgdG8gc3RvcC4nKTtcbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IHZpZGVvUGF0aCA9IGF3YWl0IHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyLmZpbmlzaCgpO1xuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHZpZGVvUGF0aCkpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgc2NyZWVuIHJlY29yZGVyIHV0aWxpdHkgaGFzIGZhaWxlZCBgICtcbiAgICAgICAgYHRvIHN0b3JlIHRoZSBhY3R1YWwgc2NyZWVuIHJlY29yZGluZyBhdCAnJHt2aWRlb1BhdGh9J2ApO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgZW5jb2RlQmFzZTY0T3JVcGxvYWQodmlkZW9QYXRoLCByZW1vdGVQYXRoLCB7XG4gICAgICB1c2VyLFxuICAgICAgcGFzcyxcbiAgICAgIG1ldGhvZFxuICAgIH0pO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyLmludGVycnVwdCh0cnVlKTtcbiAgICBhd2FpdCB0aGlzLl9yZWNlbnRTY3JlZW5SZWNvcmRlci5jbGVhbnVwKCk7XG4gICAgdGhpcy5fcmVjZW50U2NyZWVuUmVjb3JkZXIgPSBudWxsO1xuICB9XG59O1xuXG5cbmV4cG9ydCB7IGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3JlY29yZHNjcmVlbi5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
