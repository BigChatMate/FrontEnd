"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setupSelendroid = setupSelendroid;
exports.serverExists = serverExists;
exports.SE_MANIFEST_PATH = exports.SE_APK_PATH = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _fancyLog = _interopRequireDefault(require("fancy-log"));

var _crypto = _interopRequireDefault(require("crypto"));

const SE_VER = "0.17.0";
const SE_DOWNLOAD_CDNURL = process.env.npm_config_selendroid_driver_cdnurl || process.env.SELENDROID_DRIVER_CDNURL || "http://repo1.maven.org/maven2/io/selendroid/selendroid-standalone";
const SE_DOWNLOAD = `${SE_DOWNLOAD_CDNURL}/${SE_VER}/selendroid-standalone-${SE_VER}-with-dependencies.jar`;
const SE_DOWNLOAD_SHA256 = "7cf7163ac47f1c46eff95b62f78b58c1dabdec534acc6632da3784739f6e9d82";

const SE_DIR = _path.default.resolve(__dirname, "..", "..", "selendroid");

const SE_DOWNLOAD_DIR = _path.default.resolve(SE_DIR, "download");

const SE_JAR_PATH_TMP = _path.default.resolve(SE_DOWNLOAD_DIR, "selendroid-server.jar.tmp");

const SE_JAR_PATH = _path.default.resolve(SE_DOWNLOAD_DIR, `selendroid-server-${SE_DOWNLOAD_SHA256}.jar`);

const SE_APK_PATH = _path.default.resolve(SE_DIR, "selendroid-server.apk");

exports.SE_APK_PATH = SE_APK_PATH;

const SE_MANIFEST_PATH = _path.default.resolve(SE_DIR, "AndroidManifest.xml");

exports.SE_MANIFEST_PATH = SE_MANIFEST_PATH;

function setupSelendroid() {
  return _setupSelendroid.apply(this, arguments);
}

function _setupSelendroid() {
  _setupSelendroid = (0, _asyncToGenerator2.default)(function* () {
    try {
      yield (0, _teen_process.exec)('jar');
    } catch (err) {
      if (err.message.indexOf("ENOENT") !== -1 || err.message.indexOf("exited with code 2") !== -1 || err.message.indexOf("Command 'jar' not found. Is it installed?") !== -1) {
        _fancyLog.default.error("Could not find Java's 'jar' executable on your PATH. Please " + "ensure it is present and try running install again");

        return;
      }
    }

    if (yield _appiumSupport.fs.exists(SE_JAR_PATH)) {
      (0, _fancyLog.default)("Standalone jar exists, skipping download: " + SE_JAR_PATH);
    } else {
      yield downloadSelendroid();
    }

    (0, _fancyLog.default)(`Determining AndroidManifest location`);
    let manifestPath = yield getFilePathFromJar(/AndroidManifest.*\.xml$/, SE_JAR_PATH);
    (0, _fancyLog.default)(`Determining server apk location`);
    let serverPath = yield getFilePathFromJar(/selendroid-server.*\.apk$/, SE_JAR_PATH);
    (0, _fancyLog.default)(`Extracting manifest and apk to ${SE_DOWNLOAD_DIR}`);
    yield (0, _teen_process.exec)('jar', ['xf', SE_JAR_PATH, manifestPath, serverPath], {
      cwd: SE_DOWNLOAD_DIR
    });
    (0, _fancyLog.default)(`Copying manifest and apk to ${SE_DIR}`);

    let extractedManifestPath = _path.default.resolve(SE_DOWNLOAD_DIR, manifestPath);

    let extractedServerPath = _path.default.resolve(SE_DOWNLOAD_DIR, serverPath);

    yield _appiumSupport.fs.copyFile(extractedManifestPath, SE_MANIFEST_PATH);
    yield _appiumSupport.fs.copyFile(extractedServerPath, SE_APK_PATH);
    (0, _fancyLog.default)("Cleaning up temp files");
    yield _appiumSupport.fs.rimraf(extractedManifestPath);
    yield _appiumSupport.fs.rimraf(extractedServerPath);
    (0, _fancyLog.default)(`Fixing AndroidManifest icon bug`);
    yield fixManifestIcons(SE_MANIFEST_PATH);

    if (!(yield serverExists())) {
      throw new Error("Something went wrong in setting up selendroid");
    }
  });
  return _setupSelendroid.apply(this, arguments);
}

function downloadSelendroid() {
  return _downloadSelendroid.apply(this, arguments);
}

function _downloadSelendroid() {
  _downloadSelendroid = (0, _asyncToGenerator2.default)(function* () {
    (0, _fancyLog.default)(`Ensuring ${SE_DOWNLOAD_DIR} exists`);
    yield _appiumSupport.fs.mkdir(SE_DIR);
    yield _appiumSupport.fs.mkdir(SE_DOWNLOAD_DIR);
    (0, _fancyLog.default)(`Downloading Selendroid standalone server version ${SE_VER} from ` + `${SE_DOWNLOAD} --> ${SE_JAR_PATH}`);
    let body = yield _requestPromise.default.get({
      url: SE_DOWNLOAD,
      encoding: null
    });

    if (!(body instanceof Buffer)) {
      throw new Error(Object.prototype.toString.call(body));
    }

    (0, _fancyLog.default)(`Writing binary content to ${SE_JAR_PATH_TMP}`);
    yield _appiumSupport.fs.writeFile(SE_JAR_PATH_TMP, body);
    yield _appiumSupport.fs.chmod(SE_JAR_PATH_TMP, 0o0644);
    let fingerprint = sha256(body);

    if (fingerprint === SE_DOWNLOAD_SHA256) {
      yield _appiumSupport.fs.rename(SE_JAR_PATH_TMP, SE_JAR_PATH);
      (0, _fancyLog.default)("Selendroid standalone server downloaded");
    } else {
      throw new Error(`Bad SHA256 fingerprint: '${fingerprint}', bytes: ${body.length}`);
    }
  });
  return _downloadSelendroid.apply(this, arguments);
}

function sha256(buffer) {
  const hash = _crypto.default.createHash('sha256');

  return hash.update(buffer).digest('hex');
}

function getFilePathFromJar(_x, _x2) {
  return _getFilePathFromJar.apply(this, arguments);
}

function _getFilePathFromJar() {
  _getFilePathFromJar = (0, _asyncToGenerator2.default)(function* (fileRegex, jarPath) {
    let _ref = yield (0, _teen_process.exec)('jar', ['tf', jarPath]),
        stdout = _ref.stdout;

    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = stdout.split("\n")[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        let line = _step.value;

        if (fileRegex.test(line.trim())) {
          return line.trim();
        }
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator.return != null) {
          _iterator.return();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    throw new Error(`Could not find ${fileRegex} in ${jarPath}`);
  });
  return _getFilePathFromJar.apply(this, arguments);
}

function serverExists() {
  return _serverExists.apply(this, arguments);
}

function _serverExists() {
  _serverExists = (0, _asyncToGenerator2.default)(function* () {
    try {
      return (yield _appiumSupport.fs.exists(SE_APK_PATH)) && (yield _appiumSupport.fs.exists(SE_MANIFEST_PATH));
    } catch (e) {
      if (e.code.indexOf("ENOENT") !== -1) {
        return false;
      }

      throw e;
    }
  });
  return _serverExists.apply(this, arguments);
}

function fixManifestIcons(_x3) {
  return _fixManifestIcons.apply(this, arguments);
}

function _fixManifestIcons() {
  _fixManifestIcons = (0, _asyncToGenerator2.default)(function* (manifest) {
    let curData = (yield _appiumSupport.fs.readFile(manifest)).toString('utf8');
    let iconRe = /application[\s\S]+android:icon="[^"]+"/;
    let newData = curData.replace(iconRe, "application");
    yield _appiumSupport.fs.writeFile(manifest, newData);
  });
  return _fixManifestIcons.apply(this, arguments);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0YWxsZXIuanMiXSwibmFtZXMiOlsiU0VfVkVSIiwiU0VfRE9XTkxPQURfQ0ROVVJMIiwicHJvY2VzcyIsImVudiIsIm5wbV9jb25maWdfc2VsZW5kcm9pZF9kcml2ZXJfY2RudXJsIiwiU0VMRU5EUk9JRF9EUklWRVJfQ0ROVVJMIiwiU0VfRE9XTkxPQUQiLCJTRV9ET1dOTE9BRF9TSEEyNTYiLCJTRV9ESVIiLCJwYXRoIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsIlNFX0RPV05MT0FEX0RJUiIsIlNFX0pBUl9QQVRIX1RNUCIsIlNFX0pBUl9QQVRIIiwiU0VfQVBLX1BBVEgiLCJTRV9NQU5JRkVTVF9QQVRIIiwic2V0dXBTZWxlbmRyb2lkIiwiZXJyIiwibWVzc2FnZSIsImluZGV4T2YiLCJsb2ciLCJlcnJvciIsImZzIiwiZXhpc3RzIiwiZG93bmxvYWRTZWxlbmRyb2lkIiwibWFuaWZlc3RQYXRoIiwiZ2V0RmlsZVBhdGhGcm9tSmFyIiwic2VydmVyUGF0aCIsImN3ZCIsImV4dHJhY3RlZE1hbmlmZXN0UGF0aCIsImV4dHJhY3RlZFNlcnZlclBhdGgiLCJjb3B5RmlsZSIsInJpbXJhZiIsImZpeE1hbmlmZXN0SWNvbnMiLCJzZXJ2ZXJFeGlzdHMiLCJFcnJvciIsIm1rZGlyIiwiYm9keSIsInJlcXVlc3QiLCJnZXQiLCJ1cmwiLCJlbmNvZGluZyIsIkJ1ZmZlciIsIk9iamVjdCIsInByb3RvdHlwZSIsInRvU3RyaW5nIiwiY2FsbCIsIndyaXRlRmlsZSIsImNobW9kIiwiZmluZ2VycHJpbnQiLCJzaGEyNTYiLCJyZW5hbWUiLCJsZW5ndGgiLCJidWZmZXIiLCJoYXNoIiwiY3J5cHRvIiwiY3JlYXRlSGFzaCIsInVwZGF0ZSIsImRpZ2VzdCIsImZpbGVSZWdleCIsImphclBhdGgiLCJzdGRvdXQiLCJzcGxpdCIsImxpbmUiLCJ0ZXN0IiwidHJpbSIsImUiLCJjb2RlIiwibWFuaWZlc3QiLCJjdXJEYXRhIiwicmVhZEZpbGUiLCJpY29uUmUi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Q01RLGtCQUFHQyxNQUFILENBQVVSLGdCQUFWLENBRE4sQ0FBUjtBQUVELEtBSEQsQ0FHRSxPQUFPbUQsQ0FBUCxFQUFVO0FBQ1YsVUFBSUEsQ0FBQyxDQUFDQyxJQUFGLENBQU9oRCxPQUFQLENBQWUsUUFBZixNQUE2QixDQUFDLENBQWxDLEVBQXFDO0FBQ25DLGVBQU8sS0FBUDtBQUNEOztBQUNELFlBQU0rQyxDQUFOO0FBQ0Q7QUFDRixHOzs7O1NBRWNqQyxnQjs7Ozs7c0RBQWYsV0FBaUNtQyxRQUFqQyxFQUEyQztBQUN6QyxRQUFJQyxPQUFPLEdBQUcsT0FBTy9DLGtCQUFHZ0QsUUFBSCxDQUFZRixRQUFaLENBQVAsRUFBOEJ2QixRQUE5QixDQUF1QyxNQUF2QyxDQUFkO0FBQ0EsUUFBSTBCLE1BQU0sR0FBRyx3Q0FBYjtBQUNBLFFBQUlDLE9BQU8sR0FBR0gsT0FBTyxDQUFDSSxPQUFSLENBQWdCRixNQUFoQixFQUF3QixhQUF4QixDQUFkO0FBQ0EsVUFBTWpELGtCQUFHeUIsU0FBSCxDQUFhcUIsUUFBYixFQUF1QkksT0FBdkIsQ0FBTjtBQUNELEciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IGxvZyBmcm9tICdmYW5jeS1sb2cnO1xuaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xuXG5cbmNvbnN0IFNFX1ZFUiA9IFwiMC4xNy4wXCI7XG5jb25zdCBTRV9ET1dOTE9BRF9DRE5VUkwgPSBwcm9jZXNzLmVudi5ucG1fY29uZmlnX3NlbGVuZHJvaWRfZHJpdmVyX2NkbnVybCB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5lbnYuU0VMRU5EUk9JRF9EUklWRVJfQ0ROVVJMIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICBcImh0dHA6Ly9yZXBvMS5tYXZlbi5vcmcvbWF2ZW4yL2lvL3NlbGVuZHJvaWQvc2VsZW5kcm9pZC1zdGFuZGFsb25lXCI7XG5jb25zdCBTRV9ET1dOTE9BRCA9IGAke1NFX0RPV05MT0FEX0NETlVSTH0vJHtTRV9WRVJ9L3NlbGVuZHJvaWQtc3RhbmRhbG9uZS0ke1NFX1ZFUn0td2l0aC1kZXBlbmRlbmNpZXMuamFyYDtcbmNvbnN0IFNFX0RPV05MT0FEX1NIQTI1NiA9IFwiN2NmNzE2M2FjNDdmMWM0NmVmZjk1YjYyZjc4YjU4YzFkYWJkZWM1MzRhY2M2NjMyZGEzNzg0NzM5ZjZlOWQ4MlwiO1xuY29uc3QgU0VfRElSID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgXCIuLlwiLCBcIi4uXCIsIFwic2VsZW5kcm9pZFwiKTtcbmNvbnN0IFNFX0RPV05MT0FEX0RJUiA9IHBhdGgucmVzb2x2ZShTRV9ESVIsIFwiZG93bmxvYWRcIik7XG4vLyBVc2Ugb2YgdGVtcG9yYXJ5IGZpbGUgbWVhbnMgdGhhdCBTRV9KQVJfUEFUSCBjYW4gb25seSBleGlzdCBpZiBpdCBoYXNcbi8vIHZlcmlmaWVkIGNvbnRlbnQuXG5jb25zdCBTRV9KQVJfUEFUSF9UTVAgPSBwYXRoLnJlc29sdmUoU0VfRE9XTkxPQURfRElSLCBcInNlbGVuZHJvaWQtc2VydmVyLmphci50bXBcIik7XG4vLyBQdXR0aW5nIGZpbmdlcnByaW50IGluIGZpbGUgbmFtZSBtZWFucyBkb3dubG9hZCB0cmlnZ2VyZWQgaWYgZmluZ2VycHJpbnQgY2hhbmdlZC5cbmNvbnN0IFNFX0pBUl9QQVRIID0gcGF0aC5yZXNvbHZlKFNFX0RPV05MT0FEX0RJUiwgYHNlbGVuZHJvaWQtc2VydmVyLSR7U0VfRE9XTkxPQURfU0hBMjU2fS5qYXJgKTtcbmNvbnN0IFNFX0FQS19QQVRIID0gcGF0aC5yZXNvbHZlKFNFX0RJUiwgXCJzZWxlbmRyb2lkLXNlcnZlci5hcGtcIik7XG5jb25zdCBTRV9NQU5JRkVTVF9QQVRIID0gcGF0aC5yZXNvbHZlKFNFX0RJUiwgXCJBbmRyb2lkTWFuaWZlc3QueG1sXCIpO1xuXG5hc3luYyBmdW5jdGlvbiBzZXR1cFNlbGVuZHJvaWQgKCkge1xuICB0cnkge1xuICAgIGF3YWl0IGV4ZWMoJ2phcicpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZihcIkVOT0VOVFwiKSAhPT0gLTEgfHxcbiAgICAgICAgZXJyLm1lc3NhZ2UuaW5kZXhPZihcImV4aXRlZCB3aXRoIGNvZGUgMlwiKSAhPT0gLTEgfHxcbiAgICAgICAgZXJyLm1lc3NhZ2UuaW5kZXhPZihcIkNvbW1hbmQgJ2phcicgbm90IGZvdW5kLiBJcyBpdCBpbnN0YWxsZWQ/XCIpICE9PSAtMSkge1xuICAgICAgbG9nLmVycm9yKFwiQ291bGQgbm90IGZpbmQgSmF2YSdzICdqYXInIGV4ZWN1dGFibGUgb24geW91ciBQQVRILiBQbGVhc2UgXCIgK1xuICAgICAgICAgICAgICAgIFwiZW5zdXJlIGl0IGlzIHByZXNlbnQgYW5kIHRyeSBydW5uaW5nIGluc3RhbGwgYWdhaW5cIik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG4gIGlmIChhd2FpdCBmcy5leGlzdHMoU0VfSkFSX1BBVEgpKSB7XG4gICAgbG9nKFwiU3RhbmRhbG9uZSBqYXIgZXhpc3RzLCBza2lwcGluZyBkb3dubG9hZDogXCIgKyBTRV9KQVJfUEFUSCk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgZG93bmxvYWRTZWxlbmRyb2lkKCk7XG4gIH1cbiAgbG9nKGBEZXRlcm1pbmluZyBBbmRyb2lkTWFuaWZlc3QgbG9jYXRpb25gKTtcbiAgbGV0IG1hbmlmZXN0UGF0aCA9IGF3YWl0IGdldEZpbGVQYXRoRnJvbUphcigvQW5kcm9pZE1hbmlmZXN0LipcXC54bWwkLyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTRV9KQVJfUEFUSCk7XG4gIGxvZyhgRGV0ZXJtaW5pbmcgc2VydmVyIGFwayBsb2NhdGlvbmApO1xuICBsZXQgc2VydmVyUGF0aCA9IGF3YWl0IGdldEZpbGVQYXRoRnJvbUphcigvc2VsZW5kcm9pZC1zZXJ2ZXIuKlxcLmFwayQvLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTRV9KQVJfUEFUSCk7XG4gIGxvZyhgRXh0cmFjdGluZyBtYW5pZmVzdCBhbmQgYXBrIHRvICR7U0VfRE9XTkxPQURfRElSfWApO1xuICBhd2FpdCBleGVjKCdqYXInLCBbJ3hmJywgU0VfSkFSX1BBVEgsIG1hbmlmZXN0UGF0aCwgc2VydmVyUGF0aF0sIHtcbiAgICBjd2Q6IFNFX0RPV05MT0FEX0RJUlxuICB9KTtcbiAgbG9nKGBDb3B5aW5nIG1hbmlmZXN0IGFuZCBhcGsgdG8gJHtTRV9ESVJ9YCk7XG4gIGxldCBleHRyYWN0ZWRNYW5pZmVzdFBhdGggPSBwYXRoLnJlc29sdmUoU0VfRE9XTkxPQURfRElSLCBtYW5pZmVzdFBhdGgpO1xuICBsZXQgZXh0cmFjdGVkU2VydmVyUGF0aCA9IHBhdGgucmVzb2x2ZShTRV9ET1dOTE9BRF9ESVIsIHNlcnZlclBhdGgpO1xuICBhd2FpdCBmcy5jb3B5RmlsZShleHRyYWN0ZWRNYW5pZmVzdFBhdGgsIFNFX01BTklGRVNUX1BBVEgpO1xuICBhd2FpdCBmcy5jb3B5RmlsZShleHRyYWN0ZWRTZXJ2ZXJQYXRoLCBTRV9BUEtfUEFUSCk7XG4gIGxvZyhcIkNsZWFuaW5nIHVwIHRlbXAgZmlsZXNcIik7XG4gIGF3YWl0IGZzLnJpbXJhZihleHRyYWN0ZWRNYW5pZmVzdFBhdGgpO1xuICBhd2FpdCBmcy5yaW1yYWYoZXh0cmFjdGVkU2VydmVyUGF0aCk7XG4gIGxvZyhgRml4aW5nIEFuZHJvaWRNYW5pZmVzdCBpY29uIGJ1Z2ApO1xuICBhd2FpdCBmaXhNYW5pZmVzdEljb25zKFNFX01BTklGRVNUX1BBVEgpO1xuICBpZiAoIShhd2FpdCBzZXJ2ZXJFeGlzdHMoKSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJTb21ldGhpbmcgd2VudCB3cm9uZyBpbiBzZXR0aW5nIHVwIHNlbGVuZHJvaWRcIik7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZG93bmxvYWRTZWxlbmRyb2lkICgpIHtcbiAgbG9nKGBFbnN1cmluZyAke1NFX0RPV05MT0FEX0RJUn0gZXhpc3RzYCk7XG4gIGF3YWl0IGZzLm1rZGlyKFNFX0RJUik7XG4gIGF3YWl0IGZzLm1rZGlyKFNFX0RPV05MT0FEX0RJUik7XG4gIGxvZyhgRG93bmxvYWRpbmcgU2VsZW5kcm9pZCBzdGFuZGFsb25lIHNlcnZlciB2ZXJzaW9uICR7U0VfVkVSfSBmcm9tIGAgK1xuICAgICAgICAgICBgJHtTRV9ET1dOTE9BRH0gLS0+ICR7U0VfSkFSX1BBVEh9YCk7XG4gIGxldCBib2R5ID0gYXdhaXQgcmVxdWVzdC5nZXQoe3VybDogU0VfRE9XTkxPQUQsIGVuY29kaW5nOiBudWxsfSk7XG4gIGlmICghKGJvZHkgaW5zdGFuY2VvZiBCdWZmZXIpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChib2R5KSk7XG4gIH1cbiAgbG9nKGBXcml0aW5nIGJpbmFyeSBjb250ZW50IHRvICR7U0VfSkFSX1BBVEhfVE1QfWApO1xuICBhd2FpdCBmcy53cml0ZUZpbGUoU0VfSkFSX1BBVEhfVE1QLCBib2R5KTtcbiAgYXdhaXQgZnMuY2htb2QoU0VfSkFSX1BBVEhfVE1QLCAwbzA2NDQpO1xuICBsZXQgZmluZ2VycHJpbnQgPSBzaGEyNTYoYm9keSk7XG4gIGlmIChmaW5nZXJwcmludCA9PT0gU0VfRE9XTkxPQURfU0hBMjU2KSB7XG4gICAgYXdhaXQgZnMucmVuYW1lKFNFX0pBUl9QQVRIX1RNUCwgU0VfSkFSX1BBVEgpO1xuICAgIGxvZyhcIlNlbGVuZHJvaWQgc3RhbmRhbG9uZSBzZXJ2ZXIgZG93bmxvYWRlZFwiKTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEJhZCBTSEEyNTYgZmluZ2VycHJpbnQ6ICcke2ZpbmdlcnByaW50fScsIGJ5dGVzOiAke2JvZHkubGVuZ3RofWApO1xuICB9XG59XG5cbmZ1bmN0aW9uIHNoYTI1NiAoYnVmZmVyKSB7XG4gIGNvbnN0IGhhc2ggPSBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMjU2Jyk7XG4gIHJldHVybiBoYXNoLnVwZGF0ZShidWZmZXIpLmRpZ2VzdCgnaGV4Jyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEZpbGVQYXRoRnJvbUphciAoZmlsZVJlZ2V4LCBqYXJQYXRoKSB7XG4gIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ2phcicsIFsndGYnLCBqYXJQYXRoXSk7XG4gIGZvciAobGV0IGxpbmUgb2Ygc3Rkb3V0LnNwbGl0KFwiXFxuXCIpKSB7XG4gICAgaWYgKGZpbGVSZWdleC50ZXN0KGxpbmUudHJpbSgpKSkge1xuICAgICAgcmV0dXJuIGxpbmUudHJpbSgpO1xuICAgIH1cbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBmaW5kICR7ZmlsZVJlZ2V4fSBpbiAke2phclBhdGh9YCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNlcnZlckV4aXN0cyAoKSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIChhd2FpdCBmcy5leGlzdHMoU0VfQVBLX1BBVEgpICYmXG4gICAgICAgICAgICBhd2FpdCBmcy5leGlzdHMoU0VfTUFOSUZFU1RfUEFUSCkpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGUuY29kZS5pbmRleE9mKFwiRU5PRU5UXCIpICE9PSAtMSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aHJvdyBlO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpeE1hbmlmZXN0SWNvbnMgKG1hbmlmZXN0KSB7XG4gIGxldCBjdXJEYXRhID0gKGF3YWl0IGZzLnJlYWRGaWxlKG1hbmlmZXN0KSkudG9TdHJpbmcoJ3V0ZjgnKTtcbiAgbGV0IGljb25SZSA9IC9hcHBsaWNhdGlvbltcXHNcXFNdK2FuZHJvaWQ6aWNvbj1cIlteXCJdK1wiLztcbiAgbGV0IG5ld0RhdGEgPSBjdXJEYXRhLnJlcGxhY2UoaWNvblJlLCBcImFwcGxpY2F0aW9uXCIpO1xuICBhd2FpdCBmcy53cml0ZUZpbGUobWFuaWZlc3QsIG5ld0RhdGEpO1xufVxuXG5leHBvcnQgeyBzZXR1cFNlbGVuZHJvaWQsIHNlcnZlckV4aXN0cywgU0VfQVBLX1BBVEgsIFNFX01BTklGRVNUX1BBVEggfTtcbiJdLCJmaWxlIjoibGliL2luc3RhbGxlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
