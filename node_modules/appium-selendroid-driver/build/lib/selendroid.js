"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("./logger"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _installer = require("./installer");

const REQD_PARAMS = ['adb', 'appPackage', 'appActivity', 'tmpDir', 'apk', 'host', 'systemPort', 'devicePort'];

class SelendroidServer {
  constructor(opts = {}) {
    for (var _i = 0; _i < REQD_PARAMS.length; _i++) {
      let req = REQD_PARAMS[_i];

      if (!opts || !opts[req]) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.modServerPkg = `selendroid.${this.appPackage}`;
    this.modServerPath = _path.default.resolve(this.tmpDir, `${this.modServerPkg}.apk`);
    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.host,
      port: this.systemPort
    });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
  }

  prepareModifiedServer() {
    var _this = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let needsUninstall = false;

      if (!(yield _appiumSupport.fs.exists(_this.modServerPath))) {
        yield _this.buildNewModServer();
        needsUninstall = true;
      }

      needsUninstall = (yield _this.checkAndSignCert(_this.modServerPath)) || needsUninstall;

      if (needsUninstall) {
        _logger.default.info("New server was built, uninstalling any instances of it");

        yield _this.adb.uninstallApk(_this.modServerPkg);
      }
    })();
  }

  installModifiedServer() {
    var _this2 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let installed = yield _this2.adb.isAppInstalled(_this2.modServerPkg);

      if (!installed) {
        yield _this2.adb.install(_this2.modServerPath);
      }
    })();
  }

  buildNewModServer() {
    var _this3 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _logger.default.info(`Repackaging selendroid for: '${_this3.appPackage}'`);

      let packageTmpDir = _path.default.resolve(_this3.tmpDir, _this3.appPackage);

      let newManifestPath = _path.default.resolve(_this3.tmpDir, 'AndroidManifest.xml');

      _logger.default.info(`Creating new manifest: '${newManifestPath}'`);

      yield _appiumSupport.fs.mkdir(packageTmpDir);
      yield _appiumSupport.fs.copyFile(_installer.SE_MANIFEST_PATH, newManifestPath);
      yield _this3.adb.initAapt();
      yield _this3.adb.compileManifest(newManifestPath, _this3.modServerPkg, _this3.appPackage);
      yield _this3.adb.insertManifest(newManifestPath, _installer.SE_APK_PATH, _this3.modServerPath);

      _logger.default.info(`Repackaged selendroid ready: '${_this3.modServerPath}'`);
    })();
  }

  checkAndSignCert(apk) {
    var _this4 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let signed = yield _this4.adb.checkApkCert(apk, _this4.appPackage);

      if (!signed) {
        yield _this4.adb.sign(apk);
      }

      return !signed;
    })();
  }

  startSession(caps) {
    var _this5 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let instrumentWith = `${_this5.modServerPkg}/` + `io.selendroid.server.ServerInstrumentation`;

      _logger.default.info(`Starting selendroid server with instrumentation: ` + `${instrumentWith}`);

      yield _this5.adb.instrument(_this5.appPackage, _this5.appActivity, instrumentWith);

      _logger.default.info('Waiting for Selendroid to be online...');

      yield (0, _asyncbox.retryInterval)(20, 1000, (0, _asyncToGenerator2.default)(function* () {
        yield _this5.jwproxy.command('/status', 'GET');
      }));
      yield _this5.jwproxy.command('/session', 'POST', {
        desiredCapabilities: caps
      });
    })();
  }

  deleteSession() {
    var _this6 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _logger.default.debug('Deleting Selendroid server session');

      try {
        yield _this6.jwproxy.command('/', 'DELETE');
      } catch (err) {
        _logger.default.warn(`Did not get confirmation Selendroid deleteSession worked; ` + `Error was: ${err}`);
      }
    })();
  }

}

var _default = SelendroidServer;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zZWxlbmRyb2lkLmpzIl0sIm5hbWVzIjpbIlJFUURfUEFSQU1TIiwiU2VsZW5kcm9pZFNlcnZlciIsImNvbnN0cnVjdG9yIiwib3B0cyIsInJlcSIsIkVycm9yIiwibW9kU2VydmVyUGtnIiwiYXBwUGFja2FnZSIsIm1vZFNlcnZlclBhdGgiLCJwYXRoIiwicmVzb2x2ZSIsInRtcERpciIsImp3cHJveHkiLCJKV1Byb3h5Iiwic2VydmVyIiwiaG9zdCIsInBvcnQiLCJzeXN0ZW1Qb3J0IiwicHJveHlSZXFSZXMiLCJiaW5kIiwicHJlcGFyZU1vZGlmaWVkU2VydmVyIiwibmVlZHNVbmluc3RhbGwiLCJmcyIsImV4aXN0cyIsImJ1aWxkTmV3TW9kU2VydmVyIiwiY2hlY2tBbmRTaWduQ2VydCIsImxvZ2dlciIsImluZm8iLCJhZGIiLCJ1bmluc3RhbGxBcGsiLCJpbnN0YWxsTW9kaWZpZWRTZXJ2ZXIiLCJpbnN0YWxsZWQiLCJpc0FwcEluc3RhbGxlZCIsImluc3RhbGwiLCJwYWNrYWdlVG1wRGlyIiwibmV3TWFuaWZlc3RQYXRoIiwibWtkaXIiLCJjb3B5RmlsZSIsIlNFX01BTklGRVNUX1BBVEgiLCJpbml0QWFwdCIsImNvbXBpbGVNYW5pZmVzdCIsImluc2VydE1hbmlmZXN0IiwiU0VfQVBLX1BBVEgiLCJhcGsiLCJzaWduZWQiLCJjaGVja0Fwa0NlcnQiLCJzaWduIiwic3RhcnRTZXNzaW9uIiwiY2FwcyIsImluc3RydW1lbnRXaXRoIiwiaW5zdHJ1bWVudCIsImFwcEFjdGl2aXR5IiwiY29tbWFuZCIsImRlc2lyZWRDYXBhYmlsaXRpZXMiLCJkZWxldGVTZXNzaW9uIiwiZGVidWciLCJlcnIiLCJ3YXJuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLFdBQVcsR0FBRyxDQUNsQixLQURrQixFQUNYLFlBRFcsRUFDRyxhQURILEVBQ2tCLFFBRGxCLEVBQzRCLEtBRDVCLEVBQ21DLE1BRG5DLEVBQzJDLFlBRDNDLEVBRWxCLFlBRmtCLENBQXBCOztBQUtBLE1BQU1DLGdCQUFOLENBQXVCO0FBQ3JCQyxFQUFBQSxXQUFXLENBQUVDLElBQUksR0FBRyxFQUFULEVBQWE7QUFDdEIsMEJBQWdCSCxXQUFoQixlQUE2QjtBQUF4QixVQUFJSSxHQUFHLEdBQUlKLFdBQUosSUFBUDs7QUFDSCxVQUFJLENBQUNHLElBQUQsSUFBUyxDQUFDQSxJQUFJLENBQUNDLEdBQUQsQ0FBbEIsRUFBeUI7QUFDdkIsY0FBTSxJQUFJQyxLQUFKLENBQVcsV0FBVUQsR0FBSSxnQkFBekIsQ0FBTjtBQUNEOztBQUNELFdBQUtBLEdBQUwsSUFBWUQsSUFBSSxDQUFDQyxHQUFELENBQWhCO0FBQ0Q7O0FBR0QsU0FBS0UsWUFBTCxHQUFxQixjQUFhLEtBQUtDLFVBQVcsRUFBbEQ7QUFFQSxTQUFLQyxhQUFMLEdBQXFCQyxjQUFLQyxPQUFMLENBQWEsS0FBS0MsTUFBbEIsRUFBMkIsR0FBRSxLQUFLTCxZQUFhLE1BQS9DLENBQXJCO0FBQ0EsU0FBS00sT0FBTCxHQUFlLElBQUlDLHlCQUFKLENBQVk7QUFBQ0MsTUFBQUEsTUFBTSxFQUFFLEtBQUtDLElBQWQ7QUFBb0JDLE1BQUFBLElBQUksRUFBRSxLQUFLQztBQUEvQixLQUFaLENBQWY7QUFDQSxTQUFLQyxXQUFMLEdBQW1CLEtBQUtOLE9BQUwsQ0FBYU0sV0FBYixDQUF5QkMsSUFBekIsQ0FBOEIsS0FBS1AsT0FBbkMsQ0FBbkI7QUFDRDs7QUFFS1EsRUFBQUEscUJBQU4sR0FBK0I7QUFBQTs7QUFBQTtBQUk3QixVQUFJQyxjQUFjLEdBQUcsS0FBckI7O0FBQ0EsVUFBSSxRQUFRQyxrQkFBR0MsTUFBSCxDQUFVLEtBQUksQ0FBQ2YsYUFBZixDQUFSLENBQUosRUFBNEM7QUFDMUMsY0FBTSxLQUFJLENBQUNnQixpQkFBTCxFQUFOO0FBQ0FILFFBQUFBLGNBQWMsR0FBRyxJQUFqQjtBQUNEOztBQUNEQSxNQUFBQSxjQUFjLEdBQUcsT0FBTSxLQUFJLENBQUNJLGdCQUFMLENBQXNCLEtBQUksQ0FBQ2pCLGFBQTNCLENBQU4sS0FBbURhLGNBQXBFOztBQUNBLFVBQUlBLGNBQUosRUFBb0I7QUFDbEJLLHdCQUFPQyxJQUFQLENBQVksd0RBQVo7O0FBQ0EsY0FBTSxLQUFJLENBQUNDLEdBQUwsQ0FBU0MsWUFBVCxDQUFzQixLQUFJLENBQUN2QixZQUEzQixDQUFOO0FBQ0Q7QUFiNEI7QUFjOUI7O0FBRUt3QixFQUFBQSxxQkFBTixHQUErQjtBQUFBOztBQUFBO0FBQzdCLFVBQUlDLFNBQVMsU0FBUyxNQUFJLENBQUNILEdBQUwsQ0FBU0ksY0FBVCxDQUF3QixNQUFJLENBQUMxQixZQUE3QixDQUF0Qjs7QUFDQSxVQUFJLENBQUN5QixTQUFMLEVBQWdCO0FBQ2QsY0FBTSxNQUFJLENBQUNILEdBQUwsQ0FBU0ssT0FBVCxDQUFpQixNQUFJLENBQUN6QixhQUF0QixDQUFOO0FBQ0Q7QUFKNEI7QUFLOUI7O0FBRUtnQixFQUFBQSxpQkFBTixHQUEyQjtBQUFBOztBQUFBO0FBQ3pCRSxzQkFBT0MsSUFBUCxDQUFhLGdDQUErQixNQUFJLENBQUNwQixVQUFXLEdBQTVEOztBQUNBLFVBQUkyQixhQUFhLEdBQUd6QixjQUFLQyxPQUFMLENBQWEsTUFBSSxDQUFDQyxNQUFsQixFQUEwQixNQUFJLENBQUNKLFVBQS9CLENBQXBCOztBQUNBLFVBQUk0QixlQUFlLEdBQUcxQixjQUFLQyxPQUFMLENBQWEsTUFBSSxDQUFDQyxNQUFsQixFQUEwQixxQkFBMUIsQ0FBdEI7O0FBQ0FlLHNCQUFPQyxJQUFQLENBQWEsMkJBQTBCUSxlQUFnQixHQUF2RDs7QUFDQSxZQUFNYixrQkFBR2MsS0FBSCxDQUFTRixhQUFULENBQU47QUFDQSxZQUFNWixrQkFBR2UsUUFBSCxDQUFZQywyQkFBWixFQUE4QkgsZUFBOUIsQ0FBTjtBQUNBLFlBQU0sTUFBSSxDQUFDUCxHQUFMLENBQVNXLFFBQVQsRUFBTjtBQUNBLFlBQU0sTUFBSSxDQUFDWCxHQUFMLENBQVNZLGVBQVQsQ0FBeUJMLGVBQXpCLEVBQTBDLE1BQUksQ0FBQzdCLFlBQS9DLEVBQ3lCLE1BQUksQ0FBQ0MsVUFEOUIsQ0FBTjtBQUVBLFlBQU0sTUFBSSxDQUFDcUIsR0FBTCxDQUFTYSxjQUFULENBQXdCTixlQUF4QixFQUF5Q08sc0JBQXpDLEVBQ3dCLE1BQUksQ0FBQ2xDLGFBRDdCLENBQU47O0FBRUFrQixzQkFBT0MsSUFBUCxDQUFhLGlDQUFnQyxNQUFJLENBQUNuQixhQUFjLEdBQWhFO0FBWnlCO0FBYTFCOztBQUVLaUIsRUFBQUEsZ0JBQU4sQ0FBd0JrQixHQUF4QixFQUE2QjtBQUFBOztBQUFBO0FBQzNCLFVBQUlDLE1BQU0sU0FBUyxNQUFJLENBQUNoQixHQUFMLENBQVNpQixZQUFULENBQXNCRixHQUF0QixFQUEyQixNQUFJLENBQUNwQyxVQUFoQyxDQUFuQjs7QUFDQSxVQUFJLENBQUNxQyxNQUFMLEVBQWE7QUFDWCxjQUFNLE1BQUksQ0FBQ2hCLEdBQUwsQ0FBU2tCLElBQVQsQ0FBY0gsR0FBZCxDQUFOO0FBQ0Q7O0FBR0QsYUFBTyxDQUFDQyxNQUFSO0FBUDJCO0FBUTVCOztBQUVLRyxFQUFBQSxZQUFOLENBQW9CQyxJQUFwQixFQUEwQjtBQUFBOztBQUFBO0FBQ3hCLFVBQUlDLGNBQWMsR0FBSSxHQUFFLE1BQUksQ0FBQzNDLFlBQWEsR0FBckIsR0FDQyw0Q0FEdEI7O0FBRUFvQixzQkFBT0MsSUFBUCxDQUFhLG1EQUFELEdBQ0YsR0FBRXNCLGNBQWUsRUFEM0I7O0FBRUEsWUFBTSxNQUFJLENBQUNyQixHQUFMLENBQVNzQixVQUFULENBQW9CLE1BQUksQ0FBQzNDLFVBQXpCLEVBQXFDLE1BQUksQ0FBQzRDLFdBQTFDLEVBQXVERixjQUF2RCxDQUFOOztBQUVBdkIsc0JBQU9DLElBQVAsQ0FBWSx3Q0FBWjs7QUFFQSxZQUFNLDZCQUFjLEVBQWQsRUFBa0IsSUFBbEIsa0NBQXdCLGFBQVk7QUFDeEMsY0FBTSxNQUFJLENBQUNmLE9BQUwsQ0FBYXdDLE9BQWIsQ0FBcUIsU0FBckIsRUFBZ0MsS0FBaEMsQ0FBTjtBQUNELE9BRkssRUFBTjtBQUdBLFlBQU0sTUFBSSxDQUFDeEMsT0FBTCxDQUFhd0MsT0FBYixDQUFxQixVQUFyQixFQUFpQyxNQUFqQyxFQUF5QztBQUFDQyxRQUFBQSxtQkFBbUIsRUFBRUw7QUFBdEIsT0FBekMsQ0FBTjtBQVp3QjtBQWF6Qjs7QUFFS00sRUFBQUEsYUFBTixHQUF1QjtBQUFBOztBQUFBO0FBQ3JCNUIsc0JBQU82QixLQUFQLENBQWEsb0NBQWI7O0FBR0EsVUFBSTtBQUNGLGNBQU0sTUFBSSxDQUFDM0MsT0FBTCxDQUFhd0MsT0FBYixDQUFxQixHQUFyQixFQUEwQixRQUExQixDQUFOO0FBQ0QsT0FGRCxDQUVFLE9BQU9JLEdBQVAsRUFBWTtBQUNaOUIsd0JBQU8rQixJQUFQLENBQWEsNERBQUQsR0FDQyxjQUFhRCxHQUFJLEVBRDlCO0FBRUQ7QUFUb0I7QUFVdEI7O0FBMUZvQjs7ZUE2RlJ2RCxnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEpXUHJveHkgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IFNFX0FQS19QQVRILCBTRV9NQU5JRkVTVF9QQVRIIH0gZnJvbSAnLi9pbnN0YWxsZXInO1xuXG5cbmNvbnN0IFJFUURfUEFSQU1TID0gW1xuICAnYWRiJywgJ2FwcFBhY2thZ2UnLCAnYXBwQWN0aXZpdHknLCAndG1wRGlyJywgJ2FwaycsICdob3N0JywgJ3N5c3RlbVBvcnQnLFxuICAnZGV2aWNlUG9ydCcsXG5dO1xuXG5jbGFzcyBTZWxlbmRyb2lkU2VydmVyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIGZvciAobGV0IHJlcSBvZiBSRVFEX1BBUkFNUykge1xuICAgICAgaWYgKCFvcHRzIHx8ICFvcHRzW3JlcV0pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPcHRpb24gJyR7cmVxfScgaXMgcmVxdWlyZWQhYCk7XG4gICAgICB9XG4gICAgICB0aGlzW3JlcV0gPSBvcHRzW3JlcV07XG4gICAgfVxuXG4gICAgLy8gbmV3IHBhY2thZ2UgbmFtZSBmb3IgcmVwYWNrYWdlZCBzZWxlbmRyb2lkIHNlcnZlclxuICAgIHRoaXMubW9kU2VydmVyUGtnID0gYHNlbGVuZHJvaWQuJHt0aGlzLmFwcFBhY2thZ2V9YDtcbiAgICAvLyBwYXRoIHRvIHRoZSByZXBhY2thZ2VkIHNlbGVuZHJvaWQgc2VydmVyIHNwZWNpZmljIHRvIHRoaXMgYXBwXG4gICAgdGhpcy5tb2RTZXJ2ZXJQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCBgJHt0aGlzLm1vZFNlcnZlclBrZ30uYXBrYCk7XG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEpXUHJveHkoe3NlcnZlcjogdGhpcy5ob3N0LCBwb3J0OiB0aGlzLnN5c3RlbVBvcnR9KTtcbiAgICB0aGlzLnByb3h5UmVxUmVzID0gdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzLmJpbmQodGhpcy5qd3Byb3h5KTtcbiAgfVxuXG4gIGFzeW5jIHByZXBhcmVNb2RpZmllZFNlcnZlciAoKSB7XG4gICAgLy8gVE9ETyBtaWdodCBoYXZlIGEgcmFjZSBjb25kaXRpb24gaWYgd2UgdHJ5IGJ1aWxkaW5nIHRoaXMgd2l0aCBtdWx0aXBsZVxuICAgIC8vIHNlc3Npb25zIGF0IHRoZSBzYW1lIHRpbWUuIE9UT0ggd2UgcHJvYmFibHkgd2FudCB0byBzaGFyZSB0aGUgbW9kXG4gICAgLy8gc2VydmVyLi4uXG4gICAgbGV0IG5lZWRzVW5pbnN0YWxsID0gZmFsc2U7XG4gICAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKHRoaXMubW9kU2VydmVyUGF0aCkpKSB7XG4gICAgICBhd2FpdCB0aGlzLmJ1aWxkTmV3TW9kU2VydmVyKCk7XG4gICAgICBuZWVkc1VuaW5zdGFsbCA9IHRydWU7XG4gICAgfVxuICAgIG5lZWRzVW5pbnN0YWxsID0gYXdhaXQgdGhpcy5jaGVja0FuZFNpZ25DZXJ0KHRoaXMubW9kU2VydmVyUGF0aCkgfHwgbmVlZHNVbmluc3RhbGw7XG4gICAgaWYgKG5lZWRzVW5pbnN0YWxsKSB7XG4gICAgICBsb2dnZXIuaW5mbyhcIk5ldyBzZXJ2ZXIgd2FzIGJ1aWx0LCB1bmluc3RhbGxpbmcgYW55IGluc3RhbmNlcyBvZiBpdFwiKTtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnVuaW5zdGFsbEFwayh0aGlzLm1vZFNlcnZlclBrZyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaW5zdGFsbE1vZGlmaWVkU2VydmVyICgpIHtcbiAgICBsZXQgaW5zdGFsbGVkID0gYXdhaXQgdGhpcy5hZGIuaXNBcHBJbnN0YWxsZWQodGhpcy5tb2RTZXJ2ZXJQa2cpO1xuICAgIGlmICghaW5zdGFsbGVkKSB7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5pbnN0YWxsKHRoaXMubW9kU2VydmVyUGF0aCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgYnVpbGROZXdNb2RTZXJ2ZXIgKCkge1xuICAgIGxvZ2dlci5pbmZvKGBSZXBhY2thZ2luZyBzZWxlbmRyb2lkIGZvcjogJyR7dGhpcy5hcHBQYWNrYWdlfSdgKTtcbiAgICBsZXQgcGFja2FnZVRtcERpciA9IHBhdGgucmVzb2x2ZSh0aGlzLnRtcERpciwgdGhpcy5hcHBQYWNrYWdlKTtcbiAgICBsZXQgbmV3TWFuaWZlc3RQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCAnQW5kcm9pZE1hbmlmZXN0LnhtbCcpO1xuICAgIGxvZ2dlci5pbmZvKGBDcmVhdGluZyBuZXcgbWFuaWZlc3Q6ICcke25ld01hbmlmZXN0UGF0aH0nYCk7XG4gICAgYXdhaXQgZnMubWtkaXIocGFja2FnZVRtcERpcik7XG4gICAgYXdhaXQgZnMuY29weUZpbGUoU0VfTUFOSUZFU1RfUEFUSCwgbmV3TWFuaWZlc3RQYXRoKTtcbiAgICBhd2FpdCB0aGlzLmFkYi5pbml0QWFwdCgpOyAvLyBUT0RPIHRoaXMgc2hvdWxkIGJlIGludGVybmFsIHRvIGFkYlxuICAgIGF3YWl0IHRoaXMuYWRiLmNvbXBpbGVNYW5pZmVzdChuZXdNYW5pZmVzdFBhdGgsIHRoaXMubW9kU2VydmVyUGtnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcFBhY2thZ2UpO1xuICAgIGF3YWl0IHRoaXMuYWRiLmluc2VydE1hbmlmZXN0KG5ld01hbmlmZXN0UGF0aCwgU0VfQVBLX1BBVEgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RTZXJ2ZXJQYXRoKTtcbiAgICBsb2dnZXIuaW5mbyhgUmVwYWNrYWdlZCBzZWxlbmRyb2lkIHJlYWR5OiAnJHt0aGlzLm1vZFNlcnZlclBhdGh9J2ApO1xuICB9XG5cbiAgYXN5bmMgY2hlY2tBbmRTaWduQ2VydCAoYXBrKSB7XG4gICAgbGV0IHNpZ25lZCA9IGF3YWl0IHRoaXMuYWRiLmNoZWNrQXBrQ2VydChhcGssIHRoaXMuYXBwUGFja2FnZSk7XG4gICAgaWYgKCFzaWduZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnNpZ24oYXBrKTtcbiAgICB9XG5cbiAgICAvLyByZXR1cm4gd2hldGhlciB0aGUgYXBrIHdhcyBzaWduZWRcbiAgICByZXR1cm4gIXNpZ25lZDtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvbiAoY2Fwcykge1xuICAgIGxldCBpbnN0cnVtZW50V2l0aCA9IGAke3RoaXMubW9kU2VydmVyUGtnfS9gICtcbiAgICAgICAgICAgICAgICAgICAgICAgICBgaW8uc2VsZW5kcm9pZC5zZXJ2ZXIuU2VydmVySW5zdHJ1bWVudGF0aW9uYDtcbiAgICBsb2dnZXIuaW5mbyhgU3RhcnRpbmcgc2VsZW5kcm9pZCBzZXJ2ZXIgd2l0aCBpbnN0cnVtZW50YXRpb246IGAgK1xuICAgICAgICAgICAgIGAke2luc3RydW1lbnRXaXRofWApO1xuICAgIGF3YWl0IHRoaXMuYWRiLmluc3RydW1lbnQodGhpcy5hcHBQYWNrYWdlLCB0aGlzLmFwcEFjdGl2aXR5LCBpbnN0cnVtZW50V2l0aCk7XG5cbiAgICBsb2dnZXIuaW5mbygnV2FpdGluZyBmb3IgU2VsZW5kcm9pZCB0byBiZSBvbmxpbmUuLi4nKTtcbiAgICAvLyB3YWl0IDIwcyBmb3IgU2VsZW5kcm9pZCB0byBiZSBvbmxpbmVcbiAgICBhd2FpdCByZXRyeUludGVydmFsKDIwLCAxMDAwLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3Nlc3Npb24nLCAnUE9TVCcsIHtkZXNpcmVkQ2FwYWJpbGl0aWVzOiBjYXBzfSk7XG4gIH1cblxuICBhc3luYyBkZWxldGVTZXNzaW9uICgpIHtcbiAgICBsb2dnZXIuZGVidWcoJ0RlbGV0aW5nIFNlbGVuZHJvaWQgc2VydmVyIHNlc3Npb24nKTtcbiAgICAvLyByZWx5IG9uIGp3cHJveHkncyBpbnRlbGxpZ2VuY2UgdG8ga25vdyB3aGF0IHdlJ3JlIHRhbGtpbmcgYWJvdXQgYW5kXG4gICAgLy8gZGVsZXRlIHRoZSBjdXJyZW50IHNlc3Npb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy8nLCAnREVMRVRFJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIud2FybihgRGlkIG5vdCBnZXQgY29uZmlybWF0aW9uIFNlbGVuZHJvaWQgZGVsZXRlU2Vzc2lvbiB3b3JrZWQ7IGAgK1xuICAgICAgICAgICAgICAgICAgYEVycm9yIHdhczogJHtlcnJ9YCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFNlbGVuZHJvaWRTZXJ2ZXI7XG4iXSwiZmlsZSI6ImxpYi9zZWxlbmRyb2lkLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
